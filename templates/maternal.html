<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Maternal Health (ANC) - Uganda HMIS</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.bundle.min.js"></script>
    <style>
        :root {
            --bg-primary: #fdf2f8;
            --bg-card: #ffffff;
            --text-primary: #1f2937;
            --text-secondary: #6b7280;
            --border-color: #d1d5db;
            --shadow: rgba(0, 0, 0, 0.1);
            --accent-pink: #ec4899;
            --accent-rose: #f43f5e;
        }

        [data-theme="dark"] {
            --bg-primary: #111827;
            --bg-card: #1f2937;
            --text-primary: #f9fafb;
            --text-secondary: #9ca3af;
            --border-color: #374151;
            --shadow: rgba(0, 0, 0, 0.3);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            transition: all 0.3s ease;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, var(--accent-pink) 0%, var(--accent-rose) 100%);
            color: white;
            padding: 16px 24px;
            box-shadow: 0 4px 20px var(--shadow);
            position: sticky;
            top: 0;
            z-index: 50;
        }

        [data-theme="dark"] .header {
            background: #1f2937;
            border-bottom: 2px solid #374151;
        }

        .header-content {
            max-width: 1800px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .back-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 10px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .back-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .logo {
            width: 40px;
            height: 40px;
            background: white;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        [data-theme="dark"] .logo {
            background: var(--accent-pink);
        }

        .title-container h1 {
            font-size: 18px;
            font-weight: 700;
        }

        .title-container p {
            font-size: 12px;
            opacity: 0.9;
        }

        .theme-toggle {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 10px;
            border-radius: 12px;
            cursor: pointer;
        }

        [data-theme="dark"] .theme-toggle {
            background: #fbbf24;
            color: #111827;
        }

        /* Tab Navigation */
        .tab-nav {
            background: var(--bg-card);
            border-bottom: 2px solid var(--border-color);
            position: sticky;
            top: 64px;
            z-index: 40;
            box-shadow: 0 2px 8px var(--shadow);
        }

        .tab-nav-content {
            max-width: 1800px;
            margin: 0 auto;
            padding: 12px 24px;
            display: flex;
            gap: 8px;
        }

        .tab-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
            background: #f3f4f6;
            color: #6b7280;
        }

        [data-theme="dark"] .tab-btn {
            background: #374151;
            color: #9ca3af;
        }

        .tab-btn.active {
            background: linear-gradient(135deg, var(--accent-pink), var(--accent-rose));
            color: white;
            box-shadow: 0 4px 12px rgba(236, 72, 153, 0.3);
        }

        /* Container */
        .container {
            max-width: 1800px;
            margin: 0 auto;
            padding: 24px;
        }

        /* Filters Card */
        .filters-card {
            background: var(--bg-card);
            padding: 20px;
            border-radius: 16px;
            margin-bottom: 24px;
            box-shadow: 0 4px 20px var(--shadow);
            border: 2px solid #f9a8d4;
        }

        .filters-card h3 {
            color: var(--text-primary);
            margin-bottom: 16px;
            font-size: 16px;
            font-weight: 700;
            border-bottom: 2px solid var(--accent-pink);
            padding-bottom: 8px;
        }

        .filters-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 16px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .filter-group label {
            font-size: 12px;
            color: var(--text-secondary);
            font-weight: 600;
            text-transform: uppercase;
        }

        .filter-group select,
        .filter-group input {
            padding: 10px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 14px;
            background: var(--bg-card);
            color: var(--text-primary);
            transition: all 0.3s;
        }

        .filter-group select:focus,
        .filter-group input:focus {
            border-color: var(--accent-pink);
            outline: none;
        }

        .selected-info {
            background: #fce4ec;
            padding: 12px 16px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 12px;
            margin-top: 16px;
        }

        [data-theme="dark"] .selected-info {
            background: #4b1f3b;
        }

        .selected-info span {
            font-size: 13px;
        }

        .selected-info .highlight {
            background: var(--accent-pink);
            color: white;
            padding: 4px 12px;
            border-radius: 6px;
            font-weight: 600;
        }

        /* Buttons */
        .btn-group {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            margin-top: 16px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--accent-pink), var(--accent-rose));
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(236, 72, 153, 0.3);
        }

        .btn-secondary {
            background: var(--bg-card);
            color: var(--text-primary);
            border: 2px solid var(--border-color);
        }

        .btn-secondary:hover {
            background: #f3f4f6;
        }

        [data-theme="dark"] .btn-secondary:hover {
            background: #374151;
        }

        /* Loading Spinner */
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border-left-color: var(--accent-pink);
            animation: spin 1s ease infinite;
            margin: 40px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Cards */
        .card {
            background: var(--bg-card);
            border-radius: 16px;
            box-shadow: 0 4px 20px var(--shadow);
            overflow: hidden;
            margin-bottom: 24px;
            border: 2px solid #f9a8d4;
        }

        .card-header {
            background: linear-gradient(135deg, var(--accent-pink), var(--accent-rose));
            padding: 20px 24px;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .card-header h2 {
            font-size: 18px;
            font-weight: 700;
        }

        .card-header p {
            font-size: 13px;
            opacity: 0.9;
        }

        /* Table */
        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        th, td {
            padding: 12px;
            text-align: center;
            border: 2px solid var(--border-color);
        }

        th {
            background: #f3f4f6;
            font-weight: 700;
            color: #374151;
        }

        [data-theme="dark"] th {
            background: #374151;
            color: #f3f4f6;
        }

        th:first-child, td:first-child {
            text-align: left;
        }

        tbody tr:hover {
            background: #f9fafb;
        }

        [data-theme="dark"] tbody tr:hover {
            background: #374151;
        }

        /* Color Coding */
        .cell-green {
            background-color: #10b981 !important;
            color: white !important;
            font-weight: 700;
        }

        .cell-yellow {
            background-color: #fbbf24 !important;
            color: #111827 !important;
            font-weight: 700;
        }

        .cell-red {
            background-color: #ef4444 !important;
            color: white !important;
            font-weight: 700;
        }

        /* Analysis Section */
        .analysis-section {
            background: #fef3c7;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 24px;
            border: 2px solid #fbbf24;
        }

        [data-theme="dark"] .analysis-section {
            background: #451a03;
            border-color: #92400e;
        }

        .analysis-section h3 {
            color: #92400e;
            font-size: 16px;
            margin-bottom: 12px;
        }

        [data-theme="dark"] .analysis-section h3 {
            color: #fbbf24;
        }

        .formula {
            background: white;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 10px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            border-left: 4px solid #fbbf24;
        }

        [data-theme="dark"] .formula {
            background: #1f2937;
            color: #f3f4f6;
        }

        .editable-formula {
            position: relative;
            transition: all 0.2s ease;
        }

        .editable-formula:hover {
            border-left-color: #f97316;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .formula-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }

        .formula-content {
            line-height: 1.6;
        }

        .formula-edit {
            margin-top: 12px;
            padding: 12px;
            background: #f9fafb;
            border-radius: 6px;
            border: 1px solid #e5e7eb;
        }

        [data-theme="dark"] .formula-edit {
            background: #111827;
            border-color: #374151;
        }

        .formula-edit label {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
            margin-right: 4px;
        }

        .formula-edit input[type="text"],
        .formula-edit input[type="number"] {
            padding: 6px 8px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
        }

        [data-theme="dark"] .formula-edit input {
            background: #1f2937;
            border-color: #4b5563;
            color: #f3f4f6;
        }

        .btn-edit {
            background: #f97316;
            color: white;
            border: none;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-edit:hover {
            background: #ea580c;
            transform: translateY(-1px);
        }

        .formula-edit.hidden {
            display: none;
        }

        .editable-formula.editing {
            border-left-color: #10b981;
            background: #f0fdf4;
        }

        [data-theme="dark"] .editable-formula.editing {
            background: #064e3b;
        }

        .adjustment-inputs {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
            margin-top: 16px;
        }

        /* League Table */
        .league-section {
            margin-top: 24px;
        }

        .league-controls {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }

        .hidden {
            display: none !important;
        }

        /* Search Dropdown */
        .search-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--bg-card);
            border: 2px solid var(--accent-pink);
            border-top: none;
            border-radius: 0 0 8px 8px;
            max-height: 400px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
            box-shadow: 0 8px 20px var(--shadow);
        }

        .search-dropdown.show {
            display: block;
        }

        .search-result-item {
            padding: 12px 16px;
            cursor: pointer;
            transition: background 0.2s;
            border-bottom: 1px solid var(--border-color);
        }

        .search-result-item:hover {
            background: #fce4ec;
        }

        [data-theme="dark"] .search-result-item:hover {
            background: #4b1f3b;
        }

        .search-result-item:last-child {
            border-bottom: none;
        }

        .search-result-name {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .search-result-path {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .search-no-results {
            padding: 20px;
            text-align: center;
            color: var(--text-secondary);
        }

        .search-loading {
            padding: 20px;
            text-align: center;
            color: var(--accent-pink);
        }

        /* Legend */
        .legend {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 2px 8px var(--shadow);
            margin-top: 24px;
            border: 2px solid var(--border-color);
        }

        .legend-content {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 16px;
            font-size: 14px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .legend-box {
            width: 24px;
            height: 24px;
            border-radius: 4px;
        }

        /* Charts */
        .chart-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 24px;
            margin-top: 24px;
        }

        .chart-card {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 8px 24px var(--shadow);
            border: 3px solid #ec4899;
            transition: all 0.3s ease;
        }
        
        .chart-card:hover {
            box-shadow: 0 12px 32px rgba(236, 72, 153, 0.3);
            border-color: #db2777;
        }

        .chart-card h3 {
            font-size: 16px;
            font-weight: 700;
            margin-bottom: 16px;
        }

        .chart-container {
            position: relative;
            height: 300px;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .chart-grid {
                grid-template-columns: 1fr;
            }
            .filters-row {
                grid-template-columns: 1fr;
            }
        }

        /* Modal Styles */
        .modal-overlay {
            display: none !important;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 9999;
            justify-content: center;
            align-items: center;
        }

        .modal-overlay.show {
            display: flex !important;
        }

        .modal-content {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 32px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalSlideIn {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .modal-header h2 {
            margin: 0;
            font-size: 24px;
            color: var(--accent-pink);
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: var(--text-secondary);
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.2s;
        }

        .modal-close:hover {
            background: rgba(236, 72, 153, 0.1);
            color: var(--accent-pink);
        }

        .modal-body {
            margin-bottom: 24px;
        }

        .modal-body p {
            margin-bottom: 16px;
            color: var(--text-secondary);
            line-height: 1.6;
        }

        .modal-input-group {
            margin-bottom: 16px;
        }

        .modal-input-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text-primary);
        }

        .modal-input-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.2s;
        }

        .modal-input-group input:focus {
            outline: none;
            border-color: var(--accent-pink);
        }

        .modal-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        .modal-actions .btn {
            padding: 12px 24px;
        }
    </style>
</head>
<body data-theme="light">
    <!-- Population Input Modal -->
    <div id="populationModal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üè• Facility Information Required</h2>
                <button class="modal-close" onclick="closePopulationModal()">√ó</button>
            </div>
            <div class="modal-body">
                <p><strong>Facility selected:</strong> <span id="modalFacilityName">-</span></p>
                <p>Please enter the <strong>annual catchment population</strong> and select the reporting period.</p>
                
                <div class="modal-input-group">
                    <label for="modalPopulationInput">Annual Catchment Population *</label>
                    <input 
                        type="number" 
                        id="modalPopulationInput" 
                        placeholder="Enter annual population (e.g., 15000)" 
                        min="1"
                        step="1"
                    >
                </div>
                
                <div style="border-top: 1px solid #e5e7eb; margin: 20px 0; padding-top: 20px;">
                    <p style="font-weight: 600; margin-bottom: 12px;">üìÖ Select Reporting Period</p>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                        <div class="modal-input-group">
                            <label for="modalStartDate">Start Month *</label>
                            <input type="month" id="modalStartDate" required>
                        </div>
                        <div class="modal-input-group">
                            <label for="modalEndDate">End Month *</label>
                            <input type="month" id="modalEndDate" required>
                        </div>
                    </div>
                    <p style="font-size: 12px; color: var(--text-secondary); margin-top: 8px;">
                        üìä <strong>Period Calculation:</strong> ANC Catchment = (Annual Population √∑ 12) √ó Months Selected √ó 5%
                    </p>
                </div>
                
                <div id="modalCalculationPreview" style="background: #f0fdf4; padding: 12px; border-radius: 8px; margin-top: 16px; display: none;">
                    <p style="margin: 0; font-size: 14px; color: #166534;">
                        <strong>Preview:</strong><br>
                        <span id="modalPreviewText">-</span>
                    </p>
                </div>
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closePopulationModal()">Cancel</button>
                <button class="btn btn-primary" onclick="submitPopulationModal()">Apply & Continue</button>
            </div>
        </div>
    </div>

    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <div class="header-left">
                <button class="back-btn" onclick="window.location.href='/'">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M19 12H5M12 19l-7-7 7-7"/>
                    </svg>
                </button>
                <div class="logo">üíó</div>
                <div class="title-container">
                    <h1>Maternal Health Analytics - ANC</h1>
                    <p>Antenatal Care Indicators</p>
                </div>
            </div>
            <button class="theme-toggle" onclick="toggleTheme()">
                <svg id="theme-icon-sun" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="hidden">
                    <circle cx="12" cy="12" r="5"/><path d="M12 1v2m0 18v2M4.22 4.22l1.42 1.42m12.72 12.72 1.42 1.42M1 12h2m18 0h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/>
                </svg>
                <svg id="theme-icon-moon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                </svg>
            </button>
        </div>
    </header>

    <!-- Tab Navigation -->
    <nav class="tab-nav">
        <div class="tab-nav-content">
            <button class="tab-btn active" onclick="switchTab('data')">
                üìä Data View
            </button>
            <button class="tab-btn" onclick="switchTab('analysis')">
                üî¨ Show Analysis
            </button>
            <button class="tab-btn" onclick="switchTab('league')">
                üèÜ League Table
            </button>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="container">
        <!-- Filters -->
        <div class="filters-card">
            <h3>üéØ Data Filters & Selection</h3>
            
            <!-- Search Organization Unit -->
            <div class="filter-group" style="margin-bottom: 20px; position: relative;">
                <label for="orgUnitSearch">üîç Quick Search for Facility or District</label>
                <input type="text" 
                       id="orgUnitSearch" 
                       placeholder="Type facility or district name (min 3 characters)..." 
                       style="padding: 12px; width: 100%; border: 2px solid var(--border-color); border-radius: 8px; font-size: 14px;"
                       oninput="handleSearchInput(event)"
                       onfocus="showSearchDropdown()"
                       autocomplete="off">
                <div id="searchDropdown" class="search-dropdown">
                    <!-- Search results will appear here -->
                </div>
            </div>

            <!-- OR Separator -->
            <div style="text-align: center; margin: 20px 0; color: var(--text-secondary); font-weight: 600;">
                ‚Äî OR Navigate Hierarchy ‚Äî
            </div>

            <!-- Hierarchical Selection -->
            <div class="filters-row">
                <div class="filter-group">
                    <label for="level2">Region</label>
                    <select id="level2" onchange="loadChildren(2)">
                        <option value="">Loading...</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="level3">District</label>
                    <select id="level3" onchange="loadChildren(3)" disabled>
                        <option>--</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="level5">Sub-county</label>
                    <select id="level5" onchange="loadChildren(5)" disabled>
                        <option>--</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="level6">Facility</label>
                    <select id="level6" onchange="selectFinalLevel(6)" disabled>
                        <option>--</option>
                    </select>
                </div>
            </div>

            <!-- Period and Population -->
            <div class="filters-row" style="margin-top: 20px;">
                <div class="filter-group">
                    <label for="periodSelect">Period</label>
                    <select id="periodSelect">
                        <option value="">-- Select Period --</option>
                        <option value="LAST_12_MONTHS">Last 12 Months</option>
                        <option value="LAST_6_MONTHS">Last 6 Months</option>
                        <option value="LAST_3_MONTHS">Last 3 Months</option>
                        <option value="THIS_YEAR">This Year</option>
                        <option value="LAST_YEAR">Last Year</option>
                        <option value="CUSTOM">Custom Range</option>
                    </select>
                </div>
                <div class="filter-group" id="startDateGroup" style="display: none;">
                    <label for="startDateInput">Start Month</label>
                    <input type="month" id="startDateInput" onchange="recalculatePeriodCatchment()">
                </div>
                <div class="filter-group" id="endDateGroup" style="display: none;">
                    <label for="endDateInput">End Month</label>
                    <input type="month" id="endDateInput" onchange="recalculatePeriodCatchment()">
                </div>
                <div class="filter-group" id="populationInputGroup" style="display: none;">
                    <label for="populationInput">Annual Population</label>
                    <input type="number" id="populationInput" placeholder="Annual catchment population" min="0" onchange="recalculatePeriodCatchment()">
                </div>
            </div>

            <div class="selected-info">
                <span>Selected: <span class="highlight" id="selectedOrgUnit">None</span></span>
                <span>Period: <span class="highlight" id="selectedPeriod">Last 12 Months</span></span>
                <span>ANC Catchment (5%): <span class="highlight" id="ancCatchment">-</span></span>
            </div>
            <div class="btn-group">
                <button class="btn btn-primary" onclick="fetchData()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/>
                    </svg>
                    Load Data
                </button>
                <button class="btn btn-secondary" onclick="clearCache()">Clear Cache</button>
                <button class="btn btn-secondary" onclick="downloadExcel()">
                    üìä Download Excel
                </button>
            </div>
        </div>

        <div id="loadingSpinner" class="spinner hidden"></div>

        <!-- Data View Tab -->
        <div id="data-tab" class="tab-content">
            <div id="dataDisplay" class="hidden">
                <!-- ANC Indicators Table -->
                <div class="card">
                    <div class="card-header">
                        <div>
                            <h2>ANC Indicators Performance</h2>
                            <p>Coverage and quality metrics for antenatal care</p>
                        </div>
                    </div>
                    <div class="table-container">
                        <table id="ancTable">
                            <thead>
                                <tr>
                                    <th>Indicator</th>
                                    <th>Value</th>
                                    <th>Target Pop.</th>
                                    <th>Coverage/Rate (%)</th>
                                    <th>Target (%)</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="ancTableBody">
                                <!-- Data will be inserted here -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Charts -->
                <div class="chart-grid">
                    <div class="chart-card" id="coverageChartCard">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                            <h3 style="margin: 0;">ANC Coverage Trends</h3>
                            <button class="btn btn-secondary" onclick="downloadChartAsJPG('coverageChartCard', 'ANC_Coverage_Trends')" style="padding: 6px 12px; font-size: 12px;">
                                üì∑ Download JPG
                            </button>
                        </div>
                        <div class="chart-container">
                            <canvas id="coverageChart"></canvas>
                        </div>
                        <div id="coverageLegend" style="display: flex; justify-content: center; gap: 16px; margin-top: 12px; flex-wrap: wrap;"></div>
                    </div>
                    <div class="chart-card" id="qualityChartCard">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                            <h3 style="margin: 0;">Quality Indicators</h3>
                            <button class="btn btn-secondary" onclick="downloadChartAsJPG('qualityChartCard', 'Quality_Indicators')" style="padding: 6px 12px; font-size: 12px;">
                                üì∑ Download JPG
                            </button>
                        </div>
                        <div class="chart-container">
                            <canvas id="qualityChart"></canvas>
                        </div>
                        <div id="qualityLegend" style="display: flex; justify-content: center; gap: 16px; margin-top: 12px; flex-wrap: wrap;"></div>
                    </div>
                </div>
            </div>

            <!-- Intrapartum Section -->
            <div id="intrapartumSection" class="card" style="margin-top: 24px; display: none;">
                <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <h2 style="margin: 0;">üè• Intrapartum Indicators</h2>
                        <p style="margin: 4px 0 0 0; color: var(--text-secondary); font-size: 13px;">
                            Deliveries Catchment (4.85%): <span id="deliveriesCatchment">--</span>
                        </p>
                    </div>
                    <div style="display: flex; gap: 8px;">
                        <button class="btn btn-secondary" onclick="downloadIntrapartumExcel()">üìä Excel</button>
                        <button class="btn btn-secondary" onclick="downloadIntrapartumJPG()">üì∑ JPG</button>
                    </div>
                </div>
                <div style="padding: 20px;">
                    <table id="intrapartumTable" class="data-table" style="width: 100%;">
                        <thead>
                            <tr>
                                <th style="text-align: left;">Indicator</th>
                                <th style="text-align: right;">Data element</th>
                                <th style="text-align: right;">Target</th>
                                <th style="text-align: right;">Performance</th>
                            </tr>
                        </thead>
                        <tbody id="intrapartumTableBody">
                            <tr>
                                <td colspan="5" style="text-align: center; padding: 40px; color: var(--text-secondary);">
                                    üìä Intrapartum data will appear after loading ANC data
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Analysis Tab -->
        <div id="analysis-tab" class="tab-content hidden">
            <div class="analysis-section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                    <h3>üìê Calculation Formulas & Analysis</h3>
                    <button class="btn btn-secondary" onclick="resetCustomizations()" style="font-size: 13px; padding: 6px 12px;">
                        üîÑ Reset All to Defaults
                    </button>
                </div>
                
                <!-- ANC Catchment -->
                <div class="formula editable-formula" data-indicator="anc_catchment">
                    <div class="formula-header">
                        <strong>ANC Catchment:</strong>
                        <button class="btn-edit" onclick="editFormula('anc_catchment')">‚úèÔ∏è Edit</button>
                    </div>
                    <div class="formula-content" id="formula-anc_catchment">
                        = (5% √ó UBOS Population) for Districts<br>
                        = (5% √ó Catchment Population) for Facilities
                    </div>
                    <div class="formula-edit hidden" id="edit-anc_catchment">
                        <label>Catchment Percentage:</label>
                        <input type="number" step="0.1" value="5" id="input-anc_catchment" style="width: 100px;">%
                        <button class="btn btn-primary" onclick="saveFormula('anc_catchment')" style="margin-left: 8px;">üíæ Save</button>
                        <button class="btn btn-secondary" onclick="cancelEdit('anc_catchment')" style="margin-left: 4px;">‚ùå Cancel</button>
                    </div>
                </div>

                <!-- ANC 1 Coverage -->
                <div class="formula editable-formula" data-indicator="anc1">
                    <div class="formula-header">
                        <strong>ANC 1 Coverage:</strong>
                        <button class="btn-edit" onclick="editFormula('anc1')">‚úèÔ∏è Edit</button>
                    </div>
                    <div class="formula-content" id="formula-anc1">
                        = (105-AN01a. ANC 1st Visit / ANC Catchment) √ó 100
                    </div>
                    <div class="formula-edit hidden" id="edit-anc1">
                        <label>Custom Formula:</label>
                        <input type="text" value="(105-AN01a. ANC 1st Visit / ANC Catchment) √ó 100" id="input-anc1" style="width: 100%;">
                        <button class="btn btn-primary" onclick="saveFormula('anc1')" style="margin-top: 8px;">üíæ Save</button>
                        <button class="btn btn-secondary" onclick="cancelEdit('anc1')" style="margin-left: 4px;">‚ùå Cancel</button>
                    </div>
                </div>

                <!-- ANC 1st Trimester -->
                <div class="formula editable-formula" data-indicator="anc1_trimester">
                    <div class="formula-header">
                        <strong>ANC 1st Trimester:</strong>
                        <button class="btn-edit" onclick="editFormula('anc1_trimester')">‚úèÔ∏è Edit</button>
                    </div>
                    <div class="formula-content" id="formula-anc1_trimester">
                        = (105-AN01b. 1st Trimester Visits / 105-AN01a. ANC 1st Visit) √ó 100
                    </div>
                    <div class="formula-edit hidden" id="edit-anc1_trimester">
                        <label>Custom Formula:</label>
                        <input type="text" value="(105-AN01b. 1st Trimester Visits / 105-AN01a. ANC 1st Visit) √ó 100" id="input-anc1_trimester" style="width: 100%;">
                        <button class="btn btn-primary" onclick="saveFormula('anc1_trimester')" style="margin-top: 8px;">üíæ Save</button>
                        <button class="btn btn-secondary" onclick="cancelEdit('anc1_trimester')" style="margin-left: 4px;">‚ùå Cancel</button>
                    </div>
                </div>

                <!-- ANC 4 Coverage -->
                <div class="formula editable-formula" data-indicator="anc4">
                    <div class="formula-header">
                        <strong>ANC 4 Coverage:</strong>
                        <button class="btn-edit" onclick="editFormula('anc4')">‚úèÔ∏è Edit</button>
                    </div>
                    <div class="formula-content" id="formula-anc4">
                        = (105-AN02. ANC 4th Visit / ANC Catchment) √ó 100
                    </div>
                    <div class="formula-edit hidden" id="edit-anc4">
                        <label>Custom Formula:</label>
                        <input type="text" value="(105-AN02. ANC 4th Visit / ANC Catchment) √ó 100" id="input-anc4" style="width: 100%;">
                        <button class="btn btn-primary" onclick="saveFormula('anc4')" style="margin-top: 8px;">üíæ Save</button>
                        <button class="btn btn-secondary" onclick="cancelEdit('anc4')" style="margin-left: 4px;">‚ùå Cancel</button>
                    </div>
                </div>

                <!-- ANC 8 Coverage -->
                <div class="formula editable-formula" data-indicator="anc8">
                    <div class="formula-header">
                        <strong>ANC 8 Coverage:</strong>
                        <button class="btn-edit" onclick="editFormula('anc8')">‚úèÔ∏è Edit</button>
                    </div>
                    <div class="formula-content" id="formula-anc8">
                        = (105-AN03. ANC 8 Visits / ANC Catchment) √ó 100
                    </div>
                    <div class="formula-edit hidden" id="edit-anc8">
                        <label>Custom Formula:</label>
                        <input type="text" value="(105-AN03. ANC 8 Visits / ANC Catchment) √ó 100" id="input-anc8" style="width: 100%;">
                        <button class="btn btn-primary" onclick="saveFormula('anc8')" style="margin-top: 8px;">üíæ Save</button>
                        <button class="btn btn-secondary" onclick="cancelEdit('anc8')" style="margin-left: 4px;">‚ùå Cancel</button>
                    </div>
                </div>

                <!-- IPT3 Coverage -->
                <div class="formula editable-formula" data-indicator="ipt3">
                    <div class="formula-header">
                        <strong>IPT3 Coverage:</strong>
                        <button class="btn-edit" onclick="editFormula('ipt3')">‚úèÔ∏è Edit</button>
                    </div>
                    <div class="formula-content" id="formula-ipt3">
                        = (105-AN06c. IPT3 Recipients / ANC Catchment) √ó 100
                    </div>
                    <div class="formula-edit hidden" id="edit-ipt3">
                        <label>Custom Formula:</label>
                        <input type="text" value="(105-AN06c. IPT3 Recipients / ANC Catchment) √ó 100" id="input-ipt3" style="width: 100%;">
                        <button class="btn btn-primary" onclick="saveFormula('ipt3')" style="margin-top: 8px;">üíæ Save</button>
                        <button class="btn btn-secondary" onclick="cancelEdit('ipt3')" style="margin-left: 4px;">‚ùå Cancel</button>
                    </div>
                </div>

                <!-- Hb Testing -->
                <div class="formula editable-formula" data-indicator="hb_testing">
                    <div class="formula-header">
                        <strong>Hb Testing at 1st Contact:</strong>
                        <button class="btn-edit" onclick="editFormula('hb_testing')">‚úèÔ∏è Edit</button>
                    </div>
                    <div class="formula-content" id="formula-hb_testing">
                        = (105-AN08. Hb Test / 105-AN01a. ANC 1st Visit) √ó 100
                    </div>
                    <div class="formula-edit hidden" id="edit-hb_testing">
                        <label>Custom Formula:</label>
                        <input type="text" value="(105-AN08. Hb Test / 105-AN01a. ANC 1st Visit) √ó 100" id="input-hb_testing" style="width: 100%;">
                        <button class="btn btn-primary" onclick="saveFormula('hb_testing')" style="margin-top: 8px;">üíæ Save</button>
                        <button class="btn btn-secondary" onclick="cancelEdit('hb_testing')" style="margin-left: 4px;">‚ùå Cancel</button>
                    </div>
                </div>

                <!-- LLIN -->
                <div class="formula editable-formula" data-indicator="llin">
                    <div class="formula-header">
                        <strong>LLIN at ANC 1:</strong>
                        <button class="btn-edit" onclick="editFormula('llin')">‚úèÔ∏è Edit</button>
                    </div>
                    <div class="formula-content" id="formula-llin">
                        = (105-AN11. LLIN Given / 105-AN01a. ANC 1st Visit) √ó 100
                    </div>
                    <div class="formula-edit hidden" id="edit-llin">
                        <label>Custom Formula:</label>
                        <input type="text" value="(105-AN11. LLIN Given / 105-AN01a. ANC 1st Visit) √ó 100" id="input-llin" style="width: 100%;">
                        <button class="btn btn-primary" onclick="saveFormula('llin')" style="margin-top: 8px;">üíæ Save</button>
                        <button class="btn btn-secondary" onclick="cancelEdit('llin')" style="margin-left: 4px;">‚ùå Cancel</button>
                    </div>
                </div>

                <!-- Teenage Pregnancies -->
                <div class="formula editable-formula" data-indicator="teenage">
                    <div class="formula-header">
                        <strong>Teenage Pregnancies:</strong>
                        <button class="btn-edit" onclick="editFormula('teenage')">‚úèÔ∏è Edit</button>
                    </div>
                    <div class="formula-content" id="formula-teenage">
                        = ((ANC &lt;15yrs + ANC 15-19yrs) / Total ANC 1st Visit) √ó 100
                    </div>
                    <div class="formula-edit hidden" id="edit-teenage">
                        <label>Custom Formula:</label>
                        <input type="text" value="((ANC <15yrs + ANC 15-19yrs) / Total ANC 1st Visit) √ó 100" id="input-teenage" style="width: 100%;">
                        <button class="btn btn-primary" onclick="saveFormula('teenage')" style="margin-top: 8px;">üíæ Save</button>
                        <button class="btn btn-secondary" onclick="cancelEdit('teenage')" style="margin-left: 4px;">‚ùå Cancel</button>
                    </div>
                </div>

                <!-- Iron/Folic Acid -->
                <div class="formula editable-formula" data-indicator="iron_folic">
                    <div class="formula-header">
                        <strong>Iron/Folic Acid:</strong>
                        <button class="btn-edit" onclick="editFormula('iron_folic')">‚úèÔ∏è Edit</button>
                    </div>
                    <div class="formula-content" id="formula-iron_folic">
                        = (105-AN21_2019. IFA 30+ tablets / 105-AN01a. ANC 1st Visit) √ó 100
                    </div>
                    <div class="formula-edit hidden" id="edit-iron_folic">
                        <label>Custom Formula:</label>
                        <input type="text" value="(105-AN21_2019. IFA 30+ tablets / 105-AN01a. ANC 1st Visit) √ó 100" id="input-iron_folic" style="width: 100%;">
                        <button class="btn btn-primary" onclick="saveFormula('iron_folic')" style="margin-top: 8px;">üíæ Save</button>
                        <button class="btn btn-secondary" onclick="cancelEdit('iron_folic')" style="margin-left: 4px;">‚ùå Cancel</button>
                    </div>
                </div>

                <!-- ==================== INTRAPARTUM FORMULAS ==================== -->
                <h3 style="margin-top: 32px; margin-bottom: 16px; border-bottom: 2px solid #6366f1; padding-bottom: 8px;">üè• Intrapartum Formulas</h3>

                <!-- Deliveries Catchment -->
                <div class="formula" style="border-left-color: #6366f1;">
                    <div class="formula-header">
                        <strong>Deliveries Catchment:</strong>
                    </div>
                    <div class="formula-content">
                        = (4.85% √ó UBOS Population) for Districts<br>
                        = (4.85% √ó Catchment Population) for Facilities
                    </div>
                </div>

                <!-- Deliveries Coverage -->
                <div class="formula" style="border-left-color: #6366f1;">
                    <div class="formula-header">
                        <strong>Deliveries Coverage:</strong>
                    </div>
                    <div class="formula-content">
                        = (105-MA04. Total deliveries / Deliveries Catchment) √ó 100
                    </div>
                </div>

                <!-- Low Birth Weight -->
                <div class="formula" style="border-left-color: #6366f1;">
                    <div class="formula-header">
                        <strong>% Low Birth Weight:</strong>
                    </div>
                    <div class="formula-content">
                        = (105-MA05a2. Live births &lt;2.5 Kg / 105-MA05a1. Live births Total) √ó 100
                    </div>
                </div>

                <!-- KMC Initiated -->
                <div class="formula" style="border-left-color: #6366f1;">
                    <div class="formula-header">
                        <strong>% LBW Initiated on KMC:</strong>
                    </div>
                    <div class="formula-content">
                        = (105-MA08. LBW babies on KMC / 105-MA05a2. Live births &lt;2.5 Kg) √ó 100
                    </div>
                </div>

                <!-- Birth Asphyxia -->
                <div class="formula" style="border-left-color: #6366f1;">
                    <div class="formula-header">
                        <strong>Birth Asphyxia Rate:</strong>
                    </div>
                    <div class="formula-content">
                        = (105-MA23. Babies with Birth Asphyxia / 105-MA04. Total deliveries) √ó 100
                    </div>
                </div>

                <!-- Resuscitation Rate -->
                <div class="formula" style="border-left-color: #6366f1;">
                    <div class="formula-header">
                        <strong>Asphyxia Resuscitation Rate:</strong>
                    </div>
                    <div class="formula-content">
                        = (105-MA24. Successfully Resuscitated / 105-MA23. Babies with Asphyxia) √ó 100
                    </div>
                </div>

                <!-- Fresh Still Births -->
                <div class="formula" style="border-left-color: #6366f1;">
                    <div class="formula-header">
                        <strong>Fresh Still Births (per 1,000):</strong>
                    </div>
                    <div class="formula-content">
                        = (105-MA05b1. Fresh Still births / 105-MA04. Total deliveries) √ó 1,000
                    </div>
                </div>

                <!-- Neonatal Mortality -->
                <div class="formula" style="border-left-color: #6366f1;">
                    <div class="formula-header">
                        <strong>Neonatal Mortality Rate (per 1,000):</strong>
                    </div>
                    <div class="formula-content">
                        = ((105-MA12. Deaths 0-7 days + Deaths 8-28 days) / 105-MA05a1. Live births) √ó 1,000
                    </div>
                </div>

                <!-- Perinatal Mortality -->
                <div class="formula" style="border-left-color: #6366f1;">
                    <div class="formula-header">
                        <strong>Perinatal Mortality Rate (per 1,000):</strong>
                    </div>
                    <div class="formula-content">
                        = ((Fresh Still births + Deaths 0-7 days + Macerated Still births) / Live births) √ó 1,000
                    </div>
                </div>

                <!-- Maternal Mortality -->
                <div class="formula" style="border-left-color: #6366f1;">
                    <div class="formula-header">
                        <strong>Maternal Mortality Ratio (per 100,000):</strong>
                    </div>
                    <div class="formula-content">
                        = (105-MA13. Maternal deaths / 105-MA05a1. Live births) √ó 100,000
                    </div>
                </div>

                <h3 style="margin-top: 32px; margin-bottom: 16px;">üé® Color Coding Targets</h3>
                
                <!-- ANC 1 Targets -->
                <div class="formula editable-formula" data-indicator="target_anc1">
                    <div class="formula-header">
                        <strong>ANC 1:</strong>
                        <button class="btn-edit" onclick="editTarget('anc1')">‚úèÔ∏è Edit</button>
                    </div>
                    <div class="formula-content" id="target-anc1">
                        Green ‚â•100% | Yellow 80-99.9% | Red &lt;80%
                    </div>
                    <div class="formula-edit hidden" id="edit-target-anc1">
                        <label>Green ‚â•</label> <input type="number" step="0.1" value="100" id="green-anc1" style="width: 80px;">%
                        <label style="margin-left: 12px;">Yellow ‚â•</label> <input type="number" step="0.1" value="80" id="yellow-anc1" style="width: 80px;">%
                        <button class="btn btn-primary" onclick="saveTarget('anc1')" style="margin-left: 8px;">üíæ Save</button>
                        <button class="btn btn-secondary" onclick="cancelEditTarget('anc1')" style="margin-left: 4px;">‚ùå Cancel</button>
                    </div>
                </div>

                <!-- ANC 1st Trimester Targets -->
                <div class="formula editable-formula" data-indicator="target_anc1_trimester">
                    <div class="formula-header">
                        <strong>ANC 1st Trimester:</strong>
                        <button class="btn-edit" onclick="editTarget('anc1_trimester')">‚úèÔ∏è Edit</button>
                    </div>
                    <div class="formula-content" id="target-anc1_trimester">
                        Green ‚â•45% | Yellow 30-44.9% | Red &lt;30%
                    </div>
                    <div class="formula-edit hidden" id="edit-target-anc1_trimester">
                        <label>Green ‚â•</label> <input type="number" step="0.1" value="45" id="green-anc1_trimester" style="width: 80px;">%
                        <label style="margin-left: 12px;">Yellow ‚â•</label> <input type="number" step="0.1" value="30" id="yellow-anc1_trimester" style="width: 80px;">%
                        <button class="btn btn-primary" onclick="saveTarget('anc1_trimester')" style="margin-left: 8px;">üíæ Save</button>
                        <button class="btn btn-secondary" onclick="cancelEditTarget('anc1_trimester')" style="margin-left: 4px;">‚ùå Cancel</button>
                    </div>
                </div>

                <!-- ANC 4 Targets -->
                <div class="formula editable-formula" data-indicator="target_anc4">
                    <div class="formula-header">
                        <strong>ANC 4:</strong>
                        <button class="btn-edit" onclick="editTarget('anc4')">‚úèÔ∏è Edit</button>
                    </div>
                    <div class="formula-content" id="target-anc4">
                        Green ‚â•75% | Yellow 50-74.9% | Red &lt;50%
                    </div>
                    <div class="formula-edit hidden" id="edit-target-anc4">
                        <label>Green ‚â•</label> <input type="number" step="0.1" value="75" id="green-anc4" style="width: 80px;">%
                        <label style="margin-left: 12px;">Yellow ‚â•</label> <input type="number" step="0.1" value="50" id="yellow-anc4" style="width: 80px;">%
                        <button class="btn btn-primary" onclick="saveTarget('anc4')" style="margin-left: 8px;">üíæ Save</button>
                        <button class="btn btn-secondary" onclick="cancelEditTarget('anc4')" style="margin-left: 4px;">‚ùå Cancel</button>
                    </div>
                </div>

                <!-- ANC 8 Targets -->
                <div class="formula editable-formula" data-indicator="target_anc8">
                    <div class="formula-header">
                        <strong>ANC 8:</strong>
                        <button class="btn-edit" onclick="editTarget('anc8')">‚úèÔ∏è Edit</button>
                    </div>
                    <div class="formula-content" id="target-anc8">
                        Green ‚â•20% | Yellow 10-19.9% | Red &lt;10%
                    </div>
                    <div class="formula-edit hidden" id="edit-target-anc8">
                        <label>Green ‚â•</label> <input type="number" step="0.1" value="20" id="green-anc8" style="width: 80px;">%
                        <label style="margin-left: 12px;">Yellow ‚â•</label> <input type="number" step="0.1" value="10" id="yellow-anc8" style="width: 80px;">%
                        <button class="btn btn-primary" onclick="saveTarget('anc8')" style="margin-left: 8px;">üíæ Save</button>
                        <button class="btn btn-secondary" onclick="cancelEditTarget('anc8')" style="margin-left: 4px;">‚ùå Cancel</button>
                    </div>
                </div>

                <!-- IPT3 Targets -->
                <div class="formula editable-formula" data-indicator="target_ipt3">
                    <div class="formula-header">
                        <strong>IPT3:</strong>
                        <button class="btn-edit" onclick="editTarget('ipt3')">‚úèÔ∏è Edit</button>
                    </div>
                    <div class="formula-content" id="target-ipt3">
                        Green ‚â•80% | Yellow 60-79.9% | Red &lt;60%
                    </div>
                    <div class="formula-edit hidden" id="edit-target-ipt3">
                        <label>Green ‚â•</label> <input type="number" step="0.1" value="80" id="green-ipt3" style="width: 80px;">%
                        <label style="margin-left: 12px;">Yellow ‚â•</label> <input type="number" step="0.1" value="60" id="yellow-ipt3" style="width: 80px;">%
                        <button class="btn btn-primary" onclick="saveTarget('ipt3')" style="margin-left: 8px;">üíæ Save</button>
                        <button class="btn btn-secondary" onclick="cancelEditTarget('ipt3')" style="margin-left: 4px;">‚ùå Cancel</button>
                    </div>
                </div>

                <!-- Hb Testing & Iron/Folic Targets -->
                <div class="formula editable-formula" data-indicator="target_hb_iron">
                    <div class="formula-header">
                        <strong>Hb Testing & Iron/Folic:</strong>
                        <button class="btn-edit" onclick="editTarget('hb_iron')">‚úèÔ∏è Edit</button>
                    </div>
                    <div class="formula-content" id="target-hb_iron">
                        Green ‚â•75% | Yellow 50-74.9% | Red &lt;50%
                    </div>
                    <div class="formula-edit hidden" id="edit-target-hb_iron">
                        <label>Green ‚â•</label> <input type="number" step="0.1" value="75" id="green-hb_iron" style="width: 80px;">%
                        <label style="margin-left: 12px;">Yellow ‚â•</label> <input type="number" step="0.1" value="50" id="yellow-hb_iron" style="width: 80px;">%
                        <button class="btn btn-primary" onclick="saveTarget('hb_iron')" style="margin-left: 8px;">üíæ Save</button>
                        <button class="btn btn-secondary" onclick="cancelEditTarget('hb_iron')" style="margin-left: 4px;">‚ùå Cancel</button>
                    </div>
                </div>

                <!-- LLIN Targets -->
                <div class="formula editable-formula" data-indicator="target_llin">
                    <div class="formula-header">
                        <strong>LLIN:</strong>
                        <button class="btn-edit" onclick="editTarget('llin')">‚úèÔ∏è Edit</button>
                    </div>
                    <div class="formula-content" id="target-llin">
                        Green ‚â•80% | Yellow 60-79.9% | Red &lt;60%
                    </div>
                    <div class="formula-edit hidden" id="edit-target-llin">
                        <label>Green ‚â•</label> <input type="number" step="0.1" value="80" id="green-llin" style="width: 80px;">%
                        <label style="margin-left: 12px;">Yellow ‚â•</label> <input type="number" step="0.1" value="60" id="yellow-llin" style="width: 80px;">%
                        <button class="btn btn-primary" onclick="saveTarget('llin')" style="margin-left: 8px;">üíæ Save</button>
                        <button class="btn btn-secondary" onclick="cancelEditTarget('llin')" style="margin-left: 4px;">‚ùå Cancel</button>
                    </div>
                </div>

                <!-- Teenage Pregnancies Targets -->
                <div class="formula editable-formula" data-indicator="target_teenage">
                    <div class="formula-header">
                        <strong>Teenage Pregnancies:</strong>
                        <button class="btn-edit" onclick="editTarget('teenage')">‚úèÔ∏è Edit</button>
                    </div>
                    <div class="formula-content" id="target-teenage">
                        Green ‚â§13% | Yellow 13.1-19.9% | Red ‚â•20%
                    </div>
                    <div class="formula-edit hidden" id="edit-target-teenage">
                        <label>Green ‚â§</label> <input type="number" step="0.1" value="13" id="green-teenage" style="width: 80px;">%
                        <label style="margin-left: 12px;">Yellow ‚â§</label> <input type="number" step="0.1" value="19.9" id="yellow-teenage" style="width: 80px;">%
                        <button class="btn btn-primary" onclick="saveTarget('teenage')" style="margin-left: 8px;">üíæ Save</button>
                        <button class="btn btn-secondary" onclick="cancelEditTarget('teenage')" style="margin-left: 4px;">‚ùå Cancel</button>
                    </div>
                </div>

                <!-- ==================== INTRAPARTUM TARGETS ==================== -->
                <h3 style="margin-top: 32px; margin-bottom: 16px; border-bottom: 2px solid #6366f1; padding-bottom: 8px;">üè• Intrapartum Targets</h3>

                <!-- Deliveries Target -->
                <div class="formula" style="border-left-color: #6366f1;">
                    <div class="formula-header">
                        <strong>Deliveries Coverage:</strong>
                    </div>
                    <div class="formula-content">
                        üü¢ Green ‚â•70% | üü° Yellow 50-69.9% | üî¥ Red &lt;50%
                    </div>
                </div>

                <!-- LBW Target -->
                <div class="formula" style="border-left-color: #6366f1;">
                    <div class="formula-header">
                        <strong>Low Birth Weight (lower is better):</strong>
                    </div>
                    <div class="formula-content">
                        üü¢ Green ‚â§5% | üü° Yellow 5.1-10% | üî¥ Red &gt;10%
                    </div>
                </div>

                <!-- KMC Target -->
                <div class="formula" style="border-left-color: #6366f1;">
                    <div class="formula-header">
                        <strong>LBW Initiated on KMC:</strong>
                    </div>
                    <div class="formula-content">
                        üü¢ Green ‚â•90% | üü° Yellow 75-89.9% | üî¥ Red &lt;75%
                    </div>
                </div>

                <!-- Birth Asphyxia Target -->
                <div class="formula" style="border-left-color: #6366f1;">
                    <div class="formula-header">
                        <strong>Birth Asphyxia (lower is better):</strong>
                    </div>
                    <div class="formula-content">
                        üü¢ Green ‚â§1% | üü° Yellow 1.1-5% | üî¥ Red &gt;5%
                    </div>
                </div>

                <!-- Resuscitation Target -->
                <div class="formula" style="border-left-color: #6366f1;">
                    <div class="formula-header">
                        <strong>Asphyxia Resuscitation:</strong>
                    </div>
                    <div class="formula-content">
                        üü¢ Green ‚â•90% | üü° Yellow 70-89.9% | üî¥ Red &lt;70%
                    </div>
                </div>

                <!-- Fresh Still Birth Target -->
                <div class="formula" style="border-left-color: #6366f1;">
                    <div class="formula-header">
                        <strong>Fresh Still Births per 1,000 (lower is better):</strong>
                    </div>
                    <div class="formula-content">
                        üü¢ Green ‚â§5 | üü° Yellow 5.1-10 | üî¥ Red &gt;10
                    </div>
                </div>

                <!-- Neonatal Mortality Target -->
                <div class="formula" style="border-left-color: #6366f1;">
                    <div class="formula-header">
                        <strong>Neonatal Mortality per 1,000 (lower is better):</strong>
                    </div>
                    <div class="formula-content">
                        üü¢ Green ‚â§5 | üü° Yellow 5.1-10 | üî¥ Red &gt;10
                    </div>
                </div>

                <!-- Perinatal Mortality Target -->
                <div class="formula" style="border-left-color: #6366f1;">
                    <div class="formula-header">
                        <strong>Perinatal Mortality per 1,000 (lower is better):</strong>
                    </div>
                    <div class="formula-content">
                        üü¢ Green ‚â§12 | üü° Yellow 12.1-20 | üî¥ Red &gt;20
                    </div>
                </div>

                <!-- Maternal Mortality Target -->
                <div class="formula" style="border-left-color: #6366f1;">
                    <div class="formula-header">
                        <strong>Maternal Mortality per 100,000 (lower is better):</strong>
                    </div>
                    <div class="formula-content">
                        üü¢ Green ‚â§182 | üü° Yellow 182.1-300 | üî¥ Red &gt;300
                    </div>
                </div>
            </div>
        </div>

        <!-- League Table Tab -->
        <div id="league-tab" class="tab-content hidden">
            <div class="league-section">
                <div class="card">
                    <div class="card-header">
                        <div>
                            <h2>üèÜ League Table Comparison</h2>
                            <p>Compare performance across facilities or districts</p>
                        </div>
                    </div>
                    <div style="padding: 20px;">
                        <div class="league-controls">
                            <div class="filter-group" style="flex: 1; min-width: 250px;">
                                <label>Select Multiple Units (Ctrl+Click)</label>
                                <select id="leagueUnitsSelect" multiple size="10" style="height: 200px;">
                                    <option value="">Loading...</option>
                                </select>
                            </div>
                            <div style="flex: 1;">
                                <div class="filter-group">
                                    <label>Period for Comparison</label>
                                    <select id="leaguePeriodSelect">
                                        <option value="LAST_12_MONTHS">Last 12 Months</option>
                                        <option value="LAST_6_MONTHS">Last 6 Months</option>
                                        <option value="LAST_3_MONTHS">Last 3 Months</option>
                                        <option value="THIS_YEAR">This Year</option>
                                    </select>
                                </div>
                                <button class="btn btn-primary" style="margin-top: 16px;" onclick="loadLeagueTable()">
                                    Generate League Table
                                </button>
                            </div>
                        </div>

                        <div id="facilityCatchmentInputs" class="hidden" style="margin-top: 20px;">
                            <h4 style="margin-bottom: 12px;">Enter Catchment Populations for Facilities:</h4>
                            <div id="catchmentInputsContainer" class="adjustment-inputs">
                                <!-- Dynamic inputs will be inserted here -->
                            </div>
                            <button class="btn btn-primary" style="margin-top: 16px;" onclick="calculateLeague()">
                                Calculate Performance
                            </button>
                        </div>

                        <div id="leagueTableDisplay" class="hidden" style="margin-top: 24px;">
                            <h3 style="margin-bottom: 12px;">Performance Rankings</h3>
                            <div class="table-container">
                                <table id="leagueTable">
                                    <thead>
                                        <tr>
                                            <th>Rank</th>
                                            <th>Organization Unit</th>
                                            <th>ANC 1 (%)</th>
                                            <th>ANC 1st Tri (%)</th>
                                            <th>ANC 4 (%)</th>
                                            <th>ANC 8 (%)</th>
                                            <th>Overall Score</th>
                                        </tr>
                                    </thead>
                                    <tbody id="leagueTableBody">
                                        <!-- League data will be inserted here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Legend -->
        <div class="legend">
            <div class="legend-content">
                <span style="font-weight: 700;">Legend:</span>
                <div class="legend-item">
                    <div class="legend-box" style="background: #10b981;"></div>
                    <span>Target Met</span>
                </div>
                <div class="legend-item">
                    <div class="legend-box" style="background: #fbbf24;"></div>
                    <span>Near Target</span>
                </div>
                <div class="legend-item">
                    <div class="legend-box" style="background: #ef4444;"></div>
                    <span>Below Target</span>
                </div>
            </div>
        </div>
    </main>

    <script>
        // Global variables
        let currentData = null;
        let chartInstances = {};
        let ancCatchment = 0;
        let ubosPopulation = 0;
        let selectedOrgUnit = null;
        let searchCache = {};
        let searchTimeout = null;

        // Session customizations (formulas and targets)
        let sessionCustomizations = {
            formulas: {},
            targets: {}
        };

        // UBOS Population Data (will be populated from config)
        let UBOS_POPULATIONS = {};

        // Fetch UBOS populations on page load
        async function loadUBOSPopulations() {
            try {
                console.log('Fetching UBOS populations...');
                const response = await fetch('/api/districts');
                
                if (response.ok) {
                    UBOS_POPULATIONS = await response.json();
                    console.log('‚úÖ UBOS populations loaded:', Object.keys(UBOS_POPULATIONS).length, 'districts');
                    console.log('Sample districts:', Object.keys(UBOS_POPULATIONS).slice(0, 5));
                } else {
                    console.warn('‚ö†Ô∏è Could not fetch UBOS populations, response status:', response.status);
                    UBOS_POPULATIONS = {};
                }
            } catch (error) {
                console.error('‚ùå Error loading UBOS populations:', error);
                UBOS_POPULATIONS = {};
            }
        }

        // ANC Data Element IDs (will be fetched from DHIS2)
        const ANC_INDICATORS = {
            'ANC_1ST_VISIT': '105-AN01a',
            'ANC_1ST_TRIMESTER': '105-AN01b',
            'ANC_4TH_VISIT': '105-AN02',
            'ANC_8TH_VISIT': '105-AN03',
            'IPT3': '105-AN06c',
            'HB_TEST': '105-AN08',
            'LLIN': '105-AN11',
            'IRON_FOLIC': '105-AN21_2019',
            'TEEN_UNDER_15': '105-AN01a',  // Will filter by age
            'TEEN_15_19': '105-AN01a'      // Will filter by age
        };

        // Targets with exact color coding thresholds
        const TARGETS = {
            // ANC 1: Target 100%. ‚â•100% green, 80-99.9% yellow, <80% red
            'ANC_1ST_VISIT': { target: 100, greenMin: 100, yellowMin: 80, inverse: false },
            
            // ANC 1st Tri: Target 45%. ‚â•45% green, 30-44.9% yellow, <30% red
            'ANC_1ST_TRIMESTER': { target: 45, greenMin: 45, yellowMin: 30, inverse: false },
            
            // ANC 4: Target 75%. ‚â•75% green, 50-74.9% yellow, <50% red
            'ANC_4TH_VISIT': { target: 75, greenMin: 75, yellowMin: 50, inverse: false },
            
            // ANC 8: Target 20%. ‚â•20% green, 10-19.9% yellow, <10% red
            'ANC_8TH_VISIT': { target: 20, greenMin: 20, yellowMin: 10, inverse: false },
            
            // IPT3: Target 80%. ‚â•80% green, 60-79.9% yellow, <60% red
            'IPT3': { target: 80, greenMin: 80, yellowMin: 60, inverse: false },
            
            // Hb Testing: Target 75%. ‚â•75% green, 50-74.9% yellow, <50% red
            'HB_TEST': { target: 75, greenMin: 75, yellowMin: 50, inverse: false },
            
            // LLIN: Target 80%. ‚â•80% green, 60-79.9% yellow, <60% red
            'LLIN': { target: 80, greenMin: 80, yellowMin: 60, inverse: false },
            
            // Iron/Folic: Same as Hb Testing. ‚â•75% green, 50-74.9% yellow, <50% red
            'IRON_FOLIC': { target: 75, greenMin: 75, yellowMin: 50, inverse: false },
            
            // Teenage Pregnancies: ‚â§13% green, 13.1-19.9% yellow, ‚â•20% red (inverse)
            'TEEN_PREG': { target: 13, greenMax: 13, yellowMax: 19.9, inverse: true }
        };

        // Color coding function with exact thresholds
        function getColorClass(value, indicator) {
            const config = TARGETS[indicator];
            if (!config) return '';

            if (config.inverse) {
                // Lower is better (e.g., teenage pregnancies)
                // ‚â§13% green, 13.1-19.9% yellow, ‚â•20% red
                if (value <= config.greenMax) return 'cell-green';
                if (value <= config.yellowMax) return 'cell-yellow';
                return 'cell-red';
            } else {
                // Higher is better
                if (value >= config.greenMin) return 'cell-green';
                if (value >= config.yellowMin) return 'cell-yellow';
                return 'cell-red';
            }
        }

        // Theme toggle
        function toggleTheme() {
            const body = document.body;
            const currentTheme = body.getAttribute('data-theme');
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            body.setAttribute('data-theme', newTheme);
            
            document.getElementById('theme-icon-sun').classList.toggle('hidden');
            document.getElementById('theme-icon-moon').classList.toggle('hidden');
        }

        // Tab switching
        function switchTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.add('hidden'));
            
            event.target.classList.add('active');
            document.getElementById(`${tab}-tab`).classList.remove('hidden');
            
            // Hide filters for Analysis tab, show for others
            const filtersCard = document.querySelector('.filters-card');
            if (tab === 'analysis') {
                filtersCard.style.display = 'none';
            } else {
                filtersCard.style.display = 'block';
            }
        }

        // ========== Formula and Target Editing Functions ==========
        
        function editFormula(indicator) {
            // Hide content, show edit form
            document.getElementById(`formula-${indicator}`).style.display = 'none';
            document.getElementById(`edit-${indicator}`).classList.remove('hidden');
            document.querySelector(`[data-indicator="${indicator}"]`).classList.add('editing');
        }

        function cancelEdit(indicator) {
            // Show content, hide edit form
            document.getElementById(`formula-${indicator}`).style.display = 'block';
            document.getElementById(`edit-${indicator}`).classList.add('hidden');
            document.querySelector(`[data-indicator="${indicator}"]`).classList.remove('editing');
        }

        function saveFormula(indicator) {
            if (indicator === 'anc_catchment') {
                // Special handling for catchment percentage
                const percentage = parseFloat(document.getElementById(`input-${indicator}`).value);
                if (isNaN(percentage) || percentage <= 0 || percentage > 100) {
                    alert('Please enter a valid percentage between 0 and 100');
                    return;
                }
                sessionCustomizations.formulas[indicator] = percentage;
                document.getElementById(`formula-${indicator}`).innerHTML = 
                    `= (${percentage}% √ó UBOS Population) for Districts<br>= (${percentage}% √ó Catchment Population) for Facilities`;
                
                // Recalculate catchment with new percentage
                if (ubosPopulation > 0 || parseInt(document.getElementById('populationInput').value) > 0) {
                    recalculatePeriodCatchment();
                }
            } else {
                // Regular formula edit
                const formula = document.getElementById(`input-${indicator}`).value.trim();
                if (!formula) {
                    alert('Formula cannot be empty');
                    return;
                }
                sessionCustomizations.formulas[indicator] = formula;
                document.getElementById(`formula-${indicator}`).innerHTML = formula;
            }
            
            cancelEdit(indicator);
            alert(`‚úÖ Formula updated for this session!\n\nIndicator: ${indicator}\n\nNote: This will only apply to calculations shown in the interface. Backend calculations remain unchanged.`);
        }

        function editTarget(indicator) {
            // Hide content, show edit form
            document.getElementById(`target-${indicator}`).style.display = 'none';
            document.getElementById(`edit-target-${indicator}`).classList.remove('hidden');
            document.querySelector(`[data-indicator="target_${indicator}"]`).classList.add('editing');
        }

        function cancelEditTarget(indicator) {
            // Show content, hide edit form
            document.getElementById(`target-${indicator}`).style.display = 'block';
            document.getElementById(`edit-target-${indicator}`).classList.add('hidden');
            document.querySelector(`[data-indicator="target_${indicator}"]`).classList.remove('editing');
        }

        function saveTarget(indicator) {
            const greenThreshold = parseFloat(document.getElementById(`green-${indicator}`).value);
            const yellowThreshold = parseFloat(document.getElementById(`yellow-${indicator}`).value);
            
            if (isNaN(greenThreshold) || isNaN(yellowThreshold)) {
                alert('Please enter valid numbers for thresholds');
                return;
            }

            // Special handling for teenage pregnancies (inverted logic)
            if (indicator === 'teenage') {
                if (greenThreshold >= yellowThreshold) {
                    alert('For Teenage Pregnancies: Green threshold must be LESS than Yellow threshold');
                    return;
                }
                sessionCustomizations.targets[indicator] = { green: greenThreshold, yellow: yellowThreshold };
                document.getElementById(`target-${indicator}`).innerHTML = 
                    `Green ‚â§${greenThreshold}% | Yellow ${greenThreshold + 0.1}-${yellowThreshold}% | Red ‚â•${yellowThreshold + 0.1}%`;
            } else {
                if (greenThreshold <= yellowThreshold) {
                    alert('Green threshold must be GREATER than Yellow threshold');
                    return;
                }
                sessionCustomizations.targets[indicator] = { green: greenThreshold, yellow: yellowThreshold };
                document.getElementById(`target-${indicator}`).innerHTML = 
                    `Green ‚â•${greenThreshold}% | Yellow ${yellowThreshold}-${greenThreshold - 0.1}% | Red <${yellowThreshold}%`;
            }
            
            cancelEditTarget(indicator);
            
            // Update the color coding if data is loaded
            if (currentData) {
                updateTableWithCustomTargets();
            }
            
            alert(`‚úÖ Target thresholds updated for this session!\n\nIndicator: ${indicator}\nGreen: ${greenThreshold}%\nYellow: ${yellowThreshold}%\n\nThe table will be re-colored with new thresholds.`);
        }

        function updateTableWithCustomTargets() {
            // Re-apply color coding to the table based on custom targets
            const tbody = document.querySelector('#indicatorsTable tbody');
            if (!tbody || !currentData) return;

            const rows = tbody.querySelectorAll('tr');
            rows.forEach((row, index) => {
                const valueCell = row.querySelector('td:nth-child(2)');
                if (!valueCell) return;

                const valueText = valueCell.textContent.trim();
                const value = parseFloat(valueText);
                if (isNaN(value)) return;

                // Determine indicator type from row
                const indicatorName = row.querySelector('td:first-child')?.textContent.trim();
                let targetKey = null;
                
                if (indicatorName.includes('ANC 1 Coverage')) targetKey = 'anc1';
                else if (indicatorName.includes('1st Trimester')) targetKey = 'anc1_trimester';
                else if (indicatorName.includes('ANC 4')) targetKey = 'anc4';
                else if (indicatorName.includes('ANC 8')) targetKey = 'anc8';
                else if (indicatorName.includes('IPT3')) targetKey = 'ipt3';
                else if (indicatorName.includes('Hb Testing') || indicatorName.includes('Iron/Folic')) targetKey = 'hb_iron';
                else if (indicatorName.includes('LLIN')) targetKey = 'llin';
                else if (indicatorName.includes('Teenage')) targetKey = 'teenage';

                if (targetKey && sessionCustomizations.targets[targetKey]) {
                    const thresholds = sessionCustomizations.targets[targetKey];
                    let colorClass = '';

                    if (targetKey === 'teenage') {
                        // Inverted logic for teenage pregnancies
                        if (value <= thresholds.green) colorClass = 'green';
                        else if (value <= thresholds.yellow) colorClass = 'yellow';
                        else colorClass = 'red';
                    } else {
                        // Normal logic
                        if (value >= thresholds.green) colorClass = 'green';
                        else if (value >= thresholds.yellow) colorClass = 'yellow';
                        else colorClass = 'red';
                    }

                    // Apply color
                    valueCell.className = `indicator-value ${colorClass}`;
                }
            });

            console.log('‚úÖ Table re-colored with custom targets');
        }

        function resetCustomizations() {
            if (!confirm('Are you sure you want to reset all customizations to default values?\n\nThis will:\n- Reset all formulas\n- Reset all color coding targets\n- Clear all session changes')) {
                return;
            }

            // Clear customizations
            sessionCustomizations = {
                formulas: {},
                targets: {}
            };

            // Reload the page to reset everything
            location.reload();
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('Page loaded, initializing...');
            await loadUBOSPopulations();
            await populateLevel2(); // Start from regions
            setupEventListeners();
            console.log('Initialization complete');
        });

        // Populate Level 2 (Regions - top level)
        async function populateLevel2() {
            const sel = document.getElementById('level2');
            sel.innerHTML = '<option value="">‚è≥ Loading...</option>';
            
            try {
                // First, get the country level (top level)
                const response = await fetch('/api/org-units');
                const data = await response.json();
                
                if (data.error) {
                    sel.innerHTML = `<option value="">Error: ${data.error}</option>`;
                    return;
                }
                
                const topLevelUnits = data.organisationUnits || [];
                
                if (topLevelUnits.length === 0) {
                    sel.innerHTML = '<option value="">No units found</option>';
                    return;
                }
                
                // Get the first country/top-level unit
                const countryId = topLevelUnits[0].id;
                console.log('Country ID:', countryId, topLevelUnits[0].displayName);
                
                // Now fetch the regions (children of country)
                const regionsResponse = await fetch(`/api/org-units?parent=${countryId}`);
                const regionsData = await regionsResponse.json();
                
                if (regionsData.error) {
                    sel.innerHTML = `<option value="">Error: ${regionsData.error}</option>`;
                    return;
                }
                
                const regions = regionsData.children || [];
                
                if (regions.length > 0) {
                    regions.sort((a, b) => a.displayName.localeCompare(b.displayName));
                    sel.innerHTML = `<option value="">-- Select Region (${regions.length}) --</option>` +
                        regions.map(u => `<option value="${u.id}" data-name="${u.displayName}">${u.displayName}</option>`).join('');
                    console.log(`‚úÖ Loaded ${regions.length} regions`);
                } else {
                    sel.innerHTML = '<option value="">No regions found</option>';
                }
            } catch (error) {
                console.error('Error loading regions:', error);
                sel.innerHTML = '<option value="">Error loading</option>';
            }
        }

        // Load children for a given level
        async function loadChildren(level) {
            const sel = document.getElementById(`level${level}`);
            const parentId = sel.value;
            const parentName = sel.options[sel.selectedIndex]?.dataset?.name || sel.options[sel.selectedIndex]?.text || '';

            if (parentId) {
                selectedOrgUnit = { id: parentId, name: parentName, level: level };
                document.getElementById('selectedOrgUnit').textContent = parentName;

                // Show/hide population input based on level
                const populationInputGroup = document.getElementById('populationInputGroup');
                if (level > 3) {
                    // Facility level (sub-county and below)
                    populationInputGroup.style.display = 'block';
                    // Show modal for level 5 and 6 (sub-county and facilities)
                    if (level >= 5) {
                        showPopulationModal(parentName);
                    }
                } else {
                    // District or above
                    populationInputGroup.style.display = 'none';
                    document.getElementById('populationInput').value = ''; // Clear value
                }

                // Check if district (level 3) for UBOS population
                if (level === 3) {
                    // Try different name variations to match UBOS data
                    const cleanName = parentName.toUpperCase()
                        .replace(' DISTRICT', '')
                        .replace(' CITY', '')
                        .replace('MUNICIPAL COUNCIL', '')
                        .trim();
                    
                    // Try exact match first
                    let pop = UBOS_POPULATIONS[cleanName];
                    
                    // Try with "CITY" suffix
                    if (!pop && !cleanName.includes('CITY')) {
                        pop = UBOS_POPULATIONS[cleanName + ' CITY'];
                    }
                    
                    // Try without "CITY" suffix
                    if (!pop && cleanName.includes('CITY')) {
                        pop = UBOS_POPULATIONS[cleanName.replace('CITY', '').trim()];
                    }
                    
                    if (pop) {
                        ubosPopulation = pop;
                        recalculatePeriodCatchment(); // Recalculate based on selected period
                        console.log(`‚úÖ Found district: ${cleanName} = ${pop.toLocaleString()} (ANC catchment: ${ancCatchment.toLocaleString()})`);
                    } else {
                        console.warn(`‚ö†Ô∏è No UBOS population found for: "${cleanName}". Available districts:`, Object.keys(UBOS_POPULATIONS).slice(0, 10));
                        ubosPopulation = 0;
                        ancCatchment = 0;
                        document.getElementById('ancCatchment').textContent = 'Not found - enter custom';
                    }
                } else if (level > 3) {
                    // Facility level - clear and prompt for custom
                    ubosPopulation = 0;
                    ancCatchment = 0;
                    document.getElementById('ancCatchment').textContent = 'Enter population below';
                }
            }

            // Clear lower levels (skip level 4 - County)
            for (let i = level + 1; i <= 6; i++) {
                if (i === 4) continue; // Skip county level
                const s = document.getElementById(`level${i}`);
                if (s) {
                    s.innerHTML = '<option>--</option>';
                    s.disabled = true;
                }
            }

            // Load next level (skip level 4 - County)
            if (!parentId || level >= 6) return;

            let nextLevel = level + 1;
            if (nextLevel === 4) nextLevel = 5; // Skip county, go straight to sub-county
            const nextSel = document.getElementById(`level${nextLevel}`);
            nextSel.innerHTML = '<option>‚è≥ Loading...</option>';
            nextSel.disabled = false;

            try {
                const response = await fetch(`/api/org-units?parent=${parentId}`);
                const data = await response.json();
                const children = (data.children || []).sort((a, b) => a.displayName.localeCompare(b.displayName));
                
                if (!children.length) {
                    nextSel.innerHTML = '<option>üì≠ No sub-units</option>';
                    nextSel.disabled = true;
                    return;
                }
                
                const levelNames = ['', '', 'Region', 'District', '', 'Sub-county', 'Facility'];
                nextSel.innerHTML = `<option value="">-- Select ${levelNames[nextLevel] || 'Unit'} (${children.length}) --</option>` +
                    children.map(u => `<option value="${u.id}" data-name="${u.displayName}">${u.displayName}</option>`).join('');
            } catch (error) {
                console.error('Error loading children:', error);
                nextSel.innerHTML = '<option>‚ùå Error loading</option>';
            }
        }

        // Select final level (facility)
        function selectFinalLevel(level) {
            const sel = document.getElementById(`level${level}`);
            if (sel.value) {
                selectedOrgUnit = {
                    id: sel.value,
                    name: sel.options[sel.selectedIndex].dataset.name || sel.options[sel.selectedIndex].text,
                    level: level
                };
                document.getElementById('selectedOrgUnit').textContent = selectedOrgUnit.name;
                
                // Show population input for facilities (level 6)
                const populationInputGroup = document.getElementById('populationInputGroup');
                if (level === 6) {
                    populationInputGroup.style.display = 'block';
                    // Show modal to prompt for population
                    showPopulationModal(selectedOrgUnit.name);
                } else {
                    populationInputGroup.style.display = 'none';
                }
                
                console.log('Selected facility:', selectedOrgUnit);
            }
        }

        // Search functionality
        function handleSearchInput(event) {
            const query = event.target.value.trim();
            
            if (searchTimeout) {
                clearTimeout(searchTimeout);
            }

            if (query.length < 3) {
                document.getElementById('searchDropdown').classList.remove('show');
                return;
            }

            searchTimeout = setTimeout(() => {
                searchOrgUnits(query);
            }, 300); // Debounce 300ms
        }

        async function searchOrgUnits(query) {
            const dropdown = document.getElementById('searchDropdown');
            const cacheKey = query.toLowerCase();

            // Check cache
            if (searchCache[cacheKey]) {
                renderSearchResults(searchCache[cacheKey]);
                return;
            }

            dropdown.innerHTML = '<div class="search-loading">üîç Searching...</div>';
            dropdown.classList.add('show');

            try {
                const response = await fetch(`/api/search-org-units?query=${encodeURIComponent(query)}`);
                const data = await response.json();

                if (data.error) {
                    dropdown.innerHTML = `<div class="search-no-results">‚ùå ${data.error}</div>`;
                    return;
                }

                const results = data.organisationUnits || [];
                searchCache[cacheKey] = results;
                renderSearchResults(results);
            } catch (error) {
                console.error('Search error:', error);
                dropdown.innerHTML = '<div class="search-no-results">‚ùå Search failed. Please try again.</div>';
            }
        }

        function renderSearchResults(results) {
            const dropdown = document.getElementById('searchDropdown');
            
            if (results.length === 0) {
                dropdown.innerHTML = '<div class="search-no-results">üòû No results found. Try a different search term.</div>';
                return;
            }

            dropdown.innerHTML = results.map(unit => `
                <div class="search-result-item" onclick="selectSearchResult('${unit.id}', '${unit.displayName.replace(/'/g, "\\'")}', ${unit.level})">
                    <div class="search-result-name">${unit.displayName}</div>
                    <div class="search-result-path">Level ${unit.level} ‚Ä¢ ${unit.path || ''}</div>
                </div>
            `).join('');
        }

        async function selectSearchResult(id, name, level) {
            selectedOrgUnit = { id, name, level };
            document.getElementById('selectedOrgUnit').textContent = name;

            // Clear search
            const searchInput = document.getElementById('orgUnitSearch');
            searchInput.value = '';
            searchInput.placeholder = `‚úì Selected: ${name}`;
            document.getElementById('searchDropdown').classList.remove('show');

            console.log(`üîç Loading hierarchy for: ${name} (Level ${level})`);

            try {
                // Fetch the org unit with its ancestors
                const response = await fetch(`/api/org-units/${id}`);
                const orgUnit = await response.json();
                
                // Build hierarchy: [Country, Region, District, Sub-county, Facility]
                const ancestors = orgUnit.ancestors || [];
                const fullHierarchy = [
                    ...ancestors.map(a => ({ id: a.id, name: a.displayName, level: a.level })),
                    { id: orgUnit.id, name: orgUnit.displayName, level: orgUnit.level }
                ];
                
                console.log('Hierarchy:', fullHierarchy.map(h => `L${h.level}: ${h.name}`).join(' ‚Üí '));
                
                // Extract each level from hierarchy
                const region = fullHierarchy.find(h => h.level === 2);
                const district = fullHierarchy.find(h => h.level === 3);
                const county = fullHierarchy.find(h => h.level === 4); // County (hidden in UI but needed for hierarchy)
                const subCounty = fullHierarchy.find(h => h.level === 5);
                const facility = fullHierarchy.find(h => h.level === 6);
                
                // Reset all dropdowns first
                for (let i = 2; i <= 6; i++) {
                    if (i === 4) continue; // Skip county
                    const sel = document.getElementById(`level${i}`);
                    if (sel && i > 2) {
                        sel.innerHTML = '<option value="">-- Select --</option>';
                        sel.disabled = true;
                        sel.value = '';
                    }
                }
                
                // Populate Level 2 (Region)
                if (region) {
                    const level2Select = document.getElementById('level2');
                    level2Select.value = region.id;
                    console.log(`  ‚úÖ Region: ${region.name}`);
                    
                    // Load districts for this region
                    await loadChildrenAndSelect(2, region.id, district);
                }
                
                // Populate Level 3 (District)
                if (district) {
                    console.log(`  ‚úÖ District: ${district.name}`);
                    
                    // Check UBOS population for district
                    const cleanName = district.name.toUpperCase()
                        .replace(' DISTRICT', '')
                        .replace(' CITY', '')
                        .replace('MUNICIPAL COUNCIL', '')
                        .trim();
                    
                    let pop = UBOS_POPULATIONS[cleanName] || 
                             UBOS_POPULATIONS[cleanName + ' CITY'] ||
                             UBOS_POPULATIONS[cleanName.replace('CITY', '').trim()];
                    
                    if (pop) {
                        ubosPopulation = pop;
                        recalculatePeriodCatchment();
                        console.log(`  üíæ UBOS Population: ${pop.toLocaleString()}`);
                    } else {
                        console.warn(`  ‚ö†Ô∏è No UBOS population for: ${cleanName}`);
                        ubosPopulation = 0;
                        ancCatchment = 0;
                        document.getElementById('ancCatchment').textContent = 'Not found';
                    }
                    
                    // Load sub-counties using COUNTY as parent (County is Level 4, children are Sub-counties Level 5)
                    if (county) {
                        await loadChildrenAndSelect(4, county.id, subCounty);
                    }
                }
                
                // Populate Level 5 (Sub-county)
                if (subCounty) {
                    console.log(`  ‚úÖ Sub-county: ${subCounty.name}`);
                    
                    // Load facilities for this sub-county
                    await loadChildrenAndSelect(5, subCounty.id, facility);
                }
                
                // Populate Level 6 (Facility)
                if (facility && level === 6) {
                    console.log(`  ‚úÖ Facility: ${facility.name}`);
                }
                
                // Show/hide population input based on final level
                const populationInputGroup = document.getElementById('populationInputGroup');
                if (level > 3) {
                    // Facility level
                    populationInputGroup.style.display = 'block';
                } else {
                    // District or above
                    populationInputGroup.style.display = 'none';
                    document.getElementById('populationInput').value = '';
                }
                
            } catch (error) {
                console.error('‚ùå Error loading hierarchy:', error);
                alert('Could not load organization unit hierarchy. Please try again.');
            }

            console.log('Selected from search:', selectedOrgUnit);
        }

        // Helper function to load children and set selected value
        async function loadChildrenAndSelect(parentLevel, parentId, targetChild) {
            try {
                const response = await fetch(`/api/org-units?parent=${parentId}`);
                const data = await response.json();
                const children = data.organisationUnits || [];
                
                // Determine which level to populate
                // parentLevel 2 (Region) -> children are Level 3 (District)
                // parentLevel 4 (County) -> children are Level 5 (Sub-county)
                // parentLevel 5 (Sub-county) -> children are Level 6 (Facility)
                const targetLevel = parentLevel === 2 ? 3 : (parentLevel === 4 ? 5 : 6);
                const select = document.getElementById(`level${targetLevel}`);
                
                if (!select || children.length === 0) return;
                
                // Populate dropdown
                select.innerHTML = '<option value="">-- Select --</option>';
                children.forEach(child => {
                    const option = document.createElement('option');
                    option.value = child.id;
                    option.textContent = child.displayName;
                    option.dataset.name = child.displayName;
                    select.appendChild(option);
                });
                
                select.disabled = false;
                
                // Select the target child if provided
                if (targetChild && targetChild.id) {
                    select.value = targetChild.id;
                    console.log(`    ‚Ü≥ Loaded ${children.length} options for Level ${targetLevel}, selected: ${targetChild.name}`);
                } else {
                    console.log(`    ‚Ü≥ Loaded ${children.length} options for Level ${targetLevel}`);
                }
                
            } catch (error) {
                console.error(`Error loading children for level ${parentLevel}:`, error);
            }
        }

        function showSearchDropdown() {
            const query = document.getElementById('orgUnitSearch').value;
            if (query.length >= 3) {
                document.getElementById('searchDropdown').classList.add('show');
            }
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.filter-group')) {
                document.getElementById('searchDropdown').classList.remove('show');
            }
        });

        function setupEventListeners() {
            document.getElementById('periodSelect').addEventListener('change', (e) => {
                const isCustom = e.target.value === 'CUSTOM';
                const startGroup = document.getElementById('startDateGroup');
                const endGroup = document.getElementById('endDateGroup');
                const startInput = document.getElementById('startDateInput');
                const endInput = document.getElementById('endDateInput');
                
                if (isCustom) {
                    // Show and enable custom date inputs
                    startGroup.style.display = 'block';
                    endGroup.style.display = 'block';
                    
                    // Set default dates if empty
                    if (!startInput.value || !endInput.value) {
                        const now = new Date();
                        const endMonth = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
                        const startDate = new Date(now.getFullYear(), now.getMonth() - 11, 1);
                        const startMonth = `${startDate.getFullYear()}-${String(startDate.getMonth() + 1).padStart(2, '0')}`;
                        startInput.value = startMonth;
                        endInput.value = endMonth;
                    }
                } else {
                    // Hide custom date inputs when using preset
                    startGroup.style.display = 'none';
                    endGroup.style.display = 'none';
                }
                
                // Update period display and recalculate catchment
                updatePeriodDisplay();
                recalculatePeriodCatchment();
            });

            document.getElementById('populationInput').addEventListener('input', recalculatePeriodCatchment);
            document.getElementById('startDateInput').addEventListener('change', () => {
                recalculatePeriodCatchment();
                updatePeriodDisplay();
            });
            document.getElementById('endDateInput').addEventListener('change', () => {
                recalculatePeriodCatchment();
                updatePeriodDisplay();
            });
        }

        function updatePeriodDisplay() {
            const periodSelect = document.getElementById('periodSelect');
            const periodValue = periodSelect.value;
            const periodDisplay = document.getElementById('selectedPeriod');
            
            if (periodValue === 'CUSTOM') {
                const startDate = document.getElementById('startDateInput').value;
                const endDate = document.getElementById('endDateInput').value;
                
                if (startDate && endDate) {
                    // Format dates nicely (e.g., "Jan 2025 - Jul 2025")
                    const start = new Date(startDate + '-01');
                    const end = new Date(endDate + '-01');
                    
                    const months = (end.getFullYear() - start.getFullYear()) * 12 + (end.getMonth() - start.getMonth()) + 1;
                    
                    const startFormatted = start.toLocaleString('en-US', { month: 'short', year: 'numeric' });
                    const endFormatted = end.toLocaleString('en-US', { month: 'short', year: 'numeric' });
                    
                    periodDisplay.textContent = `${startFormatted} - ${endFormatted} (${months} month${months > 1 ? 's' : ''})`;
                } else {
                    periodDisplay.textContent = 'Custom Range (select dates)';
                }
            } else {
                // Show the selected preset period text
                const selectedOption = periodSelect.options[periodSelect.selectedIndex];
                periodDisplay.textContent = selectedOption.text;
            }
        }

        function recalculatePeriodCatchment() {
            const periodSelect = document.getElementById('periodSelect').value;
            const annualPop = parseInt(document.getElementById('populationInput').value) || 0;
            const startDate = document.getElementById('startDateInput').value;
            const endDate = document.getElementById('endDateInput').value;
            
            let months = 12; // Default to 12 months
            
            // Determine number of months based on period selection
            if (periodSelect === 'CUSTOM' && startDate && endDate) {
                const start = new Date(startDate + '-01');
                const end = new Date(endDate + '-01');
                months = (end.getFullYear() - start.getFullYear()) * 12 + (end.getMonth() - start.getMonth()) + 1;
                
                if (months < 1) {
                    months = 1;
                }
            } else if (periodSelect === 'LAST_6_MONTHS') {
                months = 6;
            } else if (periodSelect === 'LAST_3_MONTHS') {
                months = 3;
            } else if (periodSelect === 'THIS_YEAR' || periodSelect === 'LAST_YEAR') {
                months = 12;
            } else {
                months = 12; // Default for LAST_12_MONTHS
            }
            
            // Calculate catchment based on organization level
            if (selectedOrgUnit) {
                if (selectedOrgUnit.level <= 3 && ubosPopulation > 0) {
                    // District level with UBOS population
                    // Formula: (Annual UBOS Population / 12) √ó Months √ó 5%
                    const monthlyPop = Math.round(ubosPopulation / 12);
                    const periodPop = monthlyPop * months;
                    ancCatchment = Math.round(periodPop * 0.05);
                    
                    console.log(`üìä District catchment: UBOS ${ubosPopulation.toLocaleString()} ‚Üí Monthly ${monthlyPop.toLocaleString()} √ó ${months} months = ${periodPop.toLocaleString()} ‚Üí 5% = ${ancCatchment.toLocaleString()}`);
                } else if (annualPop > 0) {
                    // Facility level with custom population
                    // Formula: (Annual Population / 12) √ó Months √ó 5%
                    const monthlyPop = Math.round(annualPop / 12);
                    const periodPop = monthlyPop * months;
                    ancCatchment = Math.round(periodPop * 0.05);
                    
                    console.log(`üìä Facility catchment: ${annualPop.toLocaleString()} ‚Üí Monthly ${monthlyPop.toLocaleString()} √ó ${months} months = ${periodPop.toLocaleString()} ‚Üí 5% = ${ancCatchment.toLocaleString()}`);
                    
                    // Store facility period info
                    window.facilityPeriodInfo = {
                        annualPopulation: annualPop,
                        startDate: startDate,
                        endDate: endDate,
                        months: months,
                        periodPopulation: periodPop,
                        ancCatchment: ancCatchment
                    };
                }
            }
            
            document.getElementById('ancCatchment').textContent = ancCatchment > 0 ? ancCatchment.toLocaleString() : '-';
        }

        function updateCatchmentFromInput() {
            recalculatePeriodCatchment();
        }

        async function fetchData() {
            if (!selectedOrgUnit) {
                alert('Please select an organization unit first');
                return;
            }

            const periodSelectValue = document.getElementById('periodSelect').value;
            
            // Require period selection
            if (!periodSelectValue) {
                alert('Please select a period first');
                return;
            }
            
            const customPopulation = parseInt(document.getElementById('populationInput').value) || 0;
            let period = periodSelectValue;
            
            // Check if using custom date range
            if (periodSelectValue === 'CUSTOM') {
                const startDate = document.getElementById('startDateInput').value;
                const endDate = document.getElementById('endDateInput').value;
                
                if (!startDate || !endDate) {
                    alert('Please select both start and end dates for custom range');
                    return;
                }
                
                // Generate period string for custom date range
                const start = new Date(startDate + '-01');
                const end = new Date(endDate + '-01');
                
                // Create DHIS2 period format (e.g., 202301;202302;202303...)
                const periods = [];
                let current = new Date(start);
                while (current <= end) {
                    const year = current.getFullYear();
                    const month = String(current.getMonth() + 1).padStart(2, '0');
                    periods.push(`${year}${month}`);
                    current.setMonth(current.getMonth() + 1);
                }
                period = periods.join(';');
                console.log('Using custom period:', period);
            }
            
            const spinner = document.getElementById('loadingSpinner');
            spinner.classList.remove('hidden');
            document.getElementById('dataDisplay').classList.add('hidden');

            try {
                let url = `/maternal/api/anc-data?orgUnit=${selectedOrgUnit.id}&period=${encodeURIComponent(period)}`;
                if (customPopulation > 0) {
                    // Pass the period-adjusted catchment, not the annual population
                    const catchmentToSend = ancCatchment || Math.round(customPopulation * 0.05);
                    url += `&customPopulation=${customPopulation}&ancCatchment=${catchmentToSend}`;
                }

                console.log('Fetching data from:', url);
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.error) {
                    alert('Error: ' + data.error);
                    return;
                }

                console.log('Received data:', data);
                currentData = data;
                renderANCTable(data);
                renderCharts(data);
                
                document.getElementById('dataDisplay').classList.remove('hidden');
                
                // Also fetch Intrapartum data
                await fetchIntrapartumData(period, customPopulation);
                
            } catch (error) {
                console.error('Error fetching data:', error);
                alert('Failed to fetch data. Please try again.');
            } finally {
                spinner.classList.add('hidden');
            }
        }

        // Intrapartum data
        let intrapartumData = null;

        async function fetchIntrapartumData(period, customPopulation) {
            try {
                let url = `/maternal/api/intrapartum-data?orgUnit=${selectedOrgUnit.id}&period=${encodeURIComponent(period)}`;
                if (customPopulation > 0) {
                    const deliveriesCatchment = Math.round(customPopulation * 0.0485);
                    url += `&customPopulation=${customPopulation}&deliveriesCatchment=${deliveriesCatchment}`;
                }

                console.log('Fetching Intrapartum data from:', url);
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.error) {
                    console.warn('Intrapartum error:', data.error);
                    document.getElementById('intrapartumSection').style.display = 'block';
                    document.getElementById('intrapartumTableBody').innerHTML = `
                        <tr>
                            <td colspan="5" style="text-align: center; padding: 20px; color: var(--text-secondary);">
                                ‚ö†Ô∏è ${data.error}
                            </td>
                        </tr>
                    `;
                    return;
                }

                console.log('Received Intrapartum data:', data);
                intrapartumData = data;
                renderIntrapartumTable(data);
                document.getElementById('intrapartumSection').style.display = 'block';
                
            } catch (error) {
                console.error('Error fetching Intrapartum data:', error);
            }
        }

        function getIntrapartumColor(indicator, value) {
            // Color coding based on targets
            switch(indicator) {
                case 'DELIVERIES':
                    // Target: ‚â•70% green, 50-69.9% yellow, <50% red
                    if (value >= 70) return 'green';
                    if (value >= 50) return 'yellow';
                    return 'red';
                case 'LBW':
                    // Target: ‚â§5% green, 5.1-10% yellow, >10% red (lower is better)
                    if (value <= 5) return 'green';
                    if (value <= 10) return 'yellow';
                    return 'red';
                case 'KMC':
                    // Target: ‚â•90% green, 75-89.9% yellow, <75% red
                    if (value >= 90) return 'green';
                    if (value >= 75) return 'yellow';
                    return 'red';
                case 'ASPHYXIA':
                    // Target: ‚â§1% green, 1.1-5% yellow, >5% red (lower is better)
                    if (value <= 1) return 'green';
                    if (value <= 5) return 'yellow';
                    return 'red';
                case 'RESUSCITATION':
                    // Target: ‚â•90% green, 70-89.9% yellow, <70% red
                    if (value >= 90) return 'green';
                    if (value >= 70) return 'yellow';
                    return 'red';
                case 'FRESH_STILL':
                    // Target: ‚â§5 green, 5.1-10 yellow, >10 red (per 1000)
                    if (value <= 5) return 'green';
                    if (value <= 10) return 'yellow';
                    return 'red';
                case 'NEONATAL':
                    // Target: ‚â§5 green, 5.1-10 yellow, >10 red (per 1000)
                    if (value <= 5) return 'green';
                    if (value <= 10) return 'yellow';
                    return 'red';
                case 'PERINATAL':
                    // Target: ‚â§12 green, 12.1-20 yellow, >20 red (per 1000)
                    if (value <= 12) return 'green';
                    if (value <= 20) return 'yellow';
                    return 'red';
                case 'MMR':
                    // Target: ‚â§182 green, 182.1-300 yellow, >300 red (per 100,000)
                    if (value <= 182) return 'green';
                    if (value <= 300) return 'yellow';
                    return 'red';
                default:
                    return 'gray';
            }
        }

        function renderIntrapartumTable(data) {
            const tbody = document.getElementById('intrapartumTableBody');
            tbody.innerHTML = '';
            
            // Update deliveries catchment display
            document.getElementById('deliveriesCatchment').textContent = 
                (data.deliveriesCatchment || 0).toLocaleString();
            
            const indicators = [
                {
                    name: 'Deliveries Coverage',
                    numerator: data.totalDeliveries || 0,
                    denominator: data.deliveriesCatchment || 0,
                    value: data.deliveriesCoverage || 0,
                    unit: '%',
                    indicator: 'DELIVERIES'
                },
                {
                    name: 'Low Birth Weight (<2.5kg)',
                    numerator: data.liveBirthsLBW || 0,
                    denominator: data.liveBirthsTotal || 0,
                    value: data.lbwRate || 0,
                    unit: '%',
                    indicator: 'LBW'
                },
                {
                    name: 'LBW Initiated on KMC',
                    numerator: data.kmcInitiated || 0,
                    denominator: data.liveBirthsLBW || 0,
                    value: data.kmcRate || 0,
                    unit: '%',
                    indicator: 'KMC'
                },
                {
                    name: 'Birth Asphyxia Rate',
                    numerator: data.birthAsphyxia || 0,
                    denominator: data.totalDeliveries || 0,
                    value: data.asphyxiaRate || 0,
                    unit: '%',
                    indicator: 'ASPHYXIA'
                },
                {
                    name: 'Asphyxia Successfully Resuscitated',
                    numerator: data.resuscitated || 0,
                    denominator: data.birthAsphyxia || 0,
                    value: data.resuscitationRate || 0,
                    unit: '%',
                    indicator: 'RESUSCITATION'
                },
                {
                    name: 'Fresh Still Births (per 1,000)',
                    numerator: data.freshStillBirth || 0,
                    denominator: data.totalDeliveries || 0,
                    value: data.freshStillRate || 0,
                    unit: '',
                    indicator: 'FRESH_STILL'
                },
                {
                    name: 'Neonatal Mortality Rate (per 1,000)',
                    numerator: (data.newbornDeaths0_7 || 0) + (data.newbornDeaths8_28 || 0),
                    denominator: data.liveBirthsTotal || 0,
                    value: data.neonatalMortality || 0,
                    unit: '',
                    indicator: 'NEONATAL'
                },
                {
                    name: 'Perinatal Mortality Rate (per 1,000)',
                    numerator: (data.freshStillBirth || 0) + (data.newbornDeaths0_7 || 0) + (data.maceratedStillBirth || 0),
                    denominator: data.liveBirthsTotal || 0,
                    value: data.perinatalMortality || 0,
                    unit: '',
                    indicator: 'PERINATAL'
                },
                {
                    name: 'Maternal Mortality Ratio (per 100,000)',
                    numerator: data.maternalDeaths || 0,
                    denominator: data.liveBirthsTotal || 0,
                    value: data.maternalMortalityRatio || 0,
                    unit: '',
                    indicator: 'MMR'
                }
            ];
            
            indicators.forEach(ind => {
                const color = getIntrapartumColor(ind.indicator, ind.value);
                const colorBg = color === 'green' ? '#10b981' : (color === 'yellow' ? '#f59e0b' : '#ef4444');
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td style="font-weight: 500;">${ind.name}</td>
                    <td style="text-align: right;">${ind.numerator.toLocaleString()}</td>
                    <td style="text-align: right;">${ind.denominator.toLocaleString()}</td>
                    <td style="text-align: right; font-weight: 600; background-color: ${colorBg}; color: white; padding: 12px; border-radius: 4px;">
                        ${ind.value}${ind.unit}
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function downloadIntrapartumExcel() {
            if (!intrapartumData) {
                alert('No Intrapartum data to download');
                return;
            }
            // Similar to ANC Excel download - create XML spreadsheet
            const data = intrapartumData;
            const xml = `<?xml version="1.0"?>
<?mso-application progid="Excel.Sheet"?>
<Workbook xmlns="urn:schemas-microsoft-com:office:spreadsheet" xmlns:ss="urn:schemas-microsoft-com:office:spreadsheet">
<Styles>
    <Style ss:ID="Header"><Font ss:Bold="1"/><Interior ss:Color="#1e3a5f" ss:Pattern="Solid"/><Font ss:Color="#FFFFFF"/></Style>
    <Style ss:ID="Green"><Interior ss:Color="#10b981" ss:Pattern="Solid"/></Style>
    <Style ss:ID="Yellow"><Interior ss:Color="#f59e0b" ss:Pattern="Solid"/></Style>
    <Style ss:ID="Red"><Interior ss:Color="#ef4444" ss:Pattern="Solid"/><Font ss:Color="#FFFFFF"/></Style>
</Styles>
<Worksheet ss:Name="Intrapartum">
<Table>
    <Row><Cell ss:StyleID="Header"><Data ss:Type="String">Indicator</Data></Cell>
    <Cell ss:StyleID="Header"><Data ss:Type="String">Numerator</Data></Cell>
    <Cell ss:StyleID="Header"><Data ss:Type="String">Denominator</Data></Cell>
    <Cell ss:StyleID="Header"><Data ss:Type="String">Value</Data></Cell></Row>
    <Row><Cell><Data ss:Type="String">Deliveries Coverage</Data></Cell><Cell><Data ss:Type="Number">${data.totalDeliveries || 0}</Data></Cell><Cell><Data ss:Type="Number">${data.deliveriesCatchment || 0}</Data></Cell><Cell ss:StyleID="${getIntrapartumColor('DELIVERIES', data.deliveriesCoverage || 0) === 'green' ? 'Green' : (getIntrapartumColor('DELIVERIES', data.deliveriesCoverage || 0) === 'yellow' ? 'Yellow' : 'Red')}"><Data ss:Type="Number">${data.deliveriesCoverage || 0}</Data></Cell></Row>
    <Row><Cell><Data ss:Type="String">Low Birth Weight</Data></Cell><Cell><Data ss:Type="Number">${data.liveBirthsLBW || 0}</Data></Cell><Cell><Data ss:Type="Number">${data.liveBirthsTotal || 0}</Data></Cell><Cell ss:StyleID="${getIntrapartumColor('LBW', data.lbwRate || 0) === 'green' ? 'Green' : (getIntrapartumColor('LBW', data.lbwRate || 0) === 'yellow' ? 'Yellow' : 'Red')}"><Data ss:Type="Number">${data.lbwRate || 0}</Data></Cell></Row>
    <Row><Cell><Data ss:Type="String">KMC Initiated</Data></Cell><Cell><Data ss:Type="Number">${data.kmcInitiated || 0}</Data></Cell><Cell><Data ss:Type="Number">${data.liveBirthsLBW || 0}</Data></Cell><Cell ss:StyleID="${getIntrapartumColor('KMC', data.kmcRate || 0) === 'green' ? 'Green' : (getIntrapartumColor('KMC', data.kmcRate || 0) === 'yellow' ? 'Yellow' : 'Red')}"><Data ss:Type="Number">${data.kmcRate || 0}</Data></Cell></Row>
    <Row><Cell><Data ss:Type="String">Birth Asphyxia</Data></Cell><Cell><Data ss:Type="Number">${data.birthAsphyxia || 0}</Data></Cell><Cell><Data ss:Type="Number">${data.totalDeliveries || 0}</Data></Cell><Cell ss:StyleID="${getIntrapartumColor('ASPHYXIA', data.asphyxiaRate || 0) === 'green' ? 'Green' : (getIntrapartumColor('ASPHYXIA', data.asphyxiaRate || 0) === 'yellow' ? 'Yellow' : 'Red')}"><Data ss:Type="Number">${data.asphyxiaRate || 0}</Data></Cell></Row>
    <Row><Cell><Data ss:Type="String">Resuscitation Rate</Data></Cell><Cell><Data ss:Type="Number">${data.resuscitated || 0}</Data></Cell><Cell><Data ss:Type="Number">${data.birthAsphyxia || 0}</Data></Cell><Cell ss:StyleID="${getIntrapartumColor('RESUSCITATION', data.resuscitationRate || 0) === 'green' ? 'Green' : (getIntrapartumColor('RESUSCITATION', data.resuscitationRate || 0) === 'yellow' ? 'Yellow' : 'Red')}"><Data ss:Type="Number">${data.resuscitationRate || 0}</Data></Cell></Row>
    <Row><Cell><Data ss:Type="String">Fresh Still Births (per 1000)</Data></Cell><Cell><Data ss:Type="Number">${data.freshStillBirth || 0}</Data></Cell><Cell><Data ss:Type="Number">${data.totalDeliveries || 0}</Data></Cell><Cell ss:StyleID="${getIntrapartumColor('FRESH_STILL', data.freshStillRate || 0) === 'green' ? 'Green' : (getIntrapartumColor('FRESH_STILL', data.freshStillRate || 0) === 'yellow' ? 'Yellow' : 'Red')}"><Data ss:Type="Number">${data.freshStillRate || 0}</Data></Cell></Row>
    <Row><Cell><Data ss:Type="String">Neonatal Mortality (per 1000)</Data></Cell><Cell><Data ss:Type="Number">${(data.newbornDeaths0_7 || 0) + (data.newbornDeaths8_28 || 0)}</Data></Cell><Cell><Data ss:Type="Number">${data.liveBirthsTotal || 0}</Data></Cell><Cell ss:StyleID="${getIntrapartumColor('NEONATAL', data.neonatalMortality || 0) === 'green' ? 'Green' : (getIntrapartumColor('NEONATAL', data.neonatalMortality || 0) === 'yellow' ? 'Yellow' : 'Red')}"><Data ss:Type="Number">${data.neonatalMortality || 0}</Data></Cell></Row>
    <Row><Cell><Data ss:Type="String">Perinatal Mortality (per 1000)</Data></Cell><Cell><Data ss:Type="Number">${(data.freshStillBirth || 0) + (data.newbornDeaths0_7 || 0) + (data.maceratedStillBirth || 0)}</Data></Cell><Cell><Data ss:Type="Number">${data.liveBirthsTotal || 0}</Data></Cell><Cell ss:StyleID="${getIntrapartumColor('PERINATAL', data.perinatalMortality || 0) === 'green' ? 'Green' : (getIntrapartumColor('PERINATAL', data.perinatalMortality || 0) === 'yellow' ? 'Yellow' : 'Red')}"><Data ss:Type="Number">${data.perinatalMortality || 0}</Data></Cell></Row>
    <Row><Cell><Data ss:Type="String">Maternal Mortality (per 100,000)</Data></Cell><Cell><Data ss:Type="Number">${data.maternalDeaths || 0}</Data></Cell><Cell><Data ss:Type="Number">${data.liveBirthsTotal || 0}</Data></Cell><Cell ss:StyleID="${getIntrapartumColor('MMR', data.maternalMortalityRatio || 0) === 'green' ? 'Green' : (getIntrapartumColor('MMR', data.maternalMortalityRatio || 0) === 'yellow' ? 'Yellow' : 'Red')}"><Data ss:Type="Number">${data.maternalMortalityRatio || 0}</Data></Cell></Row>
</Table>
</Worksheet>
</Workbook>`;
            
            const blob = new Blob([xml], { type: 'application/vnd.ms-excel' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `Intrapartum_${data.orgUnit || 'data'}_${new Date().toISOString().split('T')[0]}.xls`;
            link.click();
        }

        function downloadIntrapartumJPG() {
            downloadChartAsJPG('intrapartumSection', 'Intrapartum_Indicators');
        }

        function renderANCTable(data) {
            const tbody = document.getElementById('ancTableBody');
            tbody.innerHTML = '';

            // Get raw values from API response
            const anc1Visit = data.anc1Visit || 0;
            const anc1stTri = data.anc1stTrimester || 0;
            const anc4 = data.anc4 || 0;
            const anc8 = data.anc8 || 0;
            const ipt3 = data.ipt3 || 0;
            const hbTest = data.hbTest || 0;
            const llin = data.llin || 0;
            const ironFolic = data.ironFolic || 0;
            const teenUnder15 = data.teenUnder15 || 0;
            const teen15_19 = data.teen15_19 || 0;

            // Update global ANC catchment from API if available
            if (data.ancCatchment) {
                ancCatchment = data.ancCatchment;
                document.getElementById('ancCatchment').textContent = ancCatchment.toLocaleString();
            }

            // Use calculated values from API (backend does the calculations)
            const anc1Coverage = data.anc1Coverage || 0;
            const anc1stTriRate = data.anc1stTriRate || 0;
            const anc4Coverage = data.anc4Coverage || 0;
            const anc8Coverage = data.anc8Coverage || 0;
            const ipt3Coverage = data.ipt3Coverage || 0;
            const hbTestRate = data.hbTestRate || 0;
            const llinRate = data.llinRate || 0;
            const ironFolicRate = data.ironFolicRate || 0;
            const teenPregRate = data.teenPregRate || 0;

            // Define all indicators with their formulas
            const indicators = [
                // Population-based indicators (denominator = ANC catchment)
                { 
                    name: 'ANC 1st Visit Coverage', 
                    numerator: anc1Visit, 
                    denominator: ancCatchment,
                    formula: 'ANC 1st Visit √∑ ANC Catchment √ó 100',
                    coverage: anc1Coverage, 
                    targetPct: 100, 
                    indicator: 'ANC_1ST_VISIT' 
                },
                // Non-population based (denominator = ANC 1st Visit)
                { 
                    name: 'ANC 1st Trimester Rate', 
                    numerator: anc1stTri, 
                    denominator: anc1Visit,
                    formula: 'ANC 1st Tri √∑ ANC 1st Visit √ó 100',
                    coverage: anc1stTriRate, 
                    targetPct: 45, 
                    indicator: 'ANC_1ST_TRIMESTER' 
                },
                // Population-based
                { 
                    name: 'ANC 4th Visit Coverage', 
                    numerator: anc4, 
                    denominator: ancCatchment,
                    formula: 'ANC 4th Visit √∑ ANC Catchment √ó 100',
                    coverage: anc4Coverage, 
                    targetPct: 75, 
                    indicator: 'ANC_4TH_VISIT' 
                },
                { 
                    name: 'ANC 8+ Visits Coverage', 
                    numerator: anc8, 
                    denominator: ancCatchment,
                    formula: 'ANC 8+ Visits √∑ ANC Catchment √ó 100',
                    coverage: anc8Coverage, 
                    targetPct: 20, 
                    indicator: 'ANC_8TH_VISIT' 
                },
                { 
                    name: 'IPT3 Coverage', 
                    numerator: ipt3, 
                    denominator: ancCatchment,
                    formula: 'IPT3 Recipients √∑ ANC Catchment √ó 100',
                    coverage: ipt3Coverage, 
                    targetPct: 80, 
                    indicator: 'IPT3' 
                },
                // Non-population based (denominator = ANC 1st Visit)
                { 
                    name: 'Hb Testing at 1st Contact', 
                    numerator: hbTest, 
                    denominator: anc1Visit,
                    formula: 'Hb Tests √∑ ANC 1st Visit √ó 100',
                    coverage: hbTestRate, 
                    targetPct: 75, 
                    indicator: 'HB_TEST' 
                },
                { 
                    name: 'LLIN at ANC 1', 
                    numerator: llin, 
                    denominator: anc1Visit,
                    formula: 'LLINs Given √∑ ANC 1st Visit √ó 100',
                    coverage: llinRate, 
                    targetPct: 80, 
                    indicator: 'LLIN' 
                },
                { 
                    name: 'Iron/Folic Acid (30+ tablets)', 
                    numerator: ironFolic, 
                    denominator: anc1Visit,
                    formula: 'IFA Recipients √∑ ANC 1st Visit √ó 100',
                    coverage: ironFolicRate, 
                    targetPct: 75, 
                    indicator: 'IRON_FOLIC' 
                },
                { 
                    name: 'Teenage Pregnancies', 
                    numerator: teenUnder15 + teen15_19, 
                    denominator: anc1Visit,
                    formula: '(ANC <15yrs + ANC 15-19yrs) √∑ ANC 1st Visit √ó 100',
                    coverage: teenPregRate, 
                    targetPct: 13, 
                    indicator: 'TEEN_PREG' 
                },
            ];

            indicators.forEach(ind => {
                const row = tbody.insertRow();
                
                // Indicator name
                row.insertCell().textContent = ind.name;
                
                // Numerator (raw value)
                row.insertCell().textContent = ind.numerator.toLocaleString();
                
                // Denominator
                row.insertCell().textContent = ind.denominator > 0 ? ind.denominator.toLocaleString() : 'N/A';
                
                // Coverage/Rate with color coding
                const coverageCell = row.insertCell();
                if (ind.denominator > 0 && ind.coverage > 0) {
                    coverageCell.textContent = ind.coverage + '%';
                    coverageCell.className = getColorClass(parseFloat(ind.coverage), ind.indicator);
                } else if (ind.denominator === 0) {
                    coverageCell.textContent = 'Enter Population';
                    coverageCell.style.fontStyle = 'italic';
                    coverageCell.style.color = '#888';
                } else {
                    coverageCell.textContent = '0%';
                    coverageCell.className = 'cell-red';
                }
                
                // Target
                const targetText = ind.indicator === 'TEEN_PREG' ? `‚â§${ind.targetPct}%` : `‚â•${ind.targetPct}%`;
                row.insertCell().textContent = targetText;
                
                // Status
                const statusCell = row.insertCell();
                if (ind.denominator === 0) {
                    statusCell.textContent = '‚è≥ Awaiting';
                } else {
                    const colorClass = getColorClass(parseFloat(ind.coverage), ind.indicator);
                    if (colorClass === 'cell-green') statusCell.textContent = '‚úÖ Met';
                    else if (colorClass === 'cell-yellow') statusCell.textContent = '‚ö†Ô∏è Near';
                    else statusCell.textContent = '‚ùå Below';
                }
            });

            // Show debug info in console
            console.log('üìä ANC Data Loaded:', {
                orgUnit: data.orgUnit,
                population: data.population,
                ancCatchment: data.ancCatchment,
                dataElementsFound: data.dataElementsFound,
                rowsReturned: data.rowsReturned
            });
        }

        function renderCharts(data) {
            // Destroy existing charts
            Object.values(chartInstances).forEach(chart => chart.destroy());
            chartInstances = {};

            // Helper function to get color based on value and indicator
            function getChartColor(value, indicator) {
                const colorClass = getColorClass(value, indicator);
                if (colorClass === 'cell-green') return '#22c55e';
                if (colorClass === 'cell-yellow') return '#eab308';
                return '#ef4444';
            }

            // Coverage data with color coding
            const coverageData = [
                { label: 'ANC 1', value: data.anc1Coverage || 0, indicator: 'ANC_1ST_VISIT', target: 100 },
                { label: 'ANC 1st Tri', value: data.anc1stTriRate || 0, indicator: 'ANC_1ST_TRIMESTER', target: 45 },
                { label: 'ANC 4', value: data.anc4Coverage || 0, indicator: 'ANC_4TH_VISIT', target: 75 },
                { label: 'ANC 8', value: data.anc8Coverage || 0, indicator: 'ANC_8TH_VISIT', target: 20 }
            ];

            const coverageColors = coverageData.map(d => getChartColor(d.value, d.indicator));

            // Coverage Chart
            const ctx1 = document.getElementById('coverageChart').getContext('2d');
            chartInstances.coverage = new Chart(ctx1, {
                type: 'bar',
                data: {
                    labels: coverageData.map(d => d.label),
                    datasets: [{
                        label: 'Coverage (%)',
                        data: coverageData.map(d => d.value),
                        backgroundColor: coverageColors,
                        borderColor: coverageColors.map(c => c),
                        borderWidth: 2
                    }, {
                        label: 'Target',
                        data: coverageData.map(d => d.target),
                        type: 'line',
                        borderColor: '#64748b',
                        borderWidth: 2,
                        borderDash: [5, 5],
                        pointRadius: 0,
                        fill: false
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { 
                            display: true,
                            position: 'top'
                        },
                        datalabels: {
                            display: true,
                            anchor: 'end',
                            align: 'top',
                            color: '#fff',
                            backgroundColor: function(context) {
                                return context.dataset.backgroundColor ? context.dataset.backgroundColor[context.dataIndex] : '#64748b';
                            },
                            borderRadius: 4,
                            padding: 4,
                            font: { weight: 'bold', size: 11 },
                            formatter: function(value) {
                                return value.toFixed(1) + '%';
                            }
                        }
                    },
                    scales: {
                        y: { 
                            beginAtZero: true, 
                            max: 150,
                            title: { display: true, text: 'Percentage (%)' }
                        }
                    }
                },
                plugins: [ChartDataLabels]
            });

            // Create coverage legend
            const coverageLegend = document.getElementById('coverageLegend');
            coverageLegend.innerHTML = coverageData.map((d, i) => {
                const status = getColorClass(d.value, d.indicator) === 'cell-green' ? '‚úì' : 
                              getColorClass(d.value, d.indicator) === 'cell-yellow' ? '‚ö†' : '‚úó';
                return `<span style="display: inline-flex; align-items: center; gap: 4px; padding: 4px 8px; background: ${coverageColors[i]}; color: white; border-radius: 4px; font-size: 11px; font-weight: bold;">
                    ${d.label}: ${d.value.toFixed(1)}% ${status}
                </span>`;
            }).join('');

            // Quality data with color coding
            const qualityData = [
                { label: 'IPT3', value: data.ipt3Coverage || 0, indicator: 'IPT3', target: 80 },
                { label: 'Hb Test', value: data.hbTestRate || 0, indicator: 'HB_TEST', target: 75 },
                { label: 'LLIN', value: data.llinRate || 0, indicator: 'LLIN', target: 80 },
                { label: 'Iron/Folic', value: data.ironFolicRate || 0, indicator: 'IRON_FOLIC', target: 75 },
                { label: 'Teen Preg', value: data.teenPregRate || 0, indicator: 'TEEN_PREG', target: 13 }
            ];

            const qualityColors = qualityData.map(d => getChartColor(d.value, d.indicator));

            // Quality Chart - Horizontal Bar for better visualization
            const ctx2 = document.getElementById('qualityChart').getContext('2d');
            chartInstances.quality = new Chart(ctx2, {
                type: 'bar',
                data: {
                    labels: qualityData.map(d => d.label),
                    datasets: [{
                        label: 'Performance (%)',
                        data: qualityData.map(d => d.value),
                        backgroundColor: qualityColors,
                        borderColor: qualityColors,
                        borderWidth: 2
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        datalabels: {
                            display: true,
                            anchor: 'end',
                            align: 'right',
                            color: '#fff',
                            backgroundColor: function(context) {
                                return context.dataset.backgroundColor[context.dataIndex];
                            },
                            borderRadius: 4,
                            padding: 4,
                            font: { weight: 'bold', size: 11 },
                            formatter: function(value) {
                                return value.toFixed(1) + '%';
                            }
                        }
                    },
                    scales: {
                        x: { 
                            beginAtZero: true, 
                            max: 120,
                            title: { display: true, text: 'Percentage (%)' }
                        }
                    }
                },
                plugins: [ChartDataLabels]
            });

            // Create quality legend
            const qualityLegend = document.getElementById('qualityLegend');
            qualityLegend.innerHTML = qualityData.map((d, i) => {
                const status = getColorClass(d.value, d.indicator) === 'cell-green' ? '‚úì On Target' : 
                              getColorClass(d.value, d.indicator) === 'cell-yellow' ? '‚ö† Needs Work' : '‚úó Below Target';
                return `<span style="display: inline-flex; align-items: center; gap: 4px; padding: 4px 8px; background: ${qualityColors[i]}; color: ${qualityColors[i] === '#eab308' ? '#000' : '#fff'}; border-radius: 4px; font-size: 10px; font-weight: bold;">
                    ${d.label}: ${status}
                </span>`;
            }).join('');
        }

        // Download chart as JPG
        async function downloadChartAsJPG(chartCardId, filename) {
            const cardElement = document.getElementById(chartCardId);
            if (!cardElement) {
                alert('Chart not found');
                return;
            }

            try {
                // Get the chart canvas element
                const canvasElement = cardElement.querySelector('canvas');
                if (!canvasElement) {
                    alert('Chart canvas not found');
                    return;
                }

                // Create a new canvas to combine everything
                const finalCanvas = document.createElement('canvas');
                const ctx = finalCanvas.getContext('2d');
                
                // Set dimensions (add padding for title and legend)
                const padding = 60;
                const legendHeight = 80;
                finalCanvas.width = canvasElement.width + (padding * 2);
                finalCanvas.height = canvasElement.height + (padding * 2) + legendHeight;
                
                // Fill white background
                ctx.fillStyle = '#ffffff';
                ctx.fillRect(0, 0, finalCanvas.width, finalCanvas.height);
                
                // Add title
                ctx.fillStyle = '#1e293b';
                ctx.font = 'bold 24px Arial';
                ctx.textAlign = 'center';
                const title = cardElement.querySelector('h3').textContent;
                ctx.fillText(title, finalCanvas.width / 2, 40);
                
                // Add organization unit name
                ctx.font = '16px Arial';
                ctx.fillStyle = '#64748b';
                ctx.fillText(currentData?.orgUnit || 'N/A', finalCanvas.width / 2, 65);
                
                // Draw the chart canvas
                ctx.drawImage(canvasElement, padding, padding + 30, canvasElement.width, canvasElement.height);
                
                // Add legend at bottom
                const legendElement = cardElement.querySelector('div[id$="Legend"]');
                if (legendElement) {
                    const legendItems = legendElement.querySelectorAll('span');
                    let yPos = canvasElement.height + padding + 50;
                    let xPos = padding;
                    
                    legendItems.forEach((item, index) => {
                        const text = item.textContent;
                        const bgColor = window.getComputedStyle(item).backgroundColor;
                        const color = window.getComputedStyle(item).color;
                        
                        // Draw legend box
                        ctx.fillStyle = bgColor;
                        ctx.fillRect(xPos, yPos, 15, 15);
                        
                        // Draw legend text
                        ctx.fillStyle = '#1e293b';
                        ctx.font = '12px Arial';
                        ctx.textAlign = 'left';
                        ctx.fillText(text, xPos + 20, yPos + 12);
                        
                        xPos += 180;
                        if (xPos > finalCanvas.width - 180) {
                            xPos = padding;
                            yPos += 25;
                        }
                    });
                }
                
                // Add footer
                ctx.fillStyle = '#94a3b8';
                ctx.font = '11px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(`Generated: ${new Date().toLocaleString()} | Source: Uganda HMIS`, finalCanvas.width / 2, finalCanvas.height - 15);
                
                // Convert to JPG and download
                finalCanvas.toBlob((blob) => {
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    const orgName = (currentData?.orgUnit || 'Chart').replace(/[^a-zA-Z0-9]/g, '_');
                    link.download = `${filename}_${orgName}_${new Date().toISOString().split('T')[0]}.jpg`;
                    link.href = url;
                    link.click();
                    URL.revokeObjectURL(url);
                }, 'image/jpeg', 0.95);
                
            } catch (error) {
                console.error('Error downloading chart:', error);
                alert('Error downloading chart. Please try again.');
            }
        }

        function applyAdjustments() {
            const overrideCatchment = parseInt(document.getElementById('overrideCatchment').value);
            const overridePopulation = parseInt(document.getElementById('overridePopulation').value);
            
            if (overrideCatchment) {
                ancCatchment = overrideCatchment;
            } else if (overridePopulation) {
                ancCatchment = Math.round(overridePopulation * 0.05);
            }
            
            document.getElementById('ancCatchment').textContent = ancCatchment.toLocaleString();
            
            if (currentData) {
                renderANCTable(currentData);
            }
            
            alert('Adjustments applied! Click "Load Data" to recalculate with new parameters.');
        }

        async function clearCache() {
            try {
                await fetch('/api/clear-cache', { method: 'POST' });
                alert('Cache cleared successfully!');
            } catch (error) {
                console.error('Error clearing cache:', error);
            }
        }

        function downloadExcel() {
            if (!currentData) {
                alert('Please load data first');
                return;
            }
            
            // Get the table data
            const anc1 = currentData.anc1Visit || 0;
            const ancCatch = currentData.ancCatchment || ancCatchment || 0;
            
            // Build the data array with all indicators
            const indicators = [
                { name: 'ANC 1st Visit Coverage', numerator: currentData.anc1Visit || 0, denominator: ancCatch, coverage: currentData.anc1Coverage || 0, target: '‚â•100%', indicator: 'ANC_1ST_VISIT' },
                { name: 'ANC 1st Trimester Rate', numerator: currentData.anc1stTrimester || 0, denominator: anc1, coverage: currentData.anc1stTriRate || 0, target: '‚â•45%', indicator: 'ANC_1ST_TRIMESTER' },
                { name: 'ANC 4th Visit Coverage', numerator: currentData.anc4 || 0, denominator: ancCatch, coverage: currentData.anc4Coverage || 0, target: '‚â•75%', indicator: 'ANC_4TH_VISIT' },
                { name: 'ANC 8+ Visits Coverage', numerator: currentData.anc8 || 0, denominator: ancCatch, coverage: currentData.anc8Coverage || 0, target: '‚â•20%', indicator: 'ANC_8TH_VISIT' },
                { name: 'IPT3 Coverage', numerator: currentData.ipt3 || 0, denominator: ancCatch, coverage: currentData.ipt3Coverage || 0, target: '‚â•80%', indicator: 'IPT3' },
                { name: 'Hb Testing at 1st Contact', numerator: currentData.hbTest || 0, denominator: anc1, coverage: currentData.hbTestRate || 0, target: '‚â•75%', indicator: 'HB_TEST' },
                { name: 'LLIN at ANC 1', numerator: currentData.llin || 0, denominator: anc1, coverage: currentData.llinRate || 0, target: '‚â•80%', indicator: 'LLIN' },
                { name: 'Iron/Folic Acid', numerator: currentData.ironFolic || 0, denominator: anc1, coverage: currentData.ironFolicRate || 0, target: '‚â•75%', indicator: 'IRON_FOLIC' },
                { name: 'Teenage Pregnancies', numerator: (currentData.teenUnder15 || 0) + (currentData.teen15_19 || 0), denominator: anc1, coverage: currentData.teenPregRate || 0, target: '‚â§13%', indicator: 'TEEN_PREG' }
            ];
            
            // Create Excel XML Spreadsheet format
            let xml = `<?xml version="1.0" encoding="UTF-8"?>
<?mso-application progid="Excel.Sheet"?>
<Workbook xmlns="urn:schemas-microsoft-com:office:spreadsheet"
 xmlns:o="urn:schemas-microsoft-com:office:office"
 xmlns:x="urn:schemas-microsoft-com:office:excel"
 xmlns:ss="urn:schemas-microsoft-com:office:spreadsheet">
 <Styles>
  <Style ss:ID="Default" ss:Name="Normal">
   <Alignment ss:Vertical="Center"/>
   <Font ss:FontName="Arial" ss:Size="10"/>
  </Style>
  <Style ss:ID="Header">
   <Alignment ss:Horizontal="Center" ss:Vertical="Center"/>
   <Font ss:FontName="Arial" ss:Size="11" ss:Bold="1" ss:Color="#FFFFFF"/>
   <Interior ss:Color="#1E293B" ss:Pattern="Solid"/>
   <Borders>
    <Border ss:Position="Bottom" ss:LineStyle="Continuous" ss:Weight="1"/>
    <Border ss:Position="Left" ss:LineStyle="Continuous" ss:Weight="1"/>
    <Border ss:Position="Right" ss:LineStyle="Continuous" ss:Weight="1"/>
    <Border ss:Position="Top" ss:LineStyle="Continuous" ss:Weight="1"/>
   </Borders>
  </Style>
  <Style ss:ID="Title">
   <Font ss:FontName="Arial" ss:Size="14" ss:Bold="1"/>
  </Style>
  <Style ss:ID="Info">
   <Font ss:FontName="Arial" ss:Size="10"/>
  </Style>
  <Style ss:ID="TextBold">
   <Alignment ss:Vertical="Center"/>
   <Font ss:FontName="Arial" ss:Size="10" ss:Bold="1"/>
   <Borders>
    <Border ss:Position="Bottom" ss:LineStyle="Continuous" ss:Weight="1"/>
    <Border ss:Position="Left" ss:LineStyle="Continuous" ss:Weight="1"/>
    <Border ss:Position="Right" ss:LineStyle="Continuous" ss:Weight="1"/>
    <Border ss:Position="Top" ss:LineStyle="Continuous" ss:Weight="1"/>
   </Borders>
  </Style>
  <Style ss:ID="Number">
   <Alignment ss:Horizontal="Center" ss:Vertical="Center"/>
   <Font ss:FontName="Arial" ss:Size="10"/>
   <NumberFormat ss:Format="#,##0"/>
   <Borders>
    <Border ss:Position="Bottom" ss:LineStyle="Continuous" ss:Weight="1"/>
    <Border ss:Position="Left" ss:LineStyle="Continuous" ss:Weight="1"/>
    <Border ss:Position="Right" ss:LineStyle="Continuous" ss:Weight="1"/>
    <Border ss:Position="Top" ss:LineStyle="Continuous" ss:Weight="1"/>
   </Borders>
  </Style>
  <Style ss:ID="Green">
   <Alignment ss:Horizontal="Center" ss:Vertical="Center"/>
   <Font ss:FontName="Arial" ss:Size="10" ss:Bold="1" ss:Color="#FFFFFF"/>
   <Interior ss:Color="#22C55E" ss:Pattern="Solid"/>
   <Borders>
    <Border ss:Position="Bottom" ss:LineStyle="Continuous" ss:Weight="1"/>
    <Border ss:Position="Left" ss:LineStyle="Continuous" ss:Weight="1"/>
    <Border ss:Position="Right" ss:LineStyle="Continuous" ss:Weight="1"/>
    <Border ss:Position="Top" ss:LineStyle="Continuous" ss:Weight="1"/>
   </Borders>
  </Style>
  <Style ss:ID="Yellow">
   <Alignment ss:Horizontal="Center" ss:Vertical="Center"/>
   <Font ss:FontName="Arial" ss:Size="10" ss:Bold="1" ss:Color="#000000"/>
   <Interior ss:Color="#EAB308" ss:Pattern="Solid"/>
   <Borders>
    <Border ss:Position="Bottom" ss:LineStyle="Continuous" ss:Weight="1"/>
    <Border ss:Position="Left" ss:LineStyle="Continuous" ss:Weight="1"/>
    <Border ss:Position="Right" ss:LineStyle="Continuous" ss:Weight="1"/>
    <Border ss:Position="Top" ss:LineStyle="Continuous" ss:Weight="1"/>
   </Borders>
  </Style>
  <Style ss:ID="Red">
   <Alignment ss:Horizontal="Center" ss:Vertical="Center"/>
   <Font ss:FontName="Arial" ss:Size="10" ss:Bold="1" ss:Color="#FFFFFF"/>
   <Interior ss:Color="#EF4444" ss:Pattern="Solid"/>
   <Borders>
    <Border ss:Position="Bottom" ss:LineStyle="Continuous" ss:Weight="1"/>
    <Border ss:Position="Left" ss:LineStyle="Continuous" ss:Weight="1"/>
    <Border ss:Position="Right" ss:LineStyle="Continuous" ss:Weight="1"/>
    <Border ss:Position="Top" ss:LineStyle="Continuous" ss:Weight="1"/>
   </Borders>
  </Style>
  <Style ss:ID="Center">
   <Alignment ss:Horizontal="Center" ss:Vertical="Center"/>
   <Font ss:FontName="Arial" ss:Size="10"/>
   <Borders>
    <Border ss:Position="Bottom" ss:LineStyle="Continuous" ss:Weight="1"/>
    <Border ss:Position="Left" ss:LineStyle="Continuous" ss:Weight="1"/>
    <Border ss:Position="Right" ss:LineStyle="Continuous" ss:Weight="1"/>
    <Border ss:Position="Top" ss:LineStyle="Continuous" ss:Weight="1"/>
   </Borders>
  </Style>
 </Styles>
 <Worksheet ss:Name="ANC Indicators">
  <Table ss:DefaultColumnWidth="100">
   <Column ss:Width="180"/>
   <Column ss:Width="100"/>
   <Column ss:Width="100"/>
   <Column ss:Width="100"/>
   <Column ss:Width="80"/>
   <Column ss:Width="140"/>
   <Row>
    <Cell ss:StyleID="Title"><Data ss:Type="String">ANC Quality Indicators - ${currentData.orgUnit || 'Unknown'}</Data></Cell>
   </Row>
   <Row>
    <Cell ss:StyleID="Info"><Data ss:Type="String">Period: ${currentData.period || 'N/A'}</Data></Cell>
   </Row>
   <Row>
    <Cell ss:StyleID="Info"><Data ss:Type="String">Population: ${(currentData.population || 0).toLocaleString()}</Data></Cell>
   </Row>
   <Row>
    <Cell ss:StyleID="Info"><Data ss:Type="String">ANC Catchment (5%): ${(currentData.ancCatchment || ancCatch).toLocaleString()}</Data></Cell>
   </Row>
   <Row></Row>
   <Row>
    <Cell ss:StyleID="Header"><Data ss:Type="String">Indicator</Data></Cell>
    <Cell ss:StyleID="Header"><Data ss:Type="String">Numerator</Data></Cell>
    <Cell ss:StyleID="Header"><Data ss:Type="String">Denominator</Data></Cell>
    <Cell ss:StyleID="Header"><Data ss:Type="String">Coverage (%)</Data></Cell>
    <Cell ss:StyleID="Header"><Data ss:Type="String">Target</Data></Cell>
    <Cell ss:StyleID="Header"><Data ss:Type="String">Status</Data></Cell>
   </Row>`;
            
            indicators.forEach(ind => {
                const colorClass = getColorClass(ind.coverage, ind.indicator);
                // Map cell-* classes to Excel style IDs
                const styleId = colorClass === 'cell-green' ? 'Green' : 
                               colorClass === 'cell-yellow' ? 'Yellow' : 'Red';
                const status = getStatusText(ind.coverage, ind.indicator);
                
                // Debug logging
                console.log(`Excel: ${ind.name} - Coverage: ${ind.coverage}%, Indicator: ${ind.indicator}, ColorClass: ${colorClass}, StyleId: ${styleId}`);
                
                xml += `
   <Row>
    <Cell ss:StyleID="TextBold"><Data ss:Type="String">${ind.name}</Data></Cell>
    <Cell ss:StyleID="Number"><Data ss:Type="Number">${ind.numerator}</Data></Cell>
    <Cell ss:StyleID="Number"><Data ss:Type="Number">${ind.denominator}</Data></Cell>
    <Cell ss:StyleID="${styleId}"><Data ss:Type="String">${ind.coverage.toFixed(1)}%</Data></Cell>
    <Cell ss:StyleID="Center"><Data ss:Type="String">${ind.target}</Data></Cell>
    <Cell ss:StyleID="${styleId}"><Data ss:Type="String">${status}</Data></Cell>
   </Row>`;
            });
            
            xml += `
   <Row></Row>
   <Row>
    <Cell ss:StyleID="Title"><Data ss:Type="String">Performance Legend</Data></Cell>
   </Row>
   <Row>
    <Cell ss:StyleID="Green"><Data ss:Type="String">GREEN</Data></Cell>
    <Cell ss:StyleID="Info"><Data ss:Type="String">Target Achieved</Data></Cell>
   </Row>
   <Row>
    <Cell ss:StyleID="Yellow"><Data ss:Type="String">YELLOW</Data></Cell>
    <Cell ss:StyleID="Info"><Data ss:Type="String">Needs Improvement</Data></Cell>
   </Row>
   <Row>
    <Cell ss:StyleID="Red"><Data ss:Type="String">RED</Data></Cell>
    <Cell ss:StyleID="Info"><Data ss:Type="String">Below Target</Data></Cell>
   </Row>
   <Row></Row>
   <Row>
    <Cell ss:StyleID="Info"><Data ss:Type="String">Generated: ${new Date().toLocaleString()}</Data></Cell>
   </Row>
   <Row>
    <Cell ss:StyleID="Info"><Data ss:Type="String">Source: Uganda HMIS (DHIS2)</Data></Cell>
   </Row>
  </Table>
 </Worksheet>
</Workbook>`;
            
            // Create downloadable file
            const blob = new Blob([xml], { type: 'application/vnd.ms-excel' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            const orgName = (currentData.orgUnit || 'ANC_Data').replace(/[^a-zA-Z0-9]/g, '_');
            a.href = url;
            a.download = `ANC_Indicators_${orgName}_${new Date().toISOString().split('T')[0]}.xls`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        function getStatusText(coverage, indicator) {
            const colorClass = getColorClass(coverage, indicator);
            if (colorClass === 'cell-green') return '‚úì On Target';
            if (colorClass === 'cell-yellow') return '‚ö† Needs Improvement';
            return '‚úó Below Target';
        }

        async function loadLeagueTable() {
            const selectedOptions = Array.from(document.getElementById('leagueUnitsSelect').selectedOptions);
            
            if (selectedOptions.length < 2) {
                alert('Please select at least 2 units to compare');
                return;
            }
            
            // Check if any facilities need catchment population
            const facilitiesNeedingPopulation = selectedOptions.filter(opt => opt.dataset.level > 3);
            
            if (facilitiesNeedingPopulation.length > 0) {
                const container = document.getElementById('catchmentInputsContainer');
                container.innerHTML = '';
                
                facilitiesNeedingPopulation.forEach(opt => {
                    const div = document.createElement('div');
                    div.className = 'filter-group';
                    div.innerHTML = `
                        <label>${opt.text}</label>
                        <input type="number" class="facility-population" data-unit-id="${opt.value}" placeholder="Enter population" min="0">
                    `;
                    container.appendChild(div);
                });
                
                document.getElementById('facilityCatchmentInputs').classList.remove('hidden');
            } else {
                calculateLeague();
            }
        }

        async function calculateLeague() {
            // League table calculation implementation
            alert('League table calculation in progress...');
            document.getElementById('leagueTableDisplay').classList.remove('hidden');
        }

        // Population Modal Functions
        function showPopulationModal(facilityName) {
            document.getElementById('modalFacilityName').textContent = facilityName;
            document.getElementById('modalPopulationInput').value = '';
            document.getElementById('modalStartDate').value = '';
            document.getElementById('modalEndDate').value = '';
            document.getElementById('modalCalculationPreview').style.display = 'none';
            
            // Set default dates (current month for end, 12 months ago for start)
            const now = new Date();
            const endMonth = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
            const startDate = new Date(now.getFullYear(), now.getMonth() - 11, 1);
            const startMonth = `${startDate.getFullYear()}-${String(startDate.getMonth() + 1).padStart(2, '0')}`;
            
            document.getElementById('modalStartDate').value = startMonth;
            document.getElementById('modalEndDate').value = endMonth;
            
            // Add event listeners for live preview
            document.getElementById('modalPopulationInput').oninput = updateModalPreview;
            document.getElementById('modalStartDate').onchange = updateModalPreview;
            document.getElementById('modalEndDate').onchange = updateModalPreview;
            
            // Show modal by adding the 'show' class
            const modal = document.getElementById('populationModal');
            modal.classList.add('show');
            
            // Focus on input after a brief delay
            setTimeout(() => {
                document.getElementById('modalPopulationInput').focus();
            }, 100);
        }

        function updateModalPreview() {
            const annualPop = parseInt(document.getElementById('modalPopulationInput').value) || 0;
            const startDate = document.getElementById('modalStartDate').value;
            const endDate = document.getElementById('modalEndDate').value;
            
            const previewDiv = document.getElementById('modalCalculationPreview');
            const previewText = document.getElementById('modalPreviewText');
            
            if (annualPop <= 0) {
                previewDiv.style.display = 'none';
                return;
            }
            
            let months = 12;
            let periodLabel = '12 months (full year)';
            
            if (startDate && endDate) {
                const start = new Date(startDate + '-01');
                const end = new Date(endDate + '-01');
                months = (end.getFullYear() - start.getFullYear()) * 12 + (end.getMonth() - start.getMonth()) + 1;
                
                if (months < 1) {
                    previewText.innerHTML = '<span style="color: red;">‚ö†Ô∏è End date must be after start date</span>';
                    previewDiv.style.display = 'block';
                    previewDiv.style.background = '#fef2f2';
                    return;
                }
                
                periodLabel = `${months} month${months > 1 ? 's' : ''}`;
            }
            
            const monthlyPop = Math.round(annualPop / 12);
            const periodPop = monthlyPop * months;
            const periodCatchment = Math.round(periodPop * 0.05);
            
            previewText.innerHTML = `
                Annual Population: <strong>${annualPop.toLocaleString()}</strong><br>
                Monthly Population: ${monthlyPop.toLocaleString()} (√∑ 12)<br>
                Period: <strong>${periodLabel}</strong><br>
                Period Population: ${periodPop.toLocaleString()} (√ó ${months})<br>
                <span style="font-size: 16px; color: #15803d;">ANC Catchment (5%): <strong>${periodCatchment.toLocaleString()}</strong></span>
            `;
            previewDiv.style.display = 'block';
            previewDiv.style.background = '#f0fdf4';
        }

        function closePopulationModal() {
            const modal = document.getElementById('populationModal');
            modal.classList.remove('show');
        }

        function submitPopulationModal() {
            const modalInput = document.getElementById('modalPopulationInput');
            const annualPopulation = parseInt(modalInput.value);
            const startDate = document.getElementById('modalStartDate').value;
            const endDate = document.getElementById('modalEndDate').value;
            
            if (!annualPopulation || annualPopulation <= 0) {
                alert('Please enter a valid annual population number (greater than 0)');
                modalInput.focus();
                return;
            }
            
            if (!startDate || !endDate) {
                alert('Please select both start and end dates');
                return;
            }
            
            // Calculate months in period
            const start = new Date(startDate + '-01');
            const end = new Date(endDate + '-01');
            const months = (end.getFullYear() - start.getFullYear()) * 12 + (end.getMonth() - start.getMonth()) + 1;
            
            if (months < 1) {
                alert('End date must be after or equal to start date');
                return;
            }
            
            // Calculate period catchment
            // Formula: (Annual Population / 12) √ó Months √ó 5%
            const monthlyPop = Math.round(annualPopulation / 12);
            const periodPop = monthlyPop * months;
            ancCatchment = Math.round(periodPop * 0.05);
            ubosPopulation = annualPopulation;
            
            // Store the period info for data fetching
            window.facilityPeriodInfo = {
                annualPopulation: annualPopulation,
                startDate: startDate,
                endDate: endDate,
                months: months,
                periodPopulation: periodPop,
                ancCatchment: ancCatchment
            };
            
            // Update UI
            document.getElementById('populationInput').value = annualPopulation;
            document.getElementById('startDateInput').value = startDate;
            document.getElementById('endDateInput').value = endDate;
            document.getElementById('ancCatchment').textContent = ancCatchment.toLocaleString();
            
            // Set Period dropdown to "CUSTOM" and show custom date fields
            const periodSelect = document.getElementById('periodSelect');
            periodSelect.value = 'CUSTOM';
            
            // Show the date input groups
            document.getElementById('startDateGroup').style.display = 'block';
            document.getElementById('endDateGroup').style.display = 'block';
            
            console.log(`‚úÖ Facility Period Info:`, window.facilityPeriodInfo);
            
            // Close modal
            closePopulationModal();
            
            // Show success message
            alert(`‚úÖ Population & Period Set!\n\n` +
                  `Annual Population: ${annualPopulation.toLocaleString()}\n` +
                  `Period: ${months} month${months > 1 ? 's' : ''} (${startDate} to ${endDate})\n` +
                  `Period Population: ${periodPop.toLocaleString()}\n` +
                  `ANC Catchment (5%): ${ancCatchment.toLocaleString()}\n\n` +
                  `Click "Load Data" to view indicators.`);
        }

        // Close modal when clicking outside
        document.addEventListener('click', (e) => {
            const modal = document.getElementById('populationModal');
            if (e.target === modal) {
                closePopulationModal();
            }
        });
    </script>
</body>
</html>
