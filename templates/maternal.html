<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Maternal Health (ANC) - Uganda HMIS</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.bundle.min.js"></script>
    <style>
        :root {
            --bg-primary: #fdf2f8;
            --bg-card: #ffffff;
            --text-primary: #1f2937;
            --text-secondary: #6b7280;
            --border-color: #d1d5db;
            --shadow: rgba(0, 0, 0, 0.1);
            --accent-pink: #ec4899;
            --accent-rose: #f43f5e;
        }

        [data-theme="dark"] {
            --bg-primary: #111827;
            --bg-card: #1f2937;
            --text-primary: #f9fafb;
            --text-secondary: #9ca3af;
            --border-color: #374151;
            --shadow: rgba(0, 0, 0, 0.3);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            transition: all 0.3s ease;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, var(--accent-pink) 0%, var(--accent-rose) 100%);
            color: white;
            padding: 16px 24px;
            box-shadow: 0 4px 20px var(--shadow);
            position: sticky;
            top: 0;
            z-index: 50;
        }

        [data-theme="dark"] .header {
            background: #1f2937;
            border-bottom: 2px solid #374151;
        }

        .header-content {
            max-width: 1800px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .back-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 10px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .back-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .logo {
            width: 40px;
            height: 40px;
            background: white;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        [data-theme="dark"] .logo {
            background: var(--accent-pink);
        }

        .title-container h1 {
            font-size: 18px;
            font-weight: 700;
        }

        .title-container p {
            font-size: 12px;
            opacity: 0.9;
        }

        .theme-toggle {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 10px;
            border-radius: 12px;
            cursor: pointer;
        }

        [data-theme="dark"] .theme-toggle {
            background: #fbbf24;
            color: #111827;
        }

        /* Tab Navigation */
        .tab-nav {
            background: var(--bg-card);
            border-bottom: 2px solid var(--border-color);
            position: sticky;
            top: 64px;
            z-index: 40;
            box-shadow: 0 2px 8px var(--shadow);
        }

        .tab-nav-content {
            max-width: 1800px;
            margin: 0 auto;
            padding: 12px 24px;
            display: flex;
            gap: 8px;
        }

        .tab-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            border: 2px solid #000000;
            border-radius: 12px;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
            background: #f3f4f6;
            color: #6b7280;
        }

        [data-theme="dark"] .tab-btn {
            background: #374151;
            color: #9ca3af;
            border: 2px solid #000000;
        }

        .tab-btn.active {
            background: linear-gradient(135deg, var(--accent-pink), var(--accent-rose));
            color: white;
            box-shadow: 0 4px 12px rgba(236, 72, 153, 0.3);
            border: 2px solid #000000;
        }

        /* Container */
        .container {
            max-width: 1800px;
            margin: 0 auto;
            padding: 24px;
        }

        /* Filters Card */
        .filters-card {
            background: var(--bg-card);
            padding: 20px;
            border-radius: 16px;
            margin-bottom: 24px;
            box-shadow: 0 4px 20px var(--shadow);
            border: 2px solid #000000;
        }

        .filters-card h3 {
            color: var(--text-primary);
            margin-bottom: 16px;
            font-size: 16px;
            font-weight: 700;
            border-bottom: 2px solid var(--accent-pink);
            padding-bottom: 8px;
        }

        .filters-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 16px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .filter-group label {
            font-size: 12px;
            color: var(--text-secondary);
            font-weight: 600;
            text-transform: uppercase;
        }

        .filter-group select,
        .filter-group input {
            padding: 10px;
            border: 2px solid #000000;
            border-radius: 8px;
            font-size: 14px;
            background: var(--bg-card);
            color: var(--text-primary);
            transition: all 0.3s;
        }

        .filter-group select:focus,
        .filter-group input:focus {
            border-color: var(--accent-pink);
            outline: none;
        }

        .selected-info {
            background: #fce4ec;
            padding: 12px 16px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 12px;
            margin-top: 16px;
            border: 2px solid #000000;
        }

        [data-theme="dark"] .selected-info {
            background: #4b1f3b;
        }

        .selected-info span {
            font-size: 13px;
        }

        .selected-info .highlight {
            background: var(--accent-pink);
            color: white;
            padding: 4px 12px;
            border-radius: 6px;
            font-weight: 600;
        }

        /* Buttons */
        .btn-group {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            margin-top: 16px;
        }

        .btn {
            padding: 10px 20px;
            border: 2px solid #000000;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--accent-pink), var(--accent-rose));
            color: white;
            border: 2px solid #000000;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(236, 72, 153, 0.3);
        }

        .btn-secondary {
            background: var(--bg-card);
            color: var(--text-primary);
            border: 2px solid #000000;
        }

        .btn-secondary:hover {
            background: #f3f4f6;
        }

        [data-theme="dark"] .btn-secondary:hover {
            background: #374151;
        }

        /* Loading Spinner */
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border-left-color: var(--accent-pink);
            animation: spin 1s ease infinite;
            margin: 40px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Cards */
        .card {
            background: var(--bg-card);
            border-radius: 16px;
            box-shadow: 0 4px 20px var(--shadow);
            overflow: hidden;
            margin-bottom: 24px;
            border: 2px solid #000000;
        }

        .card-header {
            background: linear-gradient(135deg, var(--accent-pink), var(--accent-rose));
            padding: 20px 24px;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .card-header h2 {
            font-size: 18px;
            font-weight: 700;
        }

        .card-header p {
            font-size: 13px;
            opacity: 0.9;
        }

        /* Table */
        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
            border: 2px solid #000000;
        }

        /* Compare Tables Styling */
        .compare-styled-table {
            border: 2px solid #1f2937;
            border-radius: 8px;
            overflow: hidden;
        }

        .compare-styled-table thead th {
            background: linear-gradient(135deg, #1f2937 0%, #374151 100%);
            color: white;
            font-weight: 600;
            padding: 12px 10px;
            text-align: center;
            border: 1px solid #4b5563;
            font-size: 12px;
        }

        .compare-styled-table tbody td {
            padding: 10px 8px;
            text-align: center;
            border: 1px solid #e5e7eb;
            font-size: 12px;
        }

        .compare-styled-table tbody tr:nth-child(even) {
            background-color: #f9fafb;
        }

        .compare-styled-table tbody tr:hover {
            background-color: #f3f4f6;
        }

        [data-theme="dark"] .compare-styled-table thead th {
            background: linear-gradient(135deg, #1e3a5f 0%, #2d4a6f 100%);
            border-color: #4b5563;
        }

        [data-theme="dark"] .compare-styled-table tbody td {
            border-color: #374151;
        }

        [data-theme="dark"] .compare-styled-table tbody tr:nth-child(even) {
            background-color: #1f2937;
        }

        [data-theme="dark"] .compare-styled-table tbody tr:hover {
            background-color: #374151;
        }

        th, td {
            padding: 12px;
            text-align: center;
            border: 2px solid #000000;
        }

        th {
            background: #f3f4f6;
            font-weight: 700;
            color: #374151;
        }

        [data-theme="dark"] th {
            background: #374151;
            color: #f3f4f6;
        }

        th:first-child, td:first-child {
            text-align: left;
        }

        tbody tr:hover {
            background: #f9fafb;
        }

        [data-theme="dark"] tbody tr:hover {
            background: #374151;
        }

        /* Color Coding */
        .cell-green {
            background-color: #10b981 !important;
            color: white !important;
            font-weight: 700;
        }

        .cell-yellow {
            background-color: #fbbf24 !important;
            color: #111827 !important;
            font-weight: 700;
        }

        .cell-red {
            background-color: #ef4444 !important;
            color: white !important;
            font-weight: 700;
        }

        /* Analysis Section */
        .analysis-section {
            background: #fef3c7;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 24px;
            border: 2px solid #000000;
        }

        [data-theme="dark"] .analysis-section {
            background: #451a03;
            border-color: #000000;
        }

        .analysis-section h3 {
            color: #92400e;
            font-size: 16px;
            margin-bottom: 12px;
        }

        [data-theme="dark"] .analysis-section h3 {
            color: #fbbf24;
        }

        .formula {
            background: white;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 10px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            border-left: 4px solid #000000;
            border: 2px solid #000000;
        }

        [data-theme="dark"] .formula {
            background: #1f2937;
            color: #f3f4f6;
        }

        .editable-formula {
            position: relative;
            transition: all 0.2s ease;
        }

        .editable-formula:hover {
            border-left-color: #f97316;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .formula-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }

        .formula-content {
            line-height: 1.6;
        }

        .formula-edit {
            margin-top: 12px;
            padding: 12px;
            background: #f9fafb;
            border-radius: 6px;
            border: 1px solid #e5e7eb;
        }

        [data-theme="dark"] .formula-edit {
            background: #111827;
            border-color: #374151;
        }

        .formula-edit label {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
            margin-right: 4px;
        }

        .formula-edit input[type="text"],
        .formula-edit input[type="number"] {
            padding: 6px 8px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
        }

        [data-theme="dark"] .formula-edit input {
            background: #1f2937;
            border-color: #4b5563;
            color: #f3f4f6;
        }

        .btn-edit {
            background: #f97316;
            color: white;
            border: none;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-edit:hover {
            background: #ea580c;
            transform: translateY(-1px);
        }

        .formula-edit.hidden {
            display: none;
        }

        .editable-formula.editing {
            border-left-color: #10b981;
            background: #f0fdf4;
        }

        [data-theme="dark"] .editable-formula.editing {
            background: #064e3b;
        }

        .adjustment-inputs {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
            margin-top: 16px;
        }

        /* League Table */
        .league-section {
            margin-top: 24px;
        }

        .league-controls {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }

        .hidden {
            display: none !important;
        }

        /* Search Dropdown */
        .search-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--bg-card);
            border: 2px solid #000000;
            border-top: none;
            border-radius: 0 0 8px 8px;
            max-height: 400px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
            box-shadow: 0 8px 20px var(--shadow);
        }

        .search-dropdown.show {
            display: block;
        }

        .search-result-item {
            padding: 12px 16px;
            cursor: pointer;
            transition: background 0.2s;
            border-bottom: 2px solid #000000;
        }

        .search-result-item:hover {
            background: #fce4ec;
        }

        [data-theme="dark"] .search-result-item:hover {
            background: #4b1f3b;
        }

        .search-result-item:last-child {
            border-bottom: none;
        }

        .search-result-name {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .search-result-path {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .search-no-results {
            padding: 20px;
            text-align: center;
            color: var(--text-secondary);
        }

        .search-loading {
            padding: 20px;
            text-align: center;
            color: var(--accent-pink);
        }

        /* Legend */
        .legend {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 2px 8px var(--shadow);
            margin-top: 24px;
            border: 2px solid #000000;
        }

        .legend-content {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 16px;
            font-size: 14px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .legend-box {
            width: 24px;
            height: 24px;
            border-radius: 4px;
        }

        /* Charts */
        .chart-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 24px;
            margin-top: 24px;
        }

        .chart-card {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 8px 24px var(--shadow);
            border: 3px solid #ec4899;
            transition: all 0.3s ease;
        }
        
        .chart-card:hover {
            box-shadow: 0 12px 32px rgba(236, 72, 153, 0.3);
            border-color: #db2777;
        }

        .chart-card h3 {
            font-size: 16px;
            font-weight: 700;
            margin-bottom: 16px;
        }

        .chart-container {
            position: relative;
            height: 300px;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .chart-grid {
                grid-template-columns: 1fr;
            }
            .filters-row {
                grid-template-columns: 1fr;
            }
        }

    </style>
</head>
<body data-theme="light">
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <div class="header-left">
                <button class="back-btn" onclick="window.location.href='/'">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M19 12H5M12 19l-7-7 7-7"/>
                    </svg>
                </button>
                <div class="logo">üíó</div>
                <div class="title-container">
                    <h1>Maternal Health Analytics - ANC</h1>
                    <p>Antenatal Care Indicators</p>
                </div>
            </div>
            <button class="theme-toggle" onclick="toggleTheme()">
                <svg id="theme-icon-sun" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="hidden">
                    <circle cx="12" cy="12" r="5"/><path d="M12 1v2m0 18v2M4.22 4.22l1.42 1.42m12.72 12.72 1.42 1.42M1 12h2m18 0h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/>
                </svg>
                <svg id="theme-icon-moon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                </svg>
            </button>
        </div>
    </header>

    <!-- Tab Navigation -->
    <nav class="tab-nav">
        <div class="tab-nav-content">
            <button class="tab-btn active" onclick="switchTab('data')">
                üìä Facility/District performance
            </button>
            <button class="tab-btn" onclick="switchTab('league')">
                üèÜ Compare Facility/District performance
            </button>
            <button class="tab-btn" onclick="switchTab('analysis')">
                üî¨ Show Calculation
            </button>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="container">
        <!-- Filters -->
        <div class="filters-card">
            <h3>üéØ Data Filters & Selection</h3>
            
            <!-- Search Organization Unit -->
            <div class="filter-group" style="margin-bottom: 20px; position: relative;">
                <label for="orgUnitSearch">üîç Quick Search for Facility or District</label>
                <input type="text" 
                       id="orgUnitSearch" 
                       placeholder="Type facility or district name (min 3 characters)..." 
                       style="padding: 12px; width: 100%; border: 2px solid var(--border-color); border-radius: 8px; font-size: 14px;"
                       oninput="handleSearchInput(event)"
                       onfocus="showSearchDropdown()"
                       autocomplete="off">
                <div id="searchDropdown" class="search-dropdown">
                    <!-- Search results will appear here -->
                </div>
            </div>

            <!-- OR Separator -->
            <div style="text-align: center; margin: 20px 0; color: var(--text-secondary); font-weight: 600;">
                ‚Äî OR Navigate Hierarchy ‚Äî
            </div>

            <!-- Hierarchical Selection -->
            <div class="filters-row">
                <div class="filter-group">
                    <label for="level2">Region</label>
                    <select id="level2" onchange="loadChildren(2)">
                        <option value="">Loading...</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="level3">District</label>
                    <select id="level3" onchange="loadChildren(3)" disabled>
                        <option>--</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="level4">County</label>
                    <select id="level4" onchange="loadChildren(4)" disabled>
                        <option>--</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="level5">Sub-county</label>
                    <select id="level5" onchange="loadChildren(5)" disabled>
                        <option>--</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="level6">Facility</label>
                    <select id="level6" onchange="selectFinalLevel(6)" disabled>
                        <option>--</option>
                    </select>
                </div>
            </div>

            <!-- Period Selection - Custom Only -->
            <div class="filters-row" style="margin-top: 20px; align-items: end;">
                <div class="filter-group">
                    <label>üìÖ Start Month</label>
                    <div style="display: flex; gap: 8px;">
                        <select id="startYear" onchange="recalculatePeriodCatchment(); updatePeriodDisplay();" style="flex: 1;">
                            <!-- Years populated by JS -->
                        </select>
                        <select id="startMonth" onchange="recalculatePeriodCatchment(); updatePeriodDisplay();" style="flex: 1;">
                            <option value="01">January</option>
                            <option value="02">February</option>
                            <option value="03">March</option>
                            <option value="04">April</option>
                            <option value="05">May</option>
                            <option value="06">June</option>
                            <option value="07">July</option>
                            <option value="08">August</option>
                            <option value="09">September</option>
                            <option value="10">October</option>
                            <option value="11">November</option>
                            <option value="12">December</option>
                    </select>
                </div>
                </div>
                <div class="filter-group">
                    <label>üìÖ End Month</label>
                    <div style="display: flex; gap: 8px;">
                        <select id="endYear" onchange="recalculatePeriodCatchment(); updatePeriodDisplay();" style="flex: 1;">
                            <!-- Years populated by JS -->
                        </select>
                        <select id="endMonth" onchange="recalculatePeriodCatchment(); updatePeriodDisplay();" style="flex: 1;">
                            <option value="01">January</option>
                            <option value="02">February</option>
                            <option value="03">March</option>
                            <option value="04">April</option>
                            <option value="05">May</option>
                            <option value="06">June</option>
                            <option value="07">July</option>
                            <option value="08">August</option>
                            <option value="09">September</option>
                            <option value="10">October</option>
                            <option value="11">November</option>
                            <option value="12">December</option>
                        </select>
                    </div>
                </div>
                <div class="filter-group" id="populationInputGroup" style="display: none;">
                    <label for="populationInput">Annual Population (for facilities)</label>
                    <input type="number" id="populationInput" placeholder="Annual catchment population" min="0" onchange="recalculatePeriodCatchment()">
                </div>
                <input type="hidden" id="periodSelect" value="CUSTOM">
                <input type="hidden" id="startDateInput" value="">
                <input type="hidden" id="endDateInput" value="">
            </div>

            <div class="selected-info">
                <span>Selected: <span class="highlight" id="selectedOrgUnit">None</span></span>
                <span>Period: <span class="highlight" id="selectedPeriod">-</span> (<span id="monthsCount">0</span> months)</span>
                <span>ANC (5%): <span class="highlight" id="ancCatchment">-</span></span>
                <span>Deliveries (4.85%): <span class="highlight" id="deliveriesTarget">-</span></span>
            </div>
            <div class="btn-group">
                <button class="btn btn-primary" onclick="fetchData()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/>
                    </svg>
                    Load analysis
                </button>
                <button class="btn btn-secondary" onclick="clearCache()">Clear Cache</button>
            </div>
        </div>

        <div id="loadingSpinner" class="spinner hidden"></div>

        <!-- Data View Tab -->
        <div id="data-tab" class="tab-content">
            <div id="dataDisplay" class="hidden">
                <!-- ANC Indicators Table -->
                <div class="card">
                    <div class="card-header">
                        <div>
                            <h2>ANC Indicators Performance</h2>
                            <p>Coverage and quality metrics for antenatal care</p>
                        </div>
                        <button class="btn btn-secondary" onclick="downloadExcel()" style="background: white; color: var(--accent-pink); border: 2px solid white; padding: 8px 16px; font-size: 14px;">
                            üìä Download Excel
                        </button>
                    </div>
                    <div class="table-container">
                        <table id="ancTable">
                            <thead>
                                <tr>
                                    <th>Indicator</th>
                                    <th>Value</th>
                                    <th>Target Pop.</th>
                                    <th>Coverage/Rate (%)</th>
                                    <th>Target (%)</th>
                                </tr>
                            </thead>
                            <tbody id="ancTableBody">
                                <!-- Data will be inserted here -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Charts -->
                <div class="chart-grid">
                    <div class="chart-card" id="coverageChartCard">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                            <h3 style="margin: 0;">ANC Coverage Trends</h3>
                            <button class="btn btn-secondary" onclick="downloadChartAsJPG('coverageChartCard', 'ANC_Coverage_Trends')" style="padding: 6px 12px; font-size: 12px;">
                                üì∑ Download JPG
                            </button>
                        </div>
                        <div class="chart-container">
                            <canvas id="coverageChart"></canvas>
                        </div>
                        <div id="coverageLegend" style="display: flex; justify-content: center; gap: 16px; margin-top: 12px; flex-wrap: wrap;"></div>
                    </div>
                    <div class="chart-card" id="qualityChartCard">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                            <h3 style="margin: 0;">Quality Indicators</h3>
                            <button class="btn btn-secondary" onclick="downloadChartAsJPG('qualityChartCard', 'Quality_Indicators')" style="padding: 6px 12px; font-size: 12px;">
                                üì∑ Download JPG
                            </button>
                        </div>
                        <div class="chart-container">
                            <canvas id="qualityChart"></canvas>
                        </div>
                        <div id="qualityLegend" style="display: flex; justify-content: center; gap: 16px; margin-top: 12px; flex-wrap: wrap;"></div>
                    </div>
                </div>
            </div>

            <!-- Intrapartum Section -->
            <div id="intrapartumSection" class="card" style="margin-top: 24px; display: none;">
                <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <h2 style="margin: 0;">üè• Intrapartum Indicators</h2>
                        <p style="margin: 4px 0 0 0; color: var(--text-secondary); font-size: 13px;">
                            Deliveries Target (4.85%): <span id="deliveriesCatchment">--</span>
                        </p>
                    </div>
                    <div style="display: flex; gap: 8px;">
                        <button class="btn btn-secondary" onclick="downloadIntrapartumExcel()">üìä Excel</button>
                        <button class="btn btn-secondary" onclick="downloadIntrapartumJPG()">üì∑ JPG</button>
                    </div>
                </div>
                <div style="padding: 20px;">
                    <table id="intrapartumTable" class="data-table" style="width: 100%;">
                        <thead>
                            <tr>
                                <th style="text-align: left;">Indicator</th>
                                <th style="text-align: right;">Numerator</th>
                                <th style="text-align: right;">Denominator</th>
                                <th style="text-align: right;">Performance</th>
                                <th style="text-align: right;">Target</th>
                            </tr>
                        </thead>
                        <tbody id="intrapartumTableBody">
                            <tr>
                                <td colspan="5" style="text-align: center; padding: 40px; color: var(--text-secondary);">
                                    üìä Intrapartum data will appear after loading ANC data
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Analysis Tab -->
        <div id="analysis-tab" class="tab-content hidden">
            <div class="analysis-section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                    <h3>üìê Calculation Formulas & Analysis</h3>
                    <button class="btn btn-secondary" onclick="resetCustomizations()" style="font-size: 13px; padding: 6px 12px;">
                        üîÑ Reset All to Defaults
                    </button>
                </div>
                
                <!-- ANC Target -->
                <div class="formula editable-formula" data-indicator="anc_catchment">
                    <div class="formula-header">
                        <strong>ANC Target (5%):</strong>
                        <button class="btn-edit" onclick="editFormula('anc_catchment')">‚úèÔ∏è Edit</button>
                    </div>
                    <div class="formula-content" id="formula-anc_catchment">
                        = (5% √ó UBOS Population) for Districts<br>
                        = (5% √ó Catchment Population) for Facilities
                    </div>
                    <div class="formula-edit hidden" id="edit-anc_catchment">
                        <label>Catchment Percentage:</label>
                        <input type="number" step="0.1" value="5" id="input-anc_catchment" style="width: 100px;">%
                        <button class="btn btn-primary" onclick="saveFormula('anc_catchment')" style="margin-left: 8px;">üíæ Save</button>
                        <button class="btn btn-secondary" onclick="cancelEdit('anc_catchment')" style="margin-left: 4px;">‚ùå Cancel</button>
                    </div>
                </div>

                <!-- ANC 1 Coverage -->
                <div class="formula editable-formula" data-indicator="anc1">
                    <div class="formula-header">
                        <strong>ANC 1 Coverage:</strong>
                        <button class="btn-edit" onclick="editFormula('anc1')">‚úèÔ∏è Edit</button>
                    </div>
                    <div class="formula-content" id="formula-anc1">
                        = (105-AN01a. ANC 1st Visit / ANC Target) √ó 100
                    </div>
                    <div class="formula-edit hidden" id="edit-anc1">
                        <label>Custom Formula:</label>
                        <input type="text" value="(105-AN01a. ANC 1st Visit / ANC Target) √ó 100" id="input-anc1" style="width: 100%;">
                        <button class="btn btn-primary" onclick="saveFormula('anc1')" style="margin-top: 8px;">üíæ Save</button>
                        <button class="btn btn-secondary" onclick="cancelEdit('anc1')" style="margin-left: 4px;">‚ùå Cancel</button>
                    </div>
                </div>

                <!-- ANC 1st Trimester -->
                <div class="formula editable-formula" data-indicator="anc1_trimester">
                    <div class="formula-header">
                        <strong>ANC 1st Trimester:</strong>
                        <button class="btn-edit" onclick="editFormula('anc1_trimester')">‚úèÔ∏è Edit</button>
                    </div>
                    <div class="formula-content" id="formula-anc1_trimester">
                        = (105-AN01b. 1st Trimester Visits / 105-AN01a. ANC 1st Visit) √ó 100
                    </div>
                    <div class="formula-edit hidden" id="edit-anc1_trimester">
                        <label>Custom Formula:</label>
                        <input type="text" value="(105-AN01b. 1st Trimester Visits / 105-AN01a. ANC 1st Visit) √ó 100" id="input-anc1_trimester" style="width: 100%;">
                        <button class="btn btn-primary" onclick="saveFormula('anc1_trimester')" style="margin-top: 8px;">üíæ Save</button>
                        <button class="btn btn-secondary" onclick="cancelEdit('anc1_trimester')" style="margin-left: 4px;">‚ùå Cancel</button>
                    </div>
                </div>

                <!-- ANC 4 Coverage -->
                <div class="formula editable-formula" data-indicator="anc4">
                    <div class="formula-header">
                        <strong>ANC 4 Coverage:</strong>
                        <button class="btn-edit" onclick="editFormula('anc4')">‚úèÔ∏è Edit</button>
                    </div>
                    <div class="formula-content" id="formula-anc4">
                        = (105-AN02. ANC 4th Visit / ANC Target) √ó 100
                    </div>
                    <div class="formula-edit hidden" id="edit-anc4">
                        <label>Custom Formula:</label>
                        <input type="text" value="(105-AN02. ANC 4th Visit / ANC Target) √ó 100" id="input-anc4" style="width: 100%;">
                        <button class="btn btn-primary" onclick="saveFormula('anc4')" style="margin-top: 8px;">üíæ Save</button>
                        <button class="btn btn-secondary" onclick="cancelEdit('anc4')" style="margin-left: 4px;">‚ùå Cancel</button>
                    </div>
                </div>

                <!-- ANC 8 Coverage -->
                <div class="formula editable-formula" data-indicator="anc8">
                    <div class="formula-header">
                        <strong>ANC 8 Coverage:</strong>
                        <button class="btn-edit" onclick="editFormula('anc8')">‚úèÔ∏è Edit</button>
                    </div>
                    <div class="formula-content" id="formula-anc8">
                        = (105-AN03. ANC 8 Visits / ANC Target) √ó 100
                    </div>
                    <div class="formula-edit hidden" id="edit-anc8">
                        <label>Custom Formula:</label>
                        <input type="text" value="(105-AN03. ANC 8 Visits / ANC Target) √ó 100" id="input-anc8" style="width: 100%;">
                        <button class="btn btn-primary" onclick="saveFormula('anc8')" style="margin-top: 8px;">üíæ Save</button>
                        <button class="btn btn-secondary" onclick="cancelEdit('anc8')" style="margin-left: 4px;">‚ùå Cancel</button>
                    </div>
                </div>

                <!-- IPT3 Coverage -->
                <div class="formula editable-formula" data-indicator="ipt3">
                    <div class="formula-header">
                        <strong>IPT3 Coverage:</strong>
                        <button class="btn-edit" onclick="editFormula('ipt3')">‚úèÔ∏è Edit</button>
                    </div>
                    <div class="formula-content" id="formula-ipt3">
                        = (105-AN06c. IPT3 Recipients / ANC Target) √ó 100
                    </div>
                    <div class="formula-edit hidden" id="edit-ipt3">
                        <label>Custom Formula:</label>
                        <input type="text" value="(105-AN06c. IPT3 Recipients / ANC Target) √ó 100" id="input-ipt3" style="width: 100%;">
                        <button class="btn btn-primary" onclick="saveFormula('ipt3')" style="margin-top: 8px;">üíæ Save</button>
                        <button class="btn btn-secondary" onclick="cancelEdit('ipt3')" style="margin-left: 4px;">‚ùå Cancel</button>
                    </div>
                </div>

                <!-- Hb Testing -->
                <div class="formula editable-formula" data-indicator="hb_testing">
                    <div class="formula-header">
                        <strong>Hb Testing at 1st Contact:</strong>
                        <button class="btn-edit" onclick="editFormula('hb_testing')">‚úèÔ∏è Edit</button>
                    </div>
                    <div class="formula-content" id="formula-hb_testing">
                        = (105-AN08. Hb Test / 105-AN01a. ANC 1st Visit) √ó 100
                    </div>
                    <div class="formula-edit hidden" id="edit-hb_testing">
                        <label>Custom Formula:</label>
                        <input type="text" value="(105-AN08. Hb Test / 105-AN01a. ANC 1st Visit) √ó 100" id="input-hb_testing" style="width: 100%;">
                        <button class="btn btn-primary" onclick="saveFormula('hb_testing')" style="margin-top: 8px;">üíæ Save</button>
                        <button class="btn btn-secondary" onclick="cancelEdit('hb_testing')" style="margin-left: 4px;">‚ùå Cancel</button>
                    </div>
                </div>

                <!-- Obstetric Ultrasound Scan -->
                <div class="formula editable-formula" data-indicator="ultrasound">
                    <div class="formula-header">
                        <strong>Obstetric Ultrasound Scan:</strong>
                        <button class="btn-edit" onclick="editFormula('ultrasound')">‚úèÔ∏è Edit</button>
                    </div>
                    <div class="formula-content" id="formula-ultrasound">
                        = (105-AN12a. Obstetric Ultrasound / 105-AN04. Total ANC Contacts) √ó 100
                    </div>
                    <div class="formula-edit hidden" id="edit-ultrasound">
                        <label>Custom Formula:</label>
                        <input type="text" value="(105-AN12a. Obstetric Ultrasound / 105-AN04. Total ANC Contacts) √ó 100" id="input-ultrasound" style="width: 100%;">
                        <button class="btn btn-primary" onclick="saveFormula('ultrasound')" style="margin-top: 8px;">üíæ Save</button>
                        <button class="btn btn-secondary" onclick="cancelEdit('ultrasound')" style="margin-left: 4px;">‚ùå Cancel</button>
                    </div>
                </div>

                <!-- LLIN -->
                <div class="formula editable-formula" data-indicator="llin">
                    <div class="formula-header">
                        <strong>LLIN at ANC 1:</strong>
                        <button class="btn-edit" onclick="editFormula('llin')">‚úèÔ∏è Edit</button>
                    </div>
                    <div class="formula-content" id="formula-llin">
                        = (105-AN11. LLIN Given / 105-AN01a. ANC 1st Visit) √ó 100
                    </div>
                    <div class="formula-edit hidden" id="edit-llin">
                        <label>Custom Formula:</label>
                        <input type="text" value="(105-AN11. LLIN Given / 105-AN01a. ANC 1st Visit) √ó 100" id="input-llin" style="width: 100%;">
                        <button class="btn btn-primary" onclick="saveFormula('llin')" style="margin-top: 8px;">üíæ Save</button>
                        <button class="btn btn-secondary" onclick="cancelEdit('llin')" style="margin-left: 4px;">‚ùå Cancel</button>
                    </div>
                </div>

                <!-- Teenage Pregnancies -->
                <div class="formula editable-formula" data-indicator="teenage">
                    <div class="formula-header">
                        <strong>Teenage Pregnancies:</strong>
                        <button class="btn-edit" onclick="editFormula('teenage')">‚úèÔ∏è Edit</button>
                    </div>
                    <div class="formula-content" id="formula-teenage">
                        = ((ANC &lt;15yrs + ANC 15-19yrs) / Total ANC 1st Visit) √ó 100
                    </div>
                    <div class="formula-edit hidden" id="edit-teenage">
                        <label>Custom Formula:</label>
                        <input type="text" value="((ANC <15yrs + ANC 15-19yrs) / Total ANC 1st Visit) √ó 100" id="input-teenage" style="width: 100%;">
                        <button class="btn btn-primary" onclick="saveFormula('teenage')" style="margin-top: 8px;">üíæ Save</button>
                        <button class="btn btn-secondary" onclick="cancelEdit('teenage')" style="margin-left: 4px;">‚ùå Cancel</button>
                    </div>
                </div>

                <!-- Iron/Folic Acid -->
                <div class="formula editable-formula" data-indicator="iron_folic">
                    <div class="formula-header">
                        <strong>Iron/Folic Acid:</strong>
                        <button class="btn-edit" onclick="editFormula('iron_folic')">‚úèÔ∏è Edit</button>
                    </div>
                    <div class="formula-content" id="formula-iron_folic">
                        = (105-AN21_2019. IFA 30+ tablets / 105-AN01a. ANC 1st Visit) √ó 100
                    </div>
                    <div class="formula-edit hidden" id="edit-iron_folic">
                        <label>Custom Formula:</label>
                        <input type="text" value="(105-AN21_2019. IFA 30+ tablets / 105-AN01a. ANC 1st Visit) √ó 100" id="input-iron_folic" style="width: 100%;">
                        <button class="btn btn-primary" onclick="saveFormula('iron_folic')" style="margin-top: 8px;">üíæ Save</button>
                        <button class="btn btn-secondary" onclick="cancelEdit('iron_folic')" style="margin-left: 4px;">‚ùå Cancel</button>
                    </div>
                </div>

                <!-- ==================== INTRAPARTUM FORMULAS ==================== -->
                <h3 style="margin-top: 32px; margin-bottom: 16px; border-bottom: 2px solid #6366f1; padding-bottom: 8px;">üè• Intrapartum Formulas</h3>

                <!-- Deliveries Target -->
                <div class="formula" style="border-left-color: #6366f1;">
                    <div class="formula-header">
                        <strong>Deliveries Target (4.85%):</strong>
                    </div>
                    <div class="formula-content">
                        = (4.85% √ó UBOS Population) for Districts<br>
                        = (4.85% √ó Catchment Population) for Facilities
                    </div>
                </div>

                <!-- Deliveries Coverage -->
                <div class="formula" style="border-left-color: #6366f1;">
                    <div class="formula-header">
                        <strong>Deliveries Coverage:</strong>
                    </div>
                    <div class="formula-content">
                        = (105-MA04. Total deliveries / Deliveries Target) √ó 100
                    </div>
                </div>

                <!-- Low Birth Weight -->
                <div class="formula" style="border-left-color: #6366f1;">
                    <div class="formula-header">
                        <strong>% Low Birth Weight:</strong>
                    </div>
                    <div class="formula-content">
                        = (105-MA05a2. Live births &lt;2.5 Kg / 105-MA05a1. Live births Total) √ó 100
                    </div>
                </div>

                <!-- KMC Initiated -->
                <div class="formula" style="border-left-color: #6366f1;">
                    <div class="formula-header">
                        <strong>% LBW Initiated on KMC:</strong>
                    </div>
                    <div class="formula-content">
                        = (105-MA08. LBW babies on KMC / 105-MA05a2. Live births &lt;2.5 Kg) √ó 100
                    </div>
                </div>

                <!-- Birth Asphyxia -->
                <div class="formula" style="border-left-color: #6366f1;">
                    <div class="formula-header">
                        <strong>Birth Asphyxia Rate:</strong>
                    </div>
                    <div class="formula-content">
                        = (105-MA23. Babies with Birth Asphyxia / 105-MA04. Total deliveries) √ó 100
                    </div>
                </div>

                <!-- Resuscitation Rate -->
                <div class="formula" style="border-left-color: #6366f1;">
                    <div class="formula-header">
                        <strong>Asphyxia Resuscitation Rate:</strong>
                    </div>
                    <div class="formula-content">
                        = (105-MA24. Successfully Resuscitated / 105-MA23. Babies with Asphyxia) √ó 100
                    </div>
                </div>

                <!-- Fresh Still Births -->
                <div class="formula" style="border-left-color: #6366f1;">
                    <div class="formula-header">
                        <strong>Fresh Still Births (per 1,000):</strong>
                    </div>
                    <div class="formula-content">
                        = (105-MA05b1. Fresh Still births / 105-MA04. Total deliveries) √ó 1,000
                    </div>
                </div>

                <!-- Neonatal Mortality -->
                <div class="formula" style="border-left-color: #6366f1;">
                    <div class="formula-header">
                        <strong>Neonatal Mortality Rate (per 1,000):</strong>
                    </div>
                    <div class="formula-content">
                        = ((105-MA12. Deaths 0-7 days + Deaths 8-28 days) / 105-MA05a1. Live births) √ó 1,000
                    </div>
                </div>

                <!-- Perinatal Mortality -->
                <div class="formula" style="border-left-color: #6366f1;">
                    <div class="formula-header">
                        <strong>Perinatal Mortality Rate (per 1,000):</strong>
                    </div>
                    <div class="formula-content">
                        = ((Fresh Still births + Deaths 0-7 days + Macerated Still births) / Live births) √ó 1,000
                    </div>
                </div>

                <!-- Maternal Mortality -->
                <div class="formula" style="border-left-color: #6366f1;">
                    <div class="formula-header">
                        <strong>Maternal Mortality Ratio (per 100,000):</strong>
                    </div>
                    <div class="formula-content">
                        = (105-MA13. Maternal deaths / 105-MA05a1. Live births) √ó 100,000
                    </div>
                </div>

                <h3 style="margin-top: 32px; margin-bottom: 16px;">üé® Color Coding Targets</h3>
                
                <!-- ANC 1 Targets -->
                <div class="formula editable-formula" data-indicator="target_anc1">
                    <div class="formula-header">
                        <strong>ANC 1:</strong>
                        <button class="btn-edit" onclick="editTarget('anc1')">‚úèÔ∏è Edit</button>
                    </div>
                    <div class="formula-content" id="target-anc1">
                        Green ‚â•100% | Yellow 80-99.9% | Red &lt;80%
                    </div>
                    <div class="formula-edit hidden" id="edit-target-anc1">
                        <label>Green ‚â•</label> <input type="number" step="0.1" value="100" id="green-anc1" style="width: 80px;">%
                        <label style="margin-left: 12px;">Yellow ‚â•</label> <input type="number" step="0.1" value="80" id="yellow-anc1" style="width: 80px;">%
                        <button class="btn btn-primary" onclick="saveTarget('anc1')" style="margin-left: 8px;">üíæ Save</button>
                        <button class="btn btn-secondary" onclick="cancelEditTarget('anc1')" style="margin-left: 4px;">‚ùå Cancel</button>
                    </div>
                </div>

                <!-- ANC 1st Trimester Targets -->
                <div class="formula editable-formula" data-indicator="target_anc1_trimester">
                    <div class="formula-header">
                        <strong>ANC 1st Trimester:</strong>
                        <button class="btn-edit" onclick="editTarget('anc1_trimester')">‚úèÔ∏è Edit</button>
                    </div>
                    <div class="formula-content" id="target-anc1_trimester">
                        Green ‚â•45% | Yellow 30-44.9% | Red &lt;30%
                    </div>
                    <div class="formula-edit hidden" id="edit-target-anc1_trimester">
                        <label>Green ‚â•</label> <input type="number" step="0.1" value="45" id="green-anc1_trimester" style="width: 80px;">%
                        <label style="margin-left: 12px;">Yellow ‚â•</label> <input type="number" step="0.1" value="30" id="yellow-anc1_trimester" style="width: 80px;">%
                        <button class="btn btn-primary" onclick="saveTarget('anc1_trimester')" style="margin-left: 8px;">üíæ Save</button>
                        <button class="btn btn-secondary" onclick="cancelEditTarget('anc1_trimester')" style="margin-left: 4px;">‚ùå Cancel</button>
                    </div>
                </div>

                <!-- ANC 4 Targets -->
                <div class="formula editable-formula" data-indicator="target_anc4">
                    <div class="formula-header">
                        <strong>ANC 4:</strong>
                        <button class="btn-edit" onclick="editTarget('anc4')">‚úèÔ∏è Edit</button>
                    </div>
                    <div class="formula-content" id="target-anc4">
                        Green ‚â•75% | Yellow 50-74.9% | Red &lt;50%
                    </div>
                    <div class="formula-edit hidden" id="edit-target-anc4">
                        <label>Green ‚â•</label> <input type="number" step="0.1" value="75" id="green-anc4" style="width: 80px;">%
                        <label style="margin-left: 12px;">Yellow ‚â•</label> <input type="number" step="0.1" value="50" id="yellow-anc4" style="width: 80px;">%
                        <button class="btn btn-primary" onclick="saveTarget('anc4')" style="margin-left: 8px;">üíæ Save</button>
                        <button class="btn btn-secondary" onclick="cancelEditTarget('anc4')" style="margin-left: 4px;">‚ùå Cancel</button>
                    </div>
                </div>

                <!-- ANC 8 Targets -->
                <div class="formula editable-formula" data-indicator="target_anc8">
                    <div class="formula-header">
                        <strong>ANC 8:</strong>
                        <button class="btn-edit" onclick="editTarget('anc8')">‚úèÔ∏è Edit</button>
                    </div>
                    <div class="formula-content" id="target-anc8">
                        Green ‚â•20% | Yellow 10-19.9% | Red &lt;10%
                    </div>
                    <div class="formula-edit hidden" id="edit-target-anc8">
                        <label>Green ‚â•</label> <input type="number" step="0.1" value="20" id="green-anc8" style="width: 80px;">%
                        <label style="margin-left: 12px;">Yellow ‚â•</label> <input type="number" step="0.1" value="10" id="yellow-anc8" style="width: 80px;">%
                        <button class="btn btn-primary" onclick="saveTarget('anc8')" style="margin-left: 8px;">üíæ Save</button>
                        <button class="btn btn-secondary" onclick="cancelEditTarget('anc8')" style="margin-left: 4px;">‚ùå Cancel</button>
                    </div>
                </div>

                <!-- IPT3 Targets -->
                <div class="formula editable-formula" data-indicator="target_ipt3">
                    <div class="formula-header">
                        <strong>IPT3:</strong>
                        <button class="btn-edit" onclick="editTarget('ipt3')">‚úèÔ∏è Edit</button>
                    </div>
                    <div class="formula-content" id="target-ipt3">
                        Green ‚â•80% | Yellow 60-79.9% | Red &lt;60%
                    </div>
                    <div class="formula-edit hidden" id="edit-target-ipt3">
                        <label>Green ‚â•</label> <input type="number" step="0.1" value="80" id="green-ipt3" style="width: 80px;">%
                        <label style="margin-left: 12px;">Yellow ‚â•</label> <input type="number" step="0.1" value="60" id="yellow-ipt3" style="width: 80px;">%
                        <button class="btn btn-primary" onclick="saveTarget('ipt3')" style="margin-left: 8px;">üíæ Save</button>
                        <button class="btn btn-secondary" onclick="cancelEditTarget('ipt3')" style="margin-left: 4px;">‚ùå Cancel</button>
                    </div>
                </div>

                <!-- Hb Testing, Ultrasound & Iron/Folic Targets -->
                <div class="formula editable-formula" data-indicator="target_hb_iron">
                    <div class="formula-header">
                        <strong>Hb Testing, Ultrasound & Iron/Folic:</strong>
                        <button class="btn-edit" onclick="editTarget('hb_iron')">‚úèÔ∏è Edit</button>
                    </div>
                    <div class="formula-content" id="target-hb_iron">
                        Green ‚â•75% | Yellow 50-74.9% | Red &lt;50%
                    </div>
                    <div class="formula-edit hidden" id="edit-target-hb_iron">
                        <label>Green ‚â•</label> <input type="number" step="0.1" value="75" id="green-hb_iron" style="width: 80px;">%
                        <label style="margin-left: 12px;">Yellow ‚â•</label> <input type="number" step="0.1" value="50" id="yellow-hb_iron" style="width: 80px;">%
                        <button class="btn btn-primary" onclick="saveTarget('hb_iron')" style="margin-left: 8px;">üíæ Save</button>
                        <button class="btn btn-secondary" onclick="cancelEditTarget('hb_iron')" style="margin-left: 4px;">‚ùå Cancel</button>
                    </div>
                </div>

                <!-- LLIN Targets -->
                <div class="formula editable-formula" data-indicator="target_llin">
                    <div class="formula-header">
                        <strong>LLIN:</strong>
                        <button class="btn-edit" onclick="editTarget('llin')">‚úèÔ∏è Edit</button>
                    </div>
                    <div class="formula-content" id="target-llin">
                        Green ‚â•80% | Yellow 60-79.9% | Red &lt;60%
                    </div>
                    <div class="formula-edit hidden" id="edit-target-llin">
                        <label>Green ‚â•</label> <input type="number" step="0.1" value="80" id="green-llin" style="width: 80px;">%
                        <label style="margin-left: 12px;">Yellow ‚â•</label> <input type="number" step="0.1" value="60" id="yellow-llin" style="width: 80px;">%
                        <button class="btn btn-primary" onclick="saveTarget('llin')" style="margin-left: 8px;">üíæ Save</button>
                        <button class="btn btn-secondary" onclick="cancelEditTarget('llin')" style="margin-left: 4px;">‚ùå Cancel</button>
                    </div>
                </div>

                <!-- Teenage Pregnancies Targets -->
                <div class="formula editable-formula" data-indicator="target_teenage">
                    <div class="formula-header">
                        <strong>Teenage Pregnancies:</strong>
                        <button class="btn-edit" onclick="editTarget('teenage')">‚úèÔ∏è Edit</button>
                    </div>
                    <div class="formula-content" id="target-teenage">
                        Green ‚â§13% | Yellow 13.1-19.9% | Red ‚â•20%
                    </div>
                    <div class="formula-edit hidden" id="edit-target-teenage">
                        <label>Green ‚â§</label> <input type="number" step="0.1" value="13" id="green-teenage" style="width: 80px;">%
                        <label style="margin-left: 12px;">Yellow ‚â§</label> <input type="number" step="0.1" value="19.9" id="yellow-teenage" style="width: 80px;">%
                        <button class="btn btn-primary" onclick="saveTarget('teenage')" style="margin-left: 8px;">üíæ Save</button>
                        <button class="btn btn-secondary" onclick="cancelEditTarget('teenage')" style="margin-left: 4px;">‚ùå Cancel</button>
                    </div>
                </div>

                <!-- ==================== INTRAPARTUM TARGETS ==================== -->
                <h3 style="margin-top: 32px; margin-bottom: 16px; border-bottom: 2px solid #6366f1; padding-bottom: 8px;">üè• Intrapartum Targets</h3>

                <!-- Deliveries Target -->
                <div class="formula" style="border-left-color: #6366f1;">
                    <div class="formula-header">
                        <strong>Deliveries Coverage:</strong>
                    </div>
                    <div class="formula-content">
                        üü¢ Green ‚â•70% | üü° Yellow 50-69.9% | üî¥ Red &lt;50%
                    </div>
                </div>

                <!-- LBW Target -->
                <div class="formula" style="border-left-color: #6366f1;">
                    <div class="formula-header">
                        <strong>Low Birth Weight (lower is better):</strong>
                    </div>
                    <div class="formula-content">
                        üü¢ Green ‚â§5% | üü° Yellow 5.1-10% | üî¥ Red &gt;10%
                    </div>
                </div>

                <!-- KMC Target -->
                <div class="formula" style="border-left-color: #6366f1;">
                    <div class="formula-header">
                        <strong>LBW Initiated on KMC:</strong>
                    </div>
                    <div class="formula-content">
                        üü¢ Green ‚â•90% | üü° Yellow 75-89.9% | üî¥ Red &lt;75%
                    </div>
                </div>

                <!-- Birth Asphyxia Target -->
                <div class="formula" style="border-left-color: #6366f1;">
                    <div class="formula-header">
                        <strong>Birth Asphyxia (lower is better):</strong>
                    </div>
                    <div class="formula-content">
                        üü¢ Green ‚â§1% | üü° Yellow 1.1-5% | üî¥ Red &gt;5%
                    </div>
                </div>

                <!-- Resuscitation Target -->
                <div class="formula" style="border-left-color: #6366f1;">
                    <div class="formula-header">
                        <strong>Asphyxia Resuscitation:</strong>
                    </div>
                    <div class="formula-content">
                        üü¢ Green ‚â•90% | üü° Yellow 70-89.9% | üî¥ Red &lt;70%
                    </div>
                </div>

                <!-- Fresh Still Birth Target -->
                <div class="formula" style="border-left-color: #6366f1;">
                    <div class="formula-header">
                        <strong>Fresh Still Births per 1,000 (lower is better):</strong>
                    </div>
                    <div class="formula-content">
                        üü¢ Green ‚â§5 | üü° Yellow 5.1-10 | üî¥ Red &gt;10
                    </div>
                </div>

                <!-- Neonatal Mortality Target -->
                <div class="formula" style="border-left-color: #6366f1;">
                    <div class="formula-header">
                        <strong>Neonatal Mortality per 1,000 (lower is better):</strong>
                    </div>
                    <div class="formula-content">
                        üü¢ Green ‚â§5 | üü° Yellow 5.1-10 | üî¥ Red &gt;10
                    </div>
                </div>

                <!-- Perinatal Mortality Target -->
                <div class="formula" style="border-left-color: #6366f1;">
                    <div class="formula-header">
                        <strong>Perinatal Mortality per 1,000 (lower is better):</strong>
                    </div>
                    <div class="formula-content">
                        üü¢ Green ‚â§12 | üü° Yellow 12.1-20 | üî¥ Red &gt;20
                    </div>
                </div>

                <!-- Maternal Mortality Target -->
                <div class="formula" style="border-left-color: #6366f1;">
                    <div class="formula-header">
                        <strong>Maternal Mortality per 100,000 (lower is better):</strong>
                    </div>
                    <div class="formula-content">
                        üü¢ Green ‚â§182 | üü° Yellow 182.1-300 | üî¥ Red &gt;300
                    </div>
                </div>
            </div>
        </div>

        <!-- League Table Tab -->
        <div id="league-tab" class="tab-content hidden">
            <div class="league-section">
                <div class="card">
                    <div class="card-header">
                        <div>
                            <h2>üèÜ Compare Facility/District performance</h2>
                            <p>Compare performance across districts in a region, or facilities in a district</p>
                        </div>
                    </div>
                    <div style="padding: 20px;">
                        <div class="league-controls" style="align-items: flex-start;">
                            <div style="flex: 1; min-width: 280px;">
                                <div class="filter-group">
                                    <label>Compare Mode</label>
                                    <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-top: 6px;">
                                        <label style="display:flex; gap:6px; align-items:center; font-weight: 600;">
                                            <input type="radio" name="compareMode" value="districts" checked onchange="onCompareModeChange()">
                                            Compare Districts in a Region
                                        </label>
                                        <label style="display:flex; gap:6px; align-items:center; font-weight: 600;">
                                            <input type="radio" name="compareMode" value="facilities" onchange="onCompareModeChange()">
                                            Compare Facilities in a District
                                        </label>
                                    </div>
                                    <div style="margin-top: 12px;">
                                        <label style="display:block; margin-bottom: 6px;">üìÖ Period (Start / End Month)</label>
                                        <div style="display:flex; gap: 10px; flex-wrap: wrap;">
                                            <div style="display:flex; gap: 8px; align-items:center;">
                                                <select id="compareStartYear" onchange="updateComparePeriodDisplay()">
                                                    <option value="">Year</option>
                                                </select>
                                                <select id="compareStartMonth" onchange="updateComparePeriodDisplay()">
                                                    <option value="01">Jan</option><option value="02">Feb</option><option value="03">Mar</option>
                                                    <option value="04">Apr</option><option value="05">May</option><option value="06">Jun</option>
                                                    <option value="07">Jul</option><option value="08">Aug</option><option value="09">Sep</option>
                                                    <option value="10">Oct</option><option value="11">Nov</option><option value="12">Dec</option>
                                                </select>
                                            </div>
                                            <div style="display:flex; gap: 8px; align-items:center;">
                                                <select id="compareEndYear" onchange="updateComparePeriodDisplay()">
                                                    <option value="">Year</option>
                                                </select>
                                                <select id="compareEndMonth" onchange="updateComparePeriodDisplay()">
                                                    <option value="01">Jan</option><option value="02">Feb</option><option value="03">Mar</option>
                                                    <option value="04">Apr</option><option value="05">May</option><option value="06">Jun</option>
                                                    <option value="07">Jul</option><option value="08">Aug</option><option value="09">Sep</option>
                                                    <option value="10">Oct</option><option value="11">Nov</option><option value="12">Dec</option>
                                                </select>
                                            </div>
                                        </div>
                                        <p style="font-size: 12px; color: var(--text-secondary); margin-top: 8px;">
                                            Selected period: <strong id="leaguePeriodDisplay">-</strong>
                                        </p>
                                    </div>
                                </div>
                            </div>

                            <div style="flex: 1; min-width: 280px;">
                                <div id="compareDistrictsPanel">
                                    <div class="filter-group">
                                        <label>Select Region</label>
                                        <select id="compareRegionSelect">
                                            <option value="">‚è≥ Loading...</option>
                                        </select>
                                    </div>
                                    <button class="btn btn-primary" onclick="runCompareDistricts()" style="margin-top: 6px;">
                                        Compare Districts
                                    </button>
                                </div>

                                <div id="compareFacilitiesPanel" class="hidden">
                                    <div class="filter-group">
                                        <label>Select District</label>
                                        <select id="compareDistrictSelect">
                                            <option value="">‚è≥ Loading...</option>
                                        </select>
                                    </div>
                                    
                                    <!-- Clear Instruction Box -->
                                    <div style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border: 2px solid #f59e0b; border-radius: 8px; padding: 12px 16px; margin: 12px 0;">
                                        <div style="display: flex; align-items: start; gap: 10px;">
                                            <span style="font-size: 20px;">üí°</span>
                                            <div>
                                                <strong style="color: #92400e; font-size: 14px;">How to Calculate Facility Coverage:</strong>
                                                <ol style="margin: 8px 0 0 0; padding-left: 20px; color: #78350f; font-size: 13px; line-height: 1.6;">
                                                    <li>Click <strong>"Load Facilities"</strong> - table loads with quality indicators (rates)</li>
                                                    <li><strong>Fill annual population</strong> for each facility in the "Annual Pop." column</li>
                                                    <li>Click <strong>"Update Coverage"</strong> to calculate coverage based on populations</li>
                                                </ol>
                                                <p style="margin: 8px 0 0 0; font-size: 12px; color: #92400e; font-style: italic;">
                                                    Coverage requires catchment population; quality indicators (%, ‚Ä∞) are calculated directly from DHIS2 data.
                                                </p>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div style="display:flex; gap: 10px; flex-wrap: wrap;">
                                        <button class="btn btn-primary" onclick="runCompareFacilities()">
                                            Load Facilities
                                        </button>
                                        <button class="btn btn-secondary" onclick="applyFacilityPopulations()">
                                            Update Coverage (from populations)
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div id="compareTableDisplay" class="hidden" style="margin-top: 24px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                <h3 id="compareTableTitle">Comparison</h3>
                                <button onclick="downloadCompareExcel()" class="btn-download" style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); color: white; padding: 10px 18px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 8px;">
                                    üì• Download Excel (Color-coded)
                                </button>
                            </div>
                            <div class="table-container">
                                <!-- ANC Comparison Table -->
                                <h4 style="margin: 0 0 12px 0; color: #10b981;">üìä ANC Indicators</h4>
                                <table id="compareTable" class="compare-styled-table">
                                    <thead>
                                        <tr>
                                            <th>Org Unit</th>
                                            <th class="facility-only hidden">Annual Pop.</th>
                                            <th class="facility-only hidden">ANC Target</th>
                                            <th>ANC 1 (%)</th>
                                            <th>ANC 4 (%)</th>
                                            <th>ANC 8 (%)</th>
                                            <th>IPT3 (%)</th>
                                            <th>1st Tri (%)</th>
                                            <th>Hb Test (%)</th>
                                            <th>Ultrasound (%)</th>
                                            <th>Iron/Folic (%)</th>
                                            <th>Teen Preg (%)</th>
                                        </tr>
                                    </thead>
                                    <tbody id="compareTableBody">
                                        <!-- rows -->
                                    </tbody>
                                </table>

                                <!-- Intrapartum Comparison Table -->
                                <h4 style="margin: 24px 0 12px 0; color: #6366f1;">üè• Intrapartum Indicators</h4>
                                <table id="compareIntraTable" class="compare-styled-table">
                                    <thead>
                                        <tr>
                                            <th>Org Unit</th>
                                            <th>Deliveries (%)</th>
                                            <th>LBW (%)</th>
                                            <th>KMC (%)</th>
                                            <th>Asphyxia (%)</th>
                                            <th>Resuscitation (%)</th>
                                            <th>Fresh SB (‚Ä∞)</th>
                                            <th>Neonatal (‚Ä∞)</th>
                                            <th>Perinatal (‚Ä∞)</th>
                                            <th>MMR (/100k)</th>
                                        </tr>
                                    </thead>
                                    <tbody id="compareIntraTableBody">
                                        <!-- rows -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Legend -->
        <div class="legend">
            <div class="legend-content">
                <span style="font-weight: 700;">Legend:</span>
                <div class="legend-item">
                    <div class="legend-box" style="background: #10b981;"></div>
                    <span>Target Met</span>
                </div>
                <div class="legend-item">
                    <div class="legend-box" style="background: #fbbf24;"></div>
                    <span>Near Target</span>
                </div>
                <div class="legend-item">
                    <div class="legend-box" style="background: #ef4444;"></div>
                    <span>Below Target</span>
                </div>
            </div>
        </div>
    </main>

    <script>
        // Global variables
        let currentData = null;
        let chartInstances = {};
        let ancCatchment = 0;
        let ubosPopulation = 0;
        let selectedOrgUnit = null;
        let searchCache = {};
        let searchTimeout = null;

        // Session customizations (formulas and targets)
        let sessionCustomizations = {
            formulas: {},
            targets: {}
        };

        // UBOS Population Data (will be populated from config)
        let UBOS_POPULATIONS = {};

        // Uganda Regions and their Districts
        const REGIONS = {
            "ACHOLI": ["AGAGO", "AMURU", "GULU", "GULU CITY", "KITGUM", "LAMWO", "NWOYA", "OMORO", "PADER"],
            "ANKOLE": ["BUHWEJU", "BUSHENYI", "IBANDA", "ISINGIRO", "KIRUHURA", "MBARARA", "MBARARA CITY", "MITOOMA", "NTUNGAMO", "RUBIRIZI", "RWAMPARA", "SHEEMA"],
            "BUGANDA": ["BUIKWE", "BUKOMANSIMBI", "BUTAMBALA", "BUVUMA", "GOMBA", "KALANGALA", "KALUNGU", "KAMPALA", "KAYUNGA", "KIBOGA", "KYANKWANZI", "LUWEERO", "LWENGO", "LYANTONDE", "MASAKA", "MASAKA CITY", "MITYANA", "MPIGI", "MUBENDE", "MUKONO", "NAKASEKE", "NAKASONGOLA", "RAKAI", "SEMBABULE", "WAKISO", "KASSANDA", "KYOTERA"],
            "BUKEDI": ["BUDAKA", "BUSIA", "BUTALEJA", "KIBUKU", "PALLISA", "TORORO", "BUTEBO"],
            "BUNYORO": ["BULIISA", "HOIMA", "HOIMA CITY", "KIBAALE", "KAGADI", "KAKUMIRO", "KIKUUBE", "KIRYANDONGO", "MASINDI"],
            "BUSOGA": ["BUGIRI", "BUGWERI", "BUYENDE", "IGANGA", "JINJA", "JINJA CITY", "KALIRO", "KAMULI", "LUUKA", "MAYUGE", "NAMAYINGO", "NAMUTUMBA"],
            "ELGON": ["BUDUDA", "BUKWO", "BULAMBULI", "KAPCHORWA", "KWEEN", "MANAFWA", "MBALE", "MBALE CITY", "NAMISINDWA", "SIRONKO"],
            "KARAMOJA": ["ABIM", "AMUDAT", "KAABONG", "KARENGA", "KOTIDO", "MOROTO", "NABILATUK", "NAKAPIRIPIRIT", "NAPAK"],
            "KIGEZI": ["KABALE", "KANUNGU", "KISORO", "RUBANDA", "RUKIGA", "RUKUNGIRI"],
            "LANGO": ["ALEBTONG", "AMOLATAR", "APAC", "DOKOLO", "KOLE", "KWANIA", "LIRA", "LIRA CITY", "OTUKE", "OYAM", "KABERAMAIDO", "KALAKI", "KAPELEBYONG"],
            "SEBEI": ["BUKWO", "KAPCHORWA", "KWEEN"],
            "TESO": ["AMURIA", "BUKEDEA", "KATAKWI", "KUMI", "NGORA", "SERERE", "SOROTI", "SOROTI CITY"],
            "TOORO": ["BUNDIBUGYO", "BUNYANGABU", "FORT PORTAL CITY", "KABAROLE", "KAMWENGE", "KASESE", "KITAGWENDA", "KYEGEGWA", "KYENJOJO", "NTOROKO"],
            "WEST NILE": ["ADJUMANI", "ARUA", "ARUA CITY", "KOBOKO", "MADI-OKOLLO", "MARACHA", "MOYO", "NEBBI", "OBONGI", "PAKWACH", "TEREGO", "YUMBE", "ZOMBO"]
        };

        // Calculate total population for a region
        function getRegionPopulation(regionName) {
            const districts = REGIONS[regionName.toUpperCase()];
            if (!districts) return 0;
            
            let totalPop = 0;
            districts.forEach(district => {
                const pop = UBOS_POPULATIONS[district] || UBOS_POPULATIONS[district + ' CITY'] || 0;
                totalPop += pop;
            });
            return totalPop;
        }

        // Fetch UBOS populations on page load
        async function loadUBOSPopulations() {
            try {
                console.log('Fetching UBOS populations...');
                const response = await fetch('/api/districts');
                
                if (response.ok) {
                    UBOS_POPULATIONS = await response.json();
                    console.log('‚úÖ UBOS populations loaded:', Object.keys(UBOS_POPULATIONS).length, 'districts');
                    console.log('Sample districts:', Object.keys(UBOS_POPULATIONS).slice(0, 5));
                } else {
                    console.warn('‚ö†Ô∏è Could not fetch UBOS populations, response status:', response.status);
                    UBOS_POPULATIONS = {};
                }
            } catch (error) {
                console.error('‚ùå Error loading UBOS populations:', error);
                UBOS_POPULATIONS = {};
            }
        }

        // ANC Data Element IDs (will be fetched from DHIS2)
        const ANC_INDICATORS = {
            'ANC_1ST_VISIT': '105-AN01a',
            'ANC_1ST_TRIMESTER': '105-AN01b',
            'ANC_4TH_VISIT': '105-AN02',
            'ANC_8TH_VISIT': '105-AN03',
            'IPT3': '105-AN06c',
            'HB_TEST': '105-AN08',
            'LLIN': '105-AN11',
            'IRON_FOLIC': '105-AN21_2019',
            'TEEN_UNDER_15': '105-AN01a',  // Will filter by age
            'TEEN_15_19': '105-AN01a'      // Will filter by age
        };

        // Targets with exact color coding thresholds
        const TARGETS = {
            // ANC 1: Target 100%. ‚â•100% green, 80-99.9% yellow, <80% red
            'ANC_1ST_VISIT': { target: 100, greenMin: 100, yellowMin: 80, inverse: false },
            
            // ANC 1st Tri: Target 45%. ‚â•45% green, 30-44.9% yellow, <30% red
            'ANC_1ST_TRIMESTER': { target: 45, greenMin: 45, yellowMin: 30, inverse: false },
            
            // ANC 4: Target 75%. ‚â•75% green, 50-74.9% yellow, <50% red
            'ANC_4TH_VISIT': { target: 75, greenMin: 75, yellowMin: 50, inverse: false },
            
            // ANC 8: Target 20%. ‚â•20% green, 10-19.9% yellow, <10% red
            'ANC_8TH_VISIT': { target: 20, greenMin: 20, yellowMin: 10, inverse: false },
            
            // IPT3: Target 80%. ‚â•80% green, 60-79.9% yellow, <60% red
            'IPT3': { target: 80, greenMin: 80, yellowMin: 60, inverse: false },
            
            // Hb Testing: Target 75%. ‚â•75% green, 50-74.9% yellow, <50% red
            'HB_TEST': { target: 75, greenMin: 75, yellowMin: 50, inverse: false },
            
            // Obstetric Ultrasound: Same as Hb Testing. ‚â•75% green, 50-74.9% yellow, <50% red
            'ULTRASOUND': { target: 75, greenMin: 75, yellowMin: 50, inverse: false },
            
            // LLIN: Target 80%. ‚â•80% green, 60-79.9% yellow, <60% red
            'LLIN': { target: 80, greenMin: 80, yellowMin: 60, inverse: false },
            
            // Iron/Folic: Same as Hb Testing. ‚â•75% green, 50-74.9% yellow, <50% red
            'IRON_FOLIC': { target: 75, greenMin: 75, yellowMin: 50, inverse: false },
            
            // Teenage Pregnancies: ‚â§13% green, 13.1-19.9% yellow, ‚â•20% red (inverse)
            'TEEN_PREG': { target: 13, greenMax: 13, yellowMax: 19.9, inverse: true },
            
            // Deliveries Coverage: ‚â•70% green, 50-69.9% yellow, <50% red
            'DELIVERIES': { target: 70, greenMin: 70, yellowMin: 50, inverse: false }
        };

        // Color coding function with exact thresholds
        function getColorClass(value, indicator) {
            const config = TARGETS[indicator];
            if (!config) return '';

            if (config.inverse) {
                // Lower is better (e.g., teenage pregnancies)
                // ‚â§13% green, 13.1-19.9% yellow, ‚â•20% red
                if (value <= config.greenMax) return 'cell-green';
                if (value <= config.yellowMax) return 'cell-yellow';
                return 'cell-red';
            } else {
                // Higher is better
                if (value >= config.greenMin) return 'cell-green';
                if (value >= config.yellowMin) return 'cell-yellow';
                return 'cell-red';
            }
        }

        // Theme toggle
        function toggleTheme() {
            const body = document.body;
            const currentTheme = body.getAttribute('data-theme');
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            body.setAttribute('data-theme', newTheme);
            
            document.getElementById('theme-icon-sun').classList.toggle('hidden');
            document.getElementById('theme-icon-moon').classList.toggle('hidden');
        }

        // Tab switching
        function switchTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.add('hidden'));
            
            event.target.classList.add('active');
            document.getElementById(`${tab}-tab`).classList.remove('hidden');
            
            // Hide main filters for Analysis + Compare tab (Compare is self-contained)
            const filtersCard = document.querySelector('.filters-card');
            if (tab === 'analysis' || tab === 'league') {
                filtersCard.style.display = 'none';
            } else {
                filtersCard.style.display = 'block';
            }
        }

        // ========== Formula and Target Editing Functions ==========
        
        function editFormula(indicator) {
            // Hide content, show edit form
            document.getElementById(`formula-${indicator}`).style.display = 'none';
            document.getElementById(`edit-${indicator}`).classList.remove('hidden');
            document.querySelector(`[data-indicator="${indicator}"]`).classList.add('editing');
        }

        function cancelEdit(indicator) {
            // Show content, hide edit form
            document.getElementById(`formula-${indicator}`).style.display = 'block';
            document.getElementById(`edit-${indicator}`).classList.add('hidden');
            document.querySelector(`[data-indicator="${indicator}"]`).classList.remove('editing');
        }

        function saveFormula(indicator) {
            if (indicator === 'anc_catchment') {
                // Special handling for catchment percentage
                const percentage = parseFloat(document.getElementById(`input-${indicator}`).value);
                if (isNaN(percentage) || percentage <= 0 || percentage > 100) {
                    alert('Please enter a valid percentage between 0 and 100');
                    return;
                }
                sessionCustomizations.formulas[indicator] = percentage;
                document.getElementById(`formula-${indicator}`).innerHTML = 
                    `= (${percentage}% √ó UBOS Population) for Districts<br>= (${percentage}% √ó Catchment Population) for Facilities`;
                
                // Recalculate catchment with new percentage
                if (ubosPopulation > 0 || parseInt(document.getElementById('populationInput').value) > 0) {
                    recalculatePeriodCatchment();
                }
            } else {
                // Regular formula edit
                const formula = document.getElementById(`input-${indicator}`).value.trim();
                if (!formula) {
                    alert('Formula cannot be empty');
                    return;
                }
                sessionCustomizations.formulas[indicator] = formula;
                document.getElementById(`formula-${indicator}`).innerHTML = formula;
            }
            
            cancelEdit(indicator);
            alert(`‚úÖ Formula updated for this session!\n\nIndicator: ${indicator}\n\nNote: This will only apply to calculations shown in the interface. Backend calculations remain unchanged.`);
        }

        function editTarget(indicator) {
            // Hide content, show edit form
            document.getElementById(`target-${indicator}`).style.display = 'none';
            document.getElementById(`edit-target-${indicator}`).classList.remove('hidden');
            document.querySelector(`[data-indicator="target_${indicator}"]`).classList.add('editing');
        }

        function cancelEditTarget(indicator) {
            // Show content, hide edit form
            document.getElementById(`target-${indicator}`).style.display = 'block';
            document.getElementById(`edit-target-${indicator}`).classList.add('hidden');
            document.querySelector(`[data-indicator="target_${indicator}"]`).classList.remove('editing');
        }

        function saveTarget(indicator) {
            const greenThreshold = parseFloat(document.getElementById(`green-${indicator}`).value);
            const yellowThreshold = parseFloat(document.getElementById(`yellow-${indicator}`).value);
            
            if (isNaN(greenThreshold) || isNaN(yellowThreshold)) {
                alert('Please enter valid numbers for thresholds');
                return;
            }

            // Special handling for teenage pregnancies (inverted logic)
            if (indicator === 'teenage') {
                if (greenThreshold >= yellowThreshold) {
                    alert('For Teenage Pregnancies: Green threshold must be LESS than Yellow threshold');
                    return;
                }
                sessionCustomizations.targets[indicator] = { green: greenThreshold, yellow: yellowThreshold };
                document.getElementById(`target-${indicator}`).innerHTML = 
                    `Green ‚â§${greenThreshold}% | Yellow ${greenThreshold + 0.1}-${yellowThreshold}% | Red ‚â•${yellowThreshold + 0.1}%`;
            } else {
                if (greenThreshold <= yellowThreshold) {
                    alert('Green threshold must be GREATER than Yellow threshold');
                    return;
                }
                sessionCustomizations.targets[indicator] = { green: greenThreshold, yellow: yellowThreshold };
                document.getElementById(`target-${indicator}`).innerHTML = 
                    `Green ‚â•${greenThreshold}% | Yellow ${yellowThreshold}-${greenThreshold - 0.1}% | Red <${yellowThreshold}%`;
            }
            
            cancelEditTarget(indicator);
            
            // Update the color coding if data is loaded
            if (currentData) {
                updateTableWithCustomTargets();
            }
            
            alert(`‚úÖ Target thresholds updated for this session!\n\nIndicator: ${indicator}\nGreen: ${greenThreshold}%\nYellow: ${yellowThreshold}%\n\nThe table will be re-colored with new thresholds.`);
        }

        function updateTableWithCustomTargets() {
            // Re-apply color coding to the table based on custom targets
            const tbody = document.querySelector('#indicatorsTable tbody');
            if (!tbody || !currentData) return;

            const rows = tbody.querySelectorAll('tr');
            rows.forEach((row, index) => {
                const valueCell = row.querySelector('td:nth-child(2)');
                if (!valueCell) return;

                const valueText = valueCell.textContent.trim();
                const value = parseFloat(valueText);
                if (isNaN(value)) return;

                // Determine indicator type from row
                const indicatorName = row.querySelector('td:first-child')?.textContent.trim();
                let targetKey = null;
                
                if (indicatorName.includes('ANC 1 Coverage')) targetKey = 'anc1';
                else if (indicatorName.includes('1st Trimester')) targetKey = 'anc1_trimester';
                else if (indicatorName.includes('ANC 4')) targetKey = 'anc4';
                else if (indicatorName.includes('ANC 8')) targetKey = 'anc8';
                else if (indicatorName.includes('IPT3')) targetKey = 'ipt3';
                else if (indicatorName.includes('Hb Testing') || indicatorName.includes('Ultrasound') || indicatorName.includes('Iron/Folic')) targetKey = 'hb_iron';
                else if (indicatorName.includes('LLIN')) targetKey = 'llin';
                else if (indicatorName.includes('Teenage')) targetKey = 'teenage';

                if (targetKey && sessionCustomizations.targets[targetKey]) {
                    const thresholds = sessionCustomizations.targets[targetKey];
                    let colorClass = '';

                    if (targetKey === 'teenage') {
                        // Inverted logic for teenage pregnancies
                        if (value <= thresholds.green) colorClass = 'green';
                        else if (value <= thresholds.yellow) colorClass = 'yellow';
                        else colorClass = 'red';
                    } else {
                        // Normal logic
                        if (value >= thresholds.green) colorClass = 'green';
                        else if (value >= thresholds.yellow) colorClass = 'yellow';
                        else colorClass = 'red';
                    }

                    // Apply color
                    valueCell.className = `indicator-value ${colorClass}`;
                }
            });

            console.log('‚úÖ Table re-colored with custom targets');
        }

        function resetCustomizations() {
            if (!confirm('Are you sure you want to reset all customizations to default values?\n\nThis will:\n- Reset all formulas\n- Reset all color coding targets\n- Clear all session changes')) {
                return;
            }

            // Clear customizations
            sessionCustomizations = {
                formulas: {},
                targets: {}
            };

            // Reload the page to reset everything
            location.reload();
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('Page loaded, initializing...');
            await loadUBOSPopulations();
            await populateLevel2(); // Start from regions
            setupEventListeners();
            // Initialize compare tab dropdowns (regions + districts)
            try {
                initializeCompareYearDropdowns();
                await loadCompareDropdowns();
                onCompareModeChange(); // ensure correct panels/columns
            } catch (e) {
                console.warn('Compare init failed:', e);
            }
            console.log('Initialization complete');
        });

        // Populate Level 2 (Regions - top level)
        async function populateLevel2() {
            const sel = document.getElementById('level2');
            sel.innerHTML = '<option value="">‚è≥ Loading...</option>';
            
            try {
                // First, get the country level (top level)
                const response = await fetch('/api/org-units');
                const data = await response.json();
                
                if (data.error) {
                    sel.innerHTML = `<option value="">Error: ${data.error}</option>`;
                    return;
                }
                
                const topLevelUnits = data.organisationUnits || [];
                
                if (topLevelUnits.length === 0) {
                    sel.innerHTML = '<option value="">No units found</option>';
                    return;
                }
                
                // Get the first country/top-level unit
                const countryId = topLevelUnits[0].id;
                console.log('Country ID:', countryId, topLevelUnits[0].displayName);
                
                // Now fetch the regions (children of country)
                const regionsResponse = await fetch(`/api/org-units?parent=${countryId}`);
                const regionsData = await regionsResponse.json();
                
                if (regionsData.error) {
                    sel.innerHTML = `<option value="">Error: ${regionsData.error}</option>`;
                    return;
                }
                
                const regions = regionsData.children || [];
                
                if (regions.length > 0) {
                    regions.sort((a, b) => a.displayName.localeCompare(b.displayName));
                    sel.innerHTML = `<option value="">-- Select Region (${regions.length}) --</option>` +
                        regions.map(u => `<option value="${u.id}" data-name="${u.displayName}">${u.displayName}</option>`).join('');
                    console.log(`‚úÖ Loaded ${regions.length} regions`);
                } else {
                    sel.innerHTML = '<option value="">No regions found</option>';
                }
            } catch (error) {
                console.error('Error loading regions:', error);
                sel.innerHTML = '<option value="">Error loading</option>';
            }
        }

        // Load children for a given dropdown level
        async function loadChildren(dropdownLevel) {
            const sel = document.getElementById(`level${dropdownLevel}`);
            const parentId = sel.value;
            const parentName = sel.options[sel.selectedIndex]?.dataset?.name || sel.options[sel.selectedIndex]?.text || '';
            // Get actual DHIS2 level from data attribute (if available)
            const actualLevel = parseInt(sel.options[sel.selectedIndex]?.dataset?.level) || dropdownLevel;

            if (parentId) {
                selectedOrgUnit = { id: parentId, name: parentName, level: actualLevel };
                document.getElementById('selectedOrgUnit').textContent = parentName;

                // Show/hide population input based on actual DHIS2 level (only for facility level 6)
                const populationInputGroup = document.getElementById('populationInputGroup');
                if (actualLevel >= 6) {
                    // Facility level - need custom population
                    populationInputGroup.style.display = 'block';
                    // Clear the date fields so user must select them
                    document.getElementById('startYear').value = '';
                    document.getElementById('startMonth').value = '';
                    document.getElementById('endYear').value = '';
                    document.getElementById('endMonth').value = '';
                    document.getElementById('populationInput').value = '';
                    ancCatchment = 0;
                    document.getElementById('ancCatchment').textContent = '0';
                } else {
                    // District or above - use UBOS population
                    populationInputGroup.style.display = 'none';
                    document.getElementById('populationInput').value = ''; // Clear value
                }

                // Check if region (level 2) for aggregate population
                if (actualLevel === 2 || dropdownLevel === 2) {
                    // Region selected - aggregate all district populations
                    const cleanName = parentName.toUpperCase().replace(' REGION', '').trim();
                    const regionPop = getRegionPopulation(cleanName);
                    
                    if (regionPop > 0) {
                        ubosPopulation = regionPop;
                        recalculatePeriodCatchment();
                        console.log(`‚úÖ Region: ${cleanName} = ${regionPop.toLocaleString()} (aggregate of all districts)`);
                    } else {
                        // Try to calculate from matching districts in UBOS_POPULATIONS
                        let calcPop = 0;
                        const regionDistricts = REGIONS[cleanName] || [];
                        regionDistricts.forEach(d => {
                            if (UBOS_POPULATIONS[d]) calcPop += UBOS_POPULATIONS[d];
                        });
                        
                        if (calcPop > 0) {
                            ubosPopulation = calcPop;
                            recalculatePeriodCatchment();
                            console.log(`‚úÖ Region: ${cleanName} = ${calcPop.toLocaleString()} (calculated from ${regionDistricts.length} districts)`);
                        } else {
                            console.warn(`‚ö†Ô∏è No population data for region: "${cleanName}"`);
                            ubosPopulation = 0;
                            ancCatchment = 0;
                            document.getElementById('ancCatchment').textContent = 'Region not found';
                        }
                    }
                }
                // Check if district (level 3) for UBOS population
                else if (actualLevel === 3 || dropdownLevel === 3) {
                    // Try different name variations to match UBOS data
                    const cleanName = parentName.toUpperCase()
                        .replace(' DISTRICT', '')
                        .replace(' CITY', '')
                        .replace('MUNICIPAL COUNCIL', '')
                        .trim();
                    
                    // Try exact match first
                    let pop = UBOS_POPULATIONS[cleanName];
                    
                    // Try with "CITY" suffix
                    if (!pop && !cleanName.includes('CITY')) {
                        pop = UBOS_POPULATIONS[cleanName + ' CITY'];
                    }
                    
                    // Try without "CITY" suffix
                    if (!pop && cleanName.includes('CITY')) {
                        pop = UBOS_POPULATIONS[cleanName.replace('CITY', '').trim()];
                    }
                    
                    if (pop) {
                        ubosPopulation = pop;
                        recalculatePeriodCatchment(); // Recalculate based on selected period
                        console.log(`‚úÖ Found district: ${cleanName} = ${pop.toLocaleString()}`);
                    } else {
                        console.warn(`‚ö†Ô∏è No UBOS population found for: "${cleanName}". Available districts:`, Object.keys(UBOS_POPULATIONS).slice(0, 10));
                        ubosPopulation = 0;
                        ancCatchment = 0;
                        document.getElementById('ancCatchment').textContent = 'Not found - enter custom';
                    }
                } else if (actualLevel > 3) {
                    // Sub-county/Facility level - clear and prompt for custom
                    ubosPopulation = 0;
                    ancCatchment = 0;
                    document.getElementById('ancCatchment').textContent = 'Enter population below';
                }
            }

            // Clear all lower level dropdowns
            for (let i = dropdownLevel + 1; i <= 6; i++) {
                const s = document.getElementById(`level${i}`);
                if (s) {
                    s.innerHTML = '<option>--</option>';
                    s.disabled = true;
                }
            }

            // Load next level
            if (!parentId || dropdownLevel >= 6) return;

            const nextLevel = dropdownLevel + 1;
            const nextSel = document.getElementById(`level${nextLevel}`);
            nextSel.innerHTML = '<option>‚è≥ Loading...</option>';
            nextSel.disabled = false;

            try {
                const response = await fetch(`/api/org-units?parent=${parentId}`);
                const data = await response.json();
                const children = (data.children || []).sort((a, b) => a.displayName.localeCompare(b.displayName));
                
                if (!children.length) {
                    nextSel.innerHTML = '<option>üì≠ No sub-units</option>';
                    nextSel.disabled = true;
                    return;
                }
                
                // Level names for display
                const levelNames = ['', '', 'Region', 'District', 'County', 'Sub-county', 'Facility'];
                const labelName = levelNames[nextLevel] || 'Unit';
                
                // Store actual level in data attribute for proper selection handling
                nextSel.innerHTML = `<option value="">-- Select ${labelName} (${children.length}) --</option>` +
                    children.map(u => `<option value="${u.id}" data-name="${u.displayName}" data-level="${u.level || nextLevel}">${u.displayName}</option>`).join('');
            } catch (error) {
                console.error('Error loading children:', error);
                nextSel.innerHTML = '<option>‚ùå Error loading</option>';
            }
        }

        // Select final level (facility)
        function selectFinalLevel(dropdownLevel) {
            const sel = document.getElementById(`level${dropdownLevel}`);
            if (sel.value) {
                // Get actual DHIS2 level from data attribute
                const actualLevel = parseInt(sel.options[sel.selectedIndex].dataset.level) || dropdownLevel;
                
                selectedOrgUnit = {
                    id: sel.value,
                    name: sel.options[sel.selectedIndex].dataset.name || sel.options[sel.selectedIndex].text,
                    level: actualLevel
                };
                document.getElementById('selectedOrgUnit').textContent = selectedOrgUnit.name;
                
                // Show population input for facilities only (level 6)
                const populationInputGroup = document.getElementById('populationInputGroup');
                if (actualLevel >= 6) {
                    populationInputGroup.style.display = 'block';
                    // Clear the date fields so user must select them
                    document.getElementById('startYear').value = '';
                    document.getElementById('startMonth').value = '';
                    document.getElementById('endYear').value = '';
                    document.getElementById('endMonth').value = '';
                    document.getElementById('populationInput').value = '';
                    ancCatchment = 0;
                    document.getElementById('ancCatchment').textContent = '0';
                } else {
                    populationInputGroup.style.display = 'none';
                }
                
                console.log('Selected facility:', selectedOrgUnit);
            }
        }

        // Search functionality
        function handleSearchInput(event) {
            const query = event.target.value.trim();
            
            if (searchTimeout) {
                clearTimeout(searchTimeout);
            }

            if (query.length < 3) {
                document.getElementById('searchDropdown').classList.remove('show');
                return;
            }

            searchTimeout = setTimeout(() => {
                searchOrgUnits(query);
            }, 300); // Debounce 300ms
        }

        async function searchOrgUnits(query) {
            const dropdown = document.getElementById('searchDropdown');
            const cacheKey = query.toLowerCase();

            // Check cache
            if (searchCache[cacheKey]) {
                renderSearchResults(searchCache[cacheKey]);
                return;
            }

            dropdown.innerHTML = '<div class="search-loading">üîç Searching...</div>';
            dropdown.classList.add('show');

            try {
                const response = await fetch(`/api/search-org-units?query=${encodeURIComponent(query)}`);
                const data = await response.json();

                if (data.error) {
                    dropdown.innerHTML = `<div class="search-no-results">‚ùå ${data.error}</div>`;
                    return;
                }

                const results = data.organisationUnits || [];
                searchCache[cacheKey] = results;
                renderSearchResults(results);
            } catch (error) {
                console.error('Search error:', error);
                dropdown.innerHTML = '<div class="search-no-results">‚ùå Search failed. Please try again.</div>';
            }
        }

        function renderSearchResults(results) {
            const dropdown = document.getElementById('searchDropdown');
            
            if (results.length === 0) {
                dropdown.innerHTML = '<div class="search-no-results">üòû No results found. Try a different search term.</div>';
                return;
            }

            dropdown.innerHTML = results.map(unit => `
                <div class="search-result-item" onclick="selectSearchResult('${unit.id}', '${unit.displayName.replace(/'/g, "\\'")}', ${unit.level})">
                    <div class="search-result-name">${unit.displayName}</div>
                    <div class="search-result-path">Level ${unit.level} ‚Ä¢ ${unit.path || ''}</div>
                </div>
            `).join('');
        }

        async function selectSearchResult(id, name, level) {
            selectedOrgUnit = { id, name, level };
            document.getElementById('selectedOrgUnit').textContent = name;

            // Clear search
            const searchInput = document.getElementById('orgUnitSearch');
            searchInput.value = '';
            searchInput.placeholder = `‚úì Selected: ${name}`;
            document.getElementById('searchDropdown').classList.remove('show');

            console.log(`üîç Loading hierarchy for: ${name} (Level ${level})`);

            try {
                // Fetch the org unit with its ancestors
                const response = await fetch(`/api/org-units/${id}`);
                const orgUnit = await response.json();
                
                // Build hierarchy: [Country, Region, District, Sub-county, Facility]
                const ancestors = orgUnit.ancestors || [];
                const fullHierarchy = [
                    ...ancestors.map(a => ({ id: a.id, name: a.displayName, level: a.level })),
                    { id: orgUnit.id, name: orgUnit.displayName, level: orgUnit.level }
                ];
                
                console.log('Hierarchy:', fullHierarchy.map(h => `L${h.level}: ${h.name}`).join(' ‚Üí '));
                
                // Extract each level from hierarchy
                const region = fullHierarchy.find(h => h.level === 2);
                const district = fullHierarchy.find(h => h.level === 3);
                const county = fullHierarchy.find(h => h.level === 4);
                const subCounty = fullHierarchy.find(h => h.level === 5);
                const facility = fullHierarchy.find(h => h.level === 6);
                
                // Reset all dropdowns first (levels 3-6)
                for (let i = 3; i <= 6; i++) {
                    const sel = document.getElementById(`level${i}`);
                    if (sel) {
                        sel.innerHTML = '<option value="">-- Select --</option>';
                        sel.disabled = true;
                        sel.value = '';
                    }
                }
                
                // Populate Level 2 (Region)
                if (region) {
                    const level2Select = document.getElementById('level2');
                    level2Select.value = region.id;
                    console.log(`  ‚úÖ Region: ${region.name}`);
                    
                    // Load districts for this region
                    await loadChildrenAndSelect(2, region.id, district);
                }
                
                // Populate Level 3 (District)
                if (district) {
                    console.log(`  ‚úÖ District: ${district.name}`);
                    
                    // Check UBOS population for district
                    const cleanName = district.name.toUpperCase()
                        .replace(' DISTRICT', '')
                        .replace(' CITY', '')
                        .replace('MUNICIPAL COUNCIL', '')
                        .trim();
                    
                    let pop = UBOS_POPULATIONS[cleanName] || 
                             UBOS_POPULATIONS[cleanName + ' CITY'] ||
                             UBOS_POPULATIONS[cleanName.replace('CITY', '').trim()];
                    
                    if (pop) {
                        ubosPopulation = pop;
                        recalculatePeriodCatchment();
                        console.log(`  üíæ UBOS Population: ${pop.toLocaleString()}`);
                    } else {
                        console.warn(`  ‚ö†Ô∏è No UBOS population for: ${cleanName}`);
                        ubosPopulation = 0;
                        ancCatchment = 0;
                        document.getElementById('ancCatchment').textContent = 'Not found';
                    }
                    
                    // Load counties for this district
                    await loadChildrenAndSelect(3, district.id, county);
                }
                
                // Populate Level 4 (County)
                if (county) {
                    console.log(`  ‚úÖ County: ${county.name}`);
                    
                    // Load sub-counties for this county
                    await loadChildrenAndSelect(4, county.id, subCounty);
                }
                
                // Populate Level 5 (Sub-county)
                if (subCounty) {
                    console.log(`  ‚úÖ Sub-county: ${subCounty.name}`);
                    
                    // Load facilities for this sub-county
                    await loadChildrenAndSelect(5, subCounty.id, facility);
                }
                
                // Populate Level 6 (Facility)
                if (facility && level === 6) {
                    console.log(`  ‚úÖ Facility: ${facility.name}`);
                }
                
                // Show/hide population input based on final level (only for facility level 6)
                const populationInputGroup = document.getElementById('populationInputGroup');
                if (level >= 6) {
                    // Facility level only
                    populationInputGroup.style.display = 'block';
                    // Clear the date fields so user must select them
                    document.getElementById('startYear').value = '';
                    document.getElementById('startMonth').value = '';
                    document.getElementById('endYear').value = '';
                    document.getElementById('endMonth').value = '';
                    document.getElementById('populationInput').value = '';
                    ancCatchment = 0;
                    document.getElementById('ancCatchment').textContent = '0';
                } else {
                    // Sub-county or above - hide population input
                    populationInputGroup.style.display = 'none';
                    document.getElementById('populationInput').value = '';
                }
                
            } catch (error) {
                console.error('‚ùå Error loading hierarchy:', error);
                alert('Could not load organization unit hierarchy. Please try again.');
            }

            console.log('Selected from search:', selectedOrgUnit);
        }

        // Helper function to load children and set selected value
        async function loadChildrenAndSelect(parentLevel, parentId, targetChild) {
            try {
                const response = await fetch(`/api/org-units?parent=${parentId}`);
                const data = await response.json();
                const children = data.organisationUnits || [];
                
                // Determine which level to populate - simple sequential
                // parentLevel 2 (Region) -> children are Level 3 (District)
                // parentLevel 3 (District) -> children are Level 4 (County)
                // parentLevel 4 (County) -> children are Level 5 (Sub-county)
                // parentLevel 5 (Sub-county) -> children are Level 6 (Facility)
                const targetLevel = parentLevel + 1;
                const select = document.getElementById(`level${targetLevel}`);
                
                if (!select || children.length === 0) return;
                
                // Level names for display
                const levelNames = ['', '', 'Region', 'District', 'County', 'Sub-county', 'Facility'];
                const labelName = levelNames[targetLevel] || 'Unit';
                
                // Populate dropdown
                select.innerHTML = `<option value="">-- Select ${labelName} (${children.length}) --</option>`;
                children.forEach(child => {
                    const option = document.createElement('option');
                    option.value = child.id;
                    option.textContent = child.displayName;
                    option.dataset.name = child.displayName;
                    select.appendChild(option);
                });
                
                select.disabled = false;
                
                // Select the target child if provided
                if (targetChild && targetChild.id) {
                    select.value = targetChild.id;
                    console.log(`    ‚Ü≥ Loaded ${children.length} options for Level ${targetLevel}, selected: ${targetChild.name}`);
                } else {
                    console.log(`    ‚Ü≥ Loaded ${children.length} options for Level ${targetLevel}`);
                }
                
            } catch (error) {
                console.error(`Error loading children for level ${parentLevel}:`, error);
            }
        }

        function showSearchDropdown() {
            const query = document.getElementById('orgUnitSearch').value;
            if (query.length >= 3) {
                document.getElementById('searchDropdown').classList.add('show');
            }
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.filter-group')) {
                document.getElementById('searchDropdown').classList.remove('show');
            }
        });

        function setupEventListeners() {
            // Population input listener for facilities
            document.getElementById('populationInput').addEventListener('input', recalculatePeriodCatchment);
            
            // Initialize year dropdowns on setup
            initializeYearDropdowns();
        }

        // Initialize year dropdowns
        function initializeYearDropdowns() {
            const currentYear = new Date().getFullYear();
            const startYear = 2018;
            const yearsHtml = [];
            
            for (let y = currentYear; y >= startYear; y--) {
                yearsHtml.push(`<option value="${y}">${y}</option>`);
            }
            
            document.getElementById('startYear').innerHTML = yearsHtml.join('');
            document.getElementById('endYear').innerHTML = yearsHtml.join('');
            
            // Set default: Last 12 months
                        const now = new Date();
            const endYear = now.getFullYear();
            const endMonth = now.getMonth() + 1; // 1-12
            
            // Calculate start date (12 months ago)
            let startYearVal = endYear;
            let startMonthVal = endMonth - 11;
            if (startMonthVal <= 0) {
                startMonthVal += 12;
                startYearVal -= 1;
            }
            
            document.getElementById('startYear').value = startYearVal;
            document.getElementById('startMonth').value = String(startMonthVal).padStart(2, '0');
            document.getElementById('endYear').value = endYear;
            document.getElementById('endMonth').value = String(endMonth).padStart(2, '0');
            
            // Update hidden inputs
            updateHiddenDateInputs();
                updatePeriodDisplay();
        }

        // Initialize compare period dropdowns (Compare tab is self-contained)
        function initializeCompareYearDropdowns() {
            const currentYear = new Date().getFullYear();
            const startYear = 2018;
            const yearsHtml = [];

            for (let y = currentYear; y >= startYear; y--) {
                yearsHtml.push(`<option value="${y}">${y}</option>`);
            }

            const sy = document.getElementById('compareStartYear');
            const ey = document.getElementById('compareEndYear');
            if (sy) sy.innerHTML = `<option value="">Year</option>` + yearsHtml.join('');
            if (ey) ey.innerHTML = `<option value="">Year</option>` + yearsHtml.join('');

            // Default: Last 12 months
            const now = new Date();
            const endYear = now.getFullYear();
            const endMonth = now.getMonth() + 1;
            let startYearVal = endYear;
            let startMonthVal = endMonth - 11;
            if (startMonthVal <= 0) {
                startMonthVal += 12;
                startYearVal -= 1;
            }

            const sm = document.getElementById('compareStartMonth');
            const em = document.getElementById('compareEndMonth');
            if (sy) sy.value = String(startYearVal);
            if (sm) sm.value = String(startMonthVal).padStart(2, '0');
            if (ey) ey.value = String(endYear);
            if (em) em.value = String(endMonth).padStart(2, '0');

            updateComparePeriodDisplay();
        }
        
        function updateHiddenDateInputs() {
            const startY = document.getElementById('startYear').value;
            const startM = document.getElementById('startMonth').value;
            const endY = document.getElementById('endYear').value;
            const endM = document.getElementById('endMonth').value;
            
            document.getElementById('startDateInput').value = `${startY}-${startM}`;
            document.getElementById('endDateInput').value = `${endY}-${endM}`;
        }
        
        function updatePeriodDisplay() {
            const startY = document.getElementById('startYear').value;
            const startM = document.getElementById('startMonth').value;
            const endY = document.getElementById('endYear').value;
            const endM = document.getElementById('endMonth').value;
            
            if (!startY || !startM || !endY || !endM) {
                document.getElementById('selectedPeriod').textContent = 'Select period';
                document.getElementById('monthsCount').textContent = '0';
                return;
            }
            
            const start = new Date(startY, parseInt(startM) - 1, 1);
            const end = new Date(endY, parseInt(endM) - 1, 1);
                    const months = (end.getFullYear() - start.getFullYear()) * 12 + (end.getMonth() - start.getMonth()) + 1;
                    
            const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            const startFormatted = `${monthNames[parseInt(startM) - 1]} ${startY}`;
            const endFormatted = `${monthNames[parseInt(endM) - 1]} ${endY}`;
            
            document.getElementById('selectedPeriod').textContent = `${startFormatted} - ${endFormatted}`;
            document.getElementById('monthsCount').textContent = months > 0 ? months : 0;

            // Update hidden inputs
            updateHiddenDateInputs();
        }
        
        function getSelectedMonths() {
            const startY = parseInt(document.getElementById('startYear').value);
            const startM = parseInt(document.getElementById('startMonth').value);
            const endY = parseInt(document.getElementById('endYear').value);
            const endM = parseInt(document.getElementById('endMonth').value);
            
            if (!startY || !startM || !endY || !endM) return 12;
            
            const months = (endY - startY) * 12 + (endM - startM) + 1;
            return months > 0 ? months : 1;
        }

        function getCompareSelectedMonths() {
            const startY = parseInt(document.getElementById('compareStartYear')?.value);
            const startM = parseInt(document.getElementById('compareStartMonth')?.value);
            const endY = parseInt(document.getElementById('compareEndYear')?.value);
            const endM = parseInt(document.getElementById('compareEndMonth')?.value);

            if (!startY || !startM || !endY || !endM) return 12;
            const months = (endY - startY) * 12 + (endM - startM) + 1;
            return months > 0 ? months : 1;
        }

        function updateComparePeriodDisplay() {
            const startY = document.getElementById('compareStartYear')?.value;
            const startM = document.getElementById('compareStartMonth')?.value;
            const endY = document.getElementById('compareEndYear')?.value;
            const endM = document.getElementById('compareEndMonth')?.value;

            const leaguePeriodDisplay = document.getElementById('leaguePeriodDisplay');
            if (!leaguePeriodDisplay) return;

            if (!startY || !startM || !endY || !endM) {
                leaguePeriodDisplay.textContent = '-';
                return;
            }

            const start = new Date(startY, parseInt(startM) - 1, 1);
            const end = new Date(endY, parseInt(endM) - 1, 1);
            const months = (end.getFullYear() - start.getFullYear()) * 12 + (end.getMonth() - start.getMonth()) + 1;
            const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            const startFormatted = `${monthNames[parseInt(startM) - 1]} ${startY}`;
            const endFormatted = `${monthNames[parseInt(endM) - 1]} ${endY}`;

            leaguePeriodDisplay.textContent = `${startFormatted} - ${endFormatted} (${months} months)`;
        }

        function recalculatePeriodCatchment() {
            const annualPop = parseInt(document.getElementById('populationInput').value) || 0;
            const months = getSelectedMonths();
            
            let ancTarget = 0;
            let deliveriesTarget = 0;
            
            // Calculate targets based on organization level
            if (selectedOrgUnit) {
                if (selectedOrgUnit.level <= 3 && ubosPopulation > 0) {
                    // District/Region level with UBOS population
                    // Formula: (Annual Population √∑ 12) √ó Months √ó Percentage
                    const monthlyPop = Math.round(ubosPopulation / 12);
                    const periodPop = monthlyPop * months;
                    ancTarget = Math.round(periodPop * 0.05);
                    deliveriesTarget = Math.round(periodPop * 0.0485);
                    
                    console.log(`üìä Calculation: (${ubosPopulation.toLocaleString()} √∑ 12) √ó ${months} months = ${periodPop.toLocaleString()}`);
                    console.log(`   ‚Üí ANC Target (√ó5%): ${ancTarget.toLocaleString()}`);
                    console.log(`   ‚Üí Deliveries Target (√ó4.85%): ${deliveriesTarget.toLocaleString()}`);
                } else if (annualPop > 0) {
                    // Facility/Sub-county level with custom population
                    // Same formula: (Annual Population √∑ 12) √ó Months √ó Percentage
                    const monthlyPop = Math.round(annualPop / 12);
                    const periodPop = monthlyPop * months;
                    ancTarget = Math.round(periodPop * 0.05);
                    deliveriesTarget = Math.round(periodPop * 0.0485);
                    
                    console.log(`üìä Calculation: (${annualPop.toLocaleString()} √∑ 12) √ó ${months} months = ${periodPop.toLocaleString()}`);
                    console.log(`   ‚Üí ANC Target (√ó5%): ${ancTarget.toLocaleString()}`);
                    console.log(`   ‚Üí Deliveries Target (√ó4.85%): ${deliveriesTarget.toLocaleString()}`);
                    
                    // Store facility period info
                    window.facilityPeriodInfo = {
                        annualPopulation: annualPop,
                        months: months,
                        periodPopulation: periodPop,
                        ancTarget: ancTarget,
                        deliveriesTarget: deliveriesTarget
                    };
                }
            }
            
            // Update global variable for backward compatibility
            ancCatchment = ancTarget;
            
            // Update UI
            document.getElementById('ancCatchment').textContent = ancTarget > 0 ? ancTarget.toLocaleString() : '-';
            document.getElementById('deliveriesTarget').textContent = deliveriesTarget > 0 ? deliveriesTarget.toLocaleString() : '-';
        }

        function updateCatchmentFromInput() {
            recalculatePeriodCatchment();
        }

        async function fetchData() {
            if (!selectedOrgUnit) {
                alert('Please select an organization unit first');
                return;
            }

            // Check if facility or sub-county level (level >= 5) requires population
            const orgLevel = selectedOrgUnit.level || 0;
            const populationInput = document.getElementById('populationInput');
            const customPopulation = parseInt(populationInput.value) || 0;
            
            if (orgLevel >= 5 && customPopulation <= 0) {
                alert('‚ö†Ô∏è Annual Population Required\n\nFor Sub-county and Facility levels, please complete the "Annual Population (for facilities)" section before loading analysis.');
                populationInput.focus();
                return;
            }

            // Get period from year/month dropdowns
            const startY = document.getElementById('startYear').value;
            const startM = document.getElementById('startMonth').value;
            const endY = document.getElementById('endYear').value;
            const endM = document.getElementById('endMonth').value;
            
            // Require valid period selection
            if (!startY || !startM || !endY || !endM) {
                alert('Please select start and end months');
                return;
            }
            
            // Generate period string for the selected date range
            const startDate = `${startY}-${startM}`;
            const endDate = `${endY}-${endM}`;
            
            // Update hidden inputs for backward compatibility
            document.getElementById('startDateInput').value = startDate;
            document.getElementById('endDateInput').value = endDate;
            
            const start = new Date(parseInt(startY), parseInt(startM) - 1, 1);
            const end = new Date(parseInt(endY), parseInt(endM) - 1, 1);
            
            // Validate dates
            if (start > end) {
                alert('Start date must be before or equal to end date');
                    return;
                }
                
                // Create DHIS2 period format (e.g., 202301;202302;202303...)
                const periods = [];
                let current = new Date(start);
                while (current <= end) {
                    const year = current.getFullYear();
                    const month = String(current.getMonth() + 1).padStart(2, '0');
                    periods.push(`${year}${month}`);
                    current.setMonth(current.getMonth() + 1);
                }
            const period = periods.join(';');
            console.log('üìÖ Using period:', period, `(${periods.length} months)`);
            
            const spinner = document.getElementById('loadingSpinner');
            spinner.classList.remove('hidden');
            document.getElementById('dataDisplay').classList.add('hidden');

            try {
                let url = `/maternal/api/anc-data?orgUnit=${selectedOrgUnit.id}&period=${encodeURIComponent(period)}`;
                if (customPopulation > 0) {
                    // Pass the period-adjusted catchment, not the annual population
                    const catchmentToSend = ancCatchment || Math.round(customPopulation * 0.05);
                    url += `&customPopulation=${customPopulation}&ancCatchment=${catchmentToSend}`;
                }

                console.log('Fetching data from:', url);
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.error) {
                    alert('Error: ' + data.error);
                    return;
                }

                console.log('Received data:', data);
                currentData = data;
                renderANCTable(data);
                renderCharts(data);
                
                document.getElementById('dataDisplay').classList.remove('hidden');
                
                // Also fetch Intrapartum data
                await fetchIntrapartumData(period, customPopulation);
                
            } catch (error) {
                console.error('Error fetching data:', error);
                alert('Failed to fetch data. Please try again.');
            } finally {
                spinner.classList.add('hidden');
            }
        }

        // Intrapartum data
        let intrapartumData = null;

        async function fetchIntrapartumData(period, customPopulation) {
            try {
                let url = `/maternal/api/intrapartum-data?orgUnit=${selectedOrgUnit.id}&period=${encodeURIComponent(period)}`;
                if (customPopulation > 0) {
                    const deliveriesCatchment = Math.round(customPopulation * 0.0485);
                    url += `&customPopulation=${customPopulation}&deliveriesCatchment=${deliveriesCatchment}`;
                }

                console.log('Fetching Intrapartum data from:', url);
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.error) {
                    console.warn('Intrapartum error:', data.error);
                    document.getElementById('intrapartumSection').style.display = 'block';
                    document.getElementById('intrapartumTableBody').innerHTML = `
                        <tr>
                            <td colspan="5" style="text-align: center; padding: 20px; color: var(--text-secondary);">
                                ‚ö†Ô∏è ${data.error}
                            </td>
                        </tr>
                    `;
                    return;
                }

                console.log('Received Intrapartum data:', data);
                intrapartumData = data;
                renderIntrapartumTable(data);
                document.getElementById('intrapartumSection').style.display = 'block';
                
            } catch (error) {
                console.error('Error fetching Intrapartum data:', error);
            }
        }

        function getIntrapartumColor(indicator, value) {
            // Color coding based on targets
            switch(indicator) {
                case 'DELIVERIES':
                    // Target: ‚â•70% green, 50-69.9% yellow, <50% red
                    if (value >= 70) return 'green';
                    if (value >= 50) return 'yellow';
                    return 'red';
                case 'LBW':
                    // Target: ‚â§5% green, 5.1-10% yellow, >10% red (lower is better)
                    if (value <= 5) return 'green';
                    if (value <= 10) return 'yellow';
                    return 'red';
                case 'KMC':
                    // Target: ‚â•90% green, 75-89.9% yellow, <75% red
                    if (value >= 90) return 'green';
                    if (value >= 75) return 'yellow';
                    return 'red';
                case 'ASPHYXIA':
                    // Target: ‚â§1% green, 1.1-5% yellow, >5% red (lower is better)
                    if (value <= 1) return 'green';
                    if (value <= 5) return 'yellow';
                    return 'red';
                case 'RESUSCITATION':
                    // Target: ‚â•90% green, 70-89.9% yellow, <70% red
                    if (value >= 90) return 'green';
                    if (value >= 70) return 'yellow';
                    return 'red';
                case 'FRESH_STILL':
                    // Target: ‚â§5 green, 5.1-10 yellow, >10 red (per 1000)
                    if (value <= 5) return 'green';
                    if (value <= 10) return 'yellow';
                    return 'red';
                case 'NEONATAL':
                    // Target: ‚â§5 green, 5.1-10 yellow, >10 red (per 1000)
                    if (value <= 5) return 'green';
                    if (value <= 10) return 'yellow';
                    return 'red';
                case 'PERINATAL':
                    // Target: ‚â§12 green, 12.1-20 yellow, >20 red (per 1000)
                    if (value <= 12) return 'green';
                    if (value <= 20) return 'yellow';
                    return 'red';
                case 'MMR':
                    // Target: ‚â§182 green, 182.1-300 yellow, >300 red (per 100,000)
                    if (value <= 182) return 'green';
                    if (value <= 300) return 'yellow';
                    return 'red';
                default:
                    return 'gray';
            }
        }

        function getIntrapartumTarget(indicator) {
            // Return target text for each indicator
            switch(indicator) {
                case 'DELIVERIES':
                    return '‚â•70%';
                case 'LBW':
                    return '‚â§5%';
                case 'KMC':
                    return '‚â•90%';
                case 'ASPHYXIA':
                    return '‚â§1%';
                case 'RESUSCITATION':
                    return '‚â•90%';
                case 'FRESH_STILL':
                    return '‚â§5 per 1,000';
                case 'NEONATAL':
                    return '‚â§5 per 1,000';
                case 'PERINATAL':
                    return '‚â§12 per 1,000';
                case 'MMR':
                    return '‚â§182 per 100,000';
                default:
                    return 'N/A';
            }
        }

        function renderIntrapartumTable(data) {
            const tbody = document.getElementById('intrapartumTableBody');
            tbody.innerHTML = '';
            
            // Update deliveries catchment display
            document.getElementById('deliveriesCatchment').textContent = 
                (data.deliveriesCatchment || 0).toLocaleString();
            
            const indicators = [
                {
                    name: 'Deliveries Coverage',
                    numerator: data.totalDeliveries || 0,
                    denominator: data.deliveriesCatchment || 0,
                    value: data.deliveriesCoverage || 0,
                    unit: '%',
                    indicator: 'DELIVERIES'
                },
                {
                    name: 'Low Birth Weight (<2.5kg)',
                    numerator: data.liveBirthsLBW || 0,
                    denominator: data.liveBirthsTotal || 0,
                    value: data.lbwRate || 0,
                    unit: '%',
                    indicator: 'LBW'
                },
                {
                    name: 'LBW Initiated on KMC',
                    numerator: data.kmcInitiated || 0,
                    denominator: data.liveBirthsLBW || 0,
                    value: data.kmcRate || 0,
                    unit: '%',
                    indicator: 'KMC'
                },
                {
                    name: 'Birth Asphyxia Rate',
                    numerator: data.birthAsphyxia || 0,
                    denominator: data.totalDeliveries || 0,
                    value: data.asphyxiaRate || 0,
                    unit: '%',
                    indicator: 'ASPHYXIA'
                },
                {
                    name: 'Asphyxia Successfully Resuscitated',
                    numerator: data.resuscitated || 0,
                    denominator: data.birthAsphyxia || 0,
                    value: data.resuscitationRate || 0,
                    unit: '%',
                    indicator: 'RESUSCITATION'
                },
                {
                    name: 'Fresh Still Births (per 1,000)',
                    numerator: data.freshStillBirth || 0,
                    denominator: data.totalDeliveries || 0,
                    value: data.freshStillRate || 0,
                    unit: '',
                    indicator: 'FRESH_STILL'
                },
                {
                    name: 'Neonatal Mortality Rate (per 1,000)',
                    numerator: (data.newbornDeaths0_7 || 0) + (data.newbornDeaths8_28 || 0),
                    denominator: data.liveBirthsTotal || 0,
                    value: data.neonatalMortality || 0,
                    unit: '',
                    indicator: 'NEONATAL'
                },
                {
                    name: 'Perinatal Mortality Rate (per 1,000)',
                    numerator: (data.freshStillBirth || 0) + (data.newbornDeaths0_7 || 0) + (data.maceratedStillBirth || 0),
                    denominator: data.liveBirthsTotal || 0,
                    value: data.perinatalMortality || 0,
                    unit: '',
                    indicator: 'PERINATAL'
                },
                {
                    name: 'Maternal Mortality Ratio (per 100,000)',
                    numerator: data.maternalDeaths || 0,
                    denominator: data.liveBirthsTotal || 0,
                    value: data.maternalMortalityRatio || 0,
                    unit: '',
                    indicator: 'MMR'
                }
            ];
            
            indicators.forEach(ind => {
                const color = getIntrapartumColor(ind.indicator, ind.value);
                const colorBg = color === 'green' ? '#10b981' : (color === 'yellow' ? '#f59e0b' : '#ef4444');
                const target = getIntrapartumTarget(ind.indicator);
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td style="font-weight: 500;">${ind.name}</td>
                    <td style="text-align: right;">${ind.numerator.toLocaleString()}</td>
                    <td style="text-align: right;">${ind.denominator.toLocaleString()}</td>
                    <td style="text-align: right; font-weight: 600; background-color: ${colorBg}; color: white; padding: 12px; border-radius: 4px;">
                        ${ind.value}${ind.unit}
                    </td>
                    <td style="text-align: right; font-weight: 500; color: var(--text-secondary);">
                        ${target}
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function downloadIntrapartumExcel() {
            console.log('üìä Intrapartum Excel Download v2.0 - Using SheetJS for .xlsx format');
            if (!intrapartumData) {
                alert('No Intrapartum data to download');
                return;
            }
            
            const data = intrapartumData;
            
            // Create workbook using SheetJS
            const wb = XLSX.utils.book_new();
            
            // Prepare data for worksheet
            const wsData = [];
            
            // Title and metadata rows
            wsData.push([`Intrapartum & Newborn Indicators - ${data.orgUnit || 'Unknown'}`]);
            wsData.push([`Period: ${data.period || 'N/A'}`]);
            wsData.push([`Population: ${(data.population || 0).toLocaleString()}`]);
            wsData.push([]);
            
            // Header row
            wsData.push(['Indicator', 'Numerator', 'Denominator', 'Value']);
            
            // Build indicators array
            const indicators = [
                { name: 'Deliveries Coverage', numerator: data.totalDeliveries || 0, denominator: data.deliveriesCatchment || 0, value: (data.deliveriesCoverage || 0) + '%', indicator: 'DELIVERIES', coverage: data.deliveriesCoverage || 0 },
                { name: 'Low Birth Weight', numerator: data.liveBirthsLBW || 0, denominator: data.liveBirthsTotal || 0, value: (data.lbwRate || 0) + '%', indicator: 'LBW', coverage: data.lbwRate || 0 },
                { name: 'KMC Initiated', numerator: data.kmcInitiated || 0, denominator: data.liveBirthsLBW || 0, value: (data.kmcRate || 0) + '%', indicator: 'KMC', coverage: data.kmcRate || 0 },
                { name: 'Birth Asphyxia', numerator: data.birthAsphyxia || 0, denominator: data.totalDeliveries || 0, value: (data.asphyxiaRate || 0) + '%', indicator: 'ASPHYXIA', coverage: data.asphyxiaRate || 0 },
                { name: 'Resuscitation Rate', numerator: data.resuscitated || 0, denominator: data.birthAsphyxia || 0, value: (data.resuscitationRate || 0) + '%', indicator: 'RESUSCITATION', coverage: data.resuscitationRate || 0 },
                { name: 'Fresh Still Births (per 1000)', numerator: data.freshStillBirth || 0, denominator: data.totalDeliveries || 0, value: data.freshStillRate || 0, indicator: 'FRESH_STILL', coverage: data.freshStillRate || 0 },
                { name: 'Neonatal Mortality (per 1000)', numerator: (data.newbornDeaths0_7 || 0) + (data.newbornDeaths8_28 || 0), denominator: data.liveBirthsTotal || 0, value: data.neonatalMortality || 0, indicator: 'NEONATAL', coverage: data.neonatalMortality || 0 },
                { name: 'Perinatal Mortality (per 1000)', numerator: (data.freshStillBirth || 0) + (data.newbornDeaths0_7 || 0) + (data.maceratedStillBirth || 0), denominator: data.liveBirthsTotal || 0, value: data.perinatalMortality || 0, indicator: 'PERINATAL', coverage: data.perinatalMortality || 0 },
                { name: 'Maternal Mortality (per 100,000)', numerator: data.maternalDeaths || 0, denominator: data.liveBirthsTotal || 0, value: data.maternalMortalityRatio || 0, indicator: 'MMR', coverage: data.maternalMortalityRatio || 0 }
            ];
            
            // Data rows
            indicators.forEach(ind => {
                wsData.push([ind.name, ind.numerator, ind.denominator, ind.value]);
            });
            
            // Legend
            wsData.push([]);
            wsData.push(['Performance Legend']);
            wsData.push(['GREEN', 'Target Achieved']);
            wsData.push(['YELLOW', 'Needs Improvement']);
            wsData.push(['RED', 'Below Target']);
            wsData.push([]);
            wsData.push([`Generated: ${new Date().toLocaleString()}`]);
            wsData.push(['Source: Uganda HMIS (DHIS2)']);
            
            // Create worksheet
            const ws = XLSX.utils.aoa_to_sheet(wsData);
            
            // Set column widths
            ws['!cols'] = [
                { wch: 35 },  // Indicator
                { wch: 12 },  // Numerator
                { wch: 12 },  // Denominator
                { wch: 15 }   // Value
            ];
            
            // Define styles
            const headerStyle = {
                font: { bold: true, color: { rgb: "FFFFFF" }, sz: 11 },
                fill: { fgColor: { rgb: "1E3A5F" } },
                alignment: { horizontal: "center", vertical: "center" },
                border: {
                    top: { style: "thin", color: { rgb: "000000" } },
                    bottom: { style: "thin", color: { rgb: "000000" } },
                    left: { style: "thin", color: { rgb: "000000" } },
                    right: { style: "thin", color: { rgb: "000000" } }
                }
            };
            
            const titleStyle = { font: { bold: true, sz: 14 } };
            
            const cellBorder = {
                top: { style: "thin", color: { rgb: "000000" } },
                bottom: { style: "thin", color: { rgb: "000000" } },
                left: { style: "thin", color: { rgb: "000000" } },
                right: { style: "thin", color: { rgb: "000000" } }
            };
            
            // Apply title style
            if (ws['A1']) ws['A1'].s = titleStyle;
            
            // Apply header styles (row 5)
            ['A5', 'B5', 'C5', 'D5'].forEach(cell => {
                if (ws[cell]) ws[cell].s = headerStyle;
            });
            
            // Apply data row styles with color coding
            indicators.forEach((ind, idx) => {
                const rowNum = idx + 6; // Data starts at row 6
                const colorResult = getIntrapartumColor(ind.indicator, ind.coverage);
                
                // Get colors based on performance
                let bgColor, fontColor;
                if (colorResult === 'green') {
                    bgColor = '10B981';
                    fontColor = 'FFFFFF';
                } else if (colorResult === 'yellow') {
                    bgColor = 'F59E0B';
                    fontColor = '000000';
                } else {
                    bgColor = 'EF4444';
                    fontColor = 'FFFFFF';
                }
                
                // Style for indicator name (bold, border)
                if (ws[`A${rowNum}`]) {
                    ws[`A${rowNum}`].s = {
                        font: { bold: true },
                        border: cellBorder
                    };
                }
                
                // Style for numerator and denominator (center, border)
                ['B', 'C'].forEach(col => {
                    if (ws[`${col}${rowNum}`]) {
                        ws[`${col}${rowNum}`].s = {
                            alignment: { horizontal: "center" },
                            border: cellBorder
                        };
                    }
                });
                
                // Style for value (colored background)
                if (ws[`D${rowNum}`]) {
                    ws[`D${rowNum}`].s = {
                        font: { bold: true, color: { rgb: fontColor } },
                        fill: { fgColor: { rgb: bgColor } },
                        alignment: { horizontal: "center", vertical: "center" },
                        border: cellBorder
                    };
                }
            });
            
            // Add worksheet to workbook
            XLSX.utils.book_append_sheet(wb, ws, 'Intrapartum');
            
            // Generate and download
            const orgName = (data.orgUnit || 'data').replace(/[^a-zA-Z0-9]/g, '_');
            const fileName = `Intrapartum_${orgName}_${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(wb, fileName);
        }

        function downloadIntrapartumJPG() {
            downloadChartAsJPG('intrapartumSection', 'Intrapartum_Indicators');
        }

        function renderANCTable(data) {
            const tbody = document.getElementById('ancTableBody');
            tbody.innerHTML = '';

            // Get raw values from API response
            const anc1Visit = data.anc1Visit || 0;
            const anc1stTri = data.anc1stTrimester || 0;
            const anc4 = data.anc4 || 0;
            const anc8 = data.anc8 || 0;
            const ipt3 = data.ipt3 || 0;
            const hbTest = data.hbTest || 0;
            const ultrasoundScan = data.ultrasoundScan || 0;
            const totalANCContacts = data.totalANCContacts || 0;
            const llin = data.llin || 0;
            const ironFolic = data.ironFolic || 0;
            const teenUnder15 = data.teenUnder15 || 0;
            const teen15_19 = data.teen15_19 || 0;

            // Update global ANC catchment from API if available
            if (data.ancCatchment) {
                ancCatchment = data.ancCatchment;
                document.getElementById('ancCatchment').textContent = ancCatchment.toLocaleString();
            }

            // Use calculated values from API (backend does the calculations)
            const anc1Coverage = data.anc1Coverage || 0;
            const anc1stTriRate = data.anc1stTriRate || 0;
            const anc4Coverage = data.anc4Coverage || 0;
            const anc8Coverage = data.anc8Coverage || 0;
            const ipt3Coverage = data.ipt3Coverage || 0;
            const hbTestRate = data.hbTestRate || 0;
            const ultrasoundRate = data.ultrasoundRate || 0;
            const llinRate = data.llinRate || 0;
            const ironFolicRate = data.ironFolicRate || 0;
            const teenPregRate = data.teenPregRate || 0;

            // Define all indicators with their formulas
            const indicators = [
                // Population-based indicators (denominator = ANC catchment)
                { 
                    name: 'ANC 1st Visit Coverage', 
                    numerator: anc1Visit, 
                    denominator: ancCatchment,
                    formula: 'ANC 1st Visit √∑ ANC Catchment √ó 100',
                    coverage: anc1Coverage, 
                    targetPct: 100, 
                    indicator: 'ANC_1ST_VISIT' 
                },
                // Non-population based (denominator = ANC 1st Visit)
                { 
                    name: 'ANC 1st Trimester Rate', 
                    numerator: anc1stTri, 
                    denominator: anc1Visit,
                    formula: 'ANC 1st Tri √∑ ANC 1st Visit √ó 100',
                    coverage: anc1stTriRate, 
                    targetPct: 45, 
                    indicator: 'ANC_1ST_TRIMESTER' 
                },
                // Population-based
                { 
                    name: 'ANC 4th Visit Coverage', 
                    numerator: anc4, 
                    denominator: ancCatchment,
                    formula: 'ANC 4th Visit √∑ ANC Catchment √ó 100',
                    coverage: anc4Coverage, 
                    targetPct: 75, 
                    indicator: 'ANC_4TH_VISIT' 
                },
                { 
                    name: 'ANC 8+ Visits Coverage', 
                    numerator: anc8, 
                    denominator: ancCatchment,
                    formula: 'ANC 8+ Visits √∑ ANC Catchment √ó 100',
                    coverage: anc8Coverage, 
                    targetPct: 20, 
                    indicator: 'ANC_8TH_VISIT' 
                },
                { 
                    name: 'IPT3 Coverage', 
                    numerator: ipt3, 
                    denominator: ancCatchment,
                    formula: 'IPT3 Recipients √∑ ANC Catchment √ó 100',
                    coverage: ipt3Coverage, 
                    targetPct: 80, 
                    indicator: 'IPT3' 
                },
                // Non-population based (denominator = ANC 1st Visit)
                { 
                    name: 'Hb Testing at 1st Contact', 
                    numerator: hbTest, 
                    denominator: anc1Visit,
                    formula: 'Hb Tests √∑ ANC 1st Visit √ó 100',
                    coverage: hbTestRate, 
                    targetPct: 75, 
                    indicator: 'HB_TEST' 
                },
                { 
                    name: 'Obstetric Ultrasound Scan', 
                    numerator: ultrasoundScan, 
                    denominator: totalANCContacts,
                    formula: 'Ultrasound Scans √∑ Total ANC Contacts √ó 100',
                    coverage: ultrasoundRate, 
                    targetPct: 75, 
                    indicator: 'ULTRASOUND' 
                },
                { 
                    name: 'LLIN at ANC 1', 
                    numerator: llin, 
                    denominator: anc1Visit,
                    formula: 'LLINs Given √∑ ANC 1st Visit √ó 100',
                    coverage: llinRate, 
                    targetPct: 80, 
                    indicator: 'LLIN' 
                },
                { 
                    name: 'Iron/Folic Acid (30+ tablets)', 
                    numerator: ironFolic, 
                    denominator: anc1Visit,
                    formula: 'IFA Recipients √∑ ANC 1st Visit √ó 100',
                    coverage: ironFolicRate, 
                    targetPct: 75, 
                    indicator: 'IRON_FOLIC' 
                },
                { 
                    name: 'Teenage Pregnancies', 
                    numerator: teenUnder15 + teen15_19, 
                    denominator: anc1Visit,
                    formula: '(ANC <15yrs + ANC 15-19yrs) √∑ ANC 1st Visit √ó 100',
                    coverage: teenPregRate, 
                    targetPct: 13, 
                    indicator: 'TEEN_PREG' 
                },
            ];

            indicators.forEach(ind => {
                const row = tbody.insertRow();
                
                // Indicator name
                row.insertCell().textContent = ind.name;
                
                // Numerator (raw value)
                row.insertCell().textContent = ind.numerator.toLocaleString();
                
                // Denominator
                row.insertCell().textContent = ind.denominator > 0 ? ind.denominator.toLocaleString() : 'N/A';
                
                // Coverage/Rate with color coding
                const coverageCell = row.insertCell();
                if (ind.denominator > 0 && ind.coverage > 0) {
                    coverageCell.textContent = ind.coverage + '%';
                    coverageCell.className = getColorClass(parseFloat(ind.coverage), ind.indicator);
                } else if (ind.denominator === 0) {
                    coverageCell.textContent = 'Enter Population';
                    coverageCell.style.fontStyle = 'italic';
                    coverageCell.style.color = '#888';
                } else {
                    coverageCell.textContent = '0%';
                    coverageCell.className = 'cell-red';
                }
                
                // Target
                const targetText = ind.indicator === 'TEEN_PREG' ? `‚â§${ind.targetPct}%` : `‚â•${ind.targetPct}%`;
                row.insertCell().textContent = targetText;
            });

            // Show debug info in console
            console.log('üìä ANC Data Loaded:', {
                orgUnit: data.orgUnit,
                population: data.population,
                ancCatchment: data.ancCatchment,
                dataElementsFound: data.dataElementsFound,
                rowsReturned: data.rowsReturned
            });
        }

        function renderCharts(data) {
            // Destroy existing charts
            Object.values(chartInstances).forEach(chart => chart.destroy());
            chartInstances = {};

            // Helper function to get color based on value and indicator
            function getChartColor(value, indicator) {
                const colorClass = getColorClass(value, indicator);
                if (colorClass === 'cell-green') return '#22c55e';
                if (colorClass === 'cell-yellow') return '#eab308';
                return '#ef4444';
            }

            // Coverage data with color coding
            const coverageData = [
                { label: 'ANC 1', value: data.anc1Coverage || 0, indicator: 'ANC_1ST_VISIT', target: 100 },
                { label: 'ANC 1st Tri', value: data.anc1stTriRate || 0, indicator: 'ANC_1ST_TRIMESTER', target: 45 },
                { label: 'ANC 4', value: data.anc4Coverage || 0, indicator: 'ANC_4TH_VISIT', target: 75 },
                { label: 'ANC 8', value: data.anc8Coverage || 0, indicator: 'ANC_8TH_VISIT', target: 20 }
            ];

            const coverageColors = coverageData.map(d => getChartColor(d.value, d.indicator));

            // Coverage Chart
            const ctx1 = document.getElementById('coverageChart').getContext('2d');
            chartInstances.coverage = new Chart(ctx1, {
                type: 'bar',
                data: {
                    labels: coverageData.map(d => d.label),
                    datasets: [{
                        label: 'Coverage (%)',
                        data: coverageData.map(d => d.value),
                        backgroundColor: coverageColors,
                        borderColor: coverageColors.map(c => c),
                        borderWidth: 2
                    }, {
                        label: 'Target',
                        data: coverageData.map(d => d.target),
                        type: 'line',
                        borderColor: '#64748b',
                        borderWidth: 2,
                        borderDash: [5, 5],
                        pointRadius: 0,
                        fill: false
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { 
                            display: true,
                            position: 'top'
                        },
                        datalabels: {
                            display: true,
                            anchor: 'end',
                            align: 'top',
                            color: '#fff',
                            backgroundColor: function(context) {
                                return context.dataset.backgroundColor ? context.dataset.backgroundColor[context.dataIndex] : '#64748b';
                            },
                            borderRadius: 4,
                            padding: 4,
                            font: { weight: 'bold', size: 11 },
                            formatter: function(value) {
                                return value.toFixed(1) + '%';
                            }
                        }
                    },
                    scales: {
                        y: { 
                            beginAtZero: true, 
                            max: 150,
                            title: { display: true, text: 'Percentage (%)' }
                        }
                    }
                },
                plugins: [ChartDataLabels]
            });

            // Create coverage legend
            const coverageLegend = document.getElementById('coverageLegend');
            coverageLegend.innerHTML = coverageData.map((d, i) => {
                const status = getColorClass(d.value, d.indicator) === 'cell-green' ? '‚úì' : 
                              getColorClass(d.value, d.indicator) === 'cell-yellow' ? '‚ö†' : '‚úó';
                return `<span style="display: inline-flex; align-items: center; gap: 4px; padding: 4px 8px; background: ${coverageColors[i]}; color: white; border-radius: 4px; font-size: 11px; font-weight: bold;">
                    ${d.label}: ${d.value.toFixed(1)}% ${status}
                </span>`;
            }).join('');

            // Quality data with color coding
            const qualityData = [
                { label: 'IPT3', value: data.ipt3Coverage || 0, indicator: 'IPT3', target: 80 },
                { label: 'Hb Test', value: data.hbTestRate || 0, indicator: 'HB_TEST', target: 75 },
                { label: 'LLIN', value: data.llinRate || 0, indicator: 'LLIN', target: 80 },
                { label: 'Iron/Folic', value: data.ironFolicRate || 0, indicator: 'IRON_FOLIC', target: 75 },
                { label: 'Teen Preg', value: data.teenPregRate || 0, indicator: 'TEEN_PREG', target: 13 }
            ];

            const qualityColors = qualityData.map(d => getChartColor(d.value, d.indicator));

            // Quality Chart - Horizontal Bar for better visualization
            const ctx2 = document.getElementById('qualityChart').getContext('2d');
            chartInstances.quality = new Chart(ctx2, {
                type: 'bar',
                data: {
                    labels: qualityData.map(d => d.label),
                    datasets: [{
                        label: 'Performance (%)',
                        data: qualityData.map(d => d.value),
                        backgroundColor: qualityColors,
                        borderColor: qualityColors,
                        borderWidth: 2
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        datalabels: {
                            display: true,
                            anchor: 'end',
                            align: 'right',
                            color: '#fff',
                            backgroundColor: function(context) {
                                return context.dataset.backgroundColor[context.dataIndex];
                            },
                            borderRadius: 4,
                            padding: 4,
                            font: { weight: 'bold', size: 11 },
                            formatter: function(value) {
                                return value.toFixed(1) + '%';
                            }
                        }
                    },
                    scales: {
                        x: { 
                            beginAtZero: true, 
                            max: 120,
                            title: { display: true, text: 'Percentage (%)' }
                        }
                    }
                },
                plugins: [ChartDataLabels]
            });

            // Create quality legend
            const qualityLegend = document.getElementById('qualityLegend');
            qualityLegend.innerHTML = qualityData.map((d, i) => {
                const status = getColorClass(d.value, d.indicator) === 'cell-green' ? '‚úì On Target' : 
                              getColorClass(d.value, d.indicator) === 'cell-yellow' ? '‚ö† Needs Work' : '‚úó Below Target';
                return `<span style="display: inline-flex; align-items: center; gap: 4px; padding: 4px 8px; background: ${qualityColors[i]}; color: ${qualityColors[i] === '#eab308' ? '#000' : '#fff'}; border-radius: 4px; font-size: 10px; font-weight: bold;">
                    ${d.label}: ${status}
                </span>`;
            }).join('');
        }

        // Download chart as JPG
        async function downloadChartAsJPG(chartCardId, filename) {
            const cardElement = document.getElementById(chartCardId);
            if (!cardElement) {
                alert('Chart not found');
                return;
            }

            try {
                // Get the chart canvas element
                const canvasElement = cardElement.querySelector('canvas');
                if (!canvasElement) {
                    alert('Chart canvas not found');
                    return;
                }

                // Create a new canvas to combine everything
                const finalCanvas = document.createElement('canvas');
                const ctx = finalCanvas.getContext('2d');
                
                // Set dimensions (add padding for title and legend)
                const padding = 60;
                const legendHeight = 80;
                finalCanvas.width = canvasElement.width + (padding * 2);
                finalCanvas.height = canvasElement.height + (padding * 2) + legendHeight;
                
                // Fill white background
                ctx.fillStyle = '#ffffff';
                ctx.fillRect(0, 0, finalCanvas.width, finalCanvas.height);
                
                // Add title
                ctx.fillStyle = '#1e293b';
                ctx.font = 'bold 24px Arial';
                ctx.textAlign = 'center';
                const title = cardElement.querySelector('h3').textContent;
                ctx.fillText(title, finalCanvas.width / 2, 40);
                
                // Add organization unit name
                ctx.font = '16px Arial';
                ctx.fillStyle = '#64748b';
                ctx.fillText(currentData?.orgUnit || 'N/A', finalCanvas.width / 2, 65);
                
                // Draw the chart canvas
                ctx.drawImage(canvasElement, padding, padding + 30, canvasElement.width, canvasElement.height);
                
                // Add legend at bottom
                const legendElement = cardElement.querySelector('div[id$="Legend"]');
                if (legendElement) {
                    const legendItems = legendElement.querySelectorAll('span');
                    let yPos = canvasElement.height + padding + 50;
                    let xPos = padding;
                    
                    legendItems.forEach((item, index) => {
                        const text = item.textContent;
                        const bgColor = window.getComputedStyle(item).backgroundColor;
                        const color = window.getComputedStyle(item).color;
                        
                        // Draw legend box
                        ctx.fillStyle = bgColor;
                        ctx.fillRect(xPos, yPos, 15, 15);
                        
                        // Draw legend text
                        ctx.fillStyle = '#1e293b';
                        ctx.font = '12px Arial';
                        ctx.textAlign = 'left';
                        ctx.fillText(text, xPos + 20, yPos + 12);
                        
                        xPos += 180;
                        if (xPos > finalCanvas.width - 180) {
                            xPos = padding;
                            yPos += 25;
                        }
                    });
                }
                
                // Add footer
                ctx.fillStyle = '#94a3b8';
                ctx.font = '11px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(`Generated: ${new Date().toLocaleString()} | Source: Uganda HMIS`, finalCanvas.width / 2, finalCanvas.height - 15);
                
                // Convert to JPG and download
                finalCanvas.toBlob((blob) => {
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    const orgName = (currentData?.orgUnit || 'Chart').replace(/[^a-zA-Z0-9]/g, '_');
                    link.download = `${filename}_${orgName}_${new Date().toISOString().split('T')[0]}.jpg`;
                    link.href = url;
                    link.click();
                    URL.revokeObjectURL(url);
                }, 'image/jpeg', 0.95);
                
            } catch (error) {
                console.error('Error downloading chart:', error);
                alert('Error downloading chart. Please try again.');
            }
        }

        function applyAdjustments() {
            const overrideCatchment = parseInt(document.getElementById('overrideCatchment').value);
            const overridePopulation = parseInt(document.getElementById('overridePopulation').value);
            
            if (overrideCatchment) {
                ancCatchment = overrideCatchment;
            } else if (overridePopulation) {
                ancCatchment = Math.round(overridePopulation * 0.05);
            }
            
            document.getElementById('ancCatchment').textContent = ancCatchment.toLocaleString();
            
            if (currentData) {
                renderANCTable(currentData);
            }
            
            alert('Adjustments applied! Click "Load analysis" to recalculate with new parameters.');
        }

        async function clearCache() {
            try {
                await fetch('/api/clear-cache', { method: 'POST' });
                alert('Cache cleared successfully!');
            } catch (error) {
                console.error('Error clearing cache:', error);
            }
        }

        function downloadExcel() {
            console.log('üìä ANC Excel Download v2.0 - Using SheetJS for .xlsx format');
            if (!currentData) {
                alert('Please load data first');
                return;
            }
            
            // Get the table data
            const anc1 = currentData.anc1Visit || 0;
            const ancCatch = currentData.ancCatchment || ancCatchment || 0;
            
            // Build the data array with all indicators
            const indicators = [
                { name: 'ANC 1st Visit Coverage', numerator: currentData.anc1Visit || 0, denominator: ancCatch, coverage: currentData.anc1Coverage || 0, target: '‚â•100%', indicator: 'ANC_1ST_VISIT' },
                { name: 'ANC 1st Trimester Rate', numerator: currentData.anc1stTrimester || 0, denominator: anc1, coverage: currentData.anc1stTriRate || 0, target: '‚â•45%', indicator: 'ANC_1ST_TRIMESTER' },
                { name: 'ANC 4th Visit Coverage', numerator: currentData.anc4 || 0, denominator: ancCatch, coverage: currentData.anc4Coverage || 0, target: '‚â•75%', indicator: 'ANC_4TH_VISIT' },
                { name: 'ANC 8+ Visits Coverage', numerator: currentData.anc8 || 0, denominator: ancCatch, coverage: currentData.anc8Coverage || 0, target: '‚â•20%', indicator: 'ANC_8TH_VISIT' },
                { name: 'IPT3 Coverage', numerator: currentData.ipt3 || 0, denominator: ancCatch, coverage: currentData.ipt3Coverage || 0, target: '‚â•80%', indicator: 'IPT3' },
                { name: 'Hb Testing at 1st Contact', numerator: currentData.hbTest || 0, denominator: anc1, coverage: currentData.hbTestRate || 0, target: '‚â•75%', indicator: 'HB_TEST' },
                { name: 'Obstetric Ultrasound Scan', numerator: currentData.ultrasoundScan || 0, denominator: currentData.totalANCContacts || 0, coverage: currentData.ultrasoundRate || 0, target: '‚â•75%', indicator: 'ULTRASOUND' },
                { name: 'LLIN at ANC 1', numerator: currentData.llin || 0, denominator: anc1, coverage: currentData.llinRate || 0, target: '‚â•80%', indicator: 'LLIN' },
                { name: 'Iron/Folic Acid', numerator: currentData.ironFolic || 0, denominator: anc1, coverage: currentData.ironFolicRate || 0, target: '‚â•75%', indicator: 'IRON_FOLIC' },
                { name: 'Teenage Pregnancies', numerator: (currentData.teenUnder15 || 0) + (currentData.teen15_19 || 0), denominator: anc1, coverage: currentData.teenPregRate || 0, target: '‚â§13%', indicator: 'TEEN_PREG' }
            ];
            
            // Create workbook using SheetJS
            const wb = XLSX.utils.book_new();
            
            // Prepare data for worksheet
            const wsData = [];
            
            // Title and metadata rows
            wsData.push([`ANC Quality Indicators - ${currentData.orgUnit || 'Unknown'}`]);
            wsData.push([`Period: ${currentData.period || 'N/A'}`]);
            wsData.push([`Population: ${(currentData.population || 0).toLocaleString()}`]);
            wsData.push([`ANC Catchment (5%): ${(currentData.ancCatchment || ancCatch).toLocaleString()}`]);
            wsData.push([]);
            
            // Header row
            wsData.push(['Indicator', 'Value', 'Target Pop.', 'Coverage/Rate (%)', 'Target (%)']);
            
            // Data rows
            indicators.forEach(ind => {
                wsData.push([
                    ind.name,
                    ind.numerator,
                    ind.denominator,
                    ind.coverage.toFixed(1) + '%',
                    ind.target
                ]);
            });
            
            // Legend
            wsData.push([]);
            wsData.push(['Performance Legend']);
            wsData.push(['GREEN', 'Target Achieved']);
            wsData.push(['YELLOW', 'Needs Improvement']);
            wsData.push(['RED', 'Below Target']);
            wsData.push([]);
            wsData.push([`Generated: ${new Date().toLocaleString()}`]);
            wsData.push(['Source: Uganda HMIS (DHIS2)']);
            
            // Create worksheet
            const ws = XLSX.utils.aoa_to_sheet(wsData);
            
            // Set column widths
            ws['!cols'] = [
                { wch: 30 },  // Indicator
                { wch: 12 },  // Value
                { wch: 15 },  // Target Pop
                { wch: 18 },  // Coverage
                { wch: 12 }   // Target
            ];
            
            // Apply styles
            const headerStyle = {
                font: { bold: true, color: { rgb: "FFFFFF" }, sz: 11 },
                fill: { fgColor: { rgb: "1E293B" } },
                alignment: { horizontal: "center", vertical: "center" },
                border: {
                    top: { style: "thin", color: { rgb: "000000" } },
                    bottom: { style: "thin", color: { rgb: "000000" } },
                    left: { style: "thin", color: { rgb: "000000" } },
                    right: { style: "thin", color: { rgb: "000000" } }
                }
            };
            
            const titleStyle = {
                font: { bold: true, sz: 14 }
            };
            
            const cellBorder = {
                top: { style: "thin", color: { rgb: "000000" } },
                bottom: { style: "thin", color: { rgb: "000000" } },
                left: { style: "thin", color: { rgb: "000000" } },
                right: { style: "thin", color: { rgb: "000000" } }
            };
            
            // Apply title style
            if (ws['A1']) ws['A1'].s = titleStyle;
            
            // Apply header styles (row 6)
            ['A6', 'B6', 'C6', 'D6', 'E6'].forEach(cell => {
                if (ws[cell]) ws[cell].s = headerStyle;
            });
            
            // Apply data row styles with color coding
            indicators.forEach((ind, idx) => {
                const rowNum = idx + 7; // Data starts at row 7
                const colorClass = getColorClass(ind.coverage, ind.indicator);
                
                // Get colors based on performance
                let bgColor, fontColor;
                if (colorClass === 'cell-green') {
                    bgColor = '22C55E';
                    fontColor = 'FFFFFF';
                } else if (colorClass === 'cell-yellow') {
                    bgColor = 'EAB308';
                    fontColor = '000000';
                } else {
                    bgColor = 'EF4444';
                    fontColor = 'FFFFFF';
                }
                
                // Style for indicator name (bold, border)
                if (ws[`A${rowNum}`]) {
                    ws[`A${rowNum}`].s = {
                        font: { bold: true },
                        border: cellBorder
                    };
                }
                
                // Style for value and target pop (center, border)
                ['B', 'C'].forEach(col => {
                    if (ws[`${col}${rowNum}`]) {
                        ws[`${col}${rowNum}`].s = {
                            alignment: { horizontal: "center" },
                            border: cellBorder
                        };
                    }
                });
                
                // Style for coverage (colored background)
                if (ws[`D${rowNum}`]) {
                    ws[`D${rowNum}`].s = {
                        font: { bold: true, color: { rgb: fontColor } },
                        fill: { fgColor: { rgb: bgColor } },
                        alignment: { horizontal: "center", vertical: "center" },
                        border: cellBorder
                    };
                }
                
                // Style for target
                if (ws[`E${rowNum}`]) {
                    ws[`E${rowNum}`].s = {
                        alignment: { horizontal: "center" },
                        border: cellBorder
                    };
                }
            });
            
            // Style legend
            const legendStartRow = indicators.length + 9;
            if (ws[`A${legendStartRow}`]) ws[`A${legendStartRow}`].s = { font: { bold: true } };
            
            // Add worksheet to workbook
            XLSX.utils.book_append_sheet(wb, ws, 'ANC Indicators');
            
            // Generate and download
            const orgName = (currentData.orgUnit || 'ANC_Data').replace(/[^a-zA-Z0-9]/g, '_');
            const fileName = `ANC_Indicators_${orgName}_${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(wb, fileName);
        }
        
        function getStatusText(coverage, indicator) {
            const colorClass = getColorClass(coverage, indicator);
            if (colorClass === 'cell-green') return '‚úì On Target';
            if (colorClass === 'cell-yellow') return '‚ö† Needs Improvement';
            return '‚úó Below Target';
        }

        async function loadLeagueTable() {
            const selectedOptions = Array.from(document.getElementById('leagueUnitsSelect').selectedOptions);
            
            if (selectedOptions.length < 2) {
                alert('Please select at least 2 units to compare');
                return;
            }
            
            // Check if any facilities need catchment population
            const facilitiesNeedingPopulation = selectedOptions.filter(opt => opt.dataset.level > 3);
            
            if (facilitiesNeedingPopulation.length > 0) {
                const container = document.getElementById('catchmentInputsContainer');
                container.innerHTML = '';
                
                facilitiesNeedingPopulation.forEach(opt => {
                    const div = document.createElement('div');
                    div.className = 'filter-group';
                    div.innerHTML = `
                        <label>${opt.text}</label>
                        <input type="number" class="facility-population" data-unit-id="${opt.value}" placeholder="Enter population" min="0">
                    `;
                    container.appendChild(div);
                });
                
                document.getElementById('facilityCatchmentInputs').classList.remove('hidden');
            } else {
                calculateLeague();
            }
        }

        async function calculateLeague() {
            // League table calculation implementation
            alert('League table calculation in progress...');
            document.getElementById('leagueTableDisplay').classList.remove('hidden');
        }

        // =========================
        // üèÜ Compare (Districts / Facilities)
        // =========================
        let compareContext = {
            mode: 'districts', // 'districts' | 'facilities'
            units: [],         // [{id, displayName, level}]
            resultsById: {},   // { [id]: ancData }
            facilityPopulations: {} // { [facilityId]: annualPopulation }
        };

        function onCompareModeChange() {
            const selected = document.querySelector('input[name="compareMode"]:checked')?.value || 'districts';
            compareContext.mode = selected;
            document.getElementById('compareDistrictsPanel').classList.toggle('hidden', selected !== 'districts');
            document.getElementById('compareFacilitiesPanel').classList.toggle('hidden', selected !== 'facilities');

            // Toggle facility-only columns
            document.querySelectorAll('.facility-only').forEach(el => {
                el.classList.toggle('hidden', selected !== 'facilities');
            });

            // Hide table and clear previous results when user switches mode
            document.getElementById('compareTableDisplay').classList.add('hidden');
            document.getElementById('compareTableBody').innerHTML = '';
            compareContext.resultsById = {};
        }

        function getComparisonPeriodOrAlert() {
            const startY = document.getElementById('compareStartYear')?.value;
            const startM = document.getElementById('compareStartMonth')?.value;
            const endY = document.getElementById('compareEndYear')?.value;
            const endM = document.getElementById('compareEndMonth')?.value;

            if (!startY || !startM || !endY || !endM) {
                alert('Please select Start Month and End Month in the Compare tab (period section).');
                return null;
            }

            const start = new Date(parseInt(startY), parseInt(startM) - 1, 1);
            const end = new Date(parseInt(endY), parseInt(endM) - 1, 1);
            if (start > end) {
                alert('Start date must be before or equal to end date.');
                return null;
            }

            const periods = [];
            let current = new Date(start);
            while (current <= end) {
                const year = current.getFullYear();
                const month = String(current.getMonth() + 1).padStart(2, '0');
                periods.push(`${year}${month}`);
                current.setMonth(current.getMonth() + 1);
            }
            return periods.join(';');
        }

        function computeFacilityPeriodCatchment(annualPop) {
            const months = getCompareSelectedMonths();
            if (!annualPop || annualPop <= 0) return 0;
            const monthlyPop = Math.round(annualPop / 12);
            const periodPop = monthlyPop * months;
            return Math.round(periodPop * 0.05);
        }

        async function loadCompareDropdowns() {
            const compareRegionSel = document.getElementById('compareRegionSelect');
            const compareDistrictSel = document.getElementById('compareDistrictSelect');

            // Regions (from DHIS2)
            try {
                const top = await fetch('/api/org-units').then(r => r.json());
                const countryId = (top.organisationUnits || [])[0]?.id;
                if (!countryId) throw new Error('No top level org unit');
                const regionsData = await fetch(`/api/org-units?parent=${countryId}`).then(r => r.json());
                const regions = (regionsData.children || []).sort((a, b) => a.displayName.localeCompare(b.displayName));
                compareRegionSel.innerHTML = `<option value="">-- Select Region (${regions.length}) --</option>` +
                    regions.map(u => `<option value="${u.id}">${u.displayName}</option>`).join('');
            } catch (e) {
                compareRegionSel.innerHTML = '<option value="">Error loading regions</option>';
            }

            // Districts: we can offer a ‚Äútype-ahead‚Äù later; for now load via UBOS list (fast + stable)
            const districtNames = Object.keys(UBOS_POPULATIONS || {}).sort((a, b) => a.localeCompare(b));
            // Note: these are names; we still need DHIS2 IDs. We'll resolve via search when user selects.
            compareDistrictSel.innerHTML = `<option value="">-- Select District (search list) --</option>` +
                districtNames.map(name => `<option value="${name}">${name}</option>`).join('');
        }

        async function resolveDistrictIdByName(districtName) {
            // Use existing backend search endpoint to find best match DHIS2 org unit id.
            const q = (districtName || '').trim();
            if (!q) return null;

            const data = await fetch(`/api/search-org-units?query=${encodeURIComponent(q)}`).then(r => r.json());
            const units = data.organisationUnits || [];
            // Prefer level 3 districts with exact-ish name
            const target = q.toLowerCase();
            const district = units.find(u => (u.level === 3) && (u.displayName || '').toLowerCase() === target)
                || units.find(u => (u.level === 3) && (u.displayName || '').toLowerCase().includes(target))
                || units.find(u => (u.level === 3));
            return district ? { id: district.id, displayName: district.displayName, level: district.level } : null;
        }

        async function fetchANCForUnit(orgUnitId, period, customPopulation, ancCatchmentValue) {
            let url = `/maternal/api/anc-data?orgUnit=${orgUnitId}&period=${encodeURIComponent(period)}`;
            if (customPopulation && customPopulation > 0) {
                url += `&customPopulation=${customPopulation}&ancCatchment=${ancCatchmentValue || 0}`;
            }
            const res = await fetch(url);
            return await res.json();
        }

        async function fetchIntrapartumForUnit(orgUnitId, period, customPopulation) {
            let url = `/maternal/api/intrapartum-data?orgUnit=${orgUnitId}&period=${encodeURIComponent(period)}`;
            if (customPopulation && customPopulation > 0) {
                url += `&customPopulation=${customPopulation}`;
            }
            const res = await fetch(url);
            return await res.json();
        }

        async function fetchAllDataForUnit(orgUnitId, period, customPopulation, ancCatchmentValue) {
            // Fetch ANC and Intrapartum data in parallel
            const [ancData, intraData] = await Promise.all([
                fetchANCForUnit(orgUnitId, period, customPopulation, ancCatchmentValue),
                fetchIntrapartumForUnit(orgUnitId, period, customPopulation)
            ]);
            // Merge the data
            return {
                ...ancData,
                intrapartum: intraData
            };
        }

        async function mapWithConcurrency(items, limit, fn) {
            const results = new Array(items.length);
            let idx = 0;
            const workers = new Array(Math.min(limit, items.length)).fill(null).map(async () => {
                while (idx < items.length) {
                    const currentIndex = idx++;
                    results[currentIndex] = await fn(items[currentIndex], currentIndex);
                }
            });
            await Promise.all(workers);
            return results;
        }

        function renderCompareTable(units, mode) {
            console.log('üìä renderCompareTable called with', units.length, 'units, mode:', mode);
            const tbody = document.getElementById('compareTableBody');
            if (!tbody) {
                console.error('‚ùå compareTableBody not found!');
                alert('Error: Table body element not found');
                return;
            }
            tbody.innerHTML = '';
            console.log('Cleared tbody, now adding rows...');

            units.forEach((u, idx) => {
                const data = compareContext.resultsById[u.id] || {};
                const isFacility = (mode === 'facilities');
                const annualPop = compareContext.facilityPopulations[u.id] || 0;
                const ancTarget = isFacility ? computeFacilityPeriodCatchment(annualPop) : (data.ancCatchment || 0);

                // If facility and pop missing, show coverage as '‚Äî' instead of 0
                const missingFacilityPop = isFacility && (!annualPop || annualPop <= 0);

                const anc1 = missingFacilityPop ? null : (data.anc1Coverage ?? null);
                const anc4 = missingFacilityPop ? null : (data.anc4Coverage ?? null);
                const anc8 = missingFacilityPop ? null : (data.anc8Coverage ?? null);
                const ipt3 = missingFacilityPop ? null : (data.ipt3Coverage ?? null);

                const tr = document.createElement('tr');
                tr.dataset.id = u.id;

                const tdName = document.createElement('td');
                tdName.textContent = u.displayName || u.name || u.id;
                tr.appendChild(tdName);

                if (isFacility) {
                    const tdPop = document.createElement('td');
                    tdPop.className = 'facility-only';
                    tdPop.innerHTML = `<input type="number" min="0" style="width: 120px;" placeholder="Annual pop" value="${annualPop || ''}" oninput="onFacilityPopulationChange('${u.id}', this.value)">`;
                    tr.appendChild(tdPop);

                    const tdTarget = document.createElement('td');
                    tdTarget.className = 'facility-only';
                    tdTarget.textContent = ancTarget > 0 ? ancTarget.toLocaleString() : '‚Äî';
                    tr.appendChild(tdTarget);
                }

                function addPctCell(value, indicatorKey) {
                    const td = document.createElement('td');
                    if (value === null || value === undefined) {
                        td.textContent = '‚Äî';
                        return td;
                    }
                    const v = Number(value);
                    if (Number.isFinite(v)) {
                        td.textContent = `${v.toFixed(1)}%`;
                        td.classList.add(getColorClass(v, indicatorKey));
                    } else {
                        td.textContent = '‚Äî';
                    }
                    return td;
                }

                function addRateCell(value, suffix, thresholds) {
                    // For rates per 1000 or per 100k (lower is better)
                    const td = document.createElement('td');
                    if (value === null || value === undefined) {
                        td.textContent = '‚Äî';
                        return td;
                    }
                    const v = Number(value);
                    if (Number.isFinite(v)) {
                        td.textContent = v.toFixed(1) + suffix;
                        // Color coding: lower is better
                        if (thresholds) {
                            if (v <= thresholds.green) td.classList.add('cell-green');
                            else if (v <= thresholds.yellow) td.classList.add('cell-yellow');
                            else td.classList.add('cell-red');
                        }
                    } else {
                        td.textContent = '‚Äî';
                    }
                    return td;
                }

                // ANC indicators
                tr.appendChild(addPctCell(anc1, 'ANC_1ST_VISIT'));
                tr.appendChild(addPctCell(anc4, 'ANC_4TH_VISIT'));
                tr.appendChild(addPctCell(anc8, 'ANC_8TH_VISIT'));
                tr.appendChild(addPctCell(ipt3, 'IPT3'));
                tr.appendChild(addPctCell(data.anc1stTriRate, 'ANC_1ST_TRIMESTER'));
                tr.appendChild(addPctCell(data.hbTestRate, 'HB_TEST'));
                tr.appendChild(addPctCell(data.ultrasoundRate, 'ULTRASOUND'));
                tr.appendChild(addPctCell(data.ironFolicRate, 'IRON_FOLIC'));
                tr.appendChild(addPctCell(data.teenPregRate, 'TEEN_PREG'));

                tbody.appendChild(tr);
                if (idx === 0) console.log('First ANC row added:', u.displayName);
            });

            // Now populate Intrapartum table
            const intraTbody = document.getElementById('compareIntraTableBody');
            if (intraTbody) {
                intraTbody.innerHTML = '';
                
                units.forEach((u) => {
                    const data = compareContext.resultsById[u.id] || {};
                    const isFacility = (mode === 'facilities');
                    const annualPop = compareContext.facilityPopulations[u.id] || 0;
                    const missingFacilityPop = isFacility && (!annualPop || annualPop <= 0);
                    const intra = data.intrapartum || {};
                    
                    const tr = document.createElement('tr');
                    tr.dataset.id = u.id;
                    
                    // Org Unit name
                    const tdName = document.createElement('td');
                    tdName.textContent = u.displayName || u.name || u.id;
                    tdName.style.textAlign = 'left';
                    tdName.style.fontWeight = '500';
                    tr.appendChild(tdName);
                    
                    function addIntraPctCell(value, thresholds, higherIsBetter = true) {
                        const td = document.createElement('td');
                        if (value === null || value === undefined) {
                            td.textContent = '‚Äî';
                            return td;
                        }
                        const v = Number(value);
                        if (Number.isFinite(v)) {
                            td.textContent = `${v.toFixed(1)}%`;
                            if (thresholds) {
                                if (higherIsBetter) {
                                    if (v >= thresholds.green) td.classList.add('cell-green');
                                    else if (v >= thresholds.yellow) td.classList.add('cell-yellow');
                                    else td.classList.add('cell-red');
                                } else {
                                    if (v <= thresholds.green) td.classList.add('cell-green');
                                    else if (v <= thresholds.yellow) td.classList.add('cell-yellow');
                                    else td.classList.add('cell-red');
                                }
                            }
                        } else {
                            td.textContent = '‚Äî';
                        }
                        return td;
                    }
                    
                    function addIntraRateCell(value, suffix, thresholds) {
                        const td = document.createElement('td');
                        if (value === null || value === undefined) {
                            td.textContent = '‚Äî';
                            return td;
                        }
                        const v = Number(value);
                        if (Number.isFinite(v)) {
                            td.textContent = v.toFixed(1) + suffix;
                            if (thresholds) {
                                if (v <= thresholds.green) td.classList.add('cell-green');
                                else if (v <= thresholds.yellow) td.classList.add('cell-yellow');
                                else td.classList.add('cell-red');
                            }
                        } else {
                            td.textContent = '‚Äî';
                        }
                        return td;
                    }
                    
                    // Deliveries Coverage - higher is better
                    const deliveriesCov = missingFacilityPop ? null : (intra.deliveriesCoverage ?? null);
                    tr.appendChild(addIntraPctCell(deliveriesCov, { green: 70, yellow: 50 }, true));
                    
                    // LBW Rate - lower is better
                    tr.appendChild(addIntraPctCell(intra.lbwRate, { green: 5, yellow: 10 }, false));
                    
                    // KMC Rate - higher is better
                    tr.appendChild(addIntraPctCell(intra.kmcRate, { green: 90, yellow: 75 }, true));
                    
                    // Asphyxia Rate - lower is better
                    tr.appendChild(addIntraPctCell(intra.asphyxiaRate, { green: 2, yellow: 5 }, false));
                    
                    // Resuscitation Rate - higher is better
                    tr.appendChild(addIntraPctCell(intra.resuscitationRate, { green: 90, yellow: 70 }, true));
                    
                    // Fresh Still Birth Rate per 1000 - lower is better
                    tr.appendChild(addIntraRateCell(intra.freshStillRate, '‚Ä∞', { green: 10, yellow: 20 }));
                    
                    // Neonatal Mortality per 1000 - lower is better
                    tr.appendChild(addIntraRateCell(intra.neonatalMortality, '‚Ä∞', { green: 12, yellow: 20 }));
                    
                    // Perinatal Mortality per 1000 - lower is better
                    tr.appendChild(addIntraRateCell(intra.perinatalMortality, '‚Ä∞', { green: 20, yellow: 35 }));
                    
                    // MMR per 100k - lower is better
                    tr.appendChild(addIntraRateCell(intra.maternalMortalityRatio, '', { green: 140, yellow: 300 }));
                    
                    intraTbody.appendChild(tr);
                });
            }

            console.log('‚úÖ Added', units.length, 'rows to both tables');
            
            // Force table to be visible
            const tableDisplay = document.getElementById('compareTableDisplay');
            if (tableDisplay) {
                tableDisplay.classList.remove('hidden');
                tableDisplay.style.display = 'block';
                console.log('Table display element made visible');
            } else {
                console.error('‚ùå compareTableDisplay not found!');
            }
        }

        function onFacilityPopulationChange(facilityId, value) {
            const num = parseInt(value) || 0;
            compareContext.facilityPopulations[facilityId] = num;

            // Update the displayed ANC target cell immediately (without refetch)
            const tr = document.querySelector(`#compareTableBody tr[data-id="${facilityId}"]`);
            if (tr) {
                const targetCell = tr.querySelector('td:nth-child(3)'); // Org Unit | Pop | ANC Target
                if (targetCell) {
                    const ancTarget = computeFacilityPeriodCatchment(num);
                    targetCell.textContent = ancTarget > 0 ? ancTarget.toLocaleString() : '‚Äî';
                }
            }
        }

        async function runCompareDistricts() {
            console.log('üèÜ runCompareDistricts called');
            const regionId = document.getElementById('compareRegionSelect').value;
            console.log('Selected region ID:', regionId);
            if (!regionId) {
                alert('Please select a region first.');
                return;
            }
            const period = getComparisonPeriodOrAlert();
            console.log('Period:', period);
            if (!period) return;

            // Show loading state
            const btn = document.querySelector('#compareDistrictsPanel button');
            const originalText = btn ? btn.textContent : 'Compare Districts';
            if (btn) {
                btn.disabled = true;
                btn.textContent = '‚è≥ Loading districts...';
            }

            try {
                document.getElementById('compareTableTitle').textContent = 'Districts in Region - ANC Comparison';
                compareContext.resultsById = {};

                console.log('Fetching districts for region:', regionId);
                const regionChildren = await fetch(`/api/org-units?parent=${regionId}`).then(r => r.json());
                const candidates = (regionChildren.children || []).slice();
                // Prefer DHIS2 district level 3 if present
                const districts = candidates.filter(u => u.level === 3);
                const units = (districts.length ? districts : candidates).sort((a, b) => a.displayName.localeCompare(b.displayName));
                compareContext.units = units;
                console.log('Found', units.length, 'districts');

                if (units.length === 0) {
                    alert('No districts found for this region.');
                    return;
                }

                // Ensure correct columns are shown for this mode
                document.querySelectorAll('.facility-only').forEach(el => {
                    el.classList.add('hidden'); // Districts mode - hide facility columns
                });

                // Fetch data with concurrency limit
                console.log('Fetching ANC data for', units.length, 'districts...');
                if (btn) btn.textContent = `‚è≥ Fetching data for ${units.length} districts...`;
                
                await mapWithConcurrency(units, 6, async (u) => {
                    const data = await fetchAllDataForUnit(u.id, period);
                    compareContext.resultsById[u.id] = data;
                    return data;
                });

                console.log('Rendering table...');
                renderCompareTable(units, 'districts');
                
                // Ensure table is visible after rendering
                document.getElementById('compareTableDisplay').classList.remove('hidden');
                document.getElementById('compareTableDisplay').style.display = 'block';
                console.log('‚úÖ Compare complete');
            } catch (error) {
                console.error('Compare error:', error);
                alert('Error loading comparison: ' + error.message);
            } finally {
                if (btn) {
                    btn.disabled = false;
                    btn.textContent = originalText;
                }
            }
        }

        async function runCompareFacilities() {
            const districtName = document.getElementById('compareDistrictSelect').value;
            if (!districtName) {
                alert('Please select a district first.');
                return;
            }
            const period = getComparisonPeriodOrAlert();
            if (!period) return;

            // Show loading state
            const btn = document.querySelector('#compareFacilitiesPanel button');
            const originalText = btn ? btn.textContent : 'Load Facilities';
            if (btn) {
                btn.disabled = true;
                btn.textContent = '‚è≥ Finding district...';
            }

            try {
                const district = await resolveDistrictIdByName(districtName);
                if (!district) {
                    alert(`Could not find DHIS2 district for "${districtName}". Try using the main search then come back.`);
                    return;
                }

                document.getElementById('compareTableTitle').textContent = `Facilities in ${district.displayName} - ANC Comparison`;
                compareContext.resultsById = {};
                compareContext.facilityPopulations = {};

                // Fetch all facilities under district (level 6)
                if (btn) btn.textContent = '‚è≥ Loading facilities...';
                const facilitiesResp = await fetch(`/api/org-units-descendants?parent=${district.id}&level=6`).then(r => r.json());
                const facilities = (facilitiesResp.organisationUnits || []).sort((a, b) => a.displayName.localeCompare(b.displayName));
                
                if (!facilities.length) {
                    alert('No facilities found under this district (level 6).');
                    return;
                }

                console.log('Found', facilities.length, 'facilities');
                compareContext.units = facilities;
                
                // Show facility-only columns for this mode
                document.querySelectorAll('.facility-only').forEach(el => {
                    el.classList.remove('hidden');
                });

                // Fetch quality rates first (no population required)
                if (btn) btn.textContent = `‚è≥ Fetching data for ${facilities.length} facilities...`;
                await mapWithConcurrency(facilities, 6, async (u) => {
                    const data = await fetchAllDataForUnit(u.id, period);
                    compareContext.resultsById[u.id] = data;
                    return data;
                });

                renderCompareTable(facilities, 'facilities');
                
                // Ensure table is visible after rendering
                document.getElementById('compareTableDisplay').classList.remove('hidden');
                document.getElementById('compareTableDisplay').style.display = 'block';
                console.log('‚úÖ Facilities loaded');
            } catch (error) {
                console.error('Load facilities error:', error);
                alert('Error loading facilities: ' + error.message);
            } finally {
                if (btn) {
                    btn.disabled = false;
                    btn.textContent = originalText;
                }
            }
        }

        async function applyFacilityPopulations() {
            if (compareContext.mode !== 'facilities') {
                alert('Switch to "Compare Facilities in a District" first.');
                return;
            }
            const period = getComparisonPeriodOrAlert();
            if (!period) return;

            const facilities = compareContext.units || [];
            const toUpdate = facilities.filter(f => (compareContext.facilityPopulations[f.id] || 0) > 0);
            if (!toUpdate.length) {
                alert('Please enter at least one facility annual population first.');
                return;
            }

            await mapWithConcurrency(toUpdate, 6, async (u) => {
                const annualPop = compareContext.facilityPopulations[u.id] || 0;
                const ancTarget = computeFacilityPeriodCatchment(annualPop);
                const data = await fetchAllDataForUnit(u.id, period, annualPop, ancTarget);
                compareContext.resultsById[u.id] = data;
                return data;
            });

            renderCompareTable(facilities, 'facilities');
            
            // Ensure table is visible
            document.getElementById('compareTableDisplay').classList.remove('hidden');
            document.getElementById('compareTableDisplay').style.display = 'block';
        }

        // ========== Excel Download for Compare Table ==========
        function downloadCompareExcel() {
            console.log('üì• Downloading Compare Tables to Excel with colors and borders...');
            
            const ancTable = document.getElementById('compareTable');
            const intraTable = document.getElementById('compareIntraTable');
            
            if (!ancTable) {
                alert('No comparison table to download');
                return;
            }
            
            const title = document.getElementById('compareTableTitle')?.textContent || 'Comparison';
            const mode = compareContext.mode || 'districts';
            
            // Styling constants
            const BORDER_THIN = {
                top: { style: 'thin', color: { rgb: '000000' } },
                bottom: { style: 'thin', color: { rgb: '000000' } },
                left: { style: 'thin', color: { rgb: '000000' } },
                right: { style: 'thin', color: { rgb: '000000' } }
            };
            
            const BORDER_MEDIUM = {
                top: { style: 'medium', color: { rgb: '000000' } },
                bottom: { style: 'medium', color: { rgb: '000000' } },
                left: { style: 'medium', color: { rgb: '000000' } },
                right: { style: 'medium', color: { rgb: '000000' } }
            };
            
            const HEADER_STYLE_ANC = {
                fill: { fgColor: { rgb: '10B981' } },
                font: { color: { rgb: 'FFFFFF' }, bold: true, sz: 11 },
                alignment: { horizontal: 'center', vertical: 'center', wrapText: true },
                border: BORDER_MEDIUM
            };
            
            const HEADER_STYLE_INTRA = {
                fill: { fgColor: { rgb: '6366F1' } },
                font: { color: { rgb: 'FFFFFF' }, bold: true, sz: 11 },
                alignment: { horizontal: 'center', vertical: 'center', wrapText: true },
                border: BORDER_MEDIUM
            };
            
            const COLOR_MAP = {
                'cell-green': { fill: { fgColor: { rgb: '10B981' } }, font: { color: { rgb: 'FFFFFF' }, bold: true } },
                'cell-yellow': { fill: { fgColor: { rgb: 'FBBF24' } }, font: { color: { rgb: '000000' }, bold: true } },
                'cell-red': { fill: { fgColor: { rgb: 'EF4444' } }, font: { color: { rgb: 'FFFFFF' }, bold: true } }
            };
            
            // Helper to extract table data with styling info
            function extractTableData(table, headerStyle) {
                const data = [];
                const styles = [];
                
                // Header row
                const headerRow = [];
                const headerStyles = [];
                table.querySelectorAll('thead th').forEach(th => {
                    if (!th.classList.contains('hidden')) {
                        headerRow.push(th.textContent.trim());
                        headerStyles.push(headerStyle);
                    }
                });
                data.push(headerRow);
                styles.push(headerStyles);
                
                // Data rows
                table.querySelectorAll('tbody tr').forEach(tr => {
                    const rowData = [];
                    const rowStyles = [];
                    tr.querySelectorAll('td').forEach((td, colIdx) => {
                        if (!td.classList.contains('hidden')) {
                            let value = td.textContent.trim();
                            rowData.push(value);
                            
                            // Determine cell style
                            let cellStyle = {
                                alignment: { horizontal: colIdx === 0 ? 'left' : 'center', vertical: 'center' },
                                border: BORDER_THIN
                            };
                            
                            // Add color if present
                            if (td.classList.contains('cell-green')) {
                                cellStyle = { ...cellStyle, ...COLOR_MAP['cell-green'] };
                            } else if (td.classList.contains('cell-yellow')) {
                                cellStyle = { ...cellStyle, ...COLOR_MAP['cell-yellow'] };
                            } else if (td.classList.contains('cell-red')) {
                                cellStyle = { ...cellStyle, ...COLOR_MAP['cell-red'] };
                            } else {
                                // Alternating row background
                                cellStyle.fill = { fgColor: { rgb: 'F9FAFB' } };
                            }
                            
                            rowStyles.push(cellStyle);
                        }
                    });
                    data.push(rowData);
                    styles.push(rowStyles);
                });
                
                return { data, styles };
            }
            
            // Create workbook
            const wb = XLSX.utils.book_new();
            
            // ===== ANC Sheet =====
            const ancExtract = extractTableData(ancTable, HEADER_STYLE_ANC);
            const wsAnc = XLSX.utils.aoa_to_sheet(ancExtract.data);
            
            // Apply styles to ANC sheet
            const ancRange = XLSX.utils.decode_range(wsAnc['!ref']);
            for (let R = ancRange.s.r; R <= ancRange.e.r; R++) {
                for (let C = ancRange.s.c; C <= ancRange.e.c; C++) {
                    const cellAddr = XLSX.utils.encode_cell({ r: R, c: C });
                    if (wsAnc[cellAddr] && ancExtract.styles[R] && ancExtract.styles[R][C]) {
                        wsAnc[cellAddr].s = ancExtract.styles[R][C];
                    }
                }
            }
            
            // Set column widths for ANC
            wsAnc['!cols'] = ancExtract.data[0].map((_, i) => ({ wch: i === 0 ? 28 : 12 }));
            wsAnc['!rows'] = [{ hpt: 30 }]; // Header row height
            
            XLSX.utils.book_append_sheet(wb, wsAnc, 'ANC Indicators');
            
            // ===== Intrapartum Sheet =====
            if (intraTable) {
                const intraExtract = extractTableData(intraTable, HEADER_STYLE_INTRA);
                const wsIntra = XLSX.utils.aoa_to_sheet(intraExtract.data);
                
                // Apply styles to Intrapartum sheet
                const intraRange = XLSX.utils.decode_range(wsIntra['!ref']);
                for (let R = intraRange.s.r; R <= intraRange.e.r; R++) {
                    for (let C = intraRange.s.c; C <= intraRange.e.c; C++) {
                        const cellAddr = XLSX.utils.encode_cell({ r: R, c: C });
                        if (wsIntra[cellAddr] && intraExtract.styles[R] && intraExtract.styles[R][C]) {
                            wsIntra[cellAddr].s = intraExtract.styles[R][C];
                        }
                    }
                }
                
                // Set column widths for Intrapartum
                wsIntra['!cols'] = intraExtract.data[0].map((_, i) => ({ wch: i === 0 ? 28 : 14 }));
                wsIntra['!rows'] = [{ hpt: 30 }];
                
                XLSX.utils.book_append_sheet(wb, wsIntra, 'Intrapartum Indicators');
            }
            
            // Generate filename
            const date = new Date().toISOString().split('T')[0];
            const fileName = `Maternal_Comparison_${mode}_${date}.xlsx`;
            
            // Download
            XLSX.writeFile(wb, fileName);
            console.log('‚úÖ Excel downloaded:', fileName);
        }

    </script>
</body>
</html>
