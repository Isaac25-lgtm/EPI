<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Child Immunization Dashboard - Uganda HMIS</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.bundle.min.js"></script>
    <style>
        /* CSS Variables for Theme */
        :root {
            --bg-primary: #f0f4f8;
            --bg-card: #ffffff;
            --bg-input: #ffffff;
            --text-primary: #2c3e50;
            --text-secondary: #7f8c8d;
            --text-muted: #95a5a6;
            --border-color: #e0e0e0;
            --border-light: #ecf0f1;
            --shadow-color: rgba(0, 0, 0, 0.05);
            --accent-primary: #11998e;
            --accent-secondary: #38ef7d;
            --table-header-bg: #f8f9fa;
            --table-hover-bg: #f8f9fa;
        }

        [data-theme="dark"] {
            --bg-primary: #1a1a2e;
            --bg-card: #16213e;
            --bg-input: #1f2b47;
            --text-primary: #e8e8e8;
            --text-secondary: #a0a0a0;
            --text-muted: #6c7a89;
            --border-color: #2d3a4f;
            --border-light: #2d3a4f;
            --shadow-color: rgba(0, 0, 0, 0.3);
            --accent-primary: #11998e;
            --accent-secondary: #38ef7d;
            --table-header-bg: #1f2b47;
            --table-hover-bg: #1f2b47;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', sans-serif;
            background: var(--bg-primary);
            min-height: 100vh;
            transition: background 0.3s ease;
        }

        /* Navigation */
        .nav {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .nav h1 {
            color: white;
            font-size: 22px;
        }

        .nav-tabs {
            display: flex;
            gap: 5px;
        }

        .nav-tab {
            padding: 10px 25px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            border-radius: 8px 8px 0 0;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.3s;
        }

        .nav-tab:hover {
            background: rgba(255, 255, 255, 0.3);
        }


        .nav-tab.active {
            background: white;
            color: #11998e;
        }

        .user-badge {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 13px;
        }

        .container {
            max-width: 1800px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Filters Section */
        .filters-card {
            background: var(--bg-card);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px var(--shadow-color);
            transition: background 0.3s ease;
        }

        .filters-card h3 {
            color: var(--text-primary);
            margin-bottom: 15px;
            font-size: 16px;
            border-bottom: 2px solid var(--accent-primary);
            padding-bottom: 8px;
        }

        .filters-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px;
            margin-bottom: 15px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .filter-group label {
            font-size: 11px;
            color: var(--text-secondary);
            font-weight: 600;
            text-transform: uppercase;
        }

        .filter-group select,
        .filter-group input {
            padding: 10px;
            border: 2px solid var(--border-color);
            border-radius: 6px;
            font-size: 13px;
            transition: border-color 0.3s, background 0.3s;
            background: var(--bg-input);
            color: var(--text-primary);
        }

        .filter-group select:focus,
        .filter-group input:focus {
            border-color: var(--accent-primary);
            outline: none;
        }

        .filter-group select:disabled {
            background: var(--bg-primary);
            opacity: 0.7;
        }

        .selected-info {
            background: #e8f5e9;
            padding: 10px 15px;
            border-radius: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }

        .selected-info span {
            font-size: 13px;
            color: #2c3e50;
        }

        .selected-info .highlight {
            background: #11998e;
            color: white;
            padding: 4px 12px;
            border-radius: 4px;
            font-weight: 600;
        }

        /* Buttons */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 13px;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .btn-primary {
            background: #11998e;
            color: white;
        }

        .btn-primary:hover {
            background: #0d7a70;
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: #ecf0f1;
            color: #2c3e50;
        }

        .btn-secondary:hover {
            background: #bdc3c7;
        }

        .btn-download {
            background: #3498db;
            color: white;
            font-size: 11px;
            padding: 6px 12px;
        }

        .btn-download:hover {
            background: #2980b9;
        }

        /* Section Toggle */
        .section {
            display: none;
        }

        .section.active {
            display: block;
        }

        /* Cards */
        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        /* ========== EXECUTIVE DASHBOARD STYLES ========== */
        .executive-dashboard {
            background: linear-gradient(135deg, #1a2a3a 0%, #2c3e50 100%);
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 25px;
            color: white;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        }

        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 25px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .dashboard-title {
            font-size: 22px;
            font-weight: 700;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .dashboard-title .icon {
            background: linear-gradient(135deg, #11998e, #38ef7d);
            width: 42px;
            height: 42px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .dashboard-meta {
            text-align: right;
            font-size: 13px;
            opacity: 0.8;
        }

        .dashboard-meta strong {
            color: #38ef7d;
        }

        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 20px;
        }

        .kpi-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }

        .kpi-card:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: translateY(-3px);
        }

        .kpi-card.highlight {
            background: linear-gradient(135deg, rgba(17, 153, 142, 0.3), rgba(56, 239, 125, 0.2));
            border-color: rgba(56, 239, 125, 0.3);
        }

        .kpi-value {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 5px;
            font-family: 'Segoe UI', system-ui, sans-serif;
        }

        .kpi-value.green { color: #2ecc71; }
        .kpi-value.yellow { color: #f1c40f; }
        .kpi-value.red { color: #e74c3c; }

        .kpi-label {
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            opacity: 0.8;
        }

        .kpi-sublabel {
            font-size: 11px;
            opacity: 0.6;
            margin-top: 5px;
        }

        /* Performance gauge */
        .performance-gauge {
            background: rgba(255, 255, 255, 0.08);
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
        }

        .gauge-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 12px;
            font-size: 13px;
        }

        .gauge-bar {
            height: 12px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            overflow: hidden;
            display: flex;
        }

        .gauge-segment {
            height: 100%;
            transition: width 0.5s ease;
        }

        .gauge-segment.green { background: #27ae60; }
        .gauge-segment.yellow { background: #f39c12; }
        .gauge-segment.red { background: #e74c3c; }

        .gauge-legend {
            display: flex;
            justify-content: center;
            gap: 25px;
            margin-top: 12px;
            font-size: 11px;
        }

        .gauge-legend span {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .gauge-legend .dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }

        /* Modern Table Styles */
        .modern-table-card {
            background: var(--bg-card);
            border-radius: 16px;
            box-shadow: 0 4px 20px var(--shadow-color);
            overflow: hidden;
            margin-bottom: 25px;
        }

        .table-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .table-header.green-theme {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        }

        .table-header.orange-theme {
            background: linear-gradient(135deg, #f39c12 0%, #e74c3c 100%);
        }

        .table-header h3 {
            margin: 0;
            font-size: 16px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .table-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .table-actions .btn-export {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            padding: 8px 14px;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .table-actions .btn-export:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-1px);
        }

        .chart-actions {
            display: inline-flex;
            gap: 6px;
            margin-left: 10px;
        }

        .chart-actions .btn {
            font-size: 11px !important;
            padding: 5px 10px !important;
        }

        /* Export button color variants */
        .btn-excel { background: linear-gradient(135deg, #217346, #2ecc71) !important; }
        .btn-csv { background: linear-gradient(135deg, #6c757d, #95a5a6) !important; }
        .btn-pdf { background: linear-gradient(135deg, #c0392b, #e74c3c) !important; }
        .btn-image { background: linear-gradient(135deg, #8e44ad, #9b59b6) !important; }

        .table-toolbar {
            padding: 15px 20px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .search-box {
            display: flex;
            align-items: center;
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 8px 12px;
            gap: 8px;
            flex: 1;
            max-width: 300px;
        }

        .search-box input {
            border: none;
            background: transparent;
            outline: none;
            font-size: 13px;
            color: var(--text-primary);
            width: 100%;
        }

        .search-box .icon {
            color: var(--text-muted);
            font-size: 14px;
        }

        .filter-pills {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .filter-pill {
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 12px;
            cursor: pointer;
            border: 1px solid var(--border-color);
            background: var(--bg-primary);
            color: var(--text-secondary);
            transition: all 0.2s;
        }

        .filter-pill:hover {
            border-color: #11998e;
            color: #11998e;
        }

        .filter-pill.active {
            background: #11998e;
            color: white;
            border-color: #11998e;
        }

        .filter-pill.green-active.active {
            background: #27ae60;
            border-color: #27ae60;
        }

        .filter-pill.yellow-active.active {
            background: #f39c12;
            border-color: #f39c12;
        }

        .filter-pill.red-active.active {
            background: #e74c3c;
            border-color: #e74c3c;
        }

        .modern-table {
            width: 100%;
            border-collapse: collapse;
            border: 1px solid var(--border-color);
        }

        .modern-table thead th {
            background: var(--bg-secondary);
            padding: 14px 16px;
            text-align: left;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-muted);
            font-weight: 600;
            border: 1px solid var(--border-color);
        }

        .modern-table tbody tr {
            border-bottom: 1px solid var(--border-color);
            transition: background 0.2s;
        }

        .modern-table tbody tr:hover {
            background: var(--bg-hover);
        }

        .modern-table tbody td {
            padding: 16px;
            font-size: 13px;
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .modern-table .indicator-cell {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .indicator-icon {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            flex-shrink: 0;
        }

        .indicator-icon.bcg { background: #e3f2fd; }
        .indicator-icon.polio { background: #fff3e0; }
        .indicator-icon.dpt { background: #f3e5f5; }
        .indicator-icon.pcv { background: #e8f5e9; }
        .indicator-icon.rota { background: #fce4ec; }
        .indicator-icon.malaria { background: #fff8e1; }
        .indicator-icon.mr { background: #e1f5fe; }
        .indicator-icon.other { background: #f5f5f5; }

        .indicator-name {
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 2px;
        }

        .indicator-disease {
            font-size: 11px;
            color: var(--text-muted);
        }

        .coverage-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 13px;
        }

        .coverage-badge.green {
            background: rgba(39, 174, 96, 0.15);
            color: #27ae60;
        }

        .coverage-badge.yellow {
            background: rgba(243, 156, 18, 0.15);
            color: #e67e22;
        }

        .coverage-badge.red {
            background: rgba(231, 76, 60, 0.15);
            color: #e74c3c;
        }

        /* RED Categorization Tool Styles */
        .red-table {
            font-size: 12px;
        }

        .red-table th {
            font-size: 11px;
            padding: 10px 8px;
            white-space: nowrap;
        }

        .red-table td {
            padding: 10px 8px;
            text-align: center;
            font-size: 12px;
        }

        .red-table td:first-child {
            text-align: left;
            font-weight: 500;
        }

        .red-summary-box {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px 20px;
            border-radius: 8px;
            color: white;
            min-width: 70px;
        }

        .red-summary-box .count {
            font-size: 24px;
            font-weight: 700;
        }

        .red-summary-box .label {
            font-size: 11px;
            opacity: 0.9;
        }

        .red-cat-1 { background: #92D050 !important; color: #1a5f1a !important; font-weight: 600; }
        .red-cat-2 { background: #FFFF00 !important; color: #333 !important; font-weight: 600; }
        .red-cat-3 { background: #FFC000 !important; color: #333 !important; font-weight: 600; }
        .red-cat-4 { background: #FF0000 !important; color: white !important; font-weight: 700; }

        .red-access-good { background: #C6EFCE !important; color: #006100 !important; }
        .red-access-poor { background: #FFC7CE !important; color: #9C0006 !important; }

        .red-coverage-high { background: rgba(39, 174, 96, 0.3); }
        .red-coverage-med { background: rgba(243, 156, 18, 0.3); }
        .red-coverage-low { background: rgba(231, 76, 60, 0.3); }

        .red-gap-critical { background: rgba(231, 76, 60, 0.2); color: #c0392b; font-weight: 600; }

        .schedule-text {
            font-size: 12px;
            color: var(--text-muted);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .schedule-text::before {
            content: "ðŸ“…";
            font-size: 14px;
        }

        /* Dropout Cards */
        .dropout-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .dropout-card-modern {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 10px var(--shadow-color);
            border-left: 4px solid;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .dropout-card-modern.good {
            border-left-color: #27ae60;
        }

        .dropout-card-modern.bad {
            border-left-color: #e74c3c;
        }

        .dropout-info h4 {
            margin: 0 0 5px 0;
            font-size: 14px;
            color: var(--text-primary);
        }

        .dropout-info p {
            margin: 0;
            font-size: 12px;
            color: var(--text-muted);
        }

        .dropout-rate {
            font-size: 28px;
            font-weight: 700;
        }

        .dropout-rate.good { color: #27ae60; }
        .dropout-rate.bad { color: #e74c3c; }

        .stat-card {
            background: var(--bg-card);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 10px var(--shadow-color);
            text-align: center;
            border-top: 4px solid var(--accent-primary);
            transition: background 0.3s ease;
        }

        .stat-card h4 {
            color: var(--text-secondary);
            font-size: 11px;
            text-transform: uppercase;
            margin-bottom: 8px;
        }

        .stat-card .value {
            font-size: 28px;
            font-weight: bold;
            color: var(--text-primary);
        }

        .stat-card .sub {
            font-size: 11px;
            color: var(--text-muted);
            margin-top: 5px;
        }

        /* Coverage Cards */
        .coverage-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .coverage-card {
            background: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            border-left: 5px solid #ccc;
        }

        .coverage-card.green {
            border-left-color: #27ae60;
        }

        .coverage-card.yellow {
            border-left-color: #f39c12;
        }

        .coverage-card.red {
            border-left-color: #e74c3c;
        }

        .coverage-card h4 {
            font-size: 12px;
            color: #2c3e50;
            margin-bottom: 10px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .coverage-card .metrics {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 8px;
        }

        .coverage-card .metric {
            text-align: center;
        }

        .coverage-card .metric .label {
            font-size: 10px;
            color: #7f8c8d;
        }

        .coverage-card .metric .val {
            font-size: 14px;
            font-weight: 600;
        }

        .coverage-card .metric .val.green {
            color: #27ae60;
        }

        .coverage-card .metric .val.yellow {
            color: #f39c12;
        }

        .coverage-card .metric .val.red {
            color: #e74c3c;
        }

        /* Dropout Cards */
        .dropout-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .dropout-card {
            background: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .dropout-card .info h4 {
            font-size: 13px;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .dropout-card .info p {
            font-size: 11px;
            color: #7f8c8d;
        }

        .dropout-card .rate {
            font-size: 24px;
            font-weight: bold;
            padding: 8px 15px;
            border-radius: 8px;
        }

        .dropout-card .rate.green {
            background: #d4edda;
            color: #27ae60;
        }

        .dropout-card .rate.red {
            background: #f8d7da;
            color: #e74c3c;
        }

        /* Charts */
        .charts-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .chart-card {
            background: var(--bg-card);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 10px var(--shadow-color);
            transition: background 0.3s ease;
        }

        .chart-card.full {
            grid-column: 1 / -1;
        }

        .chart-card h3 {
            font-size: 14px;
            color: var(--text-primary);
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* Tables */
        .table-card {
            background: var(--bg-card);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 10px var(--shadow-color);
            margin-bottom: 20px;
            overflow-x: auto;
            transition: background 0.3s ease;
        }

        .table-card h3 {
            font-size: 14px;
            color: var(--text-primary);
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        th,
        td {
            padding: 10px 8px;
            text-align: left;
            border: 1px solid var(--border-color);
        }

        th {
            background: var(--table-header-bg);
            font-weight: 600;
            position: sticky;
            top: 0;
            color: var(--text-primary);
            border-bottom: 2px solid var(--border-color);
        }

        .badge {
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
        }

        .badge.green {
            background: #d4edda;
            color: #27ae60;
        }

        .badge.yellow {
            background: #fff3cd;
            color: #856404;
        }

        .badge.red {
            background: #f8d7da;
            color: #e74c3c;
        }

        /* Color-coded table cells */
        .coverage-cell {
            font-weight: bold;
            text-align: center;
            border-radius: 4px;
            padding: 8px 12px !important;
        }

        .coverage-cell.green {
            background: #27ae60 !important;
            color: white;
        }

        .coverage-cell.yellow {
            background: #f39c12 !important;
            color: white;
        }

        .coverage-cell.red {
            background: #e74c3c !important;
            color: white;
        }

        #coverageTable {
            border-collapse: separate;
            border-spacing: 0;
        }

        #coverageTable th {
            background: linear-gradient(135deg, #1a5f1a, #27ae60);
            color: white;
            font-weight: 700;
            text-align: center;
            font-size: 14px;
            padding: 14px 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        #coverageTable td {
            text-align: center;
            vertical-align: middle;
            font-weight: 600;
            font-size: 13px;
            padding: 12px 10px;
        }

        #coverageTable tbody tr {
            border-bottom: 2px solid #e0e0e0;
        }

        #coverageTable tbody tr:hover {
            background: #e8f5e9;
            transform: scale(1.005);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        /* Coverage column - full cell color */
        #coverageTable td:nth-child(4) {
            padding: 0;
        }

        #coverageTable .coverage-cell {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            min-height: 50px;
            font-size: 16px;
            font-weight: 800;
            color: white;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
        }

        #coverageTable .coverage-cell.green {
            background: linear-gradient(135deg, #27ae60, #2ecc71);
        }

        #coverageTable .coverage-cell.yellow {
            background: linear-gradient(135deg, #e67e22, #f39c12);
        }

        #coverageTable .coverage-cell.red {
            background: linear-gradient(135deg, #c0392b, #e74c3c);
        }

        /* Indicator Selection */
        .indicator-selector {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .indicator-selector h4 {
            font-size: 12px;
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .indicator-checkboxes {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 6px;
            max-height: 150px;
            overflow-y: auto;
        }

        .indicator-checkbox {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 11px;
            padding: 5px;
            border-radius: 4px;
            cursor: pointer;
        }

        .indicator-checkbox:hover {
            background: #e8f5e9;
        }

        .indicator-checkbox input {
            accent-color: #11998e;
        }

        .quick-btns {
            display: flex;
            gap: 8px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }

        .quick-btn {
            padding: 5px 12px;
            background: #e8f5e9;
            border: 1px solid #11998e;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
        }

        .quick-btn:hover {
            background: #c8e6c9;
        }

        /* Loading & Error */
        .loading {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        /* Loading Overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.85);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            backdrop-filter: blur(3px);
        }

        .loading-overlay.hidden {
            display: none;
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 5px solid #e0e0e0;
            border-top-color: #11998e;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Facility Population Modal */
        .facility-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            backdrop-filter: blur(4px);
            animation: fadeIn 0.2s ease;
        }

        .facility-modal {
            background: white;
            border-radius: 16px;
            padding: 0;
            max-width: 480px;
            width: 90%;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.25);
            animation: slideUp 0.3s ease;
            overflow: hidden;
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .facility-modal-header {
            background: linear-gradient(135deg, #11998e, #38ef7d);
            color: white;
            padding: 24px;
            text-align: center;
        }

        .facility-modal-header h3 {
            margin: 0 0 8px 0;
            font-size: 20px;
            font-weight: 600;
        }

        .facility-modal-header p {
            margin: 0;
            font-size: 13px;
            opacity: 0.9;
        }

        .facility-modal-body {
            padding: 24px;
        }

        .facility-info-box {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 16px;
            margin-bottom: 20px;
            border-left: 4px solid #11998e;
        }

        .facility-info-box .facility-name {
            font-weight: 600;
            color: #2c3e50;
            font-size: 16px;
            margin-bottom: 4px;
        }

        .facility-info-box .facility-path {
            font-size: 12px;
            color: #7f8c8d;
        }

        .population-input-group {
            margin-bottom: 20px;
        }

        .population-input-group label {
            display: block;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .population-input-group .hint {
            font-size: 12px;
            color: #7f8c8d;
            margin-bottom: 8px;
        }

        .population-input-wrapper {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .population-input-wrapper input {
            flex: 1;
            padding: 14px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 18px;
            font-weight: 600;
            text-align: center;
            transition: border-color 0.2s;
        }

        .population-input-wrapper input:focus {
            border-color: #11998e;
            outline: none;
        }

        .population-input-wrapper input::placeholder {
            color: #bdc3c7;
            font-weight: 400;
        }

        .population-presets {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .population-preset-btn {
            padding: 8px 14px;
            border: 1px solid #e0e0e0;
            background: white;
            border-radius: 20px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .population-preset-btn:hover {
            border-color: #11998e;
            background: #f0fdf4;
        }

        .facility-modal-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        .facility-modal-actions .btn-cancel {
            padding: 12px 24px;
            background: #f8f9fa;
            color: #6c757d;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }

        .facility-modal-actions .btn-cancel:hover {
            background: #e9ecef;
        }

        .facility-modal-actions .btn-proceed {
            padding: 12px 32px;
            background: linear-gradient(135deg, #11998e, #38ef7d);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .facility-modal-actions .btn-proceed:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(17, 153, 142, 0.4);
        }

        .facility-modal-actions .btn-proceed:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .loading-text {
            margin-top: 20px;
            font-size: 16px;
            color: #2c3e50;
            font-weight: 500;
        }

        .loading-subtext {
            margin-top: 8px;
            font-size: 13px;
            color: #7f8c8d;
        }

        .loading-progress {
            width: 200px;
            height: 4px;
            background: #e0e0e0;
            border-radius: 2px;
            margin-top: 15px;
            overflow: hidden;
        }

        .loading-progress-bar {
            height: 100%;
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            border-radius: 2px;
            animation: progress 2s ease-in-out infinite;
        }

        @keyframes progress {
            0% { width: 0%; margin-left: 0%; }
            50% { width: 60%; margin-left: 20%; }
            100% { width: 0%; margin-left: 100%; }
        }

        /* Skeleton Loaders */
        .skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e8e8e8 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            border-radius: 6px;
        }

        @keyframes shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        .skeleton-card {
            height: 100px;
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .skeleton-card .skeleton-title {
            height: 12px;
            width: 60%;
            margin-bottom: 15px;
        }

        .skeleton-card .skeleton-value {
            height: 28px;
            width: 40%;
        }

        .skeleton-chart {
            height: 300px;
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .skeleton-table {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .skeleton-row {
            display: flex;
            gap: 15px;
            margin-bottom: 12px;
        }

        .skeleton-cell {
            height: 16px;
            flex: 1;
        }

        .skeleton-cell:first-child {
            flex: 0.5;
        }

        /* Button loading state */
        .btn.loading {
            position: relative;
            pointer-events: none;
            opacity: 0.8;
        }

        .btn.loading::after {
            content: "";
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255,255,255,0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        /* Fade in animation for loaded content */
        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Org Unit Search */
        .search-container {
            position: relative;
            grid-column: span 2;
        }

        .search-input-wrapper {
            position: relative;
        }

        .search-input-wrapper input {
            width: 100%;
            padding: 10px 10px 10px 35px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 13px;
            transition: border-color 0.3s, box-shadow 0.3s;
        }

        .search-input-wrapper input:focus {
            border-color: #11998e;
            outline: none;
            box-shadow: 0 0 0 3px rgba(17, 153, 142, 0.1);
        }

        .search-input-wrapper .search-icon {
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            color: #7f8c8d;
            font-size: 14px;
        }

        .search-input-wrapper .clear-btn {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: #7f8c8d;
            cursor: pointer;
            font-size: 16px;
            display: none;
        }

        .search-input-wrapper .clear-btn:hover {
            color: #e74c3c;
        }

        .search-input-wrapper input:not(:placeholder-shown) + .search-icon + .clear-btn {
            display: block;
        }

        .search-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 2px solid #11998e;
            border-top: none;
            border-radius: 0 0 8px 8px;
            max-height: 300px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .search-dropdown.show {
            display: block;
        }

        .search-result-item {
            padding: 10px 15px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
            transition: background 0.2s;
        }

        .search-result-item:hover {
            background: #e8f5e9;
        }

        .search-result-item:last-child {
            border-bottom: none;
        }

        .search-result-item .name {
            font-weight: 600;
            color: #2c3e50;
            font-size: 13px;
        }

        .search-result-item .path {
            font-size: 11px;
            color: #7f8c8d;
            margin-top: 2px;
        }

        .search-result-item .level-badge {
            display: inline-block;
            padding: 2px 6px;
            background: #11998e;
            color: white;
            border-radius: 3px;
            font-size: 10px;
            margin-left: 8px;
        }

        .search-result-item .level-badge.facility {
            background: linear-gradient(135deg, #9b59b6, #8e44ad);
        }

        .search-no-results {
            padding: 20px;
            text-align: center;
            color: #7f8c8d;
            font-size: 13px;
        }

        .search-loading {
            padding: 20px;
            text-align: center;
            color: #7f8c8d;
        }

        .search-loading::after {
            content: "";
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #e0e0e0;
            border-top-color: #11998e;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-left: 8px;
            vertical-align: middle;
        }

        .search-hint {
            font-size: 10px;
            color: #95a5a6;
            margin-top: 4px;
        }

        /* Toast Notifications */
        .toast-container {
            position: fixed;
            top: 80px;
            right: 20px;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-width: 380px;
        }

        .toast {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 14px 18px;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            animation: toastSlideIn 0.3s ease-out;
            position: relative;
            overflow: hidden;
        }

        .toast.removing {
            animation: toastSlideOut 0.3s ease-in forwards;
        }

        @keyframes toastSlideIn {
            from { transform: translateX(120%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes toastSlideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(120%); opacity: 0; }
        }

        .toast-success {
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
            color: white;
        }

        .toast-error {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            color: white;
        }

        .toast-warning {
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
            color: white;
        }

        .toast-info {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
        }

        .toast-icon {
            font-size: 20px;
            flex-shrink: 0;
        }

        .toast-content {
            flex: 1;
        }

        .toast-title {
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 2px;
        }

        .toast-message {
            font-size: 12px;
            opacity: 0.95;
            line-height: 1.4;
        }

        .toast-close {
            background: none;
            border: none;
            color: white;
            opacity: 0.7;
            cursor: pointer;
            font-size: 18px;
            padding: 0;
            line-height: 1;
            flex-shrink: 0;
        }

        .toast-close:hover {
            opacity: 1;
        }

        .toast-progress {
            position: absolute;
            bottom: 0;
            left: 0;
            height: 3px;
            background: rgba(255, 255, 255, 0.4);
            animation: toastProgress linear forwards;
        }

        @keyframes toastProgress {
            from { width: 100%; }
            to { width: 0%; }
        }

        /* Sortable Tables */
        .sortable-table th.sortable {
            cursor: pointer;
            user-select: none;
            position: relative;
            padding-right: 25px;
            transition: background 0.2s;
        }

        .sortable-table th.sortable:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .sortable-table th.sortable::after {
            content: 'â‡…';
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            opacity: 0.4;
            font-size: 12px;
        }

        .sortable-table th.sortable.asc::after {
            content: 'â†‘';
            opacity: 1;
        }

        .sortable-table th.sortable.desc::after {
            content: 'â†“';
            opacity: 1;
        }

        .sortable-table th.sortable:active {
            background: rgba(255, 255, 255, 0.2);
        }

        /* Table Filter/Search */
        .table-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .table-search {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .table-search input {
            padding: 8px 12px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 12px;
            width: 200px;
            transition: border-color 0.3s;
        }

        .table-search input:focus {
            border-color: #11998e;
            outline: none;
        }

        .table-filter-btns {
            display: flex;
            gap: 5px;
        }

        .filter-btn {
            padding: 6px 12px;
            border: 1px solid #e0e0e0;
            background: white;
            border-radius: 4px;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .filter-btn:hover {
            border-color: #11998e;
        }

        .filter-btn.active {
            background: #11998e;
            color: white;
            border-color: #11998e;
        }

        .table-info {
            font-size: 11px;
            color: #7f8c8d;
        }

        /* Row highlight for filtered */
        .sortable-table tbody tr.highlight {
            background: #fffde7 !important;
        }

        .sortable-table tbody tr.hidden {
            display: none;
        }

        /* Summary Panel / Dashboard Banner */
        .summary-banner {
            background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
            border-radius: 12px;
            padding: 20px 25px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .summary-banner.hidden {
            display: none;
        }

        .summary-item {
            display: flex;
            align-items: center;
            gap: 12px;
            color: white;
        }

        .summary-icon {
            font-size: 28px;
            opacity: 0.9;
        }

        .summary-label {
            font-size: 11px;
            opacity: 0.8;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .summary-value {
            font-size: 20px;
            font-weight: 700;
        }

        .summary-change {
            font-size: 11px;
            padding: 2px 8px;
            border-radius: 10px;
            margin-left: 8px;
        }

        .summary-change.positive {
            background: rgba(39, 174, 96, 0.3);
            color: #2ecc71;
        }

        .summary-change.negative {
            background: rgba(231, 76, 60, 0.3);
            color: #e74c3c;
        }

        .summary-divider {
            width: 1px;
            height: 40px;
            background: rgba(255, 255, 255, 0.2);
        }

        /* Filter Presets */
        .presets-container {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        .preset-label {
            font-size: 11px;
            color: #7f8c8d;
            font-weight: 600;
        }

        .preset-chip {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 5px 12px;
            background: #e8f5e9;
            border: 1px solid #11998e;
            border-radius: 20px;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .preset-chip:hover {
            background: #c8e6c9;
        }

        .preset-chip .delete-preset {
            color: #7f8c8d;
            font-size: 14px;
            line-height: 1;
        }

        .preset-chip .delete-preset:hover {
            color: #e74c3c;
        }

        .save-preset-btn {
            padding: 5px 12px;
            background: white;
            border: 1px dashed #11998e;
            border-radius: 20px;
            font-size: 11px;
            color: #11998e;
            cursor: pointer;
            transition: all 0.2s;
        }

        .save-preset-btn:hover {
            background: #e8f5e9;
        }

        /* Period Comparison */
        .comparison-toggle {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-left: auto;
        }

        .comparison-switch {
            position: relative;
            width: 44px;
            height: 24px;
        }

        .comparison-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .comparison-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #ccc;
            border-radius: 24px;
            transition: 0.3s;
        }

        .comparison-slider::before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background: white;
            border-radius: 50%;
            transition: 0.3s;
        }

        .comparison-switch input:checked + .comparison-slider {
            background: #11998e;
        }

        .comparison-switch input:checked + .comparison-slider::before {
            transform: translateX(20px);
        }

        .comparison-label {
            font-size: 12px;
            color: #7f8c8d;
        }

        .comparison-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            font-size: 11px;
            padding: 2px 8px;
            border-radius: 4px;
            margin-left: 8px;
        }

        .comparison-badge.up {
            background: #d4edda;
            color: #27ae60;
        }

        .comparison-badge.down {
            background: #f8d7da;
            color: #e74c3c;
        }

        .comparison-badge.same {
            background: #e9ecef;
            color: #6c757d;
        }

        /* Analytics Trend */
        .trend-analysis {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            margin-bottom: 20px;
        }

        .outlier-list {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 10px;
        }

        .outlier-badge {
            background: #fff3cd;
            color: #856404;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 11px;
        }

        .forecast-list {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .forecast-item {
            background: #e3f2fd;
            color: #1565c0;
            padding: 8px 15px;
            border-radius: 6px;
            font-size: 12px;
        }

        @media (max-width: 1024px) {
            .charts-section {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .nav {
                flex-direction: column;
                gap: 10px;
            }

            .nav-tabs {
                width: 100%;
            }

            .nav-tab {
                flex: 1;
                text-align: center;
            }
        }

        /* Print Styles */
        @media print {
            /* Hide non-essential elements */
            .nav,
            .filters-card,
            .btn-download,
            .nav-tabs,
            .quick-btns,
            .indicator-selector,
            .presets-container,
            .table-controls,
            .comparison-toggle,
            .trend-analysis,
            #toastContainer,
            #loadingOverlay,
            #summaryBanner,
            #themeToggle,
            .search-container {
                display: none !important;
            }

            /* Reset backgrounds */
            body {
                background: white !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }

            .container {
                max-width: 100% !important;
                padding: 0 !important;
                margin: 0 !important;
            }

            /* Cards styling for print */
            .chart-card,
            .table-card,
            .stat-card {
                box-shadow: none !important;
                border: 1px solid #ddd !important;
                break-inside: avoid;
                page-break-inside: avoid;
                margin-bottom: 15px !important;
                background: white !important;
            }

            /* Ensure color-coded cells print with colors */
            .coverage-cell.green {
                background: #27ae60 !important;
                color: white !important;
                print-color-adjust: exact !important;
                -webkit-print-color-adjust: exact !important;
            }

            .coverage-cell.yellow {
                background: #f39c12 !important;
                color: white !important;
                print-color-adjust: exact !important;
                -webkit-print-color-adjust: exact !important;
            }

            .coverage-cell.red {
                background: #e74c3c !important;
                color: white !important;
                print-color-adjust: exact !important;
                -webkit-print-color-adjust: exact !important;
            }

            /* Table styling */
            table {
                width: 100% !important;
                font-size: 10px !important;
            }

            th, td {
                padding: 6px 4px !important;
            }

            /* Print header */
            .section.active::before {
                content: "EPI Dashboard Report - " attr(data-org) " - " attr(data-period);
                display: block;
                font-size: 18px;
                font-weight: bold;
                margin-bottom: 20px;
                padding-bottom: 10px;
                border-bottom: 2px solid #11998e;
            }

            /* Charts - ensure they print */
            canvas {
                max-width: 100% !important;
                height: auto !important;
            }

            /* Page breaks */
            .charts-section {
                page-break-before: auto;
            }

            h3 {
                page-break-after: avoid;
            }

            /* Footer */
            @page {
                margin: 1cm;
                @bottom-center {
                    content: "Page " counter(page) " of " counter(pages);
                }
            }
        }
    </style>
</head>

<body>
    <!-- Toast Notifications Container -->
    <div id="toastContainer" class="toast-container"></div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay hidden">
        <div class="loading-spinner"></div>
        <div class="loading-text" id="loadingText">Loading data...</div>
        <div class="loading-subtext" id="loadingSubtext">Fetching from DHIS2</div>
        <div class="loading-progress">
            <div class="loading-progress-bar"></div>
        </div>
    </div>

    <!-- Facility Population Modal -->
    <div id="facilityPopulationModal" class="facility-modal-overlay" style="display: none;">
        <div class="facility-modal">
            <div class="facility-modal-header">
                <h3>ðŸ¥ Facility Catchment Population</h3>
                <p>UBOS doesn't provide facility-level population data. Please enter the catchment population for accurate coverage calculations.</p>
            </div>
            <div class="facility-modal-body">
                <div class="facility-info-box">
                    <div class="facility-name" id="facilityModalName">-</div>
                    <div class="facility-path" id="facilityModalPath">-</div>
                </div>
                
                <div class="population-input-group">
                    <label for="facilityPopulationInput">Enter Catchment Population</label>
                    <p class="hint">This is the total population served by this facility. Enter the annual target population for infants/children under 1 year.</p>
                    <div class="population-input-wrapper">
                        <input type="number" id="facilityPopulationInput" placeholder="e.g. 5000" min="1" max="1000000">
                        <span style="font-size: 14px; color: #7f8c8d;">people</span>
                    </div>
                </div>
                
                <div class="population-presets">
                    <span style="font-size: 12px; color: #7f8c8d; margin-right: 8px;">Quick select:</span>
                    <button class="population-preset-btn" onclick="setFacilityPopulation(1000)">1,000</button>
                    <button class="population-preset-btn" onclick="setFacilityPopulation(2500)">2,500</button>
                    <button class="population-preset-btn" onclick="setFacilityPopulation(5000)">5,000</button>
                    <button class="population-preset-btn" onclick="setFacilityPopulation(10000)">10,000</button>
                    <button class="population-preset-btn" onclick="setFacilityPopulation(25000)">25,000</button>
                    <button class="population-preset-btn" onclick="setFacilityPopulation(50000)">50,000</button>
                </div>
                
                <div class="facility-modal-actions">
                    <button class="btn-cancel" onclick="cancelFacilityPopulation()">Cancel</button>
                    <button class="btn-proceed" id="btnProceedWithFacility" onclick="proceedWithFacilityAnalysis()" disabled>Proceed with Analysis</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Navigation -->
    <nav class="nav">
        <h1>ðŸ’‰ Child Immunization Dashboard</h1>
        <div class="nav-tabs">
            <button class="nav-tab active">ðŸ“ˆ Analytics</button>
        </div>
        <div style="display: flex; align-items: center; gap: 10px;">
            <span class="user-badge" id="userBadge">Loading...</span>
            <button onclick="clearServerCache()" id="clearCacheBtn"
                style="background: rgba(255,255,255,0.2); color: white; padding: 8px 12px; border-radius: 6px; border: none; cursor: pointer; font-size: 14px;"
                title="Clear Cache">ðŸ—‘ï¸</button>
            <button onclick="toggleDarkMode()" id="themeToggle"
                style="background: rgba(255,255,255,0.2); color: white; padding: 8px 12px; border-radius: 6px; border: none; cursor: pointer; font-size: 14px;"
                title="Toggle Dark Mode">ðŸŒ™</button>
            <a href="/logout"
                style="background: rgba(255,255,255,0.2); color: white; padding: 8px 12px; border-radius: 6px; text-decoration: none; font-size: 12px;">ðŸšª
                Logout</a>
        </div>
    </nav>

    <div class="container">
        <!-- Summary Banner -->
        <div id="summaryBanner" class="summary-banner hidden">
            <div class="summary-item">
                <span class="summary-icon">ðŸ“…</span>
                <div>
                    <div class="summary-label">Last Data Load</div>
                    <div class="summary-value" id="bannerLastUpdate">--</div>
                </div>
            </div>
            <div class="summary-divider"></div>
            <div class="summary-item">
                <span class="summary-icon">ðŸ“</span>
                <div>
                    <div class="summary-label">Current Selection</div>
                    <div class="summary-value" id="bannerOrgUnit">Uganda</div>
                </div>
            </div>
            <div class="summary-divider"></div>
            <div class="summary-item">
                <span class="summary-icon">ðŸ’‰</span>
                <div>
                    <div class="summary-label">Total Doses</div>
                    <div class="summary-value" id="bannerTotalDoses">--</div>
                </div>
            </div>
            <div class="summary-divider"></div>
            <div class="summary-item">
                <span class="summary-icon">ðŸŽ¯</span>
                <div>
                    <div class="summary-label">Avg Coverage</div>
                    <div class="summary-value" id="bannerAvgCoverage">--%</div>
                </div>
            </div>
            <div class="summary-divider"></div>
            <div class="summary-item">
                <span class="summary-icon">âš ï¸</span>
                <div>
                    <div class="summary-label">Low Coverage</div>
                    <div class="summary-value" id="bannerAlerts">0</div>
                </div>
            </div>
        </div>

        <!-- Filters -->
        <div class="filters-card">
            <h3>ðŸ” Filters</h3>
            
            <!-- Quick Search -->
            <div class="filters-row" style="margin-bottom: 20px;">
                <div class="filter-group search-container">
                    <label>ðŸ”Ž Quick Search (Districts & Facilities)</label>
                    <div class="search-input-wrapper">
                        <input type="text" id="orgUnitSearch" 
                               placeholder="Type to search districts, sub-counties, or facilities..." 
                               oninput="handleSearchInput(this.value)"
                               onfocus="showSearchDropdown()"
                               autocomplete="off">
                        <span class="search-icon">ðŸ”</span>
                        <button class="clear-btn" onclick="clearSearch()" title="Clear search">âœ•</button>
                    </div>
                    <div id="searchDropdown" class="search-dropdown"></div>
                    <div class="search-hint">ðŸ’¡ Tip: Type at least 3 characters to search. Press Esc to close.</div>
                </div>
            </div>
            
            <!-- Or Browse Hierarchy -->
            <div style="text-align: center; margin: 10px 0; color: #7f8c8d; font-size: 12px;">
                <span style="background: #f0f4f8; padding: 0 15px;">â€” OR browse by hierarchy â€”</span>
            </div>
            
            <div class="filters-row">
                <div class="filter-group"><label>Level 1 - Country</label><select id="level1"
                        onchange="loadChildren(1)">
                        <option>Loading...</option>
                    </select></div>
                <div class="filter-group"><label>Level 2 - Region</label><select id="level2" onchange="loadChildren(2)"
                        disabled>
                        <option>--</option>
                    </select></div>
                <div class="filter-group"><label>Level 3 - District</label><select id="level3"
                        onchange="loadChildren(3)" disabled>
                        <option>--</option>
                    </select></div>
                <div class="filter-group" id="level4Group"><label>Level 4</label><select id="level4"
                        onchange="loadChildren(4)" disabled>
                        <option>--</option>
                    </select></div>
                <div class="filter-group" id="level5Group"><label>Level 5</label><select id="level5"
                        onchange="loadChildren(5)" disabled>
                        <option>--</option>
                    </select></div>
                <div class="filter-group" id="level6Group"><label>Level 6 - Facility</label><select id="level6"
                        onchange="selectFinalLevel(6)" disabled>
                        <option>--</option>
                    </select></div>
            </div>
            <div class="filters-row">
                <div class="filter-group"><label>Period Type</label><select id="periodType"
                        onchange="togglePeriodInputs()">
                        <option value="relative">Relative</option>
                        <option value="month">Month</option>
                        <option value="quarter">Quarter</option>
                        <option value="year">Year</option>
                        <option value="custom">Custom</option>
                    </select></div>
                <div class="filter-group" id="relativePeriodGroup"><label>Period</label><select id="relativePeriod">
                        <optgroup label="Months">
                            <option value="LAST_12_MONTHS" selected>Last 12 Months</option>
                            <option value="LAST_6_MONTHS">Last 6 Months</option>
                            <option value="LAST_3_MONTHS">Last 3 Months</option>
                            <option value="LAST_MONTH">Last Month</option>
                        </optgroup>
                        <optgroup label="Quarters">
                            <option value="LAST_4_QUARTERS">Last 4 Quarters</option>
                            <option value="THIS_QUARTER">This Quarter</option>
                            <option value="LAST_QUARTER">Last Quarter</option>
                        </optgroup>
                        <optgroup label="Years">
                            <option value="THIS_YEAR">This Year</option>
                            <option value="LAST_YEAR">Last Year</option>
                        </optgroup>
                    </select></div>
                <div class="filter-group" id="yearGroup" style="display:none;"><label>Year</label><select
                        id="yearSelect"></select></div>
                <div class="filter-group" id="monthYearGroup" style="display:none;"><label>Year</label><select
                        id="monthYear"></select></div>
                <div class="filter-group" id="monthGroup" style="display:none;"><label>Month</label><select
                        id="monthSelect">
                        <option value="01">Jan</option>
                        <option value="02">Feb</option>
                        <option value="03">Mar</option>
                        <option value="04">Apr</option>
                        <option value="05">May</option>
                        <option value="06">Jun</option>
                        <option value="07">Jul</option>
                        <option value="08">Aug</option>
                        <option value="09">Sep</option>
                        <option value="10">Oct</option>
                        <option value="11">Nov</option>
                        <option value="12">Dec</option>
                    </select></div>
                <div class="filter-group" id="quarterYearGroup" style="display:none;"><label>Year</label><select
                        id="quarterYear"></select></div>
                <div class="filter-group" id="quarterGroup" style="display:none;"><label>Quarter</label><select
                        id="quarterSelect">
                        <option value="Q1">Q1</option>
                        <option value="Q2">Q2</option>
                        <option value="Q3">Q3</option>
                        <option value="Q4">Q4</option>
                    </select></div>
                <div class="filter-group" id="customStartGroup" style="display:none;"><label>Start</label><input
                        id="startPeriod" placeholder="202401"></div>
                <div class="filter-group" id="customEndGroup" style="display:none;"><label>End</label><input
                        id="endPeriod" placeholder="202412"></div>
            </div>
            <div class="selected-info">
                <span>ðŸ“ <strong>Org Unit:</strong> <span class="highlight" id="selectedOrg">Uganda</span></span>
                <span>ðŸ“… <strong>Period:</strong> <span class="highlight" id="selectedPeriod">Last 12
                        Months</span></span>
                <span id="populationInfo" style="display:none;">ðŸ‘¥ <strong>UBOS Population:</strong> <span
                        class="highlight" id="ubosPopulation">-</span></span>
                
                <!-- Period Comparison Toggle -->
                <div class="comparison-toggle" id="comparisonToggle" style="display:none;">
                    <span class="comparison-label">Compare with previous:</span>
                    <label class="comparison-switch">
                        <input type="checkbox" id="compareEnabled" onchange="toggleComparison()">
                        <span class="comparison-slider"></span>
                    </label>
                </div>
                
                <button class="btn btn-primary" onclick="loadData()">ðŸ“Š Load Data</button>
            </div>
            
            <!-- Filter Presets -->
            <div class="presets-container">
                <span class="preset-label">ðŸ’¾ Saved Presets:</span>
                <div id="presetsArea">
                    <span style="color:#95a5a6; font-size:11px;">No saved presets</span>
                </div>
                <button class="save-preset-btn" onclick="saveFilterPreset()">+ Save Current</button>
            </div>
        </div>

        <div id="errorMessage" class="error" style="display:none;"></div>
        <div id="loadingSpinner" class="loading" style="display:none;">â³ Loading data from DHIS2...</div>
        <!-- ANALYTICS SECTION -->
        <div id="analyticsSection" class="section active">
            
            <!-- Executive Dashboard Summary -->
            <div class="executive-dashboard fade-in" id="executiveDashboard" style="display:none;">
                <div class="dashboard-header">
                    <h2 class="dashboard-title">
                        <span class="icon">ðŸ“Š</span>
                        <span>Immunization Performance Dashboard</span>
                    </h2>
                    <div class="dashboard-meta">
                        <div><strong id="dashboardOrg">-</strong></div>
                        <div id="dashboardPeriod">-</div>
                        <div style="margin-top:5px;">Population: <strong id="dashboardPop">-</strong></div>
                </div>
            </div>

                <div class="kpi-grid" id="kpiGrid">
                    <div class="kpi-card highlight">
                        <div class="kpi-value" id="kpiTotalDoses">-</div>
                        <div class="kpi-label">Total Doses Given</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-value" id="kpiAvgCoverage">-</div>
                        <div class="kpi-label">Average Coverage</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-value green" id="kpiOnTarget">-</div>
                        <div class="kpi-label">On Target (â‰¥95%)</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-value yellow" id="kpiModerate">-</div>
                        <div class="kpi-label">Moderate (70-94%)</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-value red" id="kpiLow">-</div>
                        <div class="kpi-label">Needs Attention (<70%)</div>
                    </div>
                </div>

                <div class="performance-gauge">
                    <div class="gauge-header">
                        <span>Coverage Distribution</span>
                        <span id="gaugeTotal">0 indicators</span>
                </div>
                    <div class="gauge-bar">
                        <div class="gauge-segment green" id="gaugeGreen" style="width:0%"></div>
                        <div class="gauge-segment yellow" id="gaugeYellow" style="width:0%"></div>
                        <div class="gauge-segment red" id="gaugeRed" style="width:0%"></div>
                    </div>
                    <div class="gauge-legend">
                        <span><div class="dot" style="background:#27ae60;"></div> On Target</span>
                        <span><div class="dot" style="background:#f39c12;"></div> Moderate</span>
                        <span><div class="dot" style="background:#e74c3c;"></div> Needs Attention</span>
                </div>
            </div>

                <!-- Full Report Download Section -->
                <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.2);">
                    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
                        <div>
                            <h4 style="margin: 0; font-size: 14px; opacity: 0.9;">ðŸ“¥ Download Full Report</h4>
                            <p style="margin: 5px 0 0; font-size: 11px; opacity: 0.7;">Get a comprehensive report with all data, charts, and analysis</p>
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <button onclick="downloadFullReport('excel')" style="background: linear-gradient(135deg, #217346, #2ecc71); color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 8px; transition: transform 0.2s;">
                                ðŸ“Š Full Excel Report
                            </button>
                            <button onclick="downloadFullReport('pdf')" style="background: linear-gradient(135deg, #c0392b, #e74c3c); color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 8px; transition: transform 0.2s;">
                                ðŸ“‘ Full PDF Report
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Coverage Table - Modern Design - MAIN EPI SECTION -->
            <div class="modern-table-card" id="coverageTableCard" style="border: 3px solid #27ae60; box-shadow: 0 8px 32px rgba(39,174,96,0.2);">
                <div class="table-header green-theme" style="background: linear-gradient(135deg, #1a5f1a, #27ae60); padding: 20px;">
                    <h3 style="font-size: 20px; font-weight: 800; text-transform: uppercase; letter-spacing: 1px;">ðŸ’‰ Vaccination Coverage by Antigen</h3>
                    <div class="table-actions">
                        <button class="btn-export" onclick="downloadCoverageExcel()">ðŸ“Š Excel</button>
                        <button class="btn-export" onclick="downloadCoverageCSV()">ðŸ“„ CSV</button>
                        <button class="btn-export" onclick="downloadTableAsPDF('coverageTable')">ðŸ“‘ PDF</button>
                        <button class="btn-export" onclick="downloadTableAsImage('coverageTableCard')">ðŸ–¼ï¸ Image</button>
                    </div>
                </div>
                
                <div class="table-toolbar">
                    <div class="search-box">
                        <span class="icon">ðŸ”</span>
                        <input type="text" id="coverageTableSearch" placeholder="Search vaccines..." 
                               oninput="filterTable('coverageTable', this.value)">
                    </div>
                    <div class="filter-pills">
                        <button class="filter-pill active" onclick="filterByColor('coverageTable', 'all', this)">All</button>
                        <button class="filter-pill green-active" onclick="filterByColor('coverageTable', 'green', this)">âœ“ On Target</button>
                        <button class="filter-pill yellow-active" onclick="filterByColor('coverageTable', 'yellow', this)">âš¡ Moderate</button>
                        <button class="filter-pill red-active" onclick="filterByColor('coverageTable', 'red', this)">âš  Low</button>
                    </div>
                </div>
                
                <table id="coverageTable" class="modern-table">
                    <thead>
                        <tr>
                            <th style="width:35%">Vaccine / Antigen</th>
                            <th style="width:12%">Doses Given</th>
                            <th style="width:12%">Target</th>
                            <th style="width:15%">Coverage</th>
                            <th style="width:26%">Schedule</th>
                        </tr>
                    </thead>
                    <tbody id="coverageTableBody">
                        <tr>
                            <td colspan="5" style="text-align:center; padding:40px; color:var(--text-muted);">
                                Select filters and click "Load Data" to view coverage
                            </td>
                        </tr>
                    </tbody>
                </table>
        </div>

            <!-- Dropout Summary Cards -->
            <div class="dropout-summary" id="dropoutSummary" style="display:none;"></div>

            <!-- Dropout Table - Modern Design -->
            <div class="modern-table-card" id="dropoutTableCard">
                <div class="table-header orange-theme">
                    <h3>ðŸ“‰ Dropout Rate Analysis</h3>
                    <div class="table-actions">
                        <button class="btn-export" onclick="downloadDropoutExcel()">ðŸ“Š Excel</button>
                        <button class="btn-export" onclick="downloadDropoutCSV()">ðŸ“„ CSV</button>
                        <button class="btn-export" onclick="downloadTableAsPDF('dropoutTable')">ðŸ“‘ PDF</button>
                        <button class="btn-export" onclick="downloadTableAsImage('dropoutTableCard')">ðŸ–¼ï¸ Image</button>
                </div>
                </div>
                
                <table id="dropoutTable" class="modern-table">
                    <thead>
                        <tr>
                            <th style="width:30%">Dropout Pathway</th>
                            <th style="width:18%">Starting Dose</th>
                            <th style="width:18%">Ending Dose</th>
                            <th style="width:17%">Dropout Rate</th>
                            <th style="width:17%">Status</th>
                        </tr>
                    </thead>
                    <tbody id="dropoutTableBody">
                        <tr>
                            <td colspan="5" style="text-align:center; padding:40px; color:var(--text-muted);">
                                Load data to view dropout rates
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- RED CATEGORISATION TOOL - Quarterly Progress Monitoring -->
            <div class="modern-table-card" id="redCategorizationCard">
                <div class="table-header" style="background: linear-gradient(135deg, #c0392b, #e74c3c);">
                    <div>
                        <h3 style="margin-bottom:5px;">ðŸ”´ RED CATEGORISATION TOOL - Progress Monitoring</h3>
                        <div style="font-size:12px; opacity:0.9;">Quarterly performance tracking | <span id="redUnitName">-</span></div>
                    </div>
                    <div class="table-actions">
                        <button class="btn-export" onclick="downloadREDExcel()">ðŸ“Š Excel</button>
                        <button class="btn-export" onclick="downloadREDCSV()">ðŸ“„ CSV</button>
                        <button class="btn-export" onclick="downloadREDAsPDF()">ðŸ“‘ PDF</button>
                        <button class="btn-export" onclick="downloadTableAsImage('redCategorizationCard')">ðŸ–¼ï¸ Image</button>
                    </div>
                </div>
                
                <!-- Criteria Box with Date Selection -->
                <div style="display:flex; justify-content:space-between; align-items:center; padding:15px 20px; background:linear-gradient(135deg, #1a5f1a, #27ae60); color:white; flex-wrap:wrap; gap:15px;">
                    <div>
                        <strong style="font-size:14px;">ðŸ‡ºðŸ‡¬ UGANDA</strong>
                        <div style="font-size:12px; margin-top:4px;">Goal: Increase immunization coverage to at least 90% with all vaccines in every sub county</div>
                    </div>
                    <div style="display:flex; gap:15px; align-items:center; flex-wrap:wrap;">
                        <div style="display:flex; gap:10px; font-size:12px; background:rgba(255,255,255,0.15); padding:10px 15px; border-radius:8px;">
                            <div><strong>DPT1 Coverage:</strong> â‰¥90%</div>
                            <div><strong>Dropout Rate:</strong> â‰¤10%</div>
                        </div>
                        <div style="display:flex; gap:8px; align-items:center; background:rgba(255,255,255,0.15); padding:8px 12px; border-radius:8px; font-size:11px;">
                            <label style="font-weight:600;">Period:</label>
                            <input type="month" id="redStartDate" style="padding:4px 8px; border-radius:4px; border:none; font-size:11px;" title="Start month">
                            <span>to</span>
                            <input type="month" id="redEndDate" style="padding:4px 8px; border-radius:4px; border:none; font-size:11px;" title="End month">
                            <button onclick="loadREDWithCustomDates()" style="padding:4px 12px; border-radius:4px; border:none; background:#2c3e50; color:white; cursor:pointer; font-size:11px; font-weight:600;">Apply</button>
                            <button onclick="resetREDDates()" style="padding:4px 10px; border-radius:4px; border:none; background:rgba(255,255,255,0.2); color:white; cursor:pointer; font-size:11px;" title="Reset to default">â†º</button>
                        </div>
                    </div>
                </div>

                <!-- Category Legend -->
                <div style="display:flex; gap:15px; padding:12px 20px; background:#f8f9fa; border-bottom:1px solid #e0e0e0; flex-wrap:wrap;">
                    <div style="display:flex; align-items:center; gap:6px;"><span style="width:20px; height:20px; background:#92D050; border-radius:4px;"></span><span style="font-size:11px;"><strong>Cat.1:</strong> Good Access & Utilization</span></div>
                    <div style="display:flex; align-items:center; gap:6px;"><span style="width:20px; height:20px; background:#FFFF00; border-radius:4px; border:1px solid #ccc;"></span><span style="font-size:11px;"><strong>Cat.2:</strong> Good Access, High Dropout</span></div>
                    <div style="display:flex; align-items:center; gap:6px;"><span style="width:20px; height:20px; background:#FFC000; border-radius:4px;"></span><span style="font-size:11px;"><strong>Cat.3:</strong> Low Access, Good Utilization</span></div>
                    <div style="display:flex; align-items:center; gap:6px;"><span style="width:20px; height:20px; background:#FF0000; border-radius:4px;"></span><span style="font-size:11px; color:#c0392b;"><strong>Cat.4:</strong> CRITICAL - Low Access & High Dropout</span></div>
                </div>

                <!-- Category Summary -->
                <div id="redCategorySummary" style="display:flex; gap:15px; padding:15px 20px; background:#f0f0f0; border-bottom:1px solid #e0e0e0; flex-wrap:wrap;">
                    <div class="red-summary-box" style="background:#92D050;"><span class="count" id="cat1Count">0</span><span class="label">Cat. 1</span></div>
                    <div class="red-summary-box" style="background:#FFFF00; color:#333;"><span class="count" id="cat2Count">0</span><span class="label">Cat. 2</span></div>
                    <div class="red-summary-box" style="background:#FFC000;"><span class="count" id="cat3Count">0</span><span class="label">Cat. 3</span></div>
                    <div class="red-summary-box" style="background:#FF0000;"><span class="count" id="cat4Count">0</span><span class="label">Cat. 4</span></div>
                    <div class="red-summary-box" style="background:#2c3e50; margin-left:auto;"><span class="count" id="totalUnitsCount">8</span><span class="label">Quarters</span></div>
                </div>

                <div style="overflow-x:auto;">
                    <table id="redCategorizationTable" class="modern-table red-table">
                    <thead>
                        <tr>
                                <th rowspan="2" style="min-width:120px;">Quarter</th>
                                <th colspan="3" style="text-align:center; background:#3498db; color:white;">Targets (Quarterly)</th>
                                <th colspan="4" style="text-align:center; background:#9b59b6; color:white;">Doses Administered</th>
                                <th colspan="4" style="text-align:center; background:#27ae60; color:white;">Coverage (%)</th>
                                <th colspan="4" style="text-align:center; background:#e67e22; color:white;">Unimmunized / Gaps</th>
                                <th colspan="2" style="text-align:center; background:#e74c3c; color:white;">Dropout (%)</th>
                                <th colspan="3" style="text-align:center; background:#2c3e50; color:white;">Classification</th>
                            </tr>
                            <tr>
                                <th title="Quarterly Population = Annual / 4">Q-Pop</th>
                                <th title="BCG Target = Annual Ã— 4.85% / 4">BCG Tgt</th>
                                <th title="DPT/MR Target = Annual Ã— 4.3% / 4">DPT/MR Tgt</th>
                                <th>BCG</th>
                                <th>DPT1</th>
                                <th>DPT3</th>
                                <th>MR</th>
                                <th>BCG</th>
                                <th>DPT1</th>
                                <th>DPT3</th>
                                <th>MR</th>
                                <th>DPT3</th>
                                <th>MR</th>
                                <th>Zero Dose</th>
                                <th>Under-Imm</th>
                                <th>DPT1â†’3</th>
                                <th>DPT1â†’MR</th>
                                <th>Access</th>
                                <th>Utilization</th>
                                <th style="min-width:80px;">Category</th>
                        </tr>
                    </thead>
                        <tbody id="redCategorizationBody">
                        <tr>
                                <td colspan="21" style="text-align:center; padding:40px; color:var(--text-muted);">
                                    Load data to view RED Categorization analysis
                                </td>
                        </tr>
                    </tbody>
                </table>
                </div>
            </div>

            <div class="trend-analysis">
                <h3>âš ï¸ Outlier Detection & Analysis</h3>
                <div class="filters-row" style="margin-top:15px; gap:15px;">
                    <div class="filter-group" style="flex:1;">
                        <label>Select Indicator</label>
                        <select id="trendIndicator" onchange="loadTrendAnalysis()">
                            <option value="">-- Select Specific Indicator --</option>
                        </select>
                </div>
                    <div class="filter-group" style="display:flex; align-items:flex-end;">
                        <button class="btn btn-primary" onclick="detectAllOutliers()" style="background:linear-gradient(135deg, #f39c12, #e67e22); padding:10px 20px;">
                            ðŸ” Detect All Outliers
                        </button>
                </div>
                </div>

                <!-- Outliers Section -->
                <div id="outliersSection"
                    style="display:none; margin-top:15px; background:#fff3cd; padding:15px; border-radius:8px; border-left:4px solid #f39c12;">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                        <h4 style="color:#856404; margin:0;" id="outliersTitle">âš ï¸ Outliers Detected in Historical Data</h4>
                        <button class="btn btn-download" onclick="downloadOutliers()" style="background:#f39c12;">ðŸ“¥
                            Download Outliers</button>
                    </div>
                    <p style="font-size:12px; color:#856404; margin-bottom:10px;">These data points deviate
                        significantly from the trend (Z-score > 2). April/October (ICHD campaign months) use a higher
                        threshold to account for expected spikes.</p>
                    <div id="outliersTable"></div>
                </div>

                <div id="trendResults" style="margin-top:15px;"></div>
                
                <!-- Chart container (Hidden as per request to focus on outliers only) -->
                <div class="charts-section" style="margin-top:15px; display: none;">
                    <div class="chart-card full">
                        <h3>ðŸ“ˆ Trend with Forecast (24 Months) <button class="btn btn-download"
                                onclick="downloadChart('forecastChart')">ðŸ“¥ PNG</button></h3>
                        <canvas id="forecastChart"></canvas>
                                </div>
                                </div>
            </div>
        </div>
    </div>

    <script>
        // Register Chart.js datalabels plugin
        Chart.register(ChartDataLabels);

        let selectedOrgUnit = { id: 'akV6429SUqu', name: 'Uganda', level: 1 };
        let selectedDistrict = '';
        let dataElements = [];
        let selectedIndicators = new Set();
        let currentSection = 'analytics';
        let charts = {};
        let ubosPopulation = {};
        let facilityPopulation = null; // Custom population for facilities
        let pendingFacilityAnalysis = false; // Flag to track if we're waiting for population input
        const FACILITY_LEVEL_THRESHOLD = 5; // Level 5+ is considered a facility
        const COLORS = ['#11998e', '#38ef7d', '#3498db', '#9b59b6', '#e74c3c', '#f39c12', '#1abc9c', '#2ecc71', '#e67e22', '#34495e'];

        // Antigen information: disease prevented and vaccination schedule
        const ANTIGEN_INFO = {
            '105-CL01': { disease: 'Tuberculosis (TB)', schedule: 'At birth' },
            '105-CL02': { disease: 'Hepatitis B', schedule: 'Within 24 hours of birth' },
            '105-CL03': { disease: 'Tetanus (Protection at Birth)', schedule: 'During pregnancy' },
            '105-CL04': { disease: 'Poliomyelitis', schedule: 'At birth (OPV0)' },
            '105-CL05': { disease: 'Poliomyelitis', schedule: '6 weeks (OPV1)' },
            '105-CL06': { disease: 'Poliomyelitis', schedule: '10 weeks (OPV2)' },
            '105-CL07': { disease: 'Poliomyelitis', schedule: '14 weeks (OPV3)' },
            '105-CL08': { disease: 'Poliomyelitis', schedule: '14 weeks (IPV1)' },
            '105-CL09': { disease: 'Poliomyelitis', schedule: '9 months (IPV2)' },
            '105-CL10': { disease: 'Diphtheria, Pertussis, Tetanus, Hep B, Hib', schedule: '6 weeks (Penta 1)' },
            '105-CL11': { disease: 'Diphtheria, Pertussis, Tetanus, Hep B, Hib', schedule: '10 weeks (Penta 2)' },
            '105-CL12': { disease: 'Diphtheria, Pertussis, Tetanus, Hep B, Hib', schedule: '14 weeks (Penta 3)' },
            '105-CL13': { disease: 'Pneumococcal disease', schedule: '6 weeks (PCV1)' },
            '105-CL14': { disease: 'Pneumococcal disease', schedule: '10 weeks (PCV2)' },
            '105-CL15': { disease: 'Pneumococcal disease', schedule: '14 weeks (PCV3)' },
            '105-CL16': { disease: 'Rotavirus diarrhea', schedule: '6 weeks (Rota 1)' },
            '105-CL17': { disease: 'Rotavirus diarrhea', schedule: '10 weeks (Rota 2)' },
            '105-CL18': { disease: 'Rotavirus diarrhea', schedule: '14 weeks (Rota 3)' },
            '105-CL19': { disease: 'Malaria', schedule: '6 months (RTS,S/Malaria 1)' },
            '105-CL20': { disease: 'Malaria', schedule: '7 months (RTS,S/Malaria 2)' },
            '105-CL21': { disease: 'Malaria', schedule: '9 months (RTS,S/Malaria 3)' },
            '105-CL22': { disease: 'Yellow Fever', schedule: '9 months' },
            '105-CL23': { disease: 'Measles, Rubella', schedule: '9 months (MR1)' },
            '105-CL24': { disease: 'Fully Immunized Child', schedule: 'By 1 year of age' },
            '105-CL25': { disease: 'Malaria prevention', schedule: 'LLINs distribution' },
            '105-CL26': { disease: 'Malaria', schedule: '24 months (RTS,S/Malaria 4)' },
            '105-CL27': { disease: 'Measles, Rubella', schedule: '18 months (MR2)' },
            '105-CL28': { disease: 'Fully Immunized Child', schedule: 'By 2 years of age' }
        };

        function getAntigenInfo(code) {
            const info = ANTIGEN_INFO[code];
            if (info) {
                return `${info.disease} | ${info.schedule}`;
            }
            return 'Immunization';
        }

        // Initialize
        window.onload = async () => {
            initYearDropdowns();
            // Load user info in background (non-blocking)
            loadUserInfo();
            // Load saved presets
            loadSavedPresets();
            // Load other data in parallel
            await Promise.all([
                loadDistricts(),
                initOrgUnits(),
                loadDataElements()
            ]);
        };

        function initYearDropdowns() {
            const year = new Date().getFullYear();
            ['yearSelect', 'monthYear', 'quarterYear'].forEach(id => {
                const el = document.getElementById(id);
                if (el) { el.innerHTML = ''; for (let y = year; y >= 2015; y--) el.innerHTML += `<option value="${y}">${y}</option>`; }
            });
        }

        async function loadUserInfo() {
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 5000); // 5 second timeout
                const r = await fetch('/api/user-info', { signal: controller.signal });
                clearTimeout(timeoutId);
                const d = await r.json();
                if (d?.displayName) document.getElementById('userBadge').textContent = `ðŸ‘¤ ${d.displayName}`;
                else document.getElementById('userBadge').textContent = 'ðŸ‘¤ User';
            } catch (e) {
                document.getElementById('userBadge').textContent = 'ðŸ‘¤ User';
            }
        }

        async function loadDistricts() {
            try { const r = await fetch('/api/districts'); ubosPopulation = await r.json(); } catch (e) { console.error(e); }
        }

        async function loadDataElements() {
            try {
                const r = await fetch('/api/search-data-elements?pattern=105-CL');
                const d = await r.json();
                dataElements = (d.dataElements || []).sort((a, b) => a.code.localeCompare(b.code));
                populateTrendIndicators();
            } catch (e) { 
                console.error('Error loading data elements:', e);
        }
        }

        function populateTrendIndicators() {
            const sel = document.getElementById('trendIndicator');
            sel.innerHTML = '<option value="">-- Select Indicator --</option>' + dataElements.map(de => `<option value="${de.id}">${de.code}: ${de.shortName || de.displayName}</option>`).join('');
        }


        function switchSection(section) {
            currentSection = section;
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            // Find the active nav-tab (analytics is now the only main tab)
            document.querySelector('.nav-tab').classList.add('active');

            // Analytics is always the main section now
            document.getElementById('analyticsSection').classList.add('active');

            // Show all org levels for analytics too (to allow facility selection)
            const isAnalytics = section === 'analytics';
            ['level4Group', 'level5Group', 'level6Group'].forEach(id => {
                document.getElementById(id).style.display = 'flex';
            });
            
            // Update population info display
            if (isAnalytics) {
                if (isFacilityLevel()) {
                    if (facilityPopulation) {
                        document.getElementById('ubosPopulation').textContent = facilityPopulation.toLocaleString() + ' (custom)';
                    } else {
                        document.getElementById('ubosPopulation').textContent = 'Will prompt for input';
                    }
                    document.getElementById('populationInfo').style.display = 'inline';
                } else if (selectedDistrict) {
                    const pop = ubosPopulation[selectedDistrict] || 0;
                    document.getElementById('ubosPopulation').textContent = pop.toLocaleString();
                    document.getElementById('populationInfo').style.display = 'inline';
                } else {
                    document.getElementById('populationInfo').style.display = 'none';
                }
            } else {
                document.getElementById('populationInfo').style.display = 'none';
            }
            
            // Show comparison toggle only in analytics
            document.getElementById('comparisonToggle').style.display = isAnalytics ? 'flex' : 'none';
        }

        async function initOrgUnits() {
            const sel = document.getElementById('level1');
            sel.innerHTML = '<option>â³ Loading...</option>';
            sel.disabled = true;
            
            try {
                const r = await fetch('/api/org-units');
                const d = await r.json();
                const units = d.organisationUnits || [];
                sel.innerHTML = '<option value="">-- Select Country --</option>' + units.map(u => `<option value="${u.id}" data-name="${u.displayName}">${u.displayName}</option>`).join('');
                sel.disabled = false;
                const uganda = units.find(u => u.displayName.includes('Uganda') || u.displayName.includes('MOH'));
                if (uganda) { sel.value = uganda.id; loadChildren(1); }
            } catch (e) { 
                sel.innerHTML = '<option>âŒ Error loading</option>'; 
                sel.disabled = false;
            }
        }

        async function loadChildren(level) {
            const sel = document.getElementById(`level${level}`);
            const parentId = sel.value;
            const parentName = sel.options[sel.selectedIndex]?.dataset?.name || sel.options[sel.selectedIndex]?.text || '';

            if (parentId) {
                // Build path from selected hierarchy
                const path = buildOrgUnitPath(level);
                selectedOrgUnit = { id: parentId, name: parentName, level: level, path: path };
                document.getElementById('selectedOrg').textContent = parentName;
                
                // Reset facility population when changing org unit
                facilityPopulation = null;

                // Check if this is a district (level 3)
                if (level === 3) {
                    selectedDistrict = parentName.toUpperCase().replace(' DISTRICT', '').trim();
                    const pop = ubosPopulation[selectedDistrict] || 0;
                    document.getElementById('ubosPopulation').textContent = pop.toLocaleString();
                    document.getElementById('populationInfo').style.display = currentSection === 'analytics' ? 'inline' : 'none';
                }
            }

            // Clear lower levels (allow all levels for analytics to enable facility analysis)
            for (let i = level + 1; i <= 6; i++) {
                const s = document.getElementById(`level${i}`);
                s.innerHTML = '<option>--</option>'; s.disabled = true;
            }

            // Allow loading children up to level 6 (facility level)
            if (!parentId || level >= 6) return;

            const nextLevel = level + 1;
            const nextSel = document.getElementById(`level${nextLevel}`);
            nextSel.innerHTML = '<option>â³ Loading...</option>'; 
            nextSel.disabled = false;
            nextSel.style.opacity = '0.7';

            try {
                const r = await fetch(`/api/org-units?parent=${parentId}`);
                const d = await r.json();
                const children = (d.children || []).sort((a, b) => a.displayName.localeCompare(b.displayName));
                nextSel.style.opacity = '1';
                if (!children.length) { 
                    nextSel.innerHTML = '<option>ðŸ“­ No sub-units</option>'; 
                    nextSel.disabled = true; 
                    return; 
                }
                const levelNames = ['', 'Country', 'Region', 'District', 'County', 'Sub-county', 'Facility'];
                nextSel.innerHTML = `<option value="">-- Select ${levelNames[nextLevel] || 'Unit'} (${children.length}) --</option>` + children.map(u => `<option value="${u.id}" data-name="${u.displayName}">${u.displayName}</option>`).join('');
            } catch (e) { 
                nextSel.innerHTML = '<option>âŒ Error loading</option>'; 
                nextSel.style.opacity = '1';
            }
        }

        function selectFinalLevel(level) {
            const sel = document.getElementById(`level${level}`);
            if (sel.value) {
                const path = buildOrgUnitPath(level);
                selectedOrgUnit = { id: sel.value, name: sel.options[sel.selectedIndex].dataset.name || sel.options[sel.selectedIndex].text, level: level, path: path };
                document.getElementById('selectedOrg').textContent = selectedOrgUnit.name;
                
                // Reset facility population when changing org unit
                facilityPopulation = null;
            }
        }

        function buildOrgUnitPath(upToLevel) {
            const parts = [];
            for (let l = 2; l <= upToLevel; l++) {
                const sel = document.getElementById(`level${l}`);
                if (sel && sel.selectedIndex > 0) {
                    const name = sel.options[sel.selectedIndex].dataset.name || sel.options[sel.selectedIndex].text;
                    parts.push(name);
                }
            }
            return parts.join(' > ');
        }

        function togglePeriodInputs() {
            const type = document.getElementById('periodType').value;
            ['relativePeriodGroup', 'yearGroup', 'monthYearGroup', 'monthGroup', 'quarterYearGroup', 'quarterGroup', 'customStartGroup', 'customEndGroup'].forEach(id => document.getElementById(id).style.display = 'none');
            if (type === 'relative') document.getElementById('relativePeriodGroup').style.display = 'flex';
            else if (type === 'year') document.getElementById('yearGroup').style.display = 'flex';
            else if (type === 'month') { document.getElementById('monthYearGroup').style.display = 'flex'; document.getElementById('monthGroup').style.display = 'flex'; }
            else if (type === 'quarter') { document.getElementById('quarterYearGroup').style.display = 'flex'; document.getElementById('quarterGroup').style.display = 'flex'; }
            else if (type === 'custom') { document.getElementById('customStartGroup').style.display = 'flex'; document.getElementById('customEndGroup').style.display = 'flex'; }
        }

        function getSelectedPeriod() {
            const type = document.getElementById('periodType').value;
            if (type === 'relative') return document.getElementById('relativePeriod').value;
            if (type === 'month') return `${document.getElementById('monthYear').value}${document.getElementById('monthSelect').value}`;
            if (type === 'quarter') return `${document.getElementById('quarterYear').value}${document.getElementById('quarterSelect').value}`;
            if (type === 'year') { const y = document.getElementById('yearSelect').value; return `${y}01-${y}12`; }
            if (type === 'custom') return `${document.getElementById('startPeriod').value}-${document.getElementById('endPeriod').value}`;
        }

        async function loadData() {
            const period = getSelectedPeriod();
            document.getElementById('selectedPeriod').textContent = period;
            document.getElementById('errorMessage').style.display = 'none';

            // Check if this is a facility-level org unit for analytics
            if (currentSection === 'analytics' && isFacilityLevel()) {
                // Check if we have a custom population for this facility
                if (!facilityPopulation) {
                    showFacilityPopulationModal();
                    return;
                }
            }

            // Show loading overlay
            const sectionName = currentSection === 'raw' ? 'Raw Data' : 'Analytics';
            showLoading(`Loading ${sectionName}...`, `Fetching data for ${selectedOrgUnit.name}`);

            // Add loading state to button
            const loadBtn = document.querySelector('.btn-primary');
            loadBtn.classList.add('loading');
            loadBtn.disabled = true;

            try {
                updateLoadingText('Loading Analytics...', 'Calculating coverage and dropouts');
                    await loadAnalyticsData(period);
            } catch (e) {
                showError(e.message);
            }
            
            hideLoading();
            loadBtn.classList.remove('loading');
            loadBtn.disabled = false;
        }

        // ============ FACILITY POPULATION FUNCTIONS ============
        function isFacilityLevel() {
            return selectedOrgUnit.level >= FACILITY_LEVEL_THRESHOLD;
        }

        function showFacilityPopulationModal() {
            const modal = document.getElementById('facilityPopulationModal');
            document.getElementById('facilityModalName').textContent = selectedOrgUnit.name;
            document.getElementById('facilityModalPath').textContent = selectedOrgUnit.path || `Level ${selectedOrgUnit.level} Organization Unit`;
            document.getElementById('facilityPopulationInput').value = facilityPopulation || '';
            document.getElementById('btnProceedWithFacility').disabled = !facilityPopulation;
            modal.style.display = 'flex';
            
            // Focus on input
            setTimeout(() => document.getElementById('facilityPopulationInput').focus(), 100);
        }

        function hideFacilityPopulationModal() {
            document.getElementById('facilityPopulationModal').style.display = 'none';
        }

        function setFacilityPopulation(value) {
            document.getElementById('facilityPopulationInput').value = value;
            validateFacilityPopulation();
        }

        function validateFacilityPopulation() {
            const input = document.getElementById('facilityPopulationInput');
            const value = parseInt(input.value);
            const btn = document.getElementById('btnProceedWithFacility');
            btn.disabled = !value || value < 1;
            return value > 0;
        }

        function cancelFacilityPopulation() {
            hideFacilityPopulationModal();
            facilityPopulation = null;
        }

        function proceedWithFacilityAnalysis() {
            const input = document.getElementById('facilityPopulationInput');
            const value = parseInt(input.value);
            
            if (!value || value < 1) {
                toastError('Please enter a valid population number');
                return;
            }
            
            facilityPopulation = value;
            hideFacilityPopulationModal();
            
            // Show in the population info
            document.getElementById('ubosPopulation').textContent = facilityPopulation.toLocaleString() + ' (custom)';
            document.getElementById('populationInfo').style.display = 'inline';
            
            toastSuccess(`Catchment population set to ${facilityPopulation.toLocaleString()}`);
            
            // Now load the data
            loadData();
        }

        // Add input validation listener
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize RED date inputs
            initializeREDDates();
            
            const input = document.getElementById('facilityPopulationInput');
            if (input) {
                input.addEventListener('input', validateFacilityPopulation);
                input.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter' && validateFacilityPopulation()) {
                        proceedWithFacilityAnalysis();
                    }
                });
            }
        });


        async function loadAnalyticsData(period) {
            // Build the API URL with optional custom population for facilities
            let url = `/api/analytics-data?orgUnit=${selectedOrgUnit.id}&period=${period}&districtName=${encodeURIComponent(selectedDistrict)}`;
            
            // Add custom population if set (for facility-level analysis)
            if (facilityPopulation && isFacilityLevel()) {
                url += `&customPopulation=${facilityPopulation}`;
            }
            
            const r = await fetch(url);
            const data = await r.json();
            if (data.error) { showError(data.error); return; }
            processAnalyticsData(data);
        }

        function processAnalyticsData(data) {
            const indicators = data.indicators || [];
            const dropouts = data.dropouts || [];
            const pop = data.population || 0;

            // Calculate statistics
            const totalDoses = indicators.reduce((s, i) => s + i.doses, 0);
            const avgCoverage = indicators.length ? Math.round(indicators.reduce((s, i) => s + i.coverage, 0) / indicators.length) : 0;
            const greenCount = indicators.filter(i => i.color === 'green').length;
            const yellowCount = indicators.filter(i => i.color === 'yellow').length;
            const redCount = indicators.filter(i => i.color === 'red').length;
            const total = indicators.length;

            // ===== EXECUTIVE DASHBOARD =====
            const dashboard = document.getElementById('executiveDashboard');
            dashboard.style.display = 'block';
            
            // Update dashboard header
            document.getElementById('dashboardOrg').textContent = selectedOrgUnit.name;
            document.getElementById('dashboardPeriod').textContent = document.getElementById('selectedPeriod').textContent;
            document.getElementById('dashboardPop').textContent = pop.toLocaleString();
            
            // Update KPIs
            document.getElementById('kpiTotalDoses').textContent = totalDoses.toLocaleString();
            document.getElementById('kpiAvgCoverage').textContent = avgCoverage + '%';
            document.getElementById('kpiAvgCoverage').className = `kpi-value ${avgCoverage >= 95 ? 'green' : avgCoverage >= 70 ? 'yellow' : 'red'}`;
            document.getElementById('kpiOnTarget').textContent = greenCount;
            document.getElementById('kpiModerate').textContent = yellowCount;
            document.getElementById('kpiLow').textContent = redCount;
            
            // Update performance gauge
            const greenPct = total ? Math.round((greenCount / total) * 100) : 0;
            const yellowPct = total ? Math.round((yellowCount / total) * 100) : 0;
            const redPct = total ? Math.round((redCount / total) * 100) : 0;
            document.getElementById('gaugeGreen').style.width = greenPct + '%';
            document.getElementById('gaugeYellow').style.width = yellowPct + '%';
            document.getElementById('gaugeRed').style.width = redPct + '%';
            document.getElementById('gaugeTotal').textContent = `${total} indicators`;

            // ===== STORE DATA FOR EXPORTS =====
            window.coverageData = indicators;
            window.dropoutData = dropouts;

            // ===== MODERN COVERAGE TABLE =====
            document.getElementById('coverageTableBody').innerHTML = indicators.map((i, idx) => {
                const info = ANTIGEN_INFO[i.code] || { disease: 'Immunization', schedule: '-' };
                const iconClass = getVaccineIconClass(i.code);
                const shortName = getShortVaccineName(i.name, i.code);
                
                return `
                <tr data-color="${i.color}">
                    <td>
                        <div class="indicator-cell">
                            <div class="indicator-icon ${iconClass}">${getVaccineEmoji(i.code)}</div>
                            <div>
                                <div class="indicator-name" style="font-weight:700; font-size:14px;">${shortName}</div>
                                <div class="indicator-disease" style="font-weight:600;">${info.disease}</div>
                            </div>
                        </div>
                    </td>
                    <td style="font-size:15px; font-weight:700;">${i.doses.toLocaleString()}</td>
                    <td style="font-size:14px; font-weight:600;">${i.target_population.toLocaleString()}</td>
                    <td><div class="coverage-cell ${i.color}">${i.coverage}%</div></td>
                    <td style="font-weight:600;"><span class="schedule-text">${info.schedule}</span></td>
                </tr>`;
            }).join('');

            // ===== DROPOUT SUMMARY CARDS =====
            const dropoutSummary = document.getElementById('dropoutSummary');
            if (dropouts.length > 0) {
                dropoutSummary.style.display = 'grid';
                dropoutSummary.innerHTML = dropouts.slice(0, 4).map(d => `
                    <div class="dropout-card-modern ${d.dropout_rate < 10 ? 'good' : 'bad'}">
                        <div class="dropout-info">
                            <h4>${d.name}</h4>
                            <p>${d.first_doses.toLocaleString()} â†’ ${d.last_doses.toLocaleString()} doses</p>
                        </div>
                        <div class="dropout-rate ${d.dropout_rate < 10 ? 'good' : 'bad'}">${d.dropout_rate}%</div>
                    </div>
            `).join('');
            }

            // ===== DROPOUT TABLE =====
            document.getElementById('dropoutTableBody').innerHTML = dropouts.map(d => `
                <tr>
                    <td><strong>${d.name}</strong></td>
                    <td>${d.first_doses.toLocaleString()}</td>
                    <td>${d.last_doses.toLocaleString()}</td>
                    <td><span class="coverage-badge ${d.dropout_rate < 10 ? 'green' : 'red'}">${d.dropout_rate}%</span></td>
                    <td>${d.dropout_rate < 10 ? '<span style="color:#27ae60">âœ“ Acceptable</span>' : '<span style="color:#e74c3c">âš  High Dropout</span>'}</td>
                </tr>
            `).join('');

            // Charts section replaced by RED Categorization Tool
            
            // Update summary banner
            updateSummaryBanner({
                totalDoses,
                avgCoverage,
                lowCoverageCount: redCount
            });
            
            // Check alerts
            const coverageAlerts = checkCoverageAlerts(indicators);
            checkDropoutAlerts(dropouts);
            
            // Show success toast if no critical alerts
            if (!coverageAlerts.critical || coverageAlerts.critical.length === 0) {
                if (redCount > 0) {
                    toastWarning(`${redCount} indicators have coverage below 70%`, 'Attention Required');
                } else {
                    toastSuccess(`All ${indicators.length} indicators loaded. Avg coverage: ${avgCoverage}%`, 'Analytics Ready');
                }
            }
            
            // Load RED Categorization for child units
            loadREDCategorization();
        }

        // Helper functions for vaccine display
        function getVaccineIconClass(code) {
            if (code.includes('CL01')) return 'bcg';
            if (code.includes('CL04') || code.includes('CL05') || code.includes('CL06') || code.includes('CL07') || code.includes('CL08') || code.includes('CL09')) return 'polio';
            if (code.includes('CL10') || code.includes('CL11') || code.includes('CL12')) return 'dpt';
            if (code.includes('CL13') || code.includes('CL14') || code.includes('CL15')) return 'pcv';
            if (code.includes('CL16') || code.includes('CL17') || code.includes('CL18')) return 'rota';
            if (code.includes('CL19') || code.includes('CL20') || code.includes('CL21') || code.includes('CL26')) return 'malaria';
            if (code.includes('CL23') || code.includes('CL27')) return 'mr';
            return 'other';
        }

        function getVaccineEmoji(code) {
            if (code.includes('CL01')) return 'ðŸ›¡ï¸';
            if (code.includes('CL02')) return 'ðŸ”¶';
            if (code.includes('CL03')) return 'ðŸ¤°';
            if (code.includes('CL04') || code.includes('CL05') || code.includes('CL06') || code.includes('CL07') || code.includes('CL08') || code.includes('CL09')) return 'ðŸ’§';
            if (code.includes('CL10') || code.includes('CL11') || code.includes('CL12')) return 'ðŸ’‰';
            if (code.includes('CL13') || code.includes('CL14') || code.includes('CL15')) return 'ðŸ«';
            if (code.includes('CL16') || code.includes('CL17') || code.includes('CL18')) return 'ðŸ¦ ';
            if (code.includes('CL19') || code.includes('CL20') || code.includes('CL21') || code.includes('CL26')) return 'ðŸ¦Ÿ';
            if (code.includes('CL22')) return 'ðŸŒ¡ï¸';
            if (code.includes('CL23') || code.includes('CL27')) return 'ðŸ©º';
            if (code.includes('CL24') || code.includes('CL28')) return 'âœ…';
            if (code.includes('CL25')) return 'ðŸ›ï¸';
            return 'ðŸ’‰';
        }

        function getShortVaccineName(fullName, code) {
            // Extract a cleaner short name
            const names = {
                '105-CL01': 'BCG Vaccine',
                '105-CL02': 'Hepatitis B Birth Dose',
                '105-CL03': 'Protected at Birth (PAB)',
                '105-CL04': 'OPV0 (Birth Polio)',
                '105-CL05': 'OPV1 (Polio Dose 1)',
                '105-CL06': 'OPV2 (Polio Dose 2)',
                '105-CL07': 'OPV3 (Polio Dose 3)',
                '105-CL08': 'IPV1 (Injectable Polio 1)',
                '105-CL09': 'IPV2 (Injectable Polio 2)',
                '105-CL10': 'Penta 1 (DPT-HepB-Hib)',
                '105-CL11': 'Penta 2 (DPT-HepB-Hib)',
                '105-CL12': 'Penta 3 (DPT-HepB-Hib)',
                '105-CL13': 'PCV 1 (Pneumococcal)',
                '105-CL14': 'PCV 2 (Pneumococcal)',
                '105-CL15': 'PCV 3 (Pneumococcal)',
                '105-CL16': 'Rotavirus Dose 1',
                '105-CL17': 'Rotavirus Dose 2',
                '105-CL18': 'Rotavirus Dose 3',
                '105-CL19': 'Malaria Vaccine 1',
                '105-CL20': 'Malaria Vaccine 2',
                '105-CL21': 'Malaria Vaccine 3',
                '105-CL22': 'Yellow Fever',
                '105-CL23': 'Measles-Rubella 1',
                '105-CL24': 'Fully Immunized (1 yr)',
                '105-CL25': 'LLINs Distributed',
                '105-CL26': 'Malaria Vaccine 4',
                '105-CL27': 'Measles-Rubella 2',
                '105-CL28': 'Fully Immunized (2 yr)'
            };
            return names[code] || fullName.replace('105-2.1 Child Health - Immunisation ', '').substring(0, 35);
        }

        function updateSummaryCards(data, meta) {
            const total = Object.values(data).reduce((s, arr) => s + arr.reduce((ss, i) => ss + i.value, 0), 0);
            const count = Object.keys(data).length;
            const container = document.getElementById('summaryCards');
            container.innerHTML = `
                <div class="stat-card fade-in"><h4>Total Doses</h4><div class="value">${total.toLocaleString()}</div></div>
                <div class="stat-card fade-in" style="animation-delay: 0.1s"><h4>Indicators</h4><div class="value">${count}</div></div>
            `;
        }

        function updateRawCharts(data, meta) {
            const periods = [...new Set(Object.values(data).flatMap(d => d.map(i => i.period)))].sort();
            const ids = Object.keys(data).slice(0, 10);

            if (charts.trend) charts.trend.destroy();
            charts.trend = new Chart(document.getElementById('trendChart'), {
                type: 'line', data: {
                    labels: periods.map(formatPeriod),
                    datasets: ids.map((id, i) => ({ label: (meta.items?.[id]?.name || id).substring(0, 25), data: periods.map(p => data[id]?.find(d => d.period === p)?.value || 0), borderColor: COLORS[i % COLORS.length], tension: 0.4, fill: false }))
                }, options: { responsive: true, plugins: { datalabels: { display: false }, legend: { position: 'bottom', labels: { boxWidth: 12, font: { size: 10 } } } } }
            });

            if (charts.bar) charts.bar.destroy();
            const lastP = periods[periods.length - 1];
            charts.bar = new Chart(document.getElementById('barChart'), {
                type: 'bar', data: {
                    labels: ids.map(id => (meta.items?.[id]?.name || id).substring(0, 20)),
                    datasets: [{ data: ids.map(id => data[id]?.find(d => d.period === lastP)?.value || 0), backgroundColor: ids.map((_, i) => COLORS[i % COLORS.length]) }]
                }, options: { responsive: true, plugins: { datalabels: { display: false }, legend: { display: false } } }
            });
        }

        function updateRawTable(data, meta) {
            const periods = [...new Set(Object.values(data).flatMap(d => d.map(i => i.period)))].sort();
            const ids = Object.keys(data);
            document.getElementById('rawTableHeader').innerHTML = '<th>Period</th>' + ids.map(id => `<th>${(meta.items?.[id]?.name || id).substring(0, 25)}</th>`).join('');
            document.getElementById('rawTableBody').innerHTML = periods.map(p => `<tr><td>${formatPeriod(p)}</td>${ids.map(id => `<td>${(data[id]?.find(d => d.period === p)?.value || 0).toLocaleString()}</td>`).join('')}</tr>`).join('');
        }

        // Store trend data globally for forecast options
        let currentTrendData = null;

        async function detectAllOutliers() {
            // Show loading state
            showLoading('Analyzing All Indicators...', 'Detecting outliers across all immunization data');
            
            const period = getSelectedPeriod();
            
            // Get all indicators from the trend dropdown
            const trendSelect = document.getElementById('trendIndicator');
            const indicators = Array.from(trendSelect.options)
                .filter(opt => opt.value)
                .map(opt => ({ id: opt.value, name: opt.text }));
            
            if (indicators.length === 0) {
                hideLoading();
                toastError('No indicators available for analysis');
                return;
            }
            
            let allOutliers = [];
            let processedCount = 0;
            
            // Fetch outliers for each indicator
            for (const indicator of indicators) {
                try {
                    const r = await fetch(`/api/trend-analysis?orgUnit=${selectedOrgUnit.id}&period=${period}&indicator=${indicator.id}`);
                    const data = await r.json();
                    
                    if (data.outliers && data.outliers.length > 0) {
                        const ts = data.data || [];
                        data.outliers.forEach(o => {
                            allOutliers.push({
                                indicator: indicator.name,
                                indicatorId: indicator.id,
                                period: ts[o.index] ? ts[o.index].period : `Period ${o.index + 1}`,
                                value: o.value,
                                zscore: o.zscore,
                                index: o.index
                            });
                        });
                    }
                    
                    processedCount++;
                    updateLoadingText('Analyzing All Indicators...', `Processed ${processedCount}/${indicators.length} indicators`);
                } catch (e) {
                    console.error(`Error fetching data for ${indicator.name}:`, e);
                }
            }
            
            hideLoading();
            
            // Store for download
            window.lastOutliers = allOutliers;
            
            // Display results
            const outliersSection = document.getElementById('outliersSection');
            outliersSection.style.display = 'block';
            
            document.getElementById('outliersTitle').textContent = `âš ï¸ ${allOutliers.length} Outliers Detected Across All Indicators`;
            
            if (allOutliers.length > 0) {
                // Sort by indicator name, then by period
                allOutliers.sort((a, b) => {
                    if (a.indicator !== b.indicator) return a.indicator.localeCompare(b.indicator);
                    return a.period.localeCompare(b.period);
                });
                
                let tableHtml = `
                    <table class="modern-table" style="margin-top:10px;">
                        <thead>
                            <tr>
                                <th style="width:30%">Indicator</th>
                                <th>Period</th>
                                <th>Value</th>
                                <th>Z-Score</th>
                                <th>Type</th>
                                <th>Severity</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                allOutliers.forEach(o => {
                    const isHigh = o.zscore > 0;
                    const severity = Math.abs(o.zscore) > 3 ? 'High' : 'Moderate';
                    const bg = isHigh ? '#fff3cd' : '#f8d7da';
                    
                    tableHtml += `
                        <tr style="background:${bg}">
                            <td><strong>${o.indicator}</strong></td>
                            <td>${formatPeriod(o.period)}</td>
                            <td>${o.value.toLocaleString()}</td>
                            <td>${o.zscore.toFixed(2)}Ïƒ</td>
                            <td>${isHigh ? 'ðŸ“ˆ Spike' : 'ðŸ“‰ Drop'}</td>
                            <td><span class="badge ${Math.abs(o.zscore) > 3 ? 'red' : 'yellow'}">${severity}</span></td>
                        </tr>
                    `;
                });
                
                tableHtml += '</tbody></table>';
                document.getElementById('outliersTable').innerHTML = tableHtml;
                
                toastSuccess(`Found ${allOutliers.length} outliers across ${indicators.length} indicators`, 'Analysis Complete');
            } else {
                document.getElementById('outliersTable').innerHTML = '<div style="padding:20px; text-align:center; color:#27ae60; font-weight:600;">âœ… No significant outliers detected across all indicators in the selected period.</div>';
                toastSuccess('No outliers detected', 'Analysis Complete');
            }
        }

        // ===== RED CATEGORIZATION TOOL =====
        // Load RED with custom date range
        async function loadREDWithCustomDates() {
            const startDate = document.getElementById('redStartDate').value;
            const endDate = document.getElementById('redEndDate').value;
            
            if (!startDate || !endDate) {
                toastWarning('Please select both start and end dates', 'Date Required');
                return;
            }
            
            if (startDate > endDate) {
                toastWarning('Start date must be before end date', 'Invalid Range');
                return;
            }
            
            await loadREDCategorization(startDate, endDate);
        }
        
        // Reset to default dates (last 8 quarters)
        function resetREDDates() {
            document.getElementById('redStartDate').value = '';
            document.getElementById('redEndDate').value = '';
            loadREDCategorization();
        }
        
        // Initialize date inputs with default values
        function initializeREDDates() {
            // Set default to Oct 2023 - Sep 2025 (8 quarters)
            document.getElementById('redStartDate').value = '2023-10';
            document.getElementById('redEndDate').value = '2025-09';
        }

        async function loadREDCategorization(startDate = null, endDate = null) {
            if (!selectedOrgUnit || !selectedOrgUnit.id) return;
            
            try {
                document.getElementById('redCategorizationBody').innerHTML = `
                    <tr>
                        <td colspan="21" style="text-align:center; padding:40px;">
                            <div class="loading-spinner" style="margin:0 auto 15px;"></div>
                            Loading quarterly progress data for ${selectedOrgUnit.name}...
                        </td>
                    </tr>
                `;
                
                // Build URL with custom population if available
                let url = `/api/red-categorization?orgUnit=${selectedOrgUnit.id}&districtName=${encodeURIComponent(selectedOrgUnit.name)}`;
                if (facilityPopulation) {
                    url += `&customPopulation=${facilityPopulation}`;
                }
                
                // Add custom date range if provided
                if (startDate && endDate) {
                    url += `&startDate=${startDate}&endDate=${endDate}`;
                }
                
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.error) {
                    document.getElementById('redCategorizationBody').innerHTML = `
                        <tr>
                            <td colspan="21" style="text-align:center; padding:40px; color:var(--text-muted);">
                                ${data.error}
                            </td>
                        </tr>
                    `;
                    document.getElementById('redUnitName').textContent = selectedOrgUnit.name;
                    document.getElementById('cat1Count').textContent = '0';
                    document.getElementById('cat2Count').textContent = '0';
                    document.getElementById('cat3Count').textContent = '0';
                    document.getElementById('cat4Count').textContent = '0';
                    document.getElementById('totalUnitsCount').textContent = '0';
                    return;
                }
                
                // Update unit name in header
                document.getElementById('redUnitName').textContent = data.unit_name;
                
                // Update summary counts
                document.getElementById('cat1Count').textContent = data.summary.cat1;
                document.getElementById('cat2Count').textContent = data.summary.cat2;
                document.getElementById('cat3Count').textContent = data.summary.cat3;
                document.getElementById('cat4Count').textContent = data.summary.cat4;
                document.getElementById('totalUnitsCount').textContent = data.total_quarters;
                
                // Store data for exports
                window.redCategorizationData = data.quarters;
                window.redUnitName = data.unit_name;
                window.redAnnualPopulation = data.annual_population;
                window.redQuarterlyPopulation = data.quarterly_population;
                window.redQuarterlyTarget = data.quarterly_target;
                
                // Populate table with quarterly data
                document.getElementById('redCategorizationBody').innerHTML = data.quarters.map((q, idx) => {
                    // Coverage color classes
                    const covClass = (val) => val >= 90 ? 'red-coverage-high' : val >= 70 ? 'red-coverage-med' : 'red-coverage-low';
                    // Category class
                    const catClass = q.category === 'Cat. 1' ? 'red-cat-1' : 
                                     q.category === 'Cat. 2' ? 'red-cat-2' :
                                     q.category === 'Cat. 3' ? 'red-cat-3' : 'red-cat-4';
                    // Access/Utilization class
                    const accessClass = q.access === 'Good' ? 'red-access-good' : 'red-access-poor';
                    const utilClass = q.utilization === 'Good' ? 'red-access-good' : 'red-access-poor';
                    // Gap highlight
                    const gapClass = (val) => val > 100 ? 'red-gap-critical' : '';
                    
                    // Trend indicators (compare with previous quarter)
                    let trendIcon = '';
                    if (idx > 0) {
                        const prevQ = data.quarters[idx - 1];
                        if (q.dpt1_cov > prevQ.dpt1_cov) trendIcon = '<span style="color:#27ae60;">â†‘</span>';
                        else if (q.dpt1_cov < prevQ.dpt1_cov) trendIcon = '<span style="color:#e74c3c;">â†“</span>';
                        else trendIcon = '<span style="color:#95a5a6;">â†’</span>';
                    }
                    
                    return `
                        <tr>
                            <td style="text-align:left; font-weight:600;">
                                <div>${q.name} ${trendIcon}</div>
                                <div style="font-size:10px; color:#666; font-weight:400;">${q.display || ''}</div>
                            </td>
                            <td>${q.population.toLocaleString()}</td>
                            <td>${q.target_bcg.toLocaleString()}</td>
                            <td>${q.target_pop.toLocaleString()}</td>
                            <td>${q.bcg.toLocaleString()}</td>
                            <td>${q.dpt1.toLocaleString()}</td>
                            <td>${q.dpt3.toLocaleString()}</td>
                            <td>${q.mr.toLocaleString()}</td>
                            <td class="${covClass(q.bcg_cov)}">${q.bcg_cov}%</td>
                            <td class="${covClass(q.dpt1_cov)}">${q.dpt1_cov}%</td>
                            <td class="${covClass(q.dpt3_cov)}">${q.dpt3_cov}%</td>
                            <td class="${covClass(q.mr_cov)}">${q.mr_cov}%</td>
                            <td class="${gapClass(q.unimm_dpt3)}">${q.unimm_dpt3.toLocaleString()}</td>
                            <td class="${gapClass(q.unimm_mr)}">${q.unimm_mr.toLocaleString()}</td>
                            <td class="${gapClass(q.zero_dose)}">${q.zero_dose.toLocaleString()}</td>
                            <td class="${gapClass(q.under_imm)}">${q.under_imm.toLocaleString()}</td>
                            <td style="font-weight:600; ${q.dpt1_3_dropout > 10 ? 'color:#c0392b;' : 'color:#27ae60;'}">${q.dpt1_3_dropout}%</td>
                            <td style="font-weight:600; ${q.dpt1_mr_dropout > 10 ? 'color:#c0392b;' : 'color:#27ae60;'}">${q.dpt1_mr_dropout}%</td>
                            <td class="${accessClass}">${q.access}</td>
                            <td class="${utilClass}">${q.utilization}</td>
                            <td class="${catClass}">${q.category}</td>
                        </tr>
                    `;
                }).join('');
                
                // Add summary row (totals/averages based on selected period)
                if (data.quarters.length > 0) {
                    const totals = data.quarters.reduce((acc, q) => ({
                        bcg: acc.bcg + q.bcg,
                        dpt1: acc.dpt1 + q.dpt1,
                        dpt3: acc.dpt3 + q.dpt3,
                        mr: acc.mr + q.mr,
                        unimm_dpt3: acc.unimm_dpt3 + q.unimm_dpt3,
                        unimm_mr: acc.unimm_mr + q.unimm_mr,
                        zero_dose: acc.zero_dose + q.zero_dose,
                        under_imm: acc.under_imm + q.under_imm
                    }), { bcg: 0, dpt1: 0, dpt3: 0, mr: 0, unimm_dpt3: 0, unimm_mr: 0, zero_dose: 0, under_imm: 0 });
                    
                    // Calculate period-based targets
                    const annualPop = data.annual_population || 0;
                    const numQuarters = data.quarters.length;
                    const numMonths = numQuarters * 3;
                    const numYears = numMonths / 12;
                    
                    // Dynamic period label
                    let periodLabel;
                    if (numMonths <= 3) periodLabel = `${numMonths}-MONTH TOTAL`;
                    else if (numMonths <= 6) periodLabel = `${numMonths}-MONTH TOTAL`;
                    else if (numMonths === 12) periodLabel = '1-YEAR TOTAL';
                    else if (numMonths === 24) periodLabel = '2-YEAR TOTAL';
                    else periodLabel = `${numMonths}-MONTH TOTAL`;
                    
                    const total_quarterly_pop = data.quarterly_population * numQuarters;
                    const total_target_bcg = Math.round(annualPop * 0.0485 * numYears);
                    const total_target = Math.round(annualPop * 0.043 * numYears);
                    
                    // Calculate overall coverage percentages
                    const bcg_cov_total = total_target_bcg > 0 ? Math.round((totals.bcg / total_target_bcg) * 100) : 0;
                    const dpt1_cov_total = total_target > 0 ? Math.round((totals.dpt1 / total_target) * 100) : 0;
                    const dpt3_cov_total = total_target > 0 ? Math.round((totals.dpt3 / total_target) * 100) : 0;
                    const mr_cov_total = total_target > 0 ? Math.round((totals.mr / total_target) * 100) : 0;
                    
                    // Calculate overall dropout rates
                    const dpt1_3_dropout_total = totals.dpt1 > 0 ? Math.round(((totals.dpt1 - totals.dpt3) / totals.dpt1) * 100) : 0;
                    const dpt1_mr_dropout_total = totals.dpt1 > 0 ? Math.round(((totals.dpt1 - totals.mr) / totals.dpt1) * 100) : 0;
                    
                    // Determine overall ACCESS and UTILIZATION
                    const overall_access = dpt1_cov_total >= 90 ? 'Good' : 'Poor';
                    const overall_util = dpt1_3_dropout_total <= 10 ? 'Good' : 'Poor';
                    
                    // Determine overall CATEGORY
                    let overall_category, category_class;
                    if (overall_access === 'Good' && overall_util === 'Good') {
                        overall_category = 'Cat. 1';
                        category_class = 'red-cat-1';
                    } else if (overall_access === 'Good' && overall_util === 'Poor') {
                        overall_category = 'Cat. 2';
                        category_class = 'red-cat-2';
                    } else if (overall_access === 'Poor' && overall_util === 'Good') {
                        overall_category = 'Cat. 3';
                        category_class = 'red-cat-3';
                    } else {
                        overall_category = 'Cat. 4';
                        category_class = 'red-cat-4';
                    }
                    
                    // Access/Utilization classes
                    const access_class = overall_access === 'Good' ? 'red-access-good' : 'red-access-poor';
                    const util_class = overall_util === 'Good' ? 'red-access-good' : 'red-access-poor';
                    
                    document.getElementById('redCategorizationBody').innerHTML += `
                        <tr style="background:#2c3e50; font-weight:700;">
                            <td style="text-align:left; color:white;">
                                <div>${periodLabel}</div>
                                <div style="font-size:10px; font-weight:400; opacity:0.8;">${numQuarters} quarters analyzed</div>
                            </td>
                            <td style="color:white;">${total_quarterly_pop.toLocaleString()}</td>
                            <td style="color:white;">${total_target_bcg.toLocaleString()}</td>
                            <td style="color:white;">${total_target.toLocaleString()}</td>
                            <td style="color:white;">${totals.bcg.toLocaleString()}</td>
                            <td style="color:white;">${totals.dpt1.toLocaleString()}</td>
                            <td style="color:white;">${totals.dpt3.toLocaleString()}</td>
                            <td style="color:white;">${totals.mr.toLocaleString()}</td>
                            <td style="color:white;">${bcg_cov_total}%</td>
                            <td style="color:white;">${dpt1_cov_total}%</td>
                            <td style="color:white;">${dpt3_cov_total}%</td>
                            <td style="color:white;">${mr_cov_total}%</td>
                            <td style="color:white;">${totals.unimm_dpt3.toLocaleString()}</td>
                            <td style="color:white;">${totals.unimm_mr.toLocaleString()}</td>
                            <td style="color:white;">${totals.zero_dose.toLocaleString()}</td>
                            <td style="color:white;">${totals.under_imm.toLocaleString()}</td>
                            <td style="color:white;">${dpt1_3_dropout_total}%</td>
                            <td style="color:white;">${dpt1_mr_dropout_total}%</td>
                            <td class="${access_class}" style="font-weight:700;">${overall_access}</td>
                            <td class="${util_class}" style="font-weight:700;">${overall_util}</td>
                            <td class="${category_class}" style="font-weight:700;">${overall_category}</td>
                        </tr>
                    `;
                    
                    // Show annual population reference
                    console.log(`RED Tool: Annual Pop=${annualPop}, Q-Pop=${data.quarterly_population}, BCG Target=${total_target_bcg/8}, DPT/MR Target=${total_target/8}`);
                }
                
            } catch (error) {
                console.error('Error loading RED categorization:', error);
                document.getElementById('redCategorizationBody').innerHTML = `
                    <tr>
                        <td colspan="21" style="text-align:center; padding:40px; color:#c0392b;">
                            Error loading RED categorization data: ${error.message}
                        </td>
                    </tr>
                `;
            }
        }
        
        // RED Categorization Export Functions
        function downloadREDExcel() {
            if (!window.redCategorizationData || window.redCategorizationData.length === 0) {
                toastWarning('No RED data to export', 'Export Failed');
                return;
            }
            
            const data = window.redCategorizationData;
            const unitName = window.redUnitName || selectedOrgUnit.name;
            const wb = XLSX.utils.book_new();
            
            // === STYLES (matching visual appearance exactly) ===
            const headerStyleBlue = {
                font: { bold: true, color: { rgb: 'FFFFFF' }, sz: 9 },
                fill: { fgColor: { rgb: '3498DB' } },
                border: EXCEL_BORDER_THIN,
                alignment: { horizontal: 'center', vertical: 'center', wrapText: true }
            };
            const headerStylePurple = {
                font: { bold: true, color: { rgb: 'FFFFFF' }, sz: 9 },
                fill: { fgColor: { rgb: '9B59B6' } },
                border: EXCEL_BORDER_THIN,
                alignment: { horizontal: 'center', vertical: 'center', wrapText: true }
            };
            const headerStyleGreen = {
                font: { bold: true, color: { rgb: 'FFFFFF' }, sz: 9 },
                fill: { fgColor: { rgb: '27AE60' } },
                border: EXCEL_BORDER_THIN,
                alignment: { horizontal: 'center', vertical: 'center', wrapText: true }
            };
            const headerStyleOrange = {
                font: { bold: true, color: { rgb: 'FFFFFF' }, sz: 9 },
                fill: { fgColor: { rgb: 'E67E22' } },
                border: EXCEL_BORDER_THIN,
                alignment: { horizontal: 'center', vertical: 'center', wrapText: true }
            };
            const headerStyleRed = {
                font: { bold: true, color: { rgb: 'FFFFFF' }, sz: 9 },
                fill: { fgColor: { rgb: 'E74C3C' } },
                border: EXCEL_BORDER_THIN,
                alignment: { horizontal: 'center', vertical: 'center', wrapText: true }
            };
            const headerStyleDark = {
                font: { bold: true, color: { rgb: 'FFFFFF' }, sz: 9 },
                fill: { fgColor: { rgb: '2C3E50' } },
                border: EXCEL_BORDER_THIN,
                alignment: { horizontal: 'center', vertical: 'center', wrapText: true }
            };
            
            const cat1Fill = { fgColor: { rgb: '92D050' } };  // Green
            const cat2Fill = { fgColor: { rgb: 'FFFF00' } };  // Yellow
            const cat3Fill = { fgColor: { rgb: 'FFC000' } };  // Orange
            const cat4Fill = { fgColor: { rgb: 'FF0000' } };  // Red
            
            const goodFill = { fgColor: { rgb: 'C6EFCE' } };  // Light green
            const poorFill = { fgColor: { rgb: 'FFC7CE' } };  // Light red/pink
            
            const covHighFill = { fgColor: { rgb: 'C6EFCE' } };  // Green for â‰¥90%
            const covMedFill = { fgColor: { rgb: 'FFEB9C' } };   // Yellow for 70-89%
            const covLowFill = { fgColor: { rgb: 'FFC7CE' } };   // Red for <70%
            
            // === HEADERS (two rows) ===
            const headerRow1 = ['Qtr', 'Targets', '', '', 'Doses', '', '', '', 'Coverage', '', '', '', 'Gaps', '', '', '', 'Dropout', '', 'Class', '', ''];
            const headerRow2 = ['', 'Pop', 'BCG', 'DPT', 'BCG', 'D1', 'D3', 'MR', 'BCG', 'D1', 'D3', 'MR', 'D3', 'MR', 'Ã˜', 'U', '1â†’3', '1â†’M', 'Acc', 'Utl', 'Cat'];
            
            // Data rows
            const rows = data.map(u => [
                `${u.name}\n${u.display || ''}`, u.population, u.target_bcg, u.target_pop,
                u.bcg, u.dpt1, u.dpt3, u.mr,
                u.bcg_cov, u.dpt1_cov, u.dpt3_cov, u.mr_cov,
                u.unimm_dpt3, u.unimm_mr, u.zero_dose, u.under_imm,
                u.dpt1_3_dropout, u.dpt1_mr_dropout,
                u.access, u.utilization, u.category
            ]);
            
            const ws_data = [headerRow1, headerRow2, ...rows];
            const ws = XLSX.utils.aoa_to_sheet(ws_data);
            
            // === MERGE HEADER CELLS ===
            ws['!merges'] = [
                { s: { r: 0, c: 0 }, e: { r: 1, c: 0 } },  // Qtr
                { s: { r: 0, c: 1 }, e: { r: 0, c: 3 } },  // Targets
                { s: { r: 0, c: 4 }, e: { r: 0, c: 7 } },  // Doses
                { s: { r: 0, c: 8 }, e: { r: 0, c: 11 } }, // Coverage
                { s: { r: 0, c: 12 }, e: { r: 0, c: 15 } },// Gaps
                { s: { r: 0, c: 16 }, e: { r: 0, c: 17 } },// Dropout
                { s: { r: 0, c: 18 }, e: { r: 0, c: 20 } } // Class
            ];
            
            // === APPLY HEADER STYLES ROW 1 ===
            ws['A1'].s = headerStyleDark;
            for (let c = 1; c <= 3; c++) ws[XLSX.utils.encode_cell({ r: 0, c: c })].s = headerStyleBlue;
            for (let c = 4; c <= 7; c++) ws[XLSX.utils.encode_cell({ r: 0, c: c })].s = headerStylePurple;
            for (let c = 8; c <= 11; c++) ws[XLSX.utils.encode_cell({ r: 0, c: c })].s = headerStyleGreen;
            for (let c = 12; c <= 15; c++) ws[XLSX.utils.encode_cell({ r: 0, c: c })].s = headerStyleOrange;
            for (let c = 16; c <= 17; c++) ws[XLSX.utils.encode_cell({ r: 0, c: c })].s = headerStyleRed;
            for (let c = 18; c <= 20; c++) ws[XLSX.utils.encode_cell({ r: 0, c: c })].s = headerStyleDark;
            
            // === APPLY HEADER STYLES ROW 2 ===
            ws['A2'].s = headerStyleDark;
            for (let c = 1; c <= 3; c++) ws[XLSX.utils.encode_cell({ r: 1, c: c })].s = headerStyleBlue;
            for (let c = 4; c <= 7; c++) ws[XLSX.utils.encode_cell({ r: 1, c: c })].s = headerStylePurple;
            for (let c = 8; c <= 11; c++) ws[XLSX.utils.encode_cell({ r: 1, c: c })].s = headerStyleGreen;
            for (let c = 12; c <= 15; c++) ws[XLSX.utils.encode_cell({ r: 1, c: c })].s = headerStyleOrange;
            for (let c = 16; c <= 17; c++) ws[XLSX.utils.encode_cell({ r: 1, c: c })].s = headerStyleRed;
            for (let c = 18; c <= 20; c++) ws[XLSX.utils.encode_cell({ r: 1, c: c })].s = headerStyleDark;
            
            // === COLUMN WIDTHS ===
            ws['!cols'] = [
                { wch: 14 },  // Qtr
                { wch: 8 }, { wch: 7 }, { wch: 7 },  // Targets
                { wch: 7 }, { wch: 7 }, { wch: 7 }, { wch: 7 },  // Doses
                { wch: 6 }, { wch: 6 }, { wch: 6 }, { wch: 6 },  // Coverage
                { wch: 7 }, { wch: 7 }, { wch: 6 }, { wch: 6 },  // Gaps
                { wch: 6 }, { wch: 6 },  // Dropout
                { wch: 6 }, { wch: 6 }, { wch: 7 }   // Class
            ];
            
            // === DATA ROW STYLES WITH COLOR CODING ===
            for (let r = 2; r < 2 + rows.length; r++) {
                const rowData = data[r - 2];
                
                // Quarter column
                const qtrCell = ws[XLSX.utils.encode_cell({ r: r, c: 0 })];
                if (qtrCell) {
                    qtrCell.s = { border: EXCEL_BORDER_THIN, alignment: { wrapText: true, vertical: 'center' } };
                }
                
                // Targets columns (1-3)
                for (let c = 1; c <= 3; c++) {
                    const cell = ws[XLSX.utils.encode_cell({ r: r, c: c })];
                    if (cell) cell.s = { border: EXCEL_BORDER_THIN, alignment: { horizontal: 'center' } };
                }
                
                // Doses columns (4-7)
                for (let c = 4; c <= 7; c++) {
                    const cell = ws[XLSX.utils.encode_cell({ r: r, c: c })];
                    if (cell) cell.s = { border: EXCEL_BORDER_THIN, alignment: { horizontal: 'center' } };
                }
                
                // Coverage columns (8-11) with color coding
                for (let c = 8; c <= 11; c++) {
                    const cell = ws[XLSX.utils.encode_cell({ r: r, c: c })];
                    if (cell) {
                        const val = parseFloat(cell.v) || 0;
                        cell.s = { 
                            border: EXCEL_BORDER_THIN, 
                            alignment: { horizontal: 'center' },
                            fill: val >= 90 ? covHighFill : val >= 70 ? covMedFill : covLowFill
                        };
                    }
                }
                
                // Gaps columns (12-15)
                for (let c = 12; c <= 15; c++) {
                    const cell = ws[XLSX.utils.encode_cell({ r: r, c: c })];
                    if (cell) cell.s = { border: EXCEL_BORDER_THIN, alignment: { horizontal: 'center' } };
                }
                
                // Dropout columns (16-17)
                for (let c = 16; c <= 17; c++) {
                    const cell = ws[XLSX.utils.encode_cell({ r: r, c: c })];
                    if (cell) cell.s = { border: EXCEL_BORDER_THIN, alignment: { horizontal: 'center' } };
                }
                
                // Access column (18)
                const accessCell = ws[XLSX.utils.encode_cell({ r: r, c: 18 })];
                if (accessCell) {
                    accessCell.s = {
                        border: EXCEL_BORDER_THIN,
                        alignment: { horizontal: 'center' },
                        fill: rowData.access === 'Good' ? goodFill : poorFill,
                        font: { bold: true }
                    };
                }
                
                // Utilization column (19)
                const utilCell = ws[XLSX.utils.encode_cell({ r: r, c: 19 })];
                if (utilCell) {
                    utilCell.s = {
                        border: EXCEL_BORDER_THIN,
                        alignment: { horizontal: 'center' },
                        fill: rowData.utilization === 'Good' ? goodFill : poorFill,
                        font: { bold: true }
                    };
                }
                
                // Category column (20)
                const catCell = ws[XLSX.utils.encode_cell({ r: r, c: 20 })];
                if (catCell) {
                    let catStyle = { 
                        border: EXCEL_BORDER_THIN, 
                        alignment: { horizontal: 'center' },
                        font: { bold: true }
                    };
                    
                    if (rowData.category === 'Cat. 1') {
                        catStyle.fill = cat1Fill;
                    } else if (rowData.category === 'Cat. 2') {
                        catStyle.fill = cat2Fill;
                    } else if (rowData.category === 'Cat. 3') {
                        catStyle.fill = cat3Fill;
                    } else if (rowData.category === 'Cat. 4') {
                        catStyle.fill = cat4Fill;
                        catStyle.font = { bold: true, color: { rgb: 'FFFFFF' } };
                    }
                    
                    catCell.s = catStyle;
                }
            }
            
            // Set row heights
            ws['!rows'] = [{ hpt: 20 }, { hpt: 18 }, ...Array(rows.length).fill({ hpt: 28 })];
            
            XLSX.utils.book_append_sheet(wb, ws, 'RED Progress');
            XLSX.writeFile(wb, `RED_Progress_${unitName.replace(/[^a-zA-Z0-9]/g, '_')}_${new Date().toISOString().split('T')[0]}.xlsx`);
            toastSuccess('RED Excel downloaded with color coding!', 'Export Complete');
        }
        
        function downloadREDCSV() {
            if (!window.redCategorizationData || window.redCategorizationData.length === 0) {
                toastWarning('No RED data to export', 'Export Failed');
                return;
            }
            
            const unitName = window.redUnitName || selectedOrgUnit.name;
            const headers = ['Quarter', 'Q-Population', 'BCG Target', 'DPT/MR Target', 'BCG', 'DPT1', 'DPT3', 'MR',
                           'BCG Cov%', 'DPT1 Cov%', 'DPT3 Cov%', 'MR Cov%', 
                           'Unimm DPT3', 'Unimm MR', 'Zero Dose', 'Under-Imm',
                           'DPT1-3 Dropout%', 'DPT1-MR Dropout%', 'Access', 'Utilization', 'Category'];
            
            const rows = window.redCategorizationData.map(q => [
                `${q.name} (${q.display || ''})`, q.population, q.target_bcg, q.target_pop, q.bcg, q.dpt1, q.dpt3, q.mr,
                q.bcg_cov, q.dpt1_cov, q.dpt3_cov, q.mr_cov,
                q.unimm_dpt3, q.unimm_mr, q.zero_dose, q.under_imm,
                q.dpt1_3_dropout, q.dpt1_mr_dropout, q.access, q.utilization, q.category
            ].join(','));
            
            const csv = [`Unit: ${unitName}`, headers.join(','), ...rows].join('\n');
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `RED_Progress_${unitName}_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            URL.revokeObjectURL(url);
            toastSuccess('RED CSV downloaded', 'Export Complete');
        }
        
        async function downloadREDAsPDF() {
            if (!window.redCategorizationData || window.redCategorizationData.length === 0) {
                toastWarning('No RED data to export', 'Export Failed');
                return;
            }
            
            try {
                showToast('Generating PDF with color-coded table...', 'info');
                
                // Capture the entire RED categorization card as an image
                const element = document.getElementById('redCategorizationCard');
                const canvas = await html2canvas(element, {
                    backgroundColor: '#ffffff',
                    scale: 2,
                    useCORS: true,
                    logging: false
                });
                
                const imgData = canvas.toDataURL('image/png');
                const imgWidth = canvas.width;
                const imgHeight = canvas.height;
                
                // Calculate PDF dimensions to fit the image
                const { jsPDF } = window.jspdf;
                const pdfWidth = 420; // A3 landscape width in mm
                const pdfHeight = 297; // A3 landscape height in mm
                
                // Calculate scale to fit width
                const scale = (pdfWidth - 20) / imgWidth * 2; // 10mm margins
                const scaledHeight = imgHeight * scale / 2;
                
                // Create PDF with appropriate size
                const doc = new jsPDF({ 
                    orientation: 'landscape', 
                    format: scaledHeight > pdfHeight - 40 ? [pdfWidth, scaledHeight + 40] : 'a3'
                });
                
                const unitName = window.redUnitName || selectedOrgUnit.name;
                
                // Header
                doc.setFillColor(192, 57, 43);
                doc.rect(0, 0, doc.internal.pageSize.getWidth(), 20, 'F');
                doc.setTextColor(255);
                doc.setFontSize(14);
                doc.setFont('helvetica', 'bold');
                doc.text('RED CATEGORISATION TOOL - Progress Monitoring', 10, 13);
                doc.setFontSize(9);
                doc.text(`${unitName} | Generated: ${new Date().toLocaleDateString()}`, doc.internal.pageSize.getWidth() - 10, 13, { align: 'right' });
                
                // Add the captured image
                doc.addImage(imgData, 'PNG', 10, 25, (pdfWidth - 20), scaledHeight);
                
                // Footer
                const pageHeight = doc.internal.pageSize.getHeight();
                doc.setFontSize(8);
                doc.setTextColor(100);
                doc.text('EPI Immunization Analysis Dashboard', 10, pageHeight - 5);
                doc.text(`Page 1 of 1`, doc.internal.pageSize.getWidth() - 10, pageHeight - 5, { align: 'right' });
                
                doc.save(`RED_Progress_${unitName.replace(/[^a-zA-Z0-9]/g, '_')}_${new Date().toISOString().split('T')[0]}.pdf`);
                toastSuccess('PDF downloaded with full color coding!', 'Export Complete');
            } catch (error) {
                console.error('PDF export error:', error);
                toastError('Failed to generate PDF: ' + error.message);
            }
        }
        
        // Keep original text-based PDF for fallback
        async function downloadREDAsPDF_text() {
            if (!window.redCategorizationData || window.redCategorizationData.length === 0) {
                toastWarning('No RED data to export', 'Export Failed');
                return;
            }
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({ orientation: 'landscape', format: 'a3' });
            const unitName = window.redUnitName || selectedOrgUnit.name;
            
            // Title
            doc.setFillColor(192, 57, 43);
            doc.rect(0, 0, 420, 25, 'F');
            doc.setTextColor(255);
            doc.setFontSize(16);
            doc.setFont('helvetica', 'bold');
            doc.text('RED CATEGORISATION TOOL - Quarterly Progress Monitoring', 15, 15);
            doc.setFontSize(10);
            doc.text(`${unitName} | Last 8 Quarters (Q4 2023 - Q3 2025)`, 15, 22);
            
            // Category summary
            let y = 35;
            const data = window.redCategorizationData;
            const counts = { 'Cat. 1': 0, 'Cat. 2': 0, 'Cat. 3': 0, 'Cat. 4': 0 };
            data.forEach(q => counts[q.category]++);
            
            doc.setFontSize(9);
            doc.setTextColor(0);
            doc.text(`Quarterly Performance: Cat.1(On Track): ${counts['Cat. 1']} | Cat.2(High Dropout): ${counts['Cat. 2']} | Cat.3(Low Access): ${counts['Cat. 3']} | Cat.4(CRITICAL): ${counts['Cat. 4']}`, 15, y);
            y += 10;
            
            // Table headers
            const headers = ['Qtr', 'Q-Pop', 'BCG T', 'DPT T', 'BCG', 'DPT1', 'DPT3', 'MR', 'BCG%', 'DPT1%', 'DPT3%', 'MR%', 'GapD3', 'GapMR', 'Zero', 'Under', 'DO13', 'DOMR', 'Acc', 'Utl', 'Cat'];
            const colWidths = [22, 18, 16, 16, 16, 16, 16, 16, 14, 14, 14, 14, 16, 16, 14, 14, 14, 14, 14, 14, 14];
            
            doc.setFillColor(44, 62, 80);
            doc.rect(10, y, 390, 8, 'F');
            doc.setTextColor(255);
            doc.setFontSize(7);
            doc.setFont('helvetica', 'bold');
            
            let x = 12;
            headers.forEach((h, i) => {
                doc.text(h, x, y + 5);
                x += colWidths[i];
            });
            y += 10;
            
            // Data rows
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(7);
            
            data.forEach((q, idx) => {
                if (y > 280) {
                    doc.addPage();
                    y = 20;
                }
                
                // Row background based on category
                if (q.category === 'Cat. 4') doc.setFillColor(255, 200, 200);
                else if (q.category === 'Cat. 3') doc.setFillColor(255, 230, 200);
                else if (q.category === 'Cat. 2') doc.setFillColor(255, 255, 200);
                else doc.setFillColor(200, 255, 200);
                
                doc.rect(10, y - 4, 390, 7, 'F');
                doc.setTextColor(0);
                
                x = 12;
                const rowData = [
                    `${q.name} (${q.display || ''})`, q.population.toLocaleString(), q.target_bcg.toLocaleString(), q.target_pop.toLocaleString(),
                    q.bcg.toLocaleString(), q.dpt1.toLocaleString(), q.dpt3.toLocaleString(), q.mr.toLocaleString(),
                    q.bcg_cov + '%', q.dpt1_cov + '%', q.dpt3_cov + '%', q.mr_cov + '%',
                    q.unimm_dpt3.toLocaleString(), q.unimm_mr.toLocaleString(), q.zero_dose.toLocaleString(), q.under_imm.toLocaleString(),
                    q.dpt1_3_dropout + '%', q.dpt1_mr_dropout + '%', q.access, q.utilization, q.category
                ];
                
                rowData.forEach((val, i) => {
                    doc.text(String(val), x, y);
                    x += colWidths[i];
                });
                
                y += 7;
            });
            
            // Footer
            doc.setFontSize(8);
            doc.setTextColor(100);
            doc.text(`Generated: ${new Date().toLocaleString()} | Annual Population: ${(window.redAnnualPopulation || 0).toLocaleString()} | Quarterly Target: ${(window.redQuarterlyTarget || 0).toLocaleString()}`, 15, 290);
            
            doc.save(`RED_Progress_${unitName}_${new Date().toISOString().split('T')[0]}.pdf`);
            toastSuccess('RED PDF downloaded', 'Export Complete');
        }

        async function loadTrendAnalysis() {
            const indicatorId = document.getElementById('trendIndicator').value;
            if (!indicatorId) {
                document.getElementById('outliersSection').style.display = 'none';
                return;
            }

            // Show loading state
            showLoading('Analyzing Data...', 'Detecting outliers in historical data');

            const period = getSelectedPeriod();
            const r = await fetch(`/api/trend-analysis?orgUnit=${selectedOrgUnit.id}&period=${period}&indicator=${indicatorId}`);
            const data = await r.json();
            
            hideLoading();

            if (data.error) {
                document.getElementById('trendResults').innerHTML = `<div class="error">${data.error}</div>`;
                document.getElementById('outliersSection').style.display = 'none';
                return;
            }

            // Store data globally for download
            window.lastOutliers = data.outliers || [];
            const ts = data.data || [];

            // Get indicator name for title
            const indicatorSelect = document.getElementById('trendIndicator');
            const indicatorName = indicatorSelect.options[indicatorSelect.selectedIndex].text;

            // Display outliers
            const outliersSection = document.getElementById('outliersSection');
            outliersSection.style.display = 'block';
            
            document.getElementById('outliersTitle').textContent = `âš ï¸ Outliers Detected for ${indicatorName}`;

            if (data.outliers && data.outliers.length > 0) {
                let tableHtml = `
                    <table class="modern-table" style="margin-top:10px;">
                        <thead>
                            <tr>
                                <th>Period</th>
                                <th>Value</th>
                                <th>Z-Score</th>
                                <th>Type</th>
                                <th>Severity</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                data.outliers.forEach(o => {
                    const periodStr = ts[o.index] ? formatPeriod(ts[o.index].period) : `Period ${o.index + 1}`;
                    const isHigh = o.zscore > 0;
                    const severity = Math.abs(o.zscore) > 3 ? 'High' : 'Moderate';
                    const bg = isHigh ? '#fff3cd' : '#f8d7da';
                    
                    tableHtml += `
                        <tr style="background:${bg}">
                            <td><strong>${periodStr}</strong></td>
                            <td>${o.value.toLocaleString()}</td>
                            <td>${o.zscore.toFixed(2)}Ïƒ</td>
                            <td>${isHigh ? 'ðŸ“ˆ Spike' : 'ðŸ“‰ Drop'}</td>
                            <td><span class="badge ${Math.abs(o.zscore) > 3 ? 'red' : 'yellow'}">${severity}</span></td>
                        </tr>
                    `;
                });

                tableHtml += '</tbody></table>';
                document.getElementById('outliersTable').innerHTML = tableHtml;
            } else {
                document.getElementById('outliersTable').innerHTML = '<div style="padding:20px; text-align:center; color:#27ae60; font-weight:600;">âœ… No significant outliers detected in the selected period.</div>';
            }
        }

        function updateForecast() {
            if (!currentTrendData) return;

            const forecastType = document.querySelector('input[name="forecastType"]:checked')?.value || 'with';
            const ts = currentTrendData.data || [];
            const outliers = currentTrendData.outliers || [];
            const outlierIndices = new Set(outliers.map(o => o.index));

            let dataForForecast, labelsForChart, valuesForChart;

            if (forecastType === 'without' && outliers.length > 0) {
                // Filter out outliers
                dataForForecast = ts.filter((_, idx) => !outlierIndices.has(idx));
                labelsForChart = ts.map((t, idx) => ({
                    label: formatPeriod(t.period),
                    isOutlier: outlierIndices.has(idx),
                    value: t.value
                }));
            } else {
                dataForForecast = ts;
                labelsForChart = ts.map((t, idx) => ({
                    label: formatPeriod(t.period),
                    isOutlier: outlierIndices.has(idx),
                    value: t.value
                }));
            }

            // Calculate new forecast
            const forecastValues = dataForForecast.map(d => d.value);
            const newForecast = simpleForecast(forecastValues, 3);

            // Build chart data
            const labels = labelsForChart.map(l => l.label).concat(newForecast.map((_, i) => `Forecast +${i + 1}`));
            const values = labelsForChart.map(l => l.value).concat(newForecast);

            // Create point colors (red for outliers)
            const pointColors = labelsForChart.map(l => l.isOutlier ? '#e74c3c' : '#11998e').concat(newForecast.map(() => '#3498db'));
            const pointRadius = labelsForChart.map(l => l.isOutlier ? 8 : 4).concat(newForecast.map(() => 4));

            if (charts.forecast) charts.forecast.destroy();
            charts.forecast = new Chart(document.getElementById('forecastChart'), {
                type: 'line',
                data: {
                    labels,
                    datasets: [{
                        label: 'Value',
                        data: values,
                        borderColor: '#11998e',
                        backgroundColor: 'rgba(17,153,142,0.1)',
                        fill: true,
                        tension: 0.4,
                        pointBackgroundColor: pointColors,
                        pointBorderColor: pointColors,
                        pointRadius: pointRadius,
                        segment: {
                            borderColor: ctx => ctx.p1DataIndex >= ts.length ? '#3498db' : '#11998e',
                            borderDash: ctx => ctx.p1DataIndex >= ts.length ? [5, 5] : []
                        }
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { display: false },
                        datalabels: {
                            display: true,
                            color: function (context) {
                                return context.dataIndex < labelsForChart.length && labelsForChart[context.dataIndex].isOutlier ? '#e74c3c' : '#333';
                            },
                            anchor: 'top',
                            align: 'top',
                            offset: 4,
                            font: { size: 9, weight: 'bold' },
                            formatter: function (value) {
                                return value >= 1000 ? (value / 1000).toFixed(1) + 'k' : value.toLocaleString();
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    return 'Doses: ' + context.parsed.y.toLocaleString();
                                },
                                afterLabel: function (context) {
                                    if (context.dataIndex < labelsForChart.length && labelsForChart[context.dataIndex].isOutlier) {
                                        return 'âš ï¸ OUTLIER';
                                    }
                                    return '';
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            display: true,
                            title: { display: true, text: 'Month/Year', font: { size: 11 } },
                            ticks: {
                                maxRotation: 45,
                                minRotation: 45,
                                font: { size: 9 }
                            }
                        },
                        y: {
                            display: true,
                            title: { display: true, text: 'Doses Administered', font: { size: 11 } },
                            beginAtZero: true,
                            ticks: {
                                callback: function (value) {
                                    return value >= 1000 ? (value / 1000).toFixed(0) + 'k' : value;
                                }
                            }
                        }
                    }
                }
            });

            // Show forecast values
            const forecastHtml = newForecast.length ? `
                <div style="margin-top:15px; padding:10px; background:#e3f2fd; border-radius:6px;">
                    <strong>ðŸ“ˆ Forecast (Next 3 periods)${forecastType === 'without' ? ' - Excluding Outliers' : ''}:</strong>
                    <div class="forecast-list" style="margin-top:8px;">
                        ${newForecast.map((f, i) => `<span class="forecast-item">+${i + 1}: ${Math.round(f).toLocaleString()}</span>`).join('')}
                    </div>
                </div>
            ` : '';

            // Append forecast to trend results
            const trendResultsDiv = document.getElementById('trendResults');
            const existingForecast = trendResultsDiv.querySelector('.forecast-display');
            if (existingForecast) existingForecast.remove();
            trendResultsDiv.insertAdjacentHTML('beforeend', `<div class="forecast-display">${forecastHtml}</div>`);
        }

        // Simple linear regression forecast
        function simpleForecast(values, periodsAhead = 3) {
            if (values.length < 2) return [];
            const n = values.length;
            const xMean = (n - 1) / 2;
            const yMean = values.reduce((a, b) => a + b, 0) / n;
            const numerator = values.reduce((sum, v, i) => sum + (i - xMean) * (v - yMean), 0);
            const denominator = values.reduce((sum, _, i) => sum + Math.pow(i - xMean, 2), 0);
            const slope = denominator !== 0 ? numerator / denominator : 0;
            const intercept = yMean - slope * xMean;
            return Array.from({ length: periodsAhead }, (_, i) => slope * (n + i) + intercept);
        }

        function downloadOutliers() {
            if (!currentTrendData || !currentTrendData.outliers || !currentTrendData.outliers.length) {
                alert('No outliers to download.');
                return;
            }

            const ts = currentTrendData.data || [];
            const outliers = currentTrendData.outliers;
            const indicatorSelect = document.getElementById('trendIndicator');
            const indicatorName = indicatorSelect.options[indicatorSelect.selectedIndex].text;

            // Create workbook
            const wb = XLSX.utils.book_new();

            // Prepare outliers data
            const wsData = [
                ['Outliers Report - ' + indicatorName],
                ['Organization: ' + selectedOrgUnit.name],
                ['Period: ' + getSelectedPeriod()],
                ['Generated: ' + new Date().toLocaleString()],
                [''],
                ['Period', 'Value', 'Z-Score', 'Severity', 'Recommendation']
            ];

            outliers.forEach(o => {
                const periodStr = ts[o.index] ? formatPeriod(ts[o.index].period) : `Period ${o.index + 1}`;
                const severity = Math.abs(o.zscore) > 3 ? 'High' : 'Moderate';
                const recommendation = Math.abs(o.zscore) > 3 ? 'Investigate data entry error' : 'Review for accuracy';
                wsData.push([periodStr, o.value, o.zscore, severity, recommendation]);
            });

            wsData.push(['']);
            wsData.push(['Notes:']);
            wsData.push(['- Z-Score > 2 indicates significant deviation from trend']);
            wsData.push(['- High severity (Z > 3) suggests possible data quality issues']);
            wsData.push(['- Consider removing outliers for cleaner forecasting']);

            const ws = XLSX.utils.aoa_to_sheet(wsData);
            ws['!cols'] = [{ wch: 15 }, { wch: 12 }, { wch: 10 }, { wch: 12 }, { wch: 30 }];
            XLSX.utils.book_append_sheet(wb, ws, 'Outliers');

            const filename = `Outliers_${indicatorName.replace(/[^a-zA-Z0-9]/g, '_')}_${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(wb, filename);
        }

        function formatPeriod(p) { const m = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec']; return p?.length === 6 ? `${m[parseInt(p.substring(4, 6)) - 1]} ${p.substring(0, 4)}` : p; }
        
        function showError(msg) { 
            const e = document.getElementById('errorMessage'); 
            e.textContent = 'âš ï¸ ' + msg; 
            e.style.display = 'block'; 
            hideLoading();
            // Also show toast
            toastError(msg, 'Data Error');
        }

        // Loading Overlay Functions
        function showLoading(text = 'Loading data...', subtext = 'Fetching from DHIS2') {
            const overlay = document.getElementById('loadingOverlay');
            document.getElementById('loadingText').textContent = text;
            document.getElementById('loadingSubtext').textContent = subtext;
            overlay.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }

        function hideLoading() {
            const overlay = document.getElementById('loadingOverlay');
            overlay.classList.add('hidden');
            document.body.style.overflow = '';
        }

        function updateLoadingText(text, subtext) {
            document.getElementById('loadingText').textContent = text;
            if (subtext) document.getElementById('loadingSubtext').textContent = subtext;
        }

        // Skeleton Loaders
        function showSkeletonCards(containerId, count = 4) {
            const container = document.getElementById(containerId);
            container.innerHTML = Array(count).fill(0).map(() => `
                <div class="skeleton-card">
                    <div class="skeleton skeleton-title"></div>
                    <div class="skeleton skeleton-value"></div>
                </div>
            `).join('');
        }

        function showSkeletonTable(containerId, rows = 5, cols = 4) {
            const container = document.getElementById(containerId);
            container.innerHTML = `
                <div class="skeleton-table">
                    <div class="skeleton skeleton-title" style="width:30%; height:20px; margin-bottom:20px;"></div>
                    ${Array(rows).fill(0).map(() => `
                        <div class="skeleton-row">
                            ${Array(cols).fill(0).map(() => `<div class="skeleton skeleton-cell"></div>`).join('')}
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function showSkeletonChart(containerId) {
            const container = document.getElementById(containerId);
            if (container.tagName === 'CANVAS') {
                const parent = container.parentElement;
                const skeleton = document.createElement('div');
                skeleton.className = 'skeleton-chart skeleton';
                skeleton.id = containerId + '_skeleton';
                skeleton.style.height = '250px';
                parent.insertBefore(skeleton, container);
                container.style.display = 'none';
            }
        }

        function hideSkeletonChart(containerId) {
            const skeleton = document.getElementById(containerId + '_skeleton');
            if (skeleton) skeleton.remove();
            const canvas = document.getElementById(containerId);
            if (canvas) canvas.style.display = '';
        }

        // Org Unit Search Functions
        let searchTimeout = null;
        let searchCache = {};

        function handleSearchInput(query) {
            clearTimeout(searchTimeout);
            const dropdown = document.getElementById('searchDropdown');
            
            if (query.length < 3) {
                dropdown.classList.remove('show');
                dropdown.innerHTML = '';
                return;
            }

            // Show loading state
            dropdown.classList.add('show');
            dropdown.innerHTML = '<div class="search-loading">Searching</div>';

            // Debounce search
            searchTimeout = setTimeout(() => searchOrgUnits(query), 300);
        }

        async function searchOrgUnits(query) {
            const dropdown = document.getElementById('searchDropdown');
            const cacheKey = query.toLowerCase();

            // Check cache first
            if (searchCache[cacheKey]) {
                renderSearchResults(searchCache[cacheKey]);
                return;
            }

            try {
                const response = await fetch(`/api/search-org-units?query=${encodeURIComponent(query)}`);
                const data = await response.json();

                if (data.error) {
                    dropdown.innerHTML = `<div class="search-no-results">âŒ ${data.error}</div>`;
                    return;
                }

                const results = data.organisationUnits || [];
                searchCache[cacheKey] = results; // Cache results
                renderSearchResults(results);
            } catch (e) {
                dropdown.innerHTML = '<div class="search-no-results">âŒ Search failed. Please try again.</div>';
            }
        }

        function renderSearchResults(results) {
            const dropdown = document.getElementById('searchDropdown');
            const levelNames = ['', 'Country', 'Region', 'District', 'County', 'Sub-county', 'Facility'];

            if (!results.length) {
                dropdown.innerHTML = '<div class="search-no-results">ðŸ“­ No results found. Try different keywords.</div>';
                return;
            }

            dropdown.innerHTML = results.slice(0, 15).map(unit => {
                const levelName = unit.level >= FACILITY_LEVEL_THRESHOLD ? 'Facility' : (levelNames[unit.level] || `Level ${unit.level}`);
                const path = unit.path || '';
                const escapedPath = path.replace(/'/g, "\\'");
                return `
                    <div class="search-result-item" onclick="selectSearchResult('${unit.id}', '${unit.displayName.replace(/'/g, "\\'")}', ${unit.level}, '${escapedPath}')">
                        <div class="name">
                            ${unit.displayName}
                            <span class="level-badge ${unit.level >= FACILITY_LEVEL_THRESHOLD ? 'facility' : ''}">${levelName}</span>
                        </div>
                        ${path ? `<div class="path">ðŸ“ ${path}</div>` : ''}
                    </div>
                `;
            }).join('');

            if (results.length > 15) {
                dropdown.innerHTML += `<div class="search-no-results" style="color:#11998e;">Showing 15 of ${results.length} results. Refine your search.</div>`;
            }
        }

        function selectSearchResult(id, name, level, path = '') {
            // Update selected org unit
            selectedOrgUnit = { id, name, level, path: path || name };
            document.getElementById('selectedOrg').textContent = name;
            
            // Reset facility population when changing org unit
            facilityPopulation = null;

            // Check if it's a district for analytics
            if (level === 3) {
                selectedDistrict = name.toUpperCase().replace(' DISTRICT', '').trim();
                const pop = ubosPopulation[selectedDistrict] || 0;
                document.getElementById('ubosPopulation').textContent = pop.toLocaleString();
                document.getElementById('populationInfo').style.display = currentSection === 'analytics' ? 'inline' : 'none';
            } else if (level >= FACILITY_LEVEL_THRESHOLD) {
                // For facility level, show that custom population is needed
                document.getElementById('ubosPopulation').textContent = 'Custom (will prompt)';
                document.getElementById('populationInfo').style.display = currentSection === 'analytics' ? 'inline' : 'none';
            } else {
                // For non-district levels below facility, clear district info
                if (level < 3) {
                    selectedDistrict = '';
                    document.getElementById('populationInfo').style.display = 'none';
                }
            }

            // Close dropdown and clear search
            clearSearch();

            // Reset hierarchy dropdowns
            resetHierarchyDropdowns();

            // Show success feedback
            const searchInput = document.getElementById('orgUnitSearch');
            searchInput.value = '';
            searchInput.placeholder = `âœ“ Selected: ${name}`;
            setTimeout(() => {
                searchInput.placeholder = 'Type to search districts, sub-counties, or facilities...';
            }, 3000);
            
            // Toast notification with facility indicator
            const levelNames = ['', 'Country', 'Region', 'District', 'County', 'Sub-county', 'Facility', 'Facility'];
            const levelName = level >= FACILITY_LEVEL_THRESHOLD ? 'Facility' : (levelNames[level] || 'Unit');
            toastSuccess(`${levelName}: ${name}`, 'Organization Selected');
        }

        function resetHierarchyDropdowns() {
            // Reset all dropdowns to show that search was used
            for (let i = 1; i <= 6; i++) {
                const sel = document.getElementById(`level${i}`);
                if (i === 1) {
                    sel.value = '';
                } else {
                    sel.innerHTML = '<option>--</option>';
                    sel.disabled = true;
                }
            }
        }

        function showSearchDropdown() {
            const query = document.getElementById('orgUnitSearch').value;
            if (query.length >= 3) {
                document.getElementById('searchDropdown').classList.add('show');
            }
        }

        function clearSearch() {
            const input = document.getElementById('orgUnitSearch');
            const dropdown = document.getElementById('searchDropdown');
            input.value = '';
            dropdown.classList.remove('show');
            dropdown.innerHTML = '';
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', (e) => {
            const searchContainer = document.querySelector('.search-container');
            if (searchContainer && !searchContainer.contains(e.target)) {
                document.getElementById('searchDropdown').classList.remove('show');
            }
        });

        // Close dropdown on Escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                document.getElementById('searchDropdown').classList.remove('show');
            }
        });

        // Toast Notification System
        const toastIcons = {
            success: 'âœ…',
            error: 'âŒ',
            warning: 'âš ï¸',
            info: 'â„¹ï¸'
        };

        function showToast(message, type = 'info', title = null, duration = 15000) {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            
            const defaultTitles = {
                success: 'Success',
                error: 'Error',
                warning: 'Warning',
                info: 'Info'
            };

            toast.innerHTML = `
                <span class="toast-icon">${toastIcons[type]}</span>
                <div class="toast-content">
                    <div class="toast-title">${title || defaultTitles[type]}</div>
                    <div class="toast-message">${message}</div>
                </div>
                <button class="toast-close" onclick="removeToast(this.parentElement)">Ã—</button>
                <div class="toast-progress" style="animation-duration: ${duration}ms;"></div>
            `;

            container.appendChild(toast);

            // Auto-remove after duration
            setTimeout(() => removeToast(toast), duration);

            return toast;
        }

        function removeToast(toast) {
            if (!toast || toast.classList.contains('removing')) return;
            toast.classList.add('removing');
            setTimeout(() => toast.remove(), 300);
        }

        // Convenience functions
        function toastSuccess(message, title = null) { return showToast(message, 'success', title); }
        function toastError(message, title = null) { return showToast(message, 'error', title, 8000); }
        function toastWarning(message, title = null) { return showToast(message, 'warning', title, 6000); }
        function toastInfo(message, title = null) { return showToast(message, 'info', title); }

        // Table Sorting Functions
        let sortState = {};

        function sortTable(tableId, columnIdx, dataType = 'string') {
            const table = document.getElementById(tableId);
            const tbody = table.querySelector('tbody');
            const rows = Array.from(tbody.querySelectorAll('tr:not(.hidden)'));
            const headers = table.querySelectorAll('th.sortable');
            
            // Determine sort direction
            const currentSort = sortState[tableId] || {};
            const isAsc = currentSort.column === columnIdx ? !currentSort.asc : true;
            sortState[tableId] = { column: columnIdx, asc: isAsc };
            
            // Update header classes
            headers.forEach((h, i) => {
                h.classList.remove('asc', 'desc');
            });
            headers[columnIdx]?.classList.add(isAsc ? 'asc' : 'desc');
            
            // Sort rows
            rows.sort((a, b) => {
                let aVal = a.cells[columnIdx]?.textContent?.trim() || '';
                let bVal = b.cells[columnIdx]?.textContent?.trim() || '';
                
                if (dataType === 'number') {
                    // Extract number from string (remove %, commas, etc.)
                    aVal = parseFloat(aVal.replace(/[^0-9.-]/g, '')) || 0;
                    bVal = parseFloat(bVal.replace(/[^0-9.-]/g, '')) || 0;
                    return isAsc ? aVal - bVal : bVal - aVal;
                } else {
                    return isAsc 
                        ? aVal.localeCompare(bVal, undefined, {numeric: true})
                        : bVal.localeCompare(aVal, undefined, {numeric: true});
                }
            });
            
            // Re-append rows in sorted order
            rows.forEach(row => tbody.appendChild(row));
            
            // Update row numbers if first column is #
            if (columnIdx !== 0) {
                updateRowNumbers(tableId);
            }
        }

        function updateRowNumbers(tableId) {
            const table = document.getElementById(tableId);
            const rows = table.querySelectorAll('tbody tr:not(.hidden)');
            rows.forEach((row, idx) => {
                const firstCell = row.cells[0];
                if (firstCell && /^\d+$/.test(firstCell.textContent.trim())) {
                    firstCell.textContent = idx + 1;
                }
            });
        }

        // Table Filtering Functions
        function filterTable(tableId, query) {
            const table = document.getElementById(tableId);
            const tbody = table.querySelector('tbody');
            const rows = tbody.querySelectorAll('tr');
            const searchLower = query.toLowerCase().trim();
            let visibleCount = 0;
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                const matches = searchLower === '' || text.includes(searchLower);
                row.classList.toggle('hidden', !matches);
                if (matches) visibleCount++;
            });
            
            // Update info
            const infoEl = document.getElementById(tableId + 'Info');
            if (infoEl) {
                infoEl.textContent = query 
                    ? `Showing ${visibleCount} of ${rows.length} indicators` 
                    : 'Showing all indicators';
            }
        }

        function filterByColor(tableId, color, btnElement) {
            const table = document.getElementById(tableId);
            const tbody = table.querySelector('tbody');
            const rows = tbody.querySelectorAll('tr');
            
            // Update button states
            const btns = btnElement.parentElement.querySelectorAll('.filter-btn');
            btns.forEach(btn => btn.classList.remove('active'));
            btnElement.classList.add('active');
            
            let visibleCount = 0;
            
            rows.forEach(row => {
                if (color === 'all') {
                    row.classList.remove('hidden');
                    visibleCount++;
                } else {
                    // Check if row contains a cell with the color class
                    const hasColor = row.querySelector(`.coverage-cell.${color}`) || 
                                     row.querySelector(`.badge.${color}`) ||
                                     row.querySelector(`.rate.${color}`);
                    row.classList.toggle('hidden', !hasColor);
                    if (hasColor) visibleCount++;
                }
            });
            
            // Update info
            const infoEl = document.getElementById(tableId + 'Info');
            if (infoEl) {
                const colorLabels = { all: 'all', green: 'on target', yellow: 'moderate', red: 'low coverage' };
                infoEl.textContent = `Showing ${visibleCount} ${colorLabels[color]} indicators`;
            }
            
            // Clear search input
            const searchInput = document.getElementById(tableId + 'Search');
            if (searchInput) searchInput.value = '';
        }

        // ============ SUMMARY BANNER ============
        let lastLoadedData = null;

        function updateSummaryBanner(data) {
            const banner = document.getElementById('summaryBanner');
            banner.classList.remove('hidden');
            
            // Update values
            document.getElementById('bannerLastUpdate').textContent = new Date().toLocaleTimeString();
            document.getElementById('bannerOrgUnit').textContent = selectedOrgUnit.name.length > 20 
                ? selectedOrgUnit.name.substring(0, 18) + '...' 
                : selectedOrgUnit.name;
            
            if (data.totalDoses !== undefined) {
                document.getElementById('bannerTotalDoses').textContent = data.totalDoses.toLocaleString();
            }
            if (data.avgCoverage !== undefined) {
                document.getElementById('bannerAvgCoverage').textContent = data.avgCoverage + '%';
            }
            if (data.lowCoverageCount !== undefined) {
                document.getElementById('bannerAlerts').textContent = data.lowCoverageCount;
            }
            
            // Store for comparison
            lastLoadedData = { ...data, timestamp: Date.now() };
        }

        // ============ FILTER PRESETS ============
        function loadSavedPresets() {
            const presets = JSON.parse(localStorage.getItem('epiFilterPresets') || '[]');
            renderPresets(presets);
        }

        function renderPresets(presets) {
            const container = document.getElementById('presetsArea');
            
            if (!presets.length) {
                container.innerHTML = '<span style="color:#95a5a6; font-size:11px;">No saved presets</span>';
                return;
            }
            
            container.innerHTML = presets.map((p, idx) => `
                <span class="preset-chip" onclick="applyPreset(${idx})">
                    ðŸ“Œ ${p.name}
                    <span class="delete-preset" onclick="event.stopPropagation(); deletePreset(${idx})">Ã—</span>
                </span>
            `).join('');
        }

        function saveFilterPreset() {
            const name = prompt('Enter a name for this preset:', `${selectedOrgUnit.name} - ${getSelectedPeriod()}`);
            if (!name) return;
            
            const preset = {
                name: name.substring(0, 30),
                orgUnit: { ...selectedOrgUnit },
                district: selectedDistrict,
                periodType: document.getElementById('periodType').value,
                period: getSelectedPeriod(),
                section: currentSection,
                timestamp: Date.now()
            };
            
            const presets = JSON.parse(localStorage.getItem('epiFilterPresets') || '[]');
            
            // Limit to 10 presets
            if (presets.length >= 10) {
                presets.shift(); // Remove oldest
            }
            
            presets.push(preset);
            localStorage.setItem('epiFilterPresets', JSON.stringify(presets));
            renderPresets(presets);
            
            toastSuccess(`Preset "${name}" saved!`, 'Preset Saved');
        }

        function applyPreset(idx) {
            const presets = JSON.parse(localStorage.getItem('epiFilterPresets') || '[]');
            const preset = presets[idx];
            if (!preset) return;
            
            // Apply org unit
            selectedOrgUnit = preset.orgUnit;
            selectedDistrict = preset.district || '';
            document.getElementById('selectedOrg').textContent = preset.orgUnit.name;
            
            // Apply period
            document.getElementById('periodType').value = preset.periodType || 'relative';
            togglePeriodInputs();
            
            if (preset.periodType === 'relative') {
                document.getElementById('relativePeriod').value = preset.period;
            }
            document.getElementById('selectedPeriod').textContent = preset.period;
            
            // Apply section
            if (preset.section) {
                switchSection(preset.section);
            }
            
            // Update population if district
            if (preset.district) {
                const pop = ubosPopulation[preset.district] || 0;
                document.getElementById('ubosPopulation').textContent = pop.toLocaleString();
                document.getElementById('populationInfo').style.display = currentSection === 'analytics' ? 'inline' : 'none';
            }
            
            toastInfo(`Applied preset: ${preset.name}`, 'Preset Loaded');
        }

        function deletePreset(idx) {
            const presets = JSON.parse(localStorage.getItem('epiFilterPresets') || '[]');
            const name = presets[idx]?.name;
            presets.splice(idx, 1);
            localStorage.setItem('epiFilterPresets', JSON.stringify(presets));
            renderPresets(presets);
            toastInfo(`Preset "${name}" deleted`, 'Preset Removed');
        }

        // ============ PERIOD COMPARISON ============
        let comparisonEnabled = false;
        let previousPeriodData = null;

        function toggleComparison() {
            comparisonEnabled = document.getElementById('compareEnabled').checked;
            if (comparisonEnabled) {
                toastInfo('Period comparison enabled. Load data to see changes.', 'Comparison Mode');
            }
        }

        function getPreviousPeriod(period) {
            // Handle relative periods
            if (period === 'LAST_12_MONTHS') return 'LAST_12_MONTHS'; // Will shift dates
            if (period === 'LAST_MONTH') return 'LAST_MONTH';
            if (period === 'THIS_YEAR') return 'LAST_YEAR';
            if (period === 'LAST_YEAR') {
                const year = new Date().getFullYear() - 2;
                return `${year}01-${year}12`;
            }
            
            // Handle YYYYMM format
            if (period.length === 6 && /^\d+$/.test(period)) {
                const year = parseInt(period.substring(0, 4));
                const month = parseInt(period.substring(4, 6));
                const prevYear = month === 1 ? year - 1 : year;
                const prevMonth = month === 1 ? 12 : month - 1;
                return `${prevYear}${String(prevMonth).padStart(2, '0')}`;
            }
            
            // Handle YYYYQX format (quarters)
            if (period.includes('Q')) {
                const year = parseInt(period.substring(0, 4));
                const quarter = parseInt(period.substring(5));
                if (quarter === 1) {
                    return `${year - 1}Q4`;
                }
                return `${year}Q${quarter - 1}`;
            }
            
            // Handle custom range YYYYMM-YYYYMM
            if (period.includes('-')) {
                const [start, end] = period.split('-');
                const months = getMonthsDiff(start, end);
                // Shift both by the number of months
                return `${shiftMonth(start, -months)}-${shiftMonth(end, -months)}`;
            }
            
            return period;
        }

        function getMonthsDiff(start, end) {
            const startYear = parseInt(start.substring(0, 4));
            const startMonth = parseInt(start.substring(4, 6));
            const endYear = parseInt(end.substring(0, 4));
            const endMonth = parseInt(end.substring(4, 6));
            return (endYear - startYear) * 12 + (endMonth - startMonth) + 1;
        }

        function shiftMonth(yyyymm, months) {
            let year = parseInt(yyyymm.substring(0, 4));
            let month = parseInt(yyyymm.substring(4, 6)) + months;
            while (month < 1) { month += 12; year--; }
            while (month > 12) { month -= 12; year++; }
            return `${year}${String(month).padStart(2, '0')}`;
        }

        function calculateChange(current, previous) {
            if (!previous || previous === 0) return null;
            return Math.round(((current - previous) / previous) * 100);
        }

        function getChangeBadge(change) {
            if (change === null) return '';
            if (change > 0) return `<span class="comparison-badge up">â†‘ ${change}%</span>`;
            if (change < 0) return `<span class="comparison-badge down">â†“ ${Math.abs(change)}%</span>`;
            return `<span class="comparison-badge same">â†’ 0%</span>`;
        }

        // ============ DARK MODE ============
        function toggleDarkMode() {
            const html = document.documentElement;
            const currentTheme = html.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            
            html.setAttribute('data-theme', newTheme);
            localStorage.setItem('epiTheme', newTheme);
            
            // Update toggle button icon
            const btn = document.getElementById('themeToggle');
            btn.textContent = newTheme === 'dark' ? 'â˜€ï¸' : 'ðŸŒ™';
            btn.title = newTheme === 'dark' ? 'Switch to Light Mode' : 'Switch to Dark Mode';
            
            // Update Chart.js colors for dark mode
            updateChartsTheme(newTheme);
            
            toastInfo(newTheme === 'dark' ? 'Dark mode enabled' : 'Light mode enabled', 'Theme Changed');
        }

        function initTheme() {
            const savedTheme = localStorage.getItem('epiTheme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
            
            const btn = document.getElementById('themeToggle');
            if (btn) {
                btn.textContent = savedTheme === 'dark' ? 'â˜€ï¸' : 'ðŸŒ™';
                btn.title = savedTheme === 'dark' ? 'Switch to Light Mode' : 'Switch to Dark Mode';
            }
        }

        function updateChartsTheme(theme) {
            const textColor = theme === 'dark' ? '#e8e8e8' : '#2c3e50';
            const gridColor = theme === 'dark' ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.1)';
            
            Chart.defaults.color = textColor;
            Chart.defaults.borderColor = gridColor;
            
            // Redraw existing charts if any
            Object.values(charts).forEach(chart => {
                if (chart && chart.options) {
                    chart.options.scales = chart.options.scales || {};
                    if (chart.options.scales.x) {
                        chart.options.scales.x.ticks = chart.options.scales.x.ticks || {};
                        chart.options.scales.x.ticks.color = textColor;
                        chart.options.scales.x.grid = chart.options.scales.x.grid || {};
                        chart.options.scales.x.grid.color = gridColor;
                    }
                    if (chart.options.scales.y) {
                        chart.options.scales.y.ticks = chart.options.scales.y.ticks || {};
                        chart.options.scales.y.ticks.color = textColor;
                        chart.options.scales.y.grid = chart.options.scales.y.grid || {};
                        chart.options.scales.y.grid.color = gridColor;
                    }
                    chart.update();
                }
            });
        }

        // Initialize theme on page load
        initTheme();

        // ============ CSV EXPORT ============
        function downloadCSV(data, filename, headers = null) {
            let csvContent = '';
            
            // Add headers if provided
            if (headers) {
                csvContent += headers.join(',') + '\n';
            } else if (data.length > 0 && typeof data[0] === 'object') {
                csvContent += Object.keys(data[0]).join(',') + '\n';
            }
            
            // Add data rows
            data.forEach(row => {
                if (Array.isArray(row)) {
                    csvContent += row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(',') + '\n';
                } else if (typeof row === 'object') {
                    csvContent += Object.values(row).map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(',') + '\n';
                }
            });
            
            // Create and download file
            const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `${filename}_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
            URL.revokeObjectURL(link.href);
            
            toastSuccess(`Downloaded ${filename}.csv`, 'Export Complete');
        }

        function downloadCoverageCSV() {
            if (!window.coverageData || !window.coverageData.length) {
                toastError('No coverage data available. Please load data first.');
                return;
            }

            const data = window.coverageData.map((i, idx) => {
                const info = ANTIGEN_INFO[i.code] || { disease: 'Immunization', schedule: '-' };
                return [
                    idx + 1,
                    i.name,
                    i.doses,
                    i.target_population,
                    i.coverage + '%',
                    i.color === 'green' ? 'On Target' : i.color === 'yellow' ? 'Moderate' : 'Low',
                    info.disease,
                    info.schedule
                ];
            });

            const headers = ['#', 'Antigen/Indicator', 'Doses Given', 'Target Pop', 'Coverage %', 'Status', 'Disease Prevented', 'Schedule'];
            downloadCSV(data, `Coverage_${selectedOrgUnit.name}`, headers);
        }

        function downloadDropoutCSV() {
            const table = document.getElementById('dropoutTable');
            const rows = table.querySelectorAll('tbody tr');
            
            if (!rows.length || rows[0].cells.length < 2) {
                toastError('No dropout data available. Please load data first.');
                return;
            }

            const data = Array.from(rows).map(row => 
                Array.from(row.cells).map(cell => cell.textContent.trim())
            );

            const headers = ['Dropout Type', 'First Dose', 'Last Dose', 'Dropout Rate', 'Status'];
            downloadCSV(data, `Dropout_Rates_${selectedOrgUnit.name}`, headers);
        }

        function downloadRawDataCSV() {
            const table = document.getElementById('rawTable');
            const headerRow = table.querySelector('thead tr');
            const rows = table.querySelectorAll('tbody tr');
            
            if (!rows.length || rows[0].cells.length < 2) {
                toastError('No raw data available. Please load data first.');
                return;
            }

            const headers = Array.from(headerRow.cells).map(cell => cell.textContent.trim());
            const data = Array.from(rows).map(row => 
                Array.from(row.cells).map(cell => cell.textContent.trim())
            );

            downloadCSV(data, `Raw_Data_${selectedOrgUnit.name}`, headers);
        }

        function downloadRawDataExcel() {
            const table = document.getElementById('rawTable');
            const headerRow = table.querySelector('thead tr');
            const rows = table.querySelectorAll('tbody tr');
            
            if (!rows.length || rows[0].cells.length < 2) {
                toastError('No raw data available. Please load data first.');
                return;
            }

            const headers = Array.from(headerRow.cells).map(cell => cell.textContent.trim());
            const data = Array.from(rows).map(row => 
                Array.from(row.cells).map(cell => {
                    const text = cell.textContent.trim();
                    return isNaN(text.replace(/,/g, '')) ? text : parseFloat(text.replace(/,/g, ''));
                })
            );
            
            const wb = XLSX.utils.book_new();
            const wsData = [headers, ...data];
            const ws = XLSX.utils.aoa_to_sheet(wsData);
            
            // Set column widths
            ws['!cols'] = headers.map(() => ({ wch: 15 }));
            
            // Style header row with borders
            for (let col = 0; col < headers.length; col++) {
                const cell = ws[XLSX.utils.encode_cell({ r: 0, c: col })];
                if (cell) {
                    cell.s = {
                        fill: { patternType: 'solid', fgColor: { rgb: '3498DB' } },
                        font: { color: { rgb: 'FFFFFF' }, bold: true },
                        alignment: { horizontal: 'center' },
                        border: EXCEL_BORDER_THIN
                    };
                }
            }
            
            // Style all data rows with borders and alternate colors
            for (let row = 1; row <= data.length; row++) {
                for (let col = 0; col < headers.length; col++) {
                    const cell = ws[XLSX.utils.encode_cell({ r: row, c: col })];
                    if (cell) {
                        cell.s = {
                            fill: { patternType: 'solid', fgColor: { rgb: row % 2 === 0 ? 'F8F9FA' : 'FFFFFF' } },
                            alignment: { horizontal: col === 0 ? 'left' : 'right' },
                            border: EXCEL_BORDER_THIN
                        };
                    }
                }
            }
            
            XLSX.utils.book_append_sheet(wb, ws, 'Raw Data');
            
            const filename = `Raw_Data_${selectedOrgUnit.name.replace(/[^a-zA-Z0-9]/g, '_')}_${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(wb, filename);
            toastSuccess('Raw data Excel downloaded!');
        }

        // ============ ALERT SYSTEM ============
        let alertsEnabled = true;
        let alertThresholds = {
            critical: 50,    // Below 50% = critical
            warning: 70,     // Below 70% = warning
            dropoutHigh: 10  // Above 10% dropout = warning
        };

        function checkCoverageAlerts(indicators) {
            if (!alertsEnabled) return;
            
            const criticalIndicators = indicators.filter(i => i.coverage < alertThresholds.critical);
            const warningIndicators = indicators.filter(i => i.coverage >= alertThresholds.critical && i.coverage < alertThresholds.warning);
            
            // Show critical alerts
            if (criticalIndicators.length > 0) {
                const names = criticalIndicators.slice(0, 3).map(i => i.code).join(', ');
                const more = criticalIndicators.length > 3 ? ` +${criticalIndicators.length - 3} more` : '';
                toastError(
                    `Critical: ${criticalIndicators.length} indicator(s) below ${alertThresholds.critical}%\n${names}${more}`,
                    'ðŸš¨ Critical Coverage Alert',
                    10000
                );
            }
            
            // Update alert indicator in summary banner
            updateAlertBadge(criticalIndicators.length, warningIndicators.length);
            
            return { critical: criticalIndicators, warning: warningIndicators };
        }

        function checkDropoutAlerts(dropouts) {
            if (!alertsEnabled) return;
            
            const highDropouts = dropouts.filter(d => d.dropout_rate >= alertThresholds.dropoutHigh);
            
            if (highDropouts.length > 0) {
                const names = highDropouts.map(d => `${d.name}: ${d.dropout_rate}%`).join(', ');
                toastWarning(
                    `High dropout detected: ${names}`,
                    'âš ï¸ Dropout Alert',
                    8000
                );
            }
            
            return highDropouts;
        }

        function updateAlertBadge(critical, warning) {
            const alertEl = document.getElementById('bannerAlerts');
            if (!alertEl) return;
            
            const total = critical + warning;
            alertEl.textContent = total;
            
            // Change color based on severity
            if (critical > 0) {
                alertEl.style.color = '#e74c3c';
            } else if (warning > 0) {
                alertEl.style.color = '#f39c12';
            } else {
                alertEl.style.color = '#2ecc71';
            }
        }

        function toggleAlerts() {
            alertsEnabled = !alertsEnabled;
            toastInfo(alertsEnabled ? 'Alerts enabled' : 'Alerts disabled', 'Alert Settings');
        }

        function setAlertThreshold(type, value) {
            if (alertThresholds.hasOwnProperty(type)) {
                alertThresholds[type] = value;
                localStorage.setItem('epiAlertThresholds', JSON.stringify(alertThresholds));
                toastInfo(`${type} threshold set to ${value}%`, 'Threshold Updated');
            }
        }

        function loadAlertThresholds() {
            const saved = localStorage.getItem('epiAlertThresholds');
            if (saved) {
                try {
                    alertThresholds = { ...alertThresholds, ...JSON.parse(saved) };
                } catch (e) {}
            }
        }

        // Load thresholds on init
        loadAlertThresholds();

        // ============ KEYBOARD SHORTCUTS ============
        const keyboardShortcuts = {
            'ctrl+enter': { action: () => loadData(), description: 'Load Data' },
            'ctrl+d': { action: () => toggleDarkMode(), description: 'Toggle Dark Mode' },
            'ctrl+s': { action: () => saveFilterPreset(), description: 'Save Filter Preset' },
            'ctrl+f': { action: () => focusSearch(), description: 'Focus Search' },
            'ctrl+p': { action: () => window.print(), description: 'Print' },
            'escape': { action: () => closeModals(), description: 'Close Dropdowns' },
            '?': { action: () => showShortcutsHelp(), description: 'Show Shortcuts Help' }
        };

        document.addEventListener('keydown', (e) => {
            // Don't trigger shortcuts when typing in inputs
            if (e.target.matches('input, textarea, select')) {
                if (e.key === 'Escape') {
                    e.target.blur();
                    closeModals();
                }
                return;
            }

            let key = '';
            if (e.ctrlKey || e.metaKey) key += 'ctrl+';
            if (e.shiftKey) key += 'shift+';
            key += e.key.toLowerCase();

            const shortcut = keyboardShortcuts[key];
            if (shortcut) {
                e.preventDefault();
                shortcut.action();
            }
        });

        function focusSearch() {
            const searchInput = document.getElementById('orgUnitSearch');
            if (searchInput) {
                searchInput.focus();
                searchInput.select();
            }
        }

        function closeModals() {
            document.getElementById('searchDropdown')?.classList.remove('show');
            hideLoading();
        }

        function showShortcutsHelp() {
            const shortcuts = Object.entries(keyboardShortcuts)
                .map(([key, { description }]) => `<b>${key.toUpperCase()}</b>: ${description}`)
                .join('<br>');
            
            // Create modal
            const modal = document.createElement('div');
            modal.id = 'shortcutsModal';
            modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:10001;';
            modal.innerHTML = `
                <div style="background:var(--bg-card);padding:30px;border-radius:12px;max-width:400px;box-shadow:0 10px 40px rgba(0,0,0,0.3);">
                    <h3 style="color:var(--text-primary);margin-bottom:20px;display:flex;justify-content:space-between;align-items:center;">
                        âŒ¨ï¸ Keyboard Shortcuts
                        <button onclick="this.closest('#shortcutsModal').remove()" style="background:none;border:none;font-size:24px;cursor:pointer;color:var(--text-secondary);">Ã—</button>
                    </h3>
                    <div style="color:var(--text-secondary);line-height:2;font-size:13px;">${shortcuts}</div>
                </div>
            `;
            modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
            document.body.appendChild(modal);
        }

        // ============ SESSION TIMEOUT WARNING ============
        let sessionTimer = null;
        let warningTimer = null;
        const SESSION_TIMEOUT = 30 * 60 * 1000; // 30 minutes
        const WARNING_BEFORE = 5 * 60 * 1000;   // Warn 5 minutes before

        function resetSessionTimer() {
            clearTimeout(sessionTimer);
            clearTimeout(warningTimer);
            
            // Warning timer
            warningTimer = setTimeout(() => {
                showSessionWarning();
            }, SESSION_TIMEOUT - WARNING_BEFORE);
            
            // Logout timer
            sessionTimer = setTimeout(() => {
                toastError('Session expired. Redirecting to login...', 'Session Timeout');
                setTimeout(() => window.location.href = '/logout', 2000);
            }, SESSION_TIMEOUT);
        }

        function showSessionWarning() {
            const modal = document.createElement('div');
            modal.id = 'sessionWarningModal';
            modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);display:flex;align-items:center;justify-content:center;z-index:10002;';
            modal.innerHTML = `
                <div style="background:var(--bg-card);padding:30px;border-radius:12px;text-align:center;max-width:400px;box-shadow:0 10px 40px rgba(0,0,0,0.3);">
                    <div style="font-size:48px;margin-bottom:15px;">â°</div>
                    <h3 style="color:var(--text-primary);margin-bottom:10px;">Session Expiring Soon</h3>
                    <p style="color:var(--text-secondary);margin-bottom:20px;font-size:14px;">
                        Your session will expire in 5 minutes due to inactivity.<br>
                        Click below to stay logged in.
                    </p>
                    <button onclick="extendSession()" class="btn btn-primary" style="padding:12px 30px;">
                        âœ“ Stay Logged In
                    </button>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function extendSession() {
            const modal = document.getElementById('sessionWarningModal');
            if (modal) modal.remove();
            
            // Ping the server to refresh session
            fetch('/api/check-auth')
                .then(() => {
                    resetSessionTimer();
                    toastSuccess('Session extended', 'Still Logged In');
                })
                .catch(() => {
                    toastError('Failed to extend session', 'Error');
                });
        }

        // Reset timer on user activity
        ['click', 'keypress', 'scroll', 'mousemove'].forEach(event => {
            document.addEventListener(event, () => {
                // Only reset if no warning is shown
                if (!document.getElementById('sessionWarningModal')) {
                    resetSessionTimer();
                }
            }, { passive: true });
        });

        // Start session timer
        resetSessionTimer();

        // ============ CACHE MANAGEMENT ============
        async function clearServerCache() {
            const btn = document.getElementById('clearCacheBtn');
            const originalText = btn.textContent;
            btn.textContent = 'â³';
            btn.disabled = true;
            
            try {
                const response = await fetch('/api/clear-cache', { method: 'POST' });
                const data = await response.json();
                
                if (data.success) {
                    toastSuccess('Cache cleared successfully');
                    btn.textContent = 'âœ“';
                    setTimeout(() => { btn.textContent = originalText; }, 2000);
                } else {
                    toastError(data.error || 'Failed to clear cache');
                    btn.textContent = 'âŒ';
                }
            } catch (err) {
                toastError('Failed to clear cache: ' + err.message);
                btn.textContent = 'âŒ';
            }
            
            btn.disabled = false;
            setTimeout(() => { btn.textContent = originalText; }, 2000);
        }

        // Download functions
        function downloadChart(chartId) {
            const canvas = document.getElementById(chartId);
            const link = document.createElement('a');
            link.download = `${chartId}_${selectedOrgUnit.name.replace(/[^a-zA-Z0-9]/g, '_')}_${new Date().toISOString().split('T')[0]}.png`;
            link.href = canvas.toDataURL('image/png');
            link.click();
            toastSuccess('Chart image downloaded!');
        }

        async function downloadTableAsImage(elementId) {
            const element = document.getElementById(elementId);
            const canvas = await html2canvas(element, { 
                backgroundColor: '#ffffff',
                scale: 2 // Higher quality
            });
            const link = document.createElement('a');
            link.download = `${elementId}_${selectedOrgUnit.name.replace(/[^a-zA-Z0-9]/g, '_')}_${new Date().toISOString().split('T')[0]}.png`;
            link.href = canvas.toDataURL('image/png');
            link.click();
            toastSuccess('Image downloaded!');
        }

        function downloadChartAsPDF(chartId, title) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('l', 'mm', 'a4'); // Landscape
            
            const canvas = document.getElementById(chartId);
            const imgData = canvas.toDataURL('image/png', 1.0);
            
            // Header
            doc.setFillColor(17, 153, 142);
            doc.rect(0, 0, 297, 25, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(16);
            doc.setFont('helvetica', 'bold');
            doc.text(title, 15, 15);
            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            doc.text(`${selectedOrgUnit.name} | ${getSelectedPeriod()}`, 297 - 15, 15, { align: 'right' });
            
            // Chart image
            const imgWidth = 260;
            const imgHeight = (canvas.height * imgWidth) / canvas.width;
            doc.addImage(imgData, 'PNG', 18, 35, imgWidth, Math.min(imgHeight, 150));
            
            // Footer
            doc.setFontSize(8);
            doc.setTextColor(128);
            doc.text('Generated by EPI Dashboard - Uganda HMIS', 15, 200);
            doc.text(new Date().toLocaleDateString(), 297 - 15, 200, { align: 'right' });
            
            doc.save(`${chartId}_${selectedOrgUnit.name.replace(/[^a-zA-Z0-9]/g, '_')}_${new Date().toISOString().split('T')[0]}.pdf`);
            toastSuccess('Chart PDF downloaded!');
        }

        // ============ EXCEL BORDER HELPER ============
        const EXCEL_BORDER_THIN = {
            top: { style: 'thin', color: { rgb: '000000' } },
            bottom: { style: 'thin', color: { rgb: '000000' } },
            left: { style: 'thin', color: { rgb: '000000' } },
            right: { style: 'thin', color: { rgb: '000000' } }
        };

        function applyExcelBordersToSheet(ws) {
            const range = XLSX.utils.decode_range(ws['!ref']);
            for (let row = range.s.r; row <= range.e.r; row++) {
                for (let col = range.s.c; col <= range.e.c; col++) {
                    const cell = ws[XLSX.utils.encode_cell({ r: row, c: col })];
                    if (cell) {
                        if (!cell.s) cell.s = {};
                        cell.s.border = EXCEL_BORDER_THIN;
                    }
                }
            }
        }

        // ============ PROFESSIONAL PDF DOWNLOAD ============
        async function downloadTableAsPDF(tableId) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('l', 'mm', 'a4'); // Landscape for better table fit
            
            // Colors
            const headerColor = [17, 153, 142];
            const greenColor = [39, 174, 96];
            const yellowColor = [243, 156, 18];
            const redColor = [231, 76, 60];
            
            // Add header
            doc.setFillColor(...headerColor);
            doc.rect(0, 0, 297, 25, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(18);
            doc.setFont('helvetica', 'bold');
            doc.text('EPI Dashboard Report', 15, 15);
            
            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            doc.text(`${selectedOrgUnit.name} | ${getSelectedPeriod()} | Generated: ${new Date().toLocaleDateString()}`, 297 - 15, 15, { align: 'right' });
            
            // Reset text color
            doc.setTextColor(0, 0, 0);
            
            // Get table data
            const table = document.getElementById(tableId);
            const headers = Array.from(table.querySelectorAll('thead th')).map(th => th.textContent.trim().substring(0, 20));
            const rows = Array.from(table.querySelectorAll('tbody tr'));
            
            let startY = 35;
            
            // Table header
            doc.setFillColor(44, 62, 80);
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(9);
            doc.setFont('helvetica', 'bold');
            
            const colWidths = tableId === 'coverageTable' ? [50, 25, 25, 25, 50] : [50, 35, 35, 30, 30];
            let x = 15;
            headers.forEach((header, i) => {
                doc.rect(x, startY, colWidths[i] || 30, 10, 'F');
                doc.text(header, x + 2, startY + 7);
                x += colWidths[i] || 30;
            });
            
            startY += 12;
            doc.setFont('helvetica', 'normal');
            doc.setTextColor(0, 0, 0);
            
            // Table rows
            rows.forEach((row, rowIdx) => {
                if (startY > 190) {
                    doc.addPage();
                    startY = 20;
                }
                
                const cells = Array.from(row.querySelectorAll('td'));
                x = 15;
                
                // Alternate row colors
                if (rowIdx % 2 === 0) {
                    doc.setFillColor(248, 249, 250);
                    doc.rect(15, startY - 2, colWidths.reduce((a, b) => a + b, 0), 9, 'F');
                }
                
                cells.forEach((cell, i) => {
                    let text = cell.textContent.trim().substring(0, 30);
                    
                    // Check for coverage badge or coverage cell and apply color
                    const badge = cell.querySelector('.coverage-badge') || cell.querySelector('.coverage-cell');
                    if (badge) {
                        const isGreen = badge.classList.contains('green');
                        const isYellow = badge.classList.contains('yellow');
                        const isRed = badge.classList.contains('red');
                        
                        if (isGreen) doc.setFillColor(...greenColor);
                        else if (isYellow) doc.setFillColor(...yellowColor);
                        else if (isRed) doc.setFillColor(...redColor);
                        
                        if (isGreen || isYellow || isRed) {
                            doc.roundedRect(x, startY - 1, colWidths[i] - 2, 7, 1, 1, 'F');
                            doc.setTextColor(255, 255, 255);
                        }
                    }
                    
                    doc.setFontSize(8);
                    doc.text(text, x + 2, startY + 4);
                    doc.setTextColor(0, 0, 0);
                    x += colWidths[i] || 30;
                });
                
                startY += 9;
            });
            
            // Add footer
            const pageCount = doc.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
                doc.setPage(i);
                doc.setFontSize(8);
                doc.setTextColor(128, 128, 128);
                doc.text(`Page ${i} of ${pageCount}`, 297 / 2, 205, { align: 'center' });
                doc.text('Generated by EPI Dashboard - Uganda HMIS', 15, 205);
            }
            
            doc.save(`${tableId}_${selectedOrgUnit.name.replace(/[^a-zA-Z0-9]/g, '_')}_${new Date().toISOString().split('T')[0]}.pdf`);
            toastSuccess('PDF downloaded successfully!');
        }

        // ============ PROFESSIONAL EXCEL DOWNLOAD ============
        function downloadCoverageExcel() {
            if (!window.coverageData || !window.coverageData.length) {
                toastError('No coverage data available. Please load data first.');
                return;
            }

            const indicators = window.coverageData;
            const wb = XLSX.utils.book_new();

            // ===== SUMMARY DASHBOARD SHEET =====
            const totalDoses = indicators.reduce((s, i) => s + i.doses, 0);
            const avgCoverage = Math.round(indicators.reduce((s, i) => s + i.coverage, 0) / indicators.length);
            const greenCount = indicators.filter(i => i.color === 'green').length;
            const yellowCount = indicators.filter(i => i.color === 'yellow').length;
            const redCount = indicators.filter(i => i.color === 'red').length;

            const dashboardData = [
                [''],
                ['', '', 'EPI COVERAGE PERFORMANCE REPORT'],
                [''],
                ['', '', 'Organization:', selectedOrgUnit.name],
                ['', '', 'Period:', getSelectedPeriod()],
                ['', '', 'Report Date:', new Date().toLocaleDateString()],
                ['', '', 'Generated By:', 'EPI Dashboard - Uganda HMIS'],
                [''],
                ['', '', 'KEY PERFORMANCE INDICATORS'],
                [''],
                ['', '', 'Total Doses Administered', totalDoses.toLocaleString()],
                ['', '', 'Average Coverage', avgCoverage + '%'],
                ['', '', 'Target Population', (indicators[0]?.target_population || 0).toLocaleString()],
                [''],
                ['', '', 'COVERAGE BREAKDOWN'],
                [''],
                ['', '', 'âœ“ On Target (â‰¥95%)', greenCount, 'indicators'],
                ['', '', 'âš¡ Moderate (70-94%)', yellowCount, 'indicators'],
                ['', '', 'âš  Needs Attention (<70%)', redCount, 'indicators'],
                [''],
                ['', '', 'PERFORMANCE DISTRIBUTION'],
                ['', '', 'On Target %', Math.round((greenCount/indicators.length)*100) + '%'],
                ['', '', 'Moderate %', Math.round((yellowCount/indicators.length)*100) + '%'],
                ['', '', 'Low %', Math.round((redCount/indicators.length)*100) + '%'],
            ];

            const wsDashboard = XLSX.utils.aoa_to_sheet(dashboardData);
            wsDashboard['!cols'] = [{ wch: 5 }, { wch: 5 }, { wch: 30 }, { wch: 20 }, { wch: 15 }];
            
            // Style dashboard
            const titleCell = wsDashboard['C2'];
            if (titleCell) {
                titleCell.s = {
                    font: { bold: true, sz: 18, color: { rgb: '11998E' } },
                    alignment: { horizontal: 'center' }
                };
            }
            
            // Merge title cell
            wsDashboard['!merges'] = [{ s: { r: 1, c: 2 }, e: { r: 1, c: 4 } }];
            
            XLSX.utils.book_append_sheet(wb, wsDashboard, 'Dashboard');

            // ===== COVERAGE DATA SHEET =====
            const wsData = [
                ['#', 'Vaccine / Antigen', 'Doses Given', 'Target Population', 'Coverage %', 'Status', 'Disease Prevented', 'Schedule']
            ];

            indicators.forEach((i, idx) => {
                const info = ANTIGEN_INFO[i.code] || { disease: 'Immunization', schedule: '-' };
                const shortName = getShortVaccineName(i.name, i.code);
                const status = i.color === 'green' ? 'âœ“ On Target' : i.color === 'yellow' ? 'âš¡ Moderate' : 'âš  Low';
                wsData.push([
                    idx + 1, 
                    shortName, 
                    i.doses, 
                    i.target_population, 
                    i.coverage,
                    status,
                    info.disease, 
                    info.schedule
                ]);
            });

            const ws = XLSX.utils.aoa_to_sheet(wsData);
            ws['!cols'] = [
                { wch: 4 }, { wch: 35 }, { wch: 12 }, { wch: 15 }, { wch: 12 }, { wch: 14 }, { wch: 35 }, { wch: 25 }
            ];

            // Style header row
            for (let col = 0; col <= 7; col++) {
                const headerCell = ws[XLSX.utils.encode_cell({ r: 0, c: col })];
                if (headerCell) {
                    headerCell.s = {
                        fill: { patternType: 'solid', fgColor: { rgb: '11998E' } },
                        font: { color: { rgb: 'FFFFFF' }, bold: true, sz: 11 },
                        alignment: { horizontal: 'center', vertical: 'center' },
                        border: {
                            top: { style: 'thin', color: { rgb: '000000' } },
                            bottom: { style: 'thin', color: { rgb: '000000' } },
                            left: { style: 'thin', color: { rgb: '000000' } },
                            right: { style: 'thin', color: { rgb: '000000' } }
                        }
                    };
                }
            }

            // Style data rows with colors and borders
            const range = XLSX.utils.decode_range(ws['!ref']);
            for (let row = 1; row <= range.e.r; row++) {
                const coverageCell = ws[XLSX.utils.encode_cell({ r: row, c: 4 })];
                const statusCell = ws[XLSX.utils.encode_cell({ r: row, c: 5 })];

                if (coverageCell) {
                    const coverageVal = parseFloat(coverageCell.v);
                    let bgColor, fontColor;

                    if (coverageVal >= 95) {
                        bgColor = '27AE60';
                        fontColor = 'FFFFFF';
                    } else if (coverageVal >= 70) {
                        bgColor = 'F39C12';
                        fontColor = 'FFFFFF';
                    } else {
                        bgColor = 'E74C3C';
                        fontColor = 'FFFFFF';
                    }

                    coverageCell.s = {
                        fill: { patternType: 'solid', fgColor: { rgb: bgColor } },
                        font: { color: { rgb: fontColor }, bold: true },
                        alignment: { horizontal: 'center' },
                        border: EXCEL_BORDER_THIN
                    };
                    
                    // Also color status cell
                    if (statusCell) {
                        statusCell.s = {
                            fill: { patternType: 'solid', fgColor: { rgb: bgColor } },
                            font: { color: { rgb: fontColor }, bold: true },
                            alignment: { horizontal: 'center' },
                            border: EXCEL_BORDER_THIN
                        };
                    }
                }
                
                // Style all other cells with borders and alternate colors
                for (let col = 0; col <= 7; col++) {
                    const cell = ws[XLSX.utils.encode_cell({ r: row, c: col })];
                    if (cell) {
                        if (!cell.s) {
                            cell.s = {
                                fill: { patternType: 'solid', fgColor: { rgb: row % 2 === 0 ? 'F8F9FA' : 'FFFFFF' } },
                                border: EXCEL_BORDER_THIN
                            };
                        } else if (!cell.s.border) {
                            cell.s.border = EXCEL_BORDER_THIN;
                        }
                    }
                }
            }

            XLSX.utils.book_append_sheet(wb, ws, 'Coverage Data');

            // ===== DROPOUT ANALYSIS SHEET =====
            if (window.dropoutData && window.dropoutData.length > 0) {
                const dropoutWsData = [
                    ['Dropout Pathway', 'First Dose', 'Last Dose', 'Dropout Rate', 'Status', 'Interpretation']
                ];
                
                window.dropoutData.forEach(d => {
                    const status = d.dropout_rate < 10 ? 'âœ“ Acceptable' : 'âš  High';
                    const interpretation = d.dropout_rate < 10 
                        ? 'Good retention - children completing the series' 
                        : 'High dropout - follow-up needed';
                    dropoutWsData.push([d.name, d.first_doses, d.last_doses, d.dropout_rate + '%', status, interpretation]);
                });
                
                const wsDropout = XLSX.utils.aoa_to_sheet(dropoutWsData);
                wsDropout['!cols'] = [{ wch: 25 }, { wch: 12 }, { wch: 12 }, { wch: 12 }, { wch: 15 }, { wch: 40 }];
                
                // Style header with borders
                for (let col = 0; col <= 5; col++) {
                    const headerCell = wsDropout[XLSX.utils.encode_cell({ r: 0, c: col })];
                if (headerCell) {
                    headerCell.s = {
                            fill: { patternType: 'solid', fgColor: { rgb: 'E74C3C' } },
                        font: { color: { rgb: 'FFFFFF' }, bold: true },
                            alignment: { horizontal: 'center' },
                            border: EXCEL_BORDER_THIN
                        };
                    }
                }
                
                // Style dropout rates and all cells with borders
                const dropoutRange = XLSX.utils.decode_range(wsDropout['!ref']);
                for (let row = 1; row <= dropoutRange.e.r; row++) {
                    for (let col = 0; col <= 5; col++) {
                        const cell = wsDropout[XLSX.utils.encode_cell({ r: row, c: col })];
                        if (cell) {
                            const isRateCol = col === 3;
                            const isStatusCol = col === 4;
                            
                            if (isRateCol) {
                                const rate = parseFloat(String(cell.v).replace('%', ''));
                                cell.s = {
                                    fill: { patternType: 'solid', fgColor: { rgb: rate < 10 ? '27AE60' : 'E74C3C' } },
                                    font: { color: { rgb: 'FFFFFF' }, bold: true },
                                    alignment: { horizontal: 'center' },
                                    border: EXCEL_BORDER_THIN
                                };
                            } else if (isStatusCol) {
                                const rateCell = wsDropout[XLSX.utils.encode_cell({ r: row, c: 3 })];
                                const rate = rateCell ? parseFloat(String(rateCell.v).replace('%', '')) : 10;
                                cell.s = {
                                    fill: { patternType: 'solid', fgColor: { rgb: rate < 10 ? '27AE60' : 'E74C3C' } },
                                    font: { color: { rgb: 'FFFFFF' }, bold: true },
                                    alignment: { horizontal: 'center' },
                                    border: EXCEL_BORDER_THIN
                                };
                            } else {
                                cell.s = {
                                    fill: { patternType: 'solid', fgColor: { rgb: row % 2 === 0 ? 'F8F9FA' : 'FFFFFF' } },
                                    border: EXCEL_BORDER_THIN
                                };
                            }
                        }
                    }
                }
                
                XLSX.utils.book_append_sheet(wb, wsDropout, 'Dropout Analysis');
            }

            const filename = `EPI_Report_${selectedOrgUnit.name.replace(/[^a-zA-Z0-9]/g, '_')}_${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(wb, filename);
            toastSuccess('Excel report downloaded successfully!');
        }

        // ============ FULL REPORT DOWNLOAD ============
        async function downloadFullReport(format = 'excel') {
            if (!window.coverageData || !window.coverageData.length) {
                toastError('No data available. Please load data first.');
                return;
            }
            
            showLoading('Generating Report...', 'Creating comprehensive report');
            
            if (format === 'excel') {
                await downloadFullExcelReport();
            } else if (format === 'pdf') {
                await downloadFullPDFReport();
            }
            
            hideLoading();
        }

        async function downloadFullExcelReport() {
            const indicators = window.coverageData;
            const dropouts = window.dropoutData || [];
            const wb = XLSX.utils.book_new();

            // Statistics
            const totalDoses = indicators.reduce((s, i) => s + i.doses, 0);
            const avgCoverage = Math.round(indicators.reduce((s, i) => s + i.coverage, 0) / indicators.length);
            const greenCount = indicators.filter(i => i.color === 'green').length;
            const yellowCount = indicators.filter(i => i.color === 'yellow').length;
            const redCount = indicators.filter(i => i.color === 'red').length;

            // Sheet 1: Executive Summary
            const summaryData = [
                [''],
                ['', 'EPI IMMUNIZATION COVERAGE REPORT'],
                [''],
                ['', 'REPORT INFORMATION'],
                ['', 'Organization', selectedOrgUnit.name],
                ['', 'Period', getSelectedPeriod()],
                ['', 'Report Date', new Date().toLocaleDateString()],
                ['', 'System', 'Uganda HMIS - EPI Dashboard'],
                [''],
                ['', 'EXECUTIVE SUMMARY'],
                ['', 'Total Vaccinations', totalDoses.toLocaleString()],
                ['', 'Average Coverage Rate', avgCoverage + '%'],
                ['', 'Target Population', (indicators[0]?.target_population || 0).toLocaleString()],
                [''],
                ['', 'PERFORMANCE OVERVIEW'],
                ['', 'Indicators On Target (â‰¥95%)', greenCount],
                ['', 'Indicators Moderate (70-94%)', yellowCount],
                ['', 'Indicators Low (<70%)', redCount],
                ['', 'Total Indicators', indicators.length],
                [''],
                ['', 'PERFORMANCE RATING'],
                ['', avgCoverage >= 90 ? 'â˜…â˜…â˜…â˜…â˜… EXCELLENT' : avgCoverage >= 80 ? 'â˜…â˜…â˜…â˜… GOOD' : avgCoverage >= 70 ? 'â˜…â˜…â˜… MODERATE' : 'â˜…â˜… NEEDS IMPROVEMENT'],
            ];

            const wsSummary = XLSX.utils.aoa_to_sheet(summaryData);
            wsSummary['!cols'] = [{ wch: 5 }, { wch: 35 }, { wch: 30 }];
            
            // Style title
            const titleCell = wsSummary['B2'];
            if (titleCell) {
                titleCell.s = { font: { bold: true, sz: 20, color: { rgb: '11998E' } } };
            }
            
            XLSX.utils.book_append_sheet(wb, wsSummary, 'Executive Summary');

            // Sheet 2: Coverage Details (styled)
            const coverageData = [
                ['#', 'Vaccine', 'Doses', 'Target', 'Coverage', 'Status', 'Disease', 'Schedule']
            ];
            indicators.forEach((i, idx) => {
                const info = ANTIGEN_INFO[i.code] || { disease: '-', schedule: '-' };
                coverageData.push([
                    idx + 1,
                    getShortVaccineName(i.name, i.code),
                    i.doses,
                    i.target_population,
                    i.coverage,
                    i.color === 'green' ? 'ON TARGET' : i.color === 'yellow' ? 'MODERATE' : 'LOW',
                    info.disease,
                    info.schedule
                ]);
            });
            
            const wsCoverage = XLSX.utils.aoa_to_sheet(coverageData);
            wsCoverage['!cols'] = [{ wch: 4 }, { wch: 30 }, { wch: 12 }, { wch: 12 }, { wch: 10 }, { wch: 12 }, { wch: 30 }, { wch: 25 }];
            
            // Style coverage sheet header with borders
            for (let col = 0; col <= 7; col++) {
                const hdr = wsCoverage[XLSX.utils.encode_cell({ r: 0, c: col })];
                if (hdr) hdr.s = { fill: { patternType: 'solid', fgColor: { rgb: '11998E' } }, font: { color: { rgb: 'FFFFFF' }, bold: true }, alignment: { horizontal: 'center' }, border: EXCEL_BORDER_THIN };
            }
            
            // Style all coverage data cells with borders
            for (let row = 1; row <= indicators.length; row++) {
                for (let col = 0; col <= 7; col++) {
                    const cell = wsCoverage[XLSX.utils.encode_cell({ r: row, c: col })];
                    if (cell) {
                        const isCovCol = col === 4;
                        const isStatCol = col === 5;
                        const covCell = wsCoverage[XLSX.utils.encode_cell({ r: row, c: 4 })];
                        const val = covCell ? parseFloat(covCell.v) : 0;
                        const bg = val >= 95 ? '27AE60' : val >= 70 ? 'F39C12' : 'E74C3C';
                        
                        if (isCovCol || isStatCol) {
                            cell.s = { fill: { patternType: 'solid', fgColor: { rgb: bg } }, font: { color: { rgb: 'FFFFFF' }, bold: true }, alignment: { horizontal: 'center' }, border: EXCEL_BORDER_THIN };
                        } else {
                            cell.s = { fill: { patternType: 'solid', fgColor: { rgb: row % 2 === 0 ? 'F8F9FA' : 'FFFFFF' } }, border: EXCEL_BORDER_THIN };
                        }
                    }
                }
            }
            
            XLSX.utils.book_append_sheet(wb, wsCoverage, 'Coverage Details');

            // Sheet 3: Dropout Analysis
            if (dropouts.length > 0) {
                const dropoutData = [['Pathway', 'Start', 'End', 'Rate', 'Status']];
                dropouts.forEach(d => {
                    dropoutData.push([d.name, d.first_doses, d.last_doses, d.dropout_rate, d.dropout_rate < 10 ? 'ACCEPTABLE' : 'HIGH']);
                });
                const wsDropout = XLSX.utils.aoa_to_sheet(dropoutData);
                wsDropout['!cols'] = [{ wch: 25 }, { wch: 12 }, { wch: 12 }, { wch: 10 }, { wch: 15 }];
                
                // Style dropout header with borders
                for (let col = 0; col <= 4; col++) {
                    const hdr = wsDropout[XLSX.utils.encode_cell({ r: 0, c: col })];
                    if (hdr) hdr.s = { fill: { patternType: 'solid', fgColor: { rgb: 'E67E22' } }, font: { color: { rgb: 'FFFFFF' }, bold: true }, border: EXCEL_BORDER_THIN };
                }
                
                // Style all dropout data cells with borders
                for (let row = 1; row <= dropouts.length; row++) {
                    for (let col = 0; col <= 4; col++) {
                        const cell = wsDropout[XLSX.utils.encode_cell({ r: row, c: col })];
                        if (cell) {
                            const isRateCol = col === 3;
                            const isStatCol = col === 4;
                            const rateCell = wsDropout[XLSX.utils.encode_cell({ r: row, c: 3 })];
                            const rate = rateCell ? parseFloat(rateCell.v) : 10;
                            const bg = rate < 10 ? '27AE60' : 'E74C3C';
                            
                            if (isRateCol || isStatCol) {
                                cell.s = { fill: { patternType: 'solid', fgColor: { rgb: bg } }, font: { color: { rgb: 'FFFFFF' }, bold: true }, alignment: { horizontal: 'center' }, border: EXCEL_BORDER_THIN };
                            } else {
                                cell.s = { fill: { patternType: 'solid', fgColor: { rgb: row % 2 === 0 ? 'F8F9FA' : 'FFFFFF' } }, border: EXCEL_BORDER_THIN };
                            }
                        }
                    }
                }
                
                XLSX.utils.book_append_sheet(wb, wsDropout, 'Dropout Analysis');
            }

            // Sheet 4: RED Categorization (if data available)
            if (window.redCategorizationData && window.redCategorizationData.length > 0) {
                const redData = window.redCategorizationData;
                const redUnitName = window.redUnitName || selectedOrgUnit.name;
                
                // Headers
                const redHeaders = [
                    'Quarter', 'Months', 'Population', 'BCG Target', 'DPT Target',
                    'BCG', 'DPT1', 'DPT3', 'MR',
                    'BCG %', 'DPT1 %', 'DPT3 %', 'MR %',
                    'Gap DPT3', 'Gap MR', 'Zero Dose', 'Under-Imm',
                    'DO 1â†’3', 'DO 1â†’MR',
                    'Access', 'Utilization', 'Category'
                ];
                
                const redRows = redData.map(q => [
                    q.name, q.display || '', q.population, q.target_bcg, q.target_pop,
                    q.bcg, q.dpt1, q.dpt3, q.mr,
                    q.bcg_cov, q.dpt1_cov, q.dpt3_cov, q.mr_cov,
                    q.unimm_dpt3, q.unimm_mr, q.zero_dose, q.under_imm,
                    q.dpt1_3_dropout, q.dpt1_mr_dropout,
                    q.access, q.utilization, q.category
                ]);
                
                const redWsData = [
                    [`RED CATEGORISATION - ${redUnitName}`],
                    [''],
                    redHeaders,
                    ...redRows
                ];
                
                const wsRed = XLSX.utils.aoa_to_sheet(redWsData);
                wsRed['!cols'] = [
                    { wch: 12 }, { wch: 10 }, { wch: 10 }, { wch: 10 }, { wch: 10 },
                    { wch: 8 }, { wch: 8 }, { wch: 8 }, { wch: 8 },
                    { wch: 8 }, { wch: 8 }, { wch: 8 }, { wch: 8 },
                    { wch: 10 }, { wch: 10 }, { wch: 10 }, { wch: 10 },
                    { wch: 8 }, { wch: 8 },
                    { wch: 8 }, { wch: 8 }, { wch: 10 }
                ];
                
                // Style title
                const titleCell = wsRed['A1'];
                if (titleCell) {
                    titleCell.s = { font: { bold: true, sz: 14, color: { rgb: 'C0392B' } } };
                }
                
                // Style headers (row 3, index 2)
                for (let c = 0; c < redHeaders.length; c++) {
                    const cell = wsRed[XLSX.utils.encode_cell({ r: 2, c: c })];
                    if (cell) {
                        cell.s = {
                            font: { bold: true, color: { rgb: 'FFFFFF' }, sz: 9 },
                            fill: { fgColor: { rgb: 'C0392B' } },
                            border: EXCEL_BORDER_THIN,
                            alignment: { horizontal: 'center' }
                        };
                    }
                }
                
                // Style data rows with category colors
                const cat1Fill = { fgColor: { rgb: '92D050' } };
                const cat2Fill = { fgColor: { rgb: 'FFFF00' } };
                const cat3Fill = { fgColor: { rgb: 'FFC000' } };
                const cat4Fill = { fgColor: { rgb: 'FF0000' } };
                const goodFill = { fgColor: { rgb: 'C6EFCE' } };
                const poorFill = { fgColor: { rgb: 'FFC7CE' } };
                
                for (let r = 3; r < 3 + redRows.length; r++) {
                    const rowData = redData[r - 3];
                    
                    for (let c = 0; c < redHeaders.length; c++) {
                        const cell = wsRed[XLSX.utils.encode_cell({ r: r, c: c })];
                        if (cell) {
                            cell.s = { border: EXCEL_BORDER_THIN, alignment: { horizontal: 'center' } };
                            
                            // Access column (19)
                            if (c === 19) {
                                cell.s.fill = rowData.access === 'Good' ? goodFill : poorFill;
                                cell.s.font = { bold: true };
                            }
                            // Utilization column (20)
                            if (c === 20) {
                                cell.s.fill = rowData.utilization === 'Good' ? goodFill : poorFill;
                                cell.s.font = { bold: true };
                            }
                            // Category column (21)
                            if (c === 21) {
                                if (rowData.category === 'Cat. 1') cell.s.fill = cat1Fill;
                                else if (rowData.category === 'Cat. 2') cell.s.fill = cat2Fill;
                                else if (rowData.category === 'Cat. 3') cell.s.fill = cat3Fill;
                                else if (rowData.category === 'Cat. 4') {
                                    cell.s.fill = cat4Fill;
                                    cell.s.font = { bold: true, color: { rgb: 'FFFFFF' } };
                                }
                            }
                        }
                    }
                }
                
                XLSX.utils.book_append_sheet(wb, wsRed, 'RED Categorization');
            }

            // Sheet 5: Data Dictionary
            const dictData = [
                ['Field', 'Description'],
                ['Vaccine/Antigen', 'Name of the vaccine or immunization antigen'],
                ['Doses Given', 'Total number of doses administered during the period'],
                ['Target Population', 'UBOS projected target population for the antigen'],
                ['Coverage %', 'Percentage of target population vaccinated'],
                ['Status', 'Performance classification based on coverage'],
                ['Disease Prevented', 'Disease(s) the vaccine protects against'],
                ['Schedule', 'Recommended age/timing for vaccination'],
                [''],
                ['Coverage Thresholds:'],
                ['â‰¥95%', 'ON TARGET - Meeting national/WHO targets'],
                ['70-94%', 'MODERATE - Below target but acceptable'],
                ['<70%', 'LOW - Requires immediate attention'],
            ];
            const wsDict = XLSX.utils.aoa_to_sheet(dictData);
            wsDict['!cols'] = [{ wch: 25 }, { wch: 50 }];
            
            // Style data dictionary with borders
            const dictRange = XLSX.utils.decode_range(wsDict['!ref']);
            for (let row = dictRange.s.r; row <= dictRange.e.r; row++) {
                for (let col = dictRange.s.c; col <= dictRange.e.c; col++) {
                    const cell = wsDict[XLSX.utils.encode_cell({ r: row, c: col })];
                    if (cell) {
                        if (row === 0) {
                            cell.s = { fill: { patternType: 'solid', fgColor: { rgb: '34495E' } }, font: { color: { rgb: 'FFFFFF' }, bold: true }, border: EXCEL_BORDER_THIN };
                        } else {
                            cell.s = { fill: { patternType: 'solid', fgColor: { rgb: row % 2 === 0 ? 'F8F9FA' : 'FFFFFF' } }, border: EXCEL_BORDER_THIN };
                        }
                    }
                }
            }
            
            XLSX.utils.book_append_sheet(wb, wsDict, 'Data Dictionary');

            const filename = `EPI_Full_Report_${selectedOrgUnit.name.replace(/[^a-zA-Z0-9]/g, '_')}_${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(wb, filename);
            toastSuccess('Full Excel report downloaded!');
        }

        async function downloadFullPDFReport() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4');
            
            const indicators = window.coverageData;
            const dropouts = window.dropoutData || [];
            const totalDoses = indicators.reduce((s, i) => s + i.doses, 0);
            const avgCoverage = Math.round(indicators.reduce((s, i) => s + i.coverage, 0) / indicators.length);
            const greenCount = indicators.filter(i => i.color === 'green').length;
            const yellowCount = indicators.filter(i => i.color === 'yellow').length;
            const redCount = indicators.filter(i => i.color === 'red').length;
            
            // Page 1: Cover
            doc.setFillColor(17, 153, 142);
            doc.rect(0, 0, 210, 60, 'F');
            
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(28);
            doc.setFont('helvetica', 'bold');
            doc.text('EPI Coverage Report', 105, 30, { align: 'center' });
            doc.setFontSize(14);
            doc.setFont('helvetica', 'normal');
            doc.text('Immunization Performance Analysis', 105, 45, { align: 'center' });
            
            doc.setTextColor(0, 0, 0);
            doc.setFontSize(16);
            doc.text(selectedOrgUnit.name, 105, 80, { align: 'center' });
            doc.setFontSize(12);
            doc.text(getSelectedPeriod(), 105, 90, { align: 'center' });
            doc.text('Generated: ' + new Date().toLocaleDateString(), 105, 100, { align: 'center' });
            
            // KPI boxes
            const kpiY = 120;
            const kpiWidth = 45;
            const kpiHeight = 35;
            
            // Total Doses
            doc.setFillColor(52, 73, 94);
            doc.roundedRect(20, kpiY, kpiWidth, kpiHeight, 3, 3, 'F');
            doc.setTextColor(255);
            doc.setFontSize(10);
            doc.text('Total Doses', 20 + kpiWidth/2, kpiY + 12, { align: 'center' });
            doc.setFontSize(14);
            doc.setFont('helvetica', 'bold');
            doc.text(totalDoses.toLocaleString(), 20 + kpiWidth/2, kpiY + 26, { align: 'center' });
            
            // Avg Coverage
            const avgColor = avgCoverage >= 95 ? [39, 174, 96] : avgCoverage >= 70 ? [243, 156, 18] : [231, 76, 60];
            doc.setFillColor(...avgColor);
            doc.roundedRect(70, kpiY, kpiWidth, kpiHeight, 3, 3, 'F');
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(10);
            doc.text('Avg Coverage', 70 + kpiWidth/2, kpiY + 12, { align: 'center' });
            doc.setFontSize(16);
            doc.setFont('helvetica', 'bold');
            doc.text(avgCoverage + '%', 70 + kpiWidth/2, kpiY + 26, { align: 'center' });
            
            // On Target
            doc.setFillColor(39, 174, 96);
            doc.roundedRect(120, kpiY, kpiWidth, kpiHeight, 3, 3, 'F');
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(10);
            doc.text('On Target', 120 + kpiWidth/2, kpiY + 12, { align: 'center' });
            doc.setFontSize(16);
            doc.setFont('helvetica', 'bold');
            doc.text(greenCount.toString(), 120 + kpiWidth/2, kpiY + 26, { align: 'center' });
            
            // Needs Attention
            doc.setFillColor(231, 76, 60);
            doc.roundedRect(170, kpiY, kpiWidth - 10, kpiHeight, 3, 3, 'F');
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(10);
            doc.text('Low', 170 + (kpiWidth-10)/2, kpiY + 12, { align: 'center' });
            doc.setFontSize(16);
            doc.setFont('helvetica', 'bold');
            doc.text(redCount.toString(), 170 + (kpiWidth-10)/2, kpiY + 26, { align: 'center' });
            
            // Performance bar
            doc.setTextColor(0);
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(11);
            doc.text('Coverage Distribution', 20, kpiY + 50);
            
            const barY = kpiY + 55;
            const barWidth = 170;
            const barHeight = 12;
            const total = indicators.length;
            const greenW = (greenCount/total) * barWidth;
            const yellowW = (yellowCount/total) * barWidth;
            const redW = (redCount/total) * barWidth;
            
            doc.setFillColor(39, 174, 96);
            doc.rect(20, barY, greenW, barHeight, 'F');
            doc.setFillColor(243, 156, 18);
            doc.rect(20 + greenW, barY, yellowW, barHeight, 'F');
            doc.setFillColor(231, 76, 60);
            doc.rect(20 + greenW + yellowW, barY, redW, barHeight, 'F');
            
            // Legend
            doc.setFontSize(8);
            doc.setFillColor(39, 174, 96);
            doc.circle(25, barY + 22, 3, 'F');
            doc.text('On Target (â‰¥95%)', 30, barY + 24);
            
            doc.setFillColor(243, 156, 18);
            doc.circle(80, barY + 22, 3, 'F');
            doc.text('Moderate (70-94%)', 85, barY + 24);
            
            doc.setFillColor(231, 76, 60);
            doc.circle(145, barY + 22, 3, 'F');
            doc.text('Low (<70%)', 150, barY + 24);
            
            // Page 2: Coverage Table
            doc.addPage();
            doc.setFillColor(17, 153, 142);
            doc.rect(0, 0, 210, 20, 'F');
            doc.setTextColor(255);
            doc.setFontSize(14);
            doc.setFont('helvetica', 'bold');
            doc.text('Coverage by Antigen', 15, 13);
            
            let y = 30;
            doc.setTextColor(0);
            doc.setFontSize(8);
            
            // Table header
            doc.setFillColor(44, 62, 80);
            doc.rect(10, y, 190, 8, 'F');
            doc.setTextColor(255);
            doc.setFont('helvetica', 'bold');
            doc.text('#', 15, y + 5);
            doc.text('Vaccine', 25, y + 5);
            doc.text('Doses', 90, y + 5);
            doc.text('Target', 115, y + 5);
            doc.text('Coverage', 140, y + 5);
            doc.text('Disease', 165, y + 5);
            y += 10;
            
            doc.setFont('helvetica', 'normal');
            doc.setTextColor(0);
            
            indicators.forEach((ind, idx) => {
                if (y > 270) {
                    doc.addPage();
                    y = 20;
                }
                
                const info = ANTIGEN_INFO[ind.code] || { disease: '-' };
                
                // Alternate row colors
                if (idx % 2 === 0) {
                    doc.setFillColor(248, 249, 250);
                    doc.rect(10, y - 2, 190, 8, 'F');
                }
                
                doc.setTextColor(0);
                doc.text((idx + 1).toString(), 15, y + 4);
                doc.text(getShortVaccineName(ind.name, ind.code).substring(0, 25), 25, y + 4);
                doc.text(ind.doses.toLocaleString(), 90, y + 4);
                doc.text(ind.target_population.toLocaleString(), 115, y + 4);
                
                // Coverage with color
                const covColor = ind.color === 'green' ? [39, 174, 96] : ind.color === 'yellow' ? [243, 156, 18] : [231, 76, 60];
                doc.setFillColor(...covColor);
                doc.roundedRect(138, y - 1, 20, 6, 1, 1, 'F');
                doc.setTextColor(255);
                doc.text(ind.coverage + '%', 140, y + 4);
                
                doc.setTextColor(0);
                doc.text(info.disease.substring(0, 20), 165, y + 4);
                
                y += 8;
            });
            
            // Page 3: RED Categorization (if data available) - Capture as image like section download
            if (window.redCategorizationData && window.redCategorizationData.length > 0) {
                try {
                    const redElement = document.getElementById('redCategorizationCard');
                    if (redElement) {
                        const redCanvas = await html2canvas(redElement, {
                            backgroundColor: '#ffffff',
                            scale: 2,
                            useCORS: true,
                            logging: false
                        });
                        
                        const redImgData = redCanvas.toDataURL('image/png');
                        const redImgWidth = redCanvas.width;
                        const redImgHeight = redCanvas.height;
                        
                        // Add landscape page for RED categorization
                        doc.addPage('landscape');
                        
                        // Calculate scale to fit
                        const pdfWidth = 297; // A4 landscape width in mm
                        const pdfHeight = 210; // A4 landscape height in mm
                        const scale = (pdfWidth - 20) / redImgWidth * 2; // 10mm margins
                        const scaledHeight = redImgHeight * scale / 2;
                        
                        // Add the captured image
                        doc.addImage(redImgData, 'PNG', 10, 10, (pdfWidth - 20), Math.min(scaledHeight, pdfHeight - 20));
                    }
                } catch (redError) {
                    console.error('Error capturing RED section:', redError);
                }
            }
            
            // Footer on all pages
            const pageCount = doc.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
                doc.setPage(i);
                doc.setFontSize(8);
                doc.setTextColor(128);
                doc.text('EPI Dashboard - Uganda HMIS', 15, 290);
                doc.text(`Page ${i} of ${pageCount}`, 195, 290, { align: 'right' });
            }
            
            const filename = `EPI_Full_Report_${selectedOrgUnit.name.replace(/[^a-zA-Z0-9]/g, '_')}_${new Date().toISOString().split('T')[0]}.pdf`;
            doc.save(filename);
            toastSuccess('Full PDF report downloaded!');
        }

        // ============ DROPOUT EXCEL DOWNLOAD ============
        function downloadDropoutExcel() {
            if (!window.dropoutData || !window.dropoutData.length) {
                toastError('No dropout data available. Please load data first.');
                return;
            }
            
            const dropouts = window.dropoutData;
            const wb = XLSX.utils.book_new();
            
            const wsData = [
                ['Dropout Pathway', 'Starting Dose', 'Ending Dose', 'Dropout Rate', 'Status', 'Recommendation']
            ];
            
            dropouts.forEach(d => {
                const status = d.dropout_rate < 10 ? 'ACCEPTABLE' : 'HIGH';
                const rec = d.dropout_rate < 10 
                    ? 'Continue current follow-up practices' 
                    : 'Implement defaulter tracing and community mobilization';
                wsData.push([d.name, d.first_doses, d.last_doses, d.dropout_rate + '%', status, rec]);
            });
            
            const ws = XLSX.utils.aoa_to_sheet(wsData);
            ws['!cols'] = [{ wch: 25 }, { wch: 15 }, { wch: 15 }, { wch: 12 }, { wch: 12 }, { wch: 45 }];
            
            // Style header with borders
            for (let col = 0; col <= 5; col++) {
                const cell = ws[XLSX.utils.encode_cell({ r: 0, c: col })];
                if (cell) cell.s = { 
                    fill: { patternType: 'solid', fgColor: { rgb: 'E67E22' } }, 
                    font: { color: { rgb: 'FFFFFF' }, bold: true },
                    alignment: { horizontal: 'center' },
                    border: EXCEL_BORDER_THIN
                };
            }
            
            // Style all data rows with borders
            for (let row = 1; row <= dropouts.length; row++) {
                for (let col = 0; col <= 5; col++) {
                    const cell = ws[XLSX.utils.encode_cell({ r: row, c: col })];
                    if (cell) {
                        const isRateCol = col === 3;
                        const isStatCol = col === 4;
                        const rateCell = ws[XLSX.utils.encode_cell({ r: row, c: 3 })];
                        const rate = rateCell ? parseFloat(String(rateCell.v).replace('%', '')) : 10;
                        const bg = rate < 10 ? '27AE60' : 'E74C3C';
                        
                        if (isRateCol || isStatCol) {
                            cell.s = { 
                                fill: { patternType: 'solid', fgColor: { rgb: bg } }, 
                                font: { color: { rgb: 'FFFFFF' }, bold: true }, 
                                alignment: { horizontal: 'center' },
                                border: EXCEL_BORDER_THIN
                            };
                        } else {
                            cell.s = { 
                                fill: { patternType: 'solid', fgColor: { rgb: row % 2 === 0 ? 'F8F9FA' : 'FFFFFF' } },
                                border: EXCEL_BORDER_THIN
                            };
                        }
                    }
                }
            }
            
            XLSX.utils.book_append_sheet(wb, ws, 'Dropout Analysis');
            
            const filename = `Dropout_Analysis_${selectedOrgUnit.name.replace(/[^a-zA-Z0-9]/g, '_')}_${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(wb, filename);
            toastSuccess('Dropout Excel downloaded!');
        }
    </script>
</body>

</html>